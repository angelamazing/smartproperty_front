# æ‰‹åŠ¨ç¡®è®¤å°±é¤æ¥å£æ–‡æ¡£

## ğŸ“‹ æ¥å£æ¦‚è¿°

æ‰‹åŠ¨ç¡®è®¤å°±é¤æ¥å£å…è®¸ç”¨æˆ·ç¡®è®¤è‡ªå·±å·²ç»å°±é¤ï¼Œç³»ç»Ÿä¼šæ›´æ–°è®¢å•çš„å°±é¤çŠ¶æ€å¹¶è®°å½•ç¡®è®¤æ—¥å¿—ã€‚

**åŸºç¡€è·¯å¾„**: `/api/dining-confirmation`

**è®¤è¯è¦æ±‚**: éœ€è¦æœ‰æ•ˆçš„JWT Token

## ğŸ¯ æ ¸å¿ƒæ¥å£

### 1. ç”¨æˆ·æ‰‹åŠ¨ç¡®è®¤å°±é¤

**æ¥å£åœ°å€**: `POST /api/dining-confirmation/manual/:orderId`

**æ¥å£æè¿°**: ç”¨æˆ·è‡ªå·±ç¡®è®¤å·²å°±é¤

#### è¯·æ±‚å¤´
```http
Authorization: Bearer {token}
Content-Type: application/json
```

#### è·¯å¾„å‚æ•°
| å‚æ•°å | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|--------|------|------|------|
| orderId | string | æ˜¯ | è®¢å•ID |

#### è¯·æ±‚å‚æ•°
```json
{
  "confirmationType": "manual"  // å¯é€‰ï¼Œé»˜è®¤ä¸ºmanual
}
```

#### æˆåŠŸå“åº”
```json
{
  "success": true,
  "message": "ç¡®è®¤å°±é¤æˆåŠŸ",
  "data": {
    "orderId": "917a80ca-bc11-4458-a72f-04122a4b37a7",
    "confirmationType": "manual",
    "actualDiningTime": "2025-09-11 12:30:00",
    "message": "ç¡®è®¤å°±é¤æˆåŠŸ"
  }
}
```

#### é”™è¯¯å“åº”

**è®¢å•ä¸å­˜åœ¨æˆ–æ— æƒæ“ä½œ (404)**
```json
{
  "success": false,
  "message": "è®¢å•ä¸å­˜åœ¨æˆ–æ— æƒæ“ä½œ",
  "error": "Not Found"
}
```

**è®¢å•å·²å–æ¶ˆ (400)**
```json
{
  "success": false,
  "message": "è®¢å•å·²å–æ¶ˆï¼Œæ— æ³•ç¡®è®¤å°±é¤",
  "error": "Bad Request"
}
```

**å·²ç¡®è®¤å°±é¤ (400)**
```json
{
  "success": false,
  "message": "è¯¥è®¢å•å·²ç¡®è®¤å°±é¤",
  "error": "Bad Request"
}
```

**ä¸åœ¨å°±é¤æ—¶é—´å†… (400)**
```json
{
  "success": false,
  "message": "å½“å‰æ—¶é—´ä¸åœ¨åˆé¤å°±é¤æ—¶é—´å†…",
  "error": "Bad Request"
}
```

## ğŸ”§ å‰ç«¯å¯¹æ¥ç¤ºä¾‹

### JavaScript/Axios ç¤ºä¾‹

```javascript
// æ‰‹åŠ¨ç¡®è®¤å°±é¤
async function confirmDiningManually(orderId, token) {
  try {
    const response = await axios.post(
      `/api/dining-confirmation/manual/${orderId}`,
      {
        confirmationType: 'manual'
      },
      {
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      }
    );
    
    if (response.data.success) {
      console.log('ç¡®è®¤å°±é¤æˆåŠŸ:', response.data.data);
      return response.data.data;
    } else {
      throw new Error(response.data.message);
    }
  } catch (error) {
    console.error('ç¡®è®¤å°±é¤å¤±è´¥:', error.response?.data?.message || error.message);
    throw error;
  }
}

// ä½¿ç”¨ç¤ºä¾‹
const orderId = '917a80ca-bc11-4458-a72f-04122a4b37a7';
const userToken = 'your-jwt-token';

confirmDiningManually(orderId, userToken)
  .then(result => {
    console.log('ç¡®è®¤å°±é¤æˆåŠŸ:', result);
    // æ›´æ–°UIçŠ¶æ€
  })
  .catch(error => {
    console.error('ç¡®è®¤å°±é¤å¤±è´¥:', error.message);
    // æ˜¾ç¤ºé”™è¯¯æç¤º
  });
```

### React Hook ç¤ºä¾‹

```javascript
import { useState } from 'react';
import axios from 'axios';

function useDiningConfirmation() {
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);

  const confirmDining = async (orderId, token) => {
    setLoading(true);
    setError(null);
    
    try {
      const response = await axios.post(
        `/api/dining-confirmation/manual/${orderId}`,
        { confirmationType: 'manual' },
        {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        }
      );
      
      if (response.data.success) {
        return response.data.data;
      } else {
        throw new Error(response.data.message);
      }
    } catch (err) {
      const errorMessage = err.response?.data?.message || err.message;
      setError(errorMessage);
      throw err;
    } finally {
      setLoading(false);
    }
  };

  return { confirmDining, loading, error };
}

// ç»„ä»¶ä¸­ä½¿ç”¨
function DiningConfirmationButton({ orderId, token, onSuccess }) {
  const { confirmDining, loading, error } = useDiningConfirmation();

  const handleConfirm = async () => {
    try {
      const result = await confirmDining(orderId, token);
      onSuccess(result);
    } catch (err) {
      // é”™è¯¯å·²åœ¨hookä¸­å¤„ç†
    }
  };

  return (
    <div>
      <button 
        onClick={handleConfirm} 
        disabled={loading}
        className="confirm-button"
      >
        {loading ? 'ç¡®è®¤ä¸­...' : 'ç¡®è®¤å°±é¤'}
      </button>
      {error && <div className="error-message">{error}</div>}
    </div>
  );
}
```

### Vue.js ç¤ºä¾‹

```javascript
// Vue 3 Composition API
import { ref } from 'vue';
import axios from 'axios';

export function useDiningConfirmation() {
  const loading = ref(false);
  const error = ref(null);

  const confirmDining = async (orderId, token) => {
    loading.value = true;
    error.value = null;
    
    try {
      const response = await axios.post(
        `/api/dining-confirmation/manual/${orderId}`,
        { confirmationType: 'manual' },
        {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        }
      );
      
      if (response.data.success) {
        return response.data.data;
      } else {
        throw new Error(response.data.message);
      }
    } catch (err) {
      error.value = err.response?.data?.message || err.message;
      throw err;
    } finally {
      loading.value = false;
    }
  };

  return { confirmDining, loading, error };
}

// ç»„ä»¶ä¸­ä½¿ç”¨
<template>
  <div>
    <button 
      @click="handleConfirm" 
      :disabled="loading"
      class="confirm-button"
    >
      {{ loading ? 'ç¡®è®¤ä¸­...' : 'ç¡®è®¤å°±é¤' }}
    </button>
    <div v-if="error" class="error-message">{{ error }}</div>
  </div>
</template>

<script setup>
import { useDiningConfirmation } from '@/composables/useDiningConfirmation';

const props = defineProps(['orderId', 'token']);
const emit = defineEmits(['success']);

const { confirmDining, loading, error } = useDiningConfirmation();

const handleConfirm = async () => {
  try {
    const result = await confirmDining(props.orderId, props.token);
    emit('success', result);
  } catch (err) {
    // é”™è¯¯å·²åœ¨composableä¸­å¤„ç†
  }
};
</script>
```

## ğŸ“± å°ç¨‹åºå¯¹æ¥ç¤ºä¾‹

### å¾®ä¿¡å°ç¨‹åº

```javascript
// æ‰‹åŠ¨ç¡®è®¤å°±é¤
function confirmDiningManually(orderId) {
  return new Promise((resolve, reject) => {
    wx.request({
      url: `${app.globalData.baseUrl}/api/dining-confirmation/manual/${orderId}`,
      method: 'POST',
      header: {
        'Authorization': `Bearer ${wx.getStorageSync('token')}`,
        'Content-Type': 'application/json'
      },
      data: {
        confirmationType: 'manual'
      },
      success: (res) => {
        if (res.data.success) {
          resolve(res.data.data);
        } else {
          reject(new Error(res.data.message));
        }
      },
      fail: (err) => {
        reject(err);
      }
    });
  });
}

// é¡µé¢ä¸­ä½¿ç”¨
Page({
  data: {
    orderId: '',
    loading: false
  },

  async onConfirmDining() {
    if (!this.data.orderId) {
      wx.showToast({
        title: 'è®¢å•IDä¸èƒ½ä¸ºç©º',
        icon: 'error'
      });
      return;
    }

    this.setData({ loading: true });

    try {
      const result = await confirmDiningManually(this.data.orderId);
      
      wx.showToast({
        title: 'ç¡®è®¤å°±é¤æˆåŠŸ',
        icon: 'success'
      });
      
      // æ›´æ–°é¡µé¢çŠ¶æ€
      this.setData({
        diningStatus: 'dined',
        actualDiningTime: result.actualDiningTime
      });
      
    } catch (error) {
      wx.showToast({
        title: error.message || 'ç¡®è®¤å°±é¤å¤±è´¥',
        icon: 'error'
      });
    } finally {
      this.setData({ loading: false });
    }
  }
});
```

## ğŸ” ä¸šåŠ¡è§„åˆ™è¯´æ˜

### 1. èº«ä»½éªŒè¯
- åªæœ‰è®¢å•çš„ `userId` å¯¹åº”çš„ç”¨æˆ·æ‰èƒ½ç¡®è®¤è¯¥è®¢å•çš„å°±é¤çŠ¶æ€
- ç³»ç»Ÿä¼šéªŒè¯JWT Tokenä¸­çš„ç”¨æˆ·IDä¸è®¢å•çš„userIdæ˜¯å¦åŒ¹é…

### 2. è®¢å•çŠ¶æ€æ£€æŸ¥
- è®¢å•çŠ¶æ€ä¸èƒ½ä¸º `cancelled`ï¼ˆå·²å–æ¶ˆï¼‰
- å°±é¤çŠ¶æ€ä¸èƒ½ä¸º `dined`ï¼ˆå·²ç¡®è®¤å°±é¤ï¼‰

### 3. æ—¶é—´é™åˆ¶
- å½“å¤©ç¡®è®¤ï¼šå¿…é¡»åœ¨å¯¹åº”é¤æ¬¡çš„å°±é¤æ—¶é—´èŒƒå›´å†…
  - æ—©é¤ï¼š6:00-10:00
  - åˆé¤ï¼š11:00-14:00  
  - æ™šé¤ï¼š17:00-20:00
- éå½“å¤©ç¡®è®¤ï¼šæ— æ—¶é—´é™åˆ¶

### 4. æ•°æ®æ›´æ–°
- æ›´æ–°è®¢å•çš„ `diningStatus` ä¸º `dined`
- è®°å½• `actualDiningTime` ä¸ºå½“å‰æ—¶é—´
- åœ¨ `dining_confirmation_logs` è¡¨ä¸­è®°å½•ç¡®è®¤æ—¥å¿—

## ğŸš¨ é”™è¯¯å¤„ç†å»ºè®®

### å‰ç«¯é”™è¯¯å¤„ç†ç­–ç•¥

```javascript
function handleConfirmationError(error) {
  const errorMessage = error.response?.data?.message || error.message;
  
  switch (error.response?.status) {
    case 404:
      // è®¢å•ä¸å­˜åœ¨æˆ–æ— æƒæ“ä½œ
      return 'è®¢å•ä¸å­˜åœ¨æˆ–æ‚¨æ— æƒæ“ä½œæ­¤è®¢å•';
    case 400:
      if (errorMessage.includes('å·²ç¡®è®¤å°±é¤')) {
        return 'è¯¥è®¢å•å·²ç¡®è®¤å°±é¤ï¼Œä¸èƒ½é‡å¤ç¡®è®¤';
      } else if (errorMessage.includes('å·²å–æ¶ˆ')) {
        return 'è®¢å•å·²å–æ¶ˆï¼Œæ— æ³•ç¡®è®¤å°±é¤';
      } else if (errorMessage.includes('ä¸åœ¨å°±é¤æ—¶é—´å†…')) {
        return 'å½“å‰æ—¶é—´ä¸åœ¨å°±é¤æ—¶é—´èŒƒå›´å†…';
      }
      return errorMessage;
    case 401:
      return 'ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•';
    case 500:
      return 'æœåŠ¡å™¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•';
    default:
      return 'ç¡®è®¤å°±é¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•';
  }
}
```

## ğŸ“Š ç›¸å…³æ¥å£

### è·å–å°±é¤ç¡®è®¤çŠ¶æ€
```http
GET /api/dining-confirmation/status?date=2025-09-11
```

### è·å–ç¡®è®¤å†å²
```http
GET /api/dining-confirmation/history?page=1&pageSize=20
```

### ç®¡ç†å‘˜ä»£ç¡®è®¤ï¼ˆéœ€è¦ç®¡ç†å‘˜æƒé™ï¼‰
```http
POST /api/dining-confirmation/admin/:orderId
```

## ğŸ”§ æµ‹è¯•ç”¨ä¾‹

### æ­£å¸¸æµç¨‹æµ‹è¯•
```javascript
// æµ‹è¯•æ•°æ®
const testOrderId = '917a80ca-bc11-4458-a72f-04122a4b37a7';
const testToken = 'valid-jwt-token';

// æµ‹è¯•ç¡®è®¤å°±é¤
const result = await confirmDiningManually(testOrderId, testToken);
console.log('ç¡®è®¤ç»“æœ:', result);
```

### å¼‚å¸¸æƒ…å†µæµ‹è¯•
```javascript
// æµ‹è¯•æ— æ•ˆè®¢å•ID
try {
  await confirmDiningManually('invalid-order-id', testToken);
} catch (error) {
  console.log('é¢„æœŸé”™è¯¯:', error.message);
}

// æµ‹è¯•æ— æ•ˆToken
try {
  await confirmDiningManually(testOrderId, 'invalid-token');
} catch (error) {
  console.log('é¢„æœŸé”™è¯¯:', error.message);
}
```

---

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **Tokenç®¡ç†**: ç¡®ä¿å‰ç«¯æ­£ç¡®ç®¡ç†JWT Tokenï¼Œè¿‡æœŸæ—¶åŠæ—¶åˆ·æ–°
2. **é”™è¯¯å¤„ç†**: æ ¹æ®ä¸åŒçš„é”™è¯¯çŠ¶æ€ç æä¾›ç›¸åº”çš„ç”¨æˆ·æç¤º
3. **åŠ è½½çŠ¶æ€**: åœ¨ç¡®è®¤è¿‡ç¨‹ä¸­æ˜¾ç¤ºåŠ è½½çŠ¶æ€ï¼Œé¿å…é‡å¤æäº¤
4. **æ•°æ®åŒæ­¥**: ç¡®è®¤æˆåŠŸååŠæ—¶æ›´æ–°æœ¬åœ°çŠ¶æ€å’ŒUIæ˜¾ç¤º
5. **æƒé™éªŒè¯**: ç¡®ä¿åªæœ‰è®¢å•æ‰€æœ‰è€…æ‰èƒ½ç¡®è®¤å°±é¤

è¿™ä¸ªæ¥å£æ–‡æ¡£æä¾›äº†å®Œæ•´çš„å‰ç«¯å¯¹æ¥æŒ‡å—ï¼ŒåŒ…æ‹¬å„ç§å‰ç«¯æ¡†æ¶çš„ç¤ºä¾‹ä»£ç å’Œé”™è¯¯å¤„ç†ç­–ç•¥ã€‚
