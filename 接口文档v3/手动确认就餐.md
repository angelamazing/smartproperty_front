# 手动确认就餐接口文档

## 📋 接口概述

手动确认就餐接口允许用户确认自己已经就餐，系统会更新订单的就餐状态并记录确认日志。

**基础路径**: `/api/dining-confirmation`

**认证要求**: 需要有效的JWT Token

## 🎯 核心接口

### 1. 用户手动确认就餐

**接口地址**: `POST /api/dining-confirmation/manual/:orderId`

**接口描述**: 用户自己确认已就餐

#### 请求头
```http
Authorization: Bearer {token}
Content-Type: application/json
```

#### 路径参数
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| orderId | string | 是 | 订单ID |

#### 请求参数
```json
{
  "confirmationType": "manual"  // 可选，默认为manual
}
```

#### 成功响应
```json
{
  "success": true,
  "message": "确认就餐成功",
  "data": {
    "orderId": "917a80ca-bc11-4458-a72f-04122a4b37a7",
    "confirmationType": "manual",
    "actualDiningTime": "2025-09-11 12:30:00",
    "message": "确认就餐成功"
  }
}
```

#### 错误响应

**订单不存在或无权操作 (404)**
```json
{
  "success": false,
  "message": "订单不存在或无权操作",
  "error": "Not Found"
}
```

**订单已取消 (400)**
```json
{
  "success": false,
  "message": "订单已取消，无法确认就餐",
  "error": "Bad Request"
}
```

**已确认就餐 (400)**
```json
{
  "success": false,
  "message": "该订单已确认就餐",
  "error": "Bad Request"
}
```

**不在就餐时间内 (400)**
```json
{
  "success": false,
  "message": "当前时间不在午餐就餐时间内",
  "error": "Bad Request"
}
```

## 🔧 前端对接示例

### JavaScript/Axios 示例

```javascript
// 手动确认就餐
async function confirmDiningManually(orderId, token) {
  try {
    const response = await axios.post(
      `/api/dining-confirmation/manual/${orderId}`,
      {
        confirmationType: 'manual'
      },
      {
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      }
    );
    
    if (response.data.success) {
      console.log('确认就餐成功:', response.data.data);
      return response.data.data;
    } else {
      throw new Error(response.data.message);
    }
  } catch (error) {
    console.error('确认就餐失败:', error.response?.data?.message || error.message);
    throw error;
  }
}

// 使用示例
const orderId = '917a80ca-bc11-4458-a72f-04122a4b37a7';
const userToken = 'your-jwt-token';

confirmDiningManually(orderId, userToken)
  .then(result => {
    console.log('确认就餐成功:', result);
    // 更新UI状态
  })
  .catch(error => {
    console.error('确认就餐失败:', error.message);
    // 显示错误提示
  });
```

### React Hook 示例

```javascript
import { useState } from 'react';
import axios from 'axios';

function useDiningConfirmation() {
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);

  const confirmDining = async (orderId, token) => {
    setLoading(true);
    setError(null);
    
    try {
      const response = await axios.post(
        `/api/dining-confirmation/manual/${orderId}`,
        { confirmationType: 'manual' },
        {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        }
      );
      
      if (response.data.success) {
        return response.data.data;
      } else {
        throw new Error(response.data.message);
      }
    } catch (err) {
      const errorMessage = err.response?.data?.message || err.message;
      setError(errorMessage);
      throw err;
    } finally {
      setLoading(false);
    }
  };

  return { confirmDining, loading, error };
}

// 组件中使用
function DiningConfirmationButton({ orderId, token, onSuccess }) {
  const { confirmDining, loading, error } = useDiningConfirmation();

  const handleConfirm = async () => {
    try {
      const result = await confirmDining(orderId, token);
      onSuccess(result);
    } catch (err) {
      // 错误已在hook中处理
    }
  };

  return (
    <div>
      <button 
        onClick={handleConfirm} 
        disabled={loading}
        className="confirm-button"
      >
        {loading ? '确认中...' : '确认就餐'}
      </button>
      {error && <div className="error-message">{error}</div>}
    </div>
  );
}
```

### Vue.js 示例

```javascript
// Vue 3 Composition API
import { ref } from 'vue';
import axios from 'axios';

export function useDiningConfirmation() {
  const loading = ref(false);
  const error = ref(null);

  const confirmDining = async (orderId, token) => {
    loading.value = true;
    error.value = null;
    
    try {
      const response = await axios.post(
        `/api/dining-confirmation/manual/${orderId}`,
        { confirmationType: 'manual' },
        {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        }
      );
      
      if (response.data.success) {
        return response.data.data;
      } else {
        throw new Error(response.data.message);
      }
    } catch (err) {
      error.value = err.response?.data?.message || err.message;
      throw err;
    } finally {
      loading.value = false;
    }
  };

  return { confirmDining, loading, error };
}

// 组件中使用
<template>
  <div>
    <button 
      @click="handleConfirm" 
      :disabled="loading"
      class="confirm-button"
    >
      {{ loading ? '确认中...' : '确认就餐' }}
    </button>
    <div v-if="error" class="error-message">{{ error }}</div>
  </div>
</template>

<script setup>
import { useDiningConfirmation } from '@/composables/useDiningConfirmation';

const props = defineProps(['orderId', 'token']);
const emit = defineEmits(['success']);

const { confirmDining, loading, error } = useDiningConfirmation();

const handleConfirm = async () => {
  try {
    const result = await confirmDining(props.orderId, props.token);
    emit('success', result);
  } catch (err) {
    // 错误已在composable中处理
  }
};
</script>
```

## 📱 小程序对接示例

### 微信小程序

```javascript
// 手动确认就餐
function confirmDiningManually(orderId) {
  return new Promise((resolve, reject) => {
    wx.request({
      url: `${app.globalData.baseUrl}/api/dining-confirmation/manual/${orderId}`,
      method: 'POST',
      header: {
        'Authorization': `Bearer ${wx.getStorageSync('token')}`,
        'Content-Type': 'application/json'
      },
      data: {
        confirmationType: 'manual'
      },
      success: (res) => {
        if (res.data.success) {
          resolve(res.data.data);
        } else {
          reject(new Error(res.data.message));
        }
      },
      fail: (err) => {
        reject(err);
      }
    });
  });
}

// 页面中使用
Page({
  data: {
    orderId: '',
    loading: false
  },

  async onConfirmDining() {
    if (!this.data.orderId) {
      wx.showToast({
        title: '订单ID不能为空',
        icon: 'error'
      });
      return;
    }

    this.setData({ loading: true });

    try {
      const result = await confirmDiningManually(this.data.orderId);
      
      wx.showToast({
        title: '确认就餐成功',
        icon: 'success'
      });
      
      // 更新页面状态
      this.setData({
        diningStatus: 'dined',
        actualDiningTime: result.actualDiningTime
      });
      
    } catch (error) {
      wx.showToast({
        title: error.message || '确认就餐失败',
        icon: 'error'
      });
    } finally {
      this.setData({ loading: false });
    }
  }
});
```

## 🔍 业务规则说明

### 1. 身份验证
- 只有订单的 `userId` 对应的用户才能确认该订单的就餐状态
- 系统会验证JWT Token中的用户ID与订单的userId是否匹配

### 2. 订单状态检查
- 订单状态不能为 `cancelled`（已取消）
- 就餐状态不能为 `dined`（已确认就餐）

### 3. 时间限制
- 当天确认：必须在对应餐次的就餐时间范围内
  - 早餐：6:00-10:00
  - 午餐：11:00-14:00  
  - 晚餐：17:00-20:00
- 非当天确认：无时间限制

### 4. 数据更新
- 更新订单的 `diningStatus` 为 `dined`
- 记录 `actualDiningTime` 为当前时间
- 在 `dining_confirmation_logs` 表中记录确认日志

## 🚨 错误处理建议

### 前端错误处理策略

```javascript
function handleConfirmationError(error) {
  const errorMessage = error.response?.data?.message || error.message;
  
  switch (error.response?.status) {
    case 404:
      // 订单不存在或无权操作
      return '订单不存在或您无权操作此订单';
    case 400:
      if (errorMessage.includes('已确认就餐')) {
        return '该订单已确认就餐，不能重复确认';
      } else if (errorMessage.includes('已取消')) {
        return '订单已取消，无法确认就餐';
      } else if (errorMessage.includes('不在就餐时间内')) {
        return '当前时间不在就餐时间范围内';
      }
      return errorMessage;
    case 401:
      return '登录已过期，请重新登录';
    case 500:
      return '服务器错误，请稍后重试';
    default:
      return '确认就餐失败，请稍后重试';
  }
}
```

## 📊 相关接口

### 获取就餐确认状态
```http
GET /api/dining-confirmation/status?date=2025-09-11
```

### 获取确认历史
```http
GET /api/dining-confirmation/history?page=1&pageSize=20
```

### 管理员代确认（需要管理员权限）
```http
POST /api/dining-confirmation/admin/:orderId
```

## 🔧 测试用例

### 正常流程测试
```javascript
// 测试数据
const testOrderId = '917a80ca-bc11-4458-a72f-04122a4b37a7';
const testToken = 'valid-jwt-token';

// 测试确认就餐
const result = await confirmDiningManually(testOrderId, testToken);
console.log('确认结果:', result);
```

### 异常情况测试
```javascript
// 测试无效订单ID
try {
  await confirmDiningManually('invalid-order-id', testToken);
} catch (error) {
  console.log('预期错误:', error.message);
}

// 测试无效Token
try {
  await confirmDiningManually(testOrderId, 'invalid-token');
} catch (error) {
  console.log('预期错误:', error.message);
}
```

---

## 📝 注意事项

1. **Token管理**: 确保前端正确管理JWT Token，过期时及时刷新
2. **错误处理**: 根据不同的错误状态码提供相应的用户提示
3. **加载状态**: 在确认过程中显示加载状态，避免重复提交
4. **数据同步**: 确认成功后及时更新本地状态和UI显示
5. **权限验证**: 确保只有订单所有者才能确认就餐

这个接口文档提供了完整的前端对接指南，包括各种前端框架的示例代码和错误处理策略。
