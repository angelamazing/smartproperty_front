# 智慧物业管理系统 - 部署运维指南

## 📋 文档概述

本指南提供了智慧物业管理系统后端服务的完整部署和运维方案，包括环境准备、服务部署、监控告警、备份恢复等关键运维操作。

**适用版本**: v2.0.0  
**部署环境**: Linux (Ubuntu 20.04+)  
**维护团队**: 湖北省地质局第三地质大队

## 🛠️ 环境要求

### 系统要求
- **操作系统**: Ubuntu 20.04+ / CentOS 8+ / RHEL 8+
- **CPU**: 2核心以上
- **内存**: 4GB以上
- **存储**: 50GB以上可用空间
- **网络**: 稳定的网络连接

### 软件依赖
- **Node.js**: 16.x 或更高版本
- **MySQL**: 8.0 或更高版本
- **Redis**: 6.0+ (可选，用于缓存)
- **PM2**: 进程管理工具
- **Nginx**: 反向代理服务器

## 🚀 部署方案

### 方案1: 传统部署

#### 1.1 环境准备
```bash
# 更新系统包
sudo apt update && sudo apt upgrade -y

# 安装Node.js
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs

# 安装MySQL
sudo apt install mysql-server -y
sudo mysql_secure_installation

# 安装PM2
sudo npm install -g pm2

# 安装Nginx
sudo apt install nginx -y
```

#### 1.2 数据库配置
```bash
# 登录MySQL
sudo mysql -u root -p

# 创建数据库和用户
CREATE DATABASE smart_property CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER 'smart_user'@'localhost' IDENTIFIED BY 'your_password';
GRANT ALL PRIVILEGES ON smart_property.* TO 'smart_user'@'localhost';
FLUSH PRIVILEGES;
EXIT;
```

#### 1.3 应用部署
```bash
# 克隆代码
git clone <repository_url> /opt/smart-property
cd /opt/smart-property

# 安装依赖
npm install --production

# 配置环境变量
cp .env.example .env
nano .env
```

#### 1.4 环境变量配置
```bash
# .env 文件配置
NODE_ENV=production
PORT=3000
DB_HOST=localhost
DB_PORT=3306
DB_NAME=smart_property
DB_USER=smart_user
DB_PASSWORD=your_password
JWT_SECRET=your_jwt_secret
REDIS_URL=redis://localhost:6379
```

#### 1.5 启动服务
```bash
# 使用PM2启动
pm2 start ecosystem.config.js

# 设置开机自启
pm2 startup
pm2 save
```

### 方案2: Docker部署

#### 2.1 Dockerfile
```dockerfile
FROM node:18-alpine

WORKDIR /app

COPY package*.json ./
RUN npm ci --only=production

COPY . .

EXPOSE 3000

CMD ["npm", "start"]
```

#### 2.2 docker-compose.yml
```yaml
version: '3.8'

services:
  app:
    build: .
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - DB_HOST=mysql
      - DB_NAME=smart_property
      - DB_USER=smart_user
      - DB_PASSWORD=your_password
    depends_on:
      - mysql
      - redis
    restart: unless-stopped

  mysql:
    image: mysql:8.0
    environment:
      - MYSQL_ROOT_PASSWORD=root_password
      - MYSQL_DATABASE=smart_property
      - MYSQL_USER=smart_user
      - MYSQL_PASSWORD=your_password
    volumes:
      - mysql_data:/var/lib/mysql
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    volumes:
      - redis_data:/data
    restart: unless-stopped

  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./ssl:/etc/nginx/ssl
    depends_on:
      - app
    restart: unless-stopped

volumes:
  mysql_data:
  redis_data:
```

#### 2.3 部署命令
```bash
# 构建和启动服务
docker-compose up -d

# 查看服务状态
docker-compose ps

# 查看日志
docker-compose logs -f app
```

## 🔧 Nginx配置

### 反向代理配置
```nginx
server {
    listen 80;
    server_name your-domain.com;

    # 重定向到HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name your-domain.com;

    # SSL证书配置
    ssl_certificate /etc/nginx/ssl/cert.pem;
    ssl_certificate_key /etc/nginx/ssl/key.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512;

    # 反向代理到Node.js应用
    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    # 静态文件缓存
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # 安全头
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;
    add_header Content-Security-Policy "default-src 'self' http: https: data: blob: 'unsafe-inline'" always;
}
```

## 📊 监控告警

### PM2监控配置
```javascript
// ecosystem.config.js
module.exports = {
  apps: [{
    name: 'smart-property-api',
    script: 'server.js',
    instances: 'max',
    exec_mode: 'cluster',
    env: {
      NODE_ENV: 'production',
      PORT: 3000
    },
    error_file: './logs/err.log',
    out_file: './logs/out.log',
    log_file: './logs/combined.log',
    time: true,
    max_memory_restart: '1G',
    node_args: '--max-old-space-size=1024'
  }]
};
```

### 监控脚本
```bash
#!/bin/bash
# monitor.sh

# 检查服务状态
check_service() {
    if pm2 list | grep -q "smart-property-api.*online"; then
        echo "✅ 服务运行正常"
        return 0
    else
        echo "❌ 服务异常"
        return 1
    fi
}

# 检查数据库连接
check_database() {
    mysql -h localhost -u smart_user -p$DB_PASSWORD -e "SELECT 1" smart_property > /dev/null 2>&1
    if [ $? -eq 0 ]; then
        echo "✅ 数据库连接正常"
        return 0
    else
        echo "❌ 数据库连接异常"
        return 1
    fi
}

# 检查磁盘空间
check_disk() {
    usage=$(df / | awk 'NR==2 {print $5}' | sed 's/%//')
    if [ $usage -lt 80 ]; then
        echo "✅ 磁盘空间充足: ${usage}%"
        return 0
    else
        echo "⚠️ 磁盘空间不足: ${usage}%"
        return 1
    fi
}

# 检查内存使用
check_memory() {
    usage=$(free | awk 'NR==2{printf "%.0f", $3*100/$2}')
    if [ $usage -lt 80 ]; then
        echo "✅ 内存使用正常: ${usage}%"
        return 0
    else
        echo "⚠️ 内存使用过高: ${usage}%"
        return 1
    fi
}

# 主检查函数
main() {
    echo "=== 系统监控检查 $(date) ==="
    
    check_service
    check_database
    check_disk
    check_memory
    
    echo "=== 检查完成 ==="
}

main
```

### 告警配置
```bash
# 设置定时检查
crontab -e

# 每5分钟检查一次
*/5 * * * * /opt/smart-property/scripts/monitor.sh >> /var/log/monitor.log 2>&1

# 每天凌晨2点备份数据库
0 2 * * * /opt/smart-property/scripts/backup.sh >> /var/log/backup.log 2>&1
```

## 💾 备份恢复

### 数据库备份脚本
```bash
#!/bin/bash
# backup.sh

BACKUP_DIR="/opt/backups"
DATE=$(date +%Y%m%d_%H%M%S)
DB_NAME="smart_property"
DB_USER="smart_user"
DB_PASSWORD="your_password"

# 创建备份目录
mkdir -p $BACKUP_DIR

# 备份数据库
mysqldump -h localhost -u $DB_USER -p$DB_PASSWORD $DB_NAME > $BACKUP_DIR/db_backup_$DATE.sql

# 压缩备份文件
gzip $BACKUP_DIR/db_backup_$DATE.sql

# 删除7天前的备份
find $BACKUP_DIR -name "db_backup_*.sql.gz" -mtime +7 -delete

echo "数据库备份完成: db_backup_$DATE.sql.gz"
```

### 应用备份脚本
```bash
#!/bin/bash
# app_backup.sh

APP_DIR="/opt/smart-property"
BACKUP_DIR="/opt/backups"
DATE=$(date +%Y%m%d_%H%M%S)

# 备份应用代码
tar -czf $BACKUP_DIR/app_backup_$DATE.tar.gz -C /opt smart-property

# 删除7天前的备份
find $BACKUP_DIR -name "app_backup_*.tar.gz" -mtime +7 -delete

echo "应用备份完成: app_backup_$DATE.tar.gz"
```

### 恢复脚本
```bash
#!/bin/bash
# restore.sh

BACKUP_FILE=$1
DB_NAME="smart_property"
DB_USER="smart_user"
DB_PASSWORD="your_password"

if [ -z "$BACKUP_FILE" ]; then
    echo "使用方法: $0 <备份文件路径>"
    exit 1
fi

# 恢复数据库
if [[ $BACKUP_FILE == *".sql.gz" ]]; then
    gunzip -c $BACKUP_FILE | mysql -h localhost -u $DB_USER -p$DB_PASSWORD $DB_NAME
    echo "数据库恢复完成"
elif [[ $BACKUP_FILE == *".tar.gz" ]]; then
    tar -xzf $BACKUP_FILE -C /opt
    echo "应用恢复完成"
else
    echo "不支持的备份文件格式"
    exit 1
fi
```

## 🔒 安全配置

### 防火墙配置
```bash
# 安装ufw
sudo apt install ufw -y

# 默认策略
sudo ufw default deny incoming
sudo ufw default allow outgoing

# 允许SSH
sudo ufw allow ssh

# 允许HTTP和HTTPS
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp

# 启用防火墙
sudo ufw enable
```

### SSL证书配置
```bash
# 使用Let's Encrypt
sudo apt install certbot python3-certbot-nginx -y

# 获取证书
sudo certbot --nginx -d your-domain.com

# 自动续期
sudo crontab -e
# 添加: 0 12 * * * /usr/bin/certbot renew --quiet
```

### 安全加固
```bash
# 禁用root登录
sudo nano /etc/ssh/sshd_config
# 设置: PermitRootLogin no

# 更改SSH端口
# 设置: Port 2222

# 重启SSH服务
sudo systemctl restart ssh
```

## 🚨 故障排查

### 常见问题及解决方案

#### 1. 服务无法启动
```bash
# 检查端口占用
sudo netstat -tlnp | grep :3000

# 检查PM2状态
pm2 status

# 查看错误日志
pm2 logs smart-property-api --err

# 重启服务
pm2 restart smart-property-api
```

#### 2. 数据库连接失败
```bash
# 检查MySQL服务状态
sudo systemctl status mysql

# 检查数据库连接
mysql -h localhost -u smart_user -p smart_property

# 检查防火墙
sudo ufw status
```

#### 3. 内存不足
```bash
# 查看内存使用
free -h

# 查看进程内存使用
ps aux --sort=-%mem | head

# 重启服务释放内存
pm2 restart smart-property-api
```

#### 4. 磁盘空间不足
```bash
# 查看磁盘使用
df -h

# 清理日志文件
sudo find /var/log -name "*.log" -mtime +30 -delete

# 清理PM2日志
pm2 flush
```

### 日志分析
```bash
# 查看应用日志
tail -f /opt/smart-property/logs/combined.log

# 查看Nginx日志
tail -f /var/log/nginx/access.log
tail -f /var/log/nginx/error.log

# 查看系统日志
journalctl -u nginx -f
```

## 📈 性能优化

### 数据库优化
```sql
-- 添加索引
CREATE INDEX idx_dining_orders_user_date ON dining_orders(userId, diningDate);
CREATE INDEX idx_dining_orders_status ON dining_orders(diningStatus);
CREATE INDEX idx_dining_confirmation_logs_order ON dining_confirmation_logs(orderId);

-- 优化查询
EXPLAIN SELECT * FROM dining_orders WHERE userId = ? AND diningDate = ?;
```

### 应用优化
```javascript
// 连接池配置
const dbConfig = {
  host: process.env.DB_HOST,
  user: process.env.DB_USER,
  password: process.env.DB_PASSWORD,
  database: process.env.DB_NAME,
  connectionLimit: 10,
  acquireTimeout: 60000,
  timeout: 60000,
  reconnect: true
};
```

### 缓存配置
```javascript
// Redis缓存配置
const redis = require('redis');
const client = redis.createClient({
  host: process.env.REDIS_HOST,
  port: process.env.REDIS_PORT,
  password: process.env.REDIS_PASSWORD,
  retry_strategy: (options) => {
    if (options.error && options.error.code === 'ECONNREFUSED') {
      return new Error('Redis服务器连接被拒绝');
    }
    if (options.total_retry_time > 1000 * 60 * 60) {
      return new Error('重试时间已用完');
    }
    if (options.attempt > 10) {
      return undefined;
    }
    return Math.min(options.attempt * 100, 3000);
  }
});
```

## 📋 运维检查清单

### 日常检查
- [ ] 服务状态检查
- [ ] 数据库连接检查
- [ ] 磁盘空间检查
- [ ] 内存使用检查
- [ ] 日志文件检查
- [ ] 备份状态检查

### 周检查
- [ ] 安全更新检查
- [ ] 性能指标分析
- [ ] 错误日志分析
- [ ] 用户反馈检查
- [ ] 容量规划评估

### 月检查
- [ ] 完整系统备份
- [ ] 安全漏洞扫描
- [ ] 性能基准测试
- [ ] 灾难恢复演练
- [ ] 文档更新检查

## 📞 联系支持

- **技术支持**: 湖北省地质局第三地质大队
- **紧急联系**: 24小时技术支持热线
- **文档更新**: 定期更新维护

---

**文档版本**: v1.0.0  
**创建时间**: 2025年1月  
**维护团队**: 湖北省地质局第三地质大队
