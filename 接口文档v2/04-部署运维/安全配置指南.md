# 智慧物业管理系统 - 安全配置指南

## 📋 安全概述

本指南提供了智慧物业管理系统的全面安全配置方案，包括系统安全、数据安全、网络安全等方面的最佳实践和配置建议。

**适用版本**: v2.0.0  
**安全等级**: 中等  
**维护团队**: 湖北省地质局第三地质大队

## 🔒 系统安全

### 操作系统安全

#### 1. 系统更新
```bash
# Ubuntu/Debian系统
sudo apt update && sudo apt upgrade -y

# CentOS/RHEL系统
sudo yum update -y

# 设置自动更新
sudo apt install unattended-upgrades -y
sudo dpkg-reconfigure unattended-upgrades
```

#### 2. 用户权限管理
```bash
# 创建专用用户
sudo useradd -m -s /bin/bash smartuser
sudo usermod -aG sudo smartuser

# 禁用root登录
sudo nano /etc/ssh/sshd_config
# 设置: PermitRootLogin no
# 设置: PasswordAuthentication no

# 重启SSH服务
sudo systemctl restart ssh
```

#### 3. 防火墙配置
```bash
# Ubuntu/Debian
sudo ufw enable
sudo ufw default deny incoming
sudo ufw default allow outgoing
sudo ufw allow ssh
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp

# CentOS/RHEL
sudo firewall-cmd --permanent --add-service=ssh
sudo firewall-cmd --permanent --add-service=http
sudo firewall-cmd --permanent --add-service=https
sudo firewall-cmd --reload
```

### 应用安全

#### 1. Node.js安全配置
```javascript
// helmet.js - 安全头配置
const helmet = require('helmet');

app.use(helmet({
  contentSecurityPolicy: {
    directives: {
      defaultSrc: ["'self'"],
      styleSrc: ["'self'", "'unsafe-inline'"],
      scriptSrc: ["'self'"],
      imgSrc: ["'self'", "data:", "https:"],
    },
  },
  hsts: {
    maxAge: 31536000,
    includeSubDomains: true,
    preload: true
  }
}));
```

#### 2. 输入验证
```javascript
// Joi验证中间件
const Joi = require('joi');

const validateRequest = (schema) => {
  return (req, res, next) => {
    const { error } = schema.validate(req.body);
    if (error) {
      return res.status(400).json({
        success: false,
        message: '请求参数验证失败',
        error: error.details[0].message
      });
    }
    next();
  };
};

// 使用示例
const loginSchema = Joi.object({
  username: Joi.string().alphanum().min(3).max(30).required(),
  password: Joi.string().min(6).required()
});

app.post('/api/auth/login', validateRequest(loginSchema), loginController);
```

#### 3. SQL注入防护
```javascript
// 使用参数化查询
const mysql = require('mysql2/promise');

const connection = await mysql.createConnection({
  host: process.env.DB_HOST,
  user: process.env.DB_USER,
  password: process.env.DB_PASSWORD,
  database: process.env.DB_NAME
});

// 正确的查询方式
const [rows] = await connection.execute(
  'SELECT * FROM users WHERE username = ? AND status = ?',
  [username, 'active']
);

// 错误的查询方式（容易SQL注入）
// const query = `SELECT * FROM users WHERE username = '${username}'`;
```

## 🔐 认证与授权

### JWT Token安全

#### 1. Token配置
```javascript
const jwt = require('jsonwebtoken');

// 安全的JWT配置
const jwtConfig = {
  secret: process.env.JWT_SECRET, // 使用强密钥
  expiresIn: '24h', // 合理的过期时间
  issuer: 'smart-property-system',
  audience: 'smart-property-users'
};

// 生成Token
const generateToken = (user) => {
  return jwt.sign(
    {
      id: user.id,
      username: user.username,
      role: user.role,
      department: user.department
    },
    jwtConfig.secret,
    {
      expiresIn: jwtConfig.expiresIn,
      issuer: jwtConfig.issuer,
      audience: jwtConfig.audience
    }
  );
};
```

#### 2. Token验证中间件
```javascript
const authenticateToken = (req, res, next) => {
  const authHeader = req.headers['authorization'];
  const token = authHeader && authHeader.split(' ')[1];

  if (!token) {
    return res.status(401).json({
      success: false,
      message: '访问令牌缺失'
    });
  }

  jwt.verify(token, process.env.JWT_SECRET, (err, user) => {
    if (err) {
      return res.status(403).json({
        success: false,
        message: '访问令牌无效'
      });
    }
    req.user = user;
    next();
  });
};
```

#### 3. 角色权限控制
```javascript
const requireRole = (roles) => {
  return (req, res, next) => {
    if (!req.user) {
      return res.status(401).json({
        success: false,
        message: '未认证用户'
      });
    }

    if (!roles.includes(req.user.role)) {
      return res.status(403).json({
        success: false,
        message: '权限不足'
      });
    }

    next();
  };
};

// 使用示例
app.get('/api/admin/users', 
  authenticateToken, 
  requireRole(['admin', 'super_admin']), 
  getUsersController
);
```

### 密码安全

#### 1. 密码加密
```javascript
const bcrypt = require('bcrypt');

// 密码加密
const hashPassword = async (password) => {
  const saltRounds = 12; // 较高的盐轮数
  return await bcrypt.hash(password, saltRounds);
};

// 密码验证
const verifyPassword = async (password, hash) => {
  return await bcrypt.compare(password, hash);
};
```

#### 2. 密码策略
```javascript
const passwordPolicy = {
  minLength: 8,
  maxLength: 128,
  requireUppercase: true,
  requireLowercase: true,
  requireNumbers: true,
  requireSpecialChars: true,
  forbiddenPatterns: [
    /password/i,
    /123456/,
    /qwerty/i,
    /admin/i
  ]
};

const validatePassword = (password) => {
  const errors = [];
  
  if (password.length < passwordPolicy.minLength) {
    errors.push('密码长度至少8位');
  }
  
  if (!/[A-Z]/.test(password)) {
    errors.push('密码必须包含大写字母');
  }
  
  if (!/[a-z]/.test(password)) {
    errors.push('密码必须包含小写字母');
  }
  
  if (!/\d/.test(password)) {
    errors.push('密码必须包含数字');
  }
  
  if (!/[!@#$%^&*(),.?":{}|<>]/.test(password)) {
    errors.push('密码必须包含特殊字符');
  }
  
  passwordPolicy.forbiddenPatterns.forEach(pattern => {
    if (pattern.test(password)) {
      errors.push('密码不能包含常见弱密码模式');
    }
  });
  
  return errors;
};
```

## 🛡️ 数据安全

### 数据库安全

#### 1. 数据库连接安全
```javascript
// 安全的数据库配置
const dbConfig = {
  host: process.env.DB_HOST,
  port: process.env.DB_PORT,
  user: process.env.DB_USER,
  password: process.env.DB_PASSWORD,
  database: process.env.DB_NAME,
  ssl: {
    rejectUnauthorized: true,
    ca: fs.readFileSync('path/to/ca-cert.pem')
  },
  connectionLimit: 10,
  acquireTimeout: 60000,
  timeout: 60000,
  reconnect: true
};
```

#### 2. 敏感数据加密
```javascript
const crypto = require('crypto');

// 数据加密
const encryptData = (text, key) => {
  const algorithm = 'aes-256-gcm';
  const iv = crypto.randomBytes(16);
  const cipher = crypto.createCipher(algorithm, key);
  
  let encrypted = cipher.update(text, 'utf8', 'hex');
  encrypted += cipher.final('hex');
  
  const authTag = cipher.getAuthTag();
  
  return {
    encrypted,
    iv: iv.toString('hex'),
    authTag: authTag.toString('hex')
  };
};

// 数据解密
const decryptData = (encryptedData, key) => {
  const algorithm = 'aes-256-gcm';
  const decipher = crypto.createDecipher(algorithm, key);
  
  decipher.setAuthTag(Buffer.from(encryptedData.authTag, 'hex'));
  
  let decrypted = decipher.update(encryptedData.encrypted, 'hex', 'utf8');
  decrypted += decipher.final('utf8');
  
  return decrypted;
};
```

#### 3. 数据备份加密
```bash
#!/bin/bash
# 加密备份脚本

BACKUP_DIR="/opt/backups"
DATE=$(date +%Y%m%d_%H%M%S)
DB_NAME="smart_property"
ENCRYPTION_KEY="your_encryption_key"

# 备份数据库
mysqldump -h localhost -u $DB_USER -p$DB_PASSWORD $DB_NAME > $BACKUP_DIR/db_backup_$DATE.sql

# 加密备份文件
openssl enc -aes-256-cbc -salt -in $BACKUP_DIR/db_backup_$DATE.sql -out $BACKUP_DIR/db_backup_$DATE.sql.enc -k $ENCRYPTION_KEY

# 删除未加密的备份文件
rm $BACKUP_DIR/db_backup_$DATE.sql

echo "加密备份完成: db_backup_$DATE.sql.enc"
```

### 日志安全

#### 1. 敏感信息过滤
```javascript
const sanitizeLogData = (data) => {
  const sensitiveFields = ['password', 'token', 'secret', 'key', 'ssn', 'creditCard'];
  const sanitized = { ...data };
  
  sensitiveFields.forEach(field => {
    if (sanitized[field]) {
      sanitized[field] = '***REDACTED***';
    }
  });
  
  return sanitized;
};

// 使用示例
logger.info('用户登录', sanitizeLogData({
  username: 'john_doe',
  password: 'secret123', // 会被过滤
  ip: '192.168.1.100'
}));
```

#### 2. 日志轮转
```bash
# logrotate配置
sudo nano /etc/logrotate.d/smart-property

# 配置内容
/opt/smart-property/logs/*.log {
    daily
    missingok
    rotate 30
    compress
    delaycompress
    notifempty
    create 644 smartuser smartuser
    postrotate
        pm2 reload smart-property-api
    endscript
}
```

## 🌐 网络安全

### HTTPS配置

#### 1. SSL证书配置
```nginx
server {
    listen 443 ssl http2;
    server_name your-domain.com;

    # SSL证书配置
    ssl_certificate /etc/nginx/ssl/cert.pem;
    ssl_certificate_key /etc/nginx/ssl/key.pem;
    
    # SSL安全配置
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    
    # HSTS
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    
    # 其他安全头
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
}
```

#### 2. 安全头配置
```javascript
// Express安全头中间件
app.use((req, res, next) => {
  // 防止点击劫持
  res.setHeader('X-Frame-Options', 'SAMEORIGIN');
  
  // 防止MIME类型嗅探
  res.setHeader('X-Content-Type-Options', 'nosniff');
  
  // XSS保护
  res.setHeader('X-XSS-Protection', '1; mode=block');
  
  // 引用策略
  res.setHeader('Referrer-Policy', 'strict-origin-when-cross-origin');
  
  // 内容安全策略
  res.setHeader('Content-Security-Policy', 
    "default-src 'self'; " +
    "script-src 'self' 'unsafe-inline'; " +
    "style-src 'self' 'unsafe-inline'; " +
    "img-src 'self' data: https:; " +
    "font-src 'self'; " +
    "connect-src 'self'; " +
    "frame-ancestors 'self';"
  );
  
  next();
});
```

### API安全

#### 1. 请求限制
```javascript
const rateLimit = require('express-rate-limit');

// 通用请求限制
const generalLimiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15分钟
  max: 100, // 限制每个IP 15分钟内最多100个请求
  message: {
    success: false,
    message: '请求过于频繁，请稍后再试'
  }
});

// 登录请求限制
const loginLimiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15分钟
  max: 5, // 限制每个IP 15分钟内最多5次登录尝试
  message: {
    success: false,
    message: '登录尝试过于频繁，请15分钟后再试'
  }
});

app.use('/api/', generalLimiter);
app.use('/api/auth/login', loginLimiter);
```

#### 2. CORS配置
```javascript
const cors = require('cors');

const corsOptions = {
  origin: function (origin, callback) {
    // 允许的域名列表
    const allowedOrigins = [
      'https://your-domain.com',
      'https://www.your-domain.com'
    ];
    
    // 允许无origin的请求（如移动应用）
    if (!origin) return callback(null, true);
    
    if (allowedOrigins.indexOf(origin) !== -1) {
      callback(null, true);
    } else {
      callback(new Error('不允许的CORS请求'));
    }
  },
  credentials: true,
  optionsSuccessStatus: 200
};

app.use(cors(corsOptions));
```

## 🔍 安全监控

### 异常检测

#### 1. 登录异常监控
```javascript
const loginAttempts = new Map();

const monitorLoginAttempts = (req, res, next) => {
  const ip = req.ip;
  const now = Date.now();
  const windowMs = 15 * 60 * 1000; // 15分钟
  
  if (!loginAttempts.has(ip)) {
    loginAttempts.set(ip, []);
  }
  
  const attempts = loginAttempts.get(ip);
  
  // 清理过期的尝试记录
  const validAttempts = attempts.filter(time => now - time < windowMs);
  loginAttempts.set(ip, validAttempts);
  
  // 检查是否超过限制
  if (validAttempts.length >= 10) {
    logger.warn('检测到异常登录尝试', {
      ip,
      attempts: validAttempts.length,
      timestamp: new Date().toISOString()
    });
    
    return res.status(429).json({
      success: false,
      message: '检测到异常登录行为，请稍后再试'
    });
  }
  
  next();
};
```

#### 2. API调用监控
```javascript
const apiCallMonitor = (req, res, next) => {
  const startTime = Date.now();
  
  res.on('finish', () => {
    const duration = Date.now() - startTime;
    const logData = {
      method: req.method,
      url: req.url,
      statusCode: res.statusCode,
      duration: duration,
      ip: req.ip,
      userAgent: req.get('User-Agent'),
      timestamp: new Date().toISOString()
    };
    
    // 记录慢请求
    if (duration > 5000) {
      logger.warn('慢请求检测', logData);
    }
    
    // 记录错误请求
    if (res.statusCode >= 400) {
      logger.error('API错误', logData);
    }
    
    // 记录正常请求
    logger.info('API调用', logData);
  });
  
  next();
};
```

### 安全审计

#### 1. 审计日志
```javascript
const auditLog = (action, details) => {
  const logEntry = {
    timestamp: new Date().toISOString(),
    action: action,
    details: details,
    ip: req.ip,
    userAgent: req.get('User-Agent'),
    userId: req.user ? req.user.id : null
  };
  
  logger.info('安全审计', logEntry);
  
  // 发送到安全监控系统
  sendToSecuritySystem(logEntry);
};
```

#### 2. 敏感操作监控
```javascript
const monitorSensitiveOperations = (req, res, next) => {
  const sensitiveEndpoints = [
    '/api/admin/users',
    '/api/admin/delete',
    '/api/auth/password-reset',
    '/api/dining/batch-confirm'
  ];
  
  if (sensitiveEndpoints.some(endpoint => req.url.includes(endpoint))) {
    auditLog('敏感操作', {
      endpoint: req.url,
      method: req.method,
      body: sanitizeLogData(req.body)
    });
  }
  
  next();
};
```

## 🚨 安全事件响应

### 事件分类

#### 1. 安全事件等级
- **严重**: 系统被入侵、数据泄露
- **高**: 大量异常登录、DDoS攻击
- **中**: 单个用户异常行为、配置错误
- **低**: 一般性安全警告

#### 2. 响应流程
```javascript
const securityIncidentResponse = {
  // 严重事件 - 立即响应
  critical: {
    actions: [
      '立即隔离系统',
      '通知安全团队',
      '启动应急响应',
      '保存证据'
    ],
    timeline: '5分钟内'
  },
  
  // 高等级事件 - 快速响应
  high: {
    actions: [
      '分析威胁',
      '实施防护措施',
      '通知相关人员',
      '记录事件'
    ],
    timeline: '30分钟内'
  },
  
  // 中等级事件 - 标准响应
  medium: {
    actions: [
      '调查事件',
      '修复问题',
      '更新防护规则',
      '定期检查'
    ],
    timeline: '4小时内'
  }
};
```

### 应急响应

#### 1. 系统隔离
```bash
#!/bin/bash
# 应急响应脚本

echo "启动安全应急响应..."

# 停止服务
pm2 stop smart-property-api

# 备份当前状态
cp -r /opt/smart-property /opt/backup/emergency_$(date +%Y%m%d_%H%M%S)

# 检查系统状态
ps aux | grep node
netstat -tlnp | grep :3000

# 通知管理员
echo "系统已隔离，请检查安全状态" | mail -s "安全事件" admin@example.com

echo "应急响应完成"
```

#### 2. 证据收集
```bash
#!/bin/bash
# 证据收集脚本

INCIDENT_DIR="/opt/incident_$(date +%Y%m%d_%H%M%S)"
mkdir -p $INCIDENT_DIR

# 收集日志
cp -r /opt/smart-property/logs $INCIDENT_DIR/
cp -r /var/log/nginx $INCIDENT_DIR/

# 收集系统信息
ps aux > $INCIDENT_DIR/processes.txt
netstat -tlnp > $INCIDENT_DIR/network.txt
lsof -i > $INCIDENT_DIR/connections.txt

# 收集配置信息
cp /etc/nginx/nginx.conf $INCIDENT_DIR/
cp /opt/smart-property/.env $INCIDENT_DIR/

echo "证据收集完成: $INCIDENT_DIR"
```

## 📋 安全检查清单

### 日常检查
- [ ] 系统更新状态检查
- [ ] 安全日志审查
- [ ] 异常登录监控
- [ ] 系统性能监控
- [ ] 备份状态检查

### 周检查
- [ ] 安全漏洞扫描
- [ ] 用户权限审计
- [ ] 配置文件检查
- [ ] 网络连接监控
- [ ] 数据完整性检查

### 月检查
- [ ] 完整安全评估
- [ ] 密码策略检查
- [ ] 访问控制审计
- [ ] 安全培训更新
- [ ] 应急响应演练

## 📞 安全联系

### 安全团队
- **安全负责人**: 安全团队负责人
- **技术负责人**: 技术团队负责人
- **应急联系**: 24小时安全热线

### 外部支持
- **安全厂商**: 安全产品供应商
- **监管机构**: 相关监管部门
- **法律顾问**: 法律事务顾问

---

**文档版本**: v1.0.0  
**创建时间**: 2025年1月  
**维护团队**: 湖北省地质局第三地质大队
