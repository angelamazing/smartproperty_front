# æ™ºæ…§ç‰©ä¸šç®¡ç†ç³»ç»Ÿ - éƒ¨ç½²è¿ç»´æŒ‡å—

## ğŸ“‹ æ–‡æ¡£æ¦‚è¿°

æœ¬æŒ‡å—æä¾›äº†æ™ºæ…§ç‰©ä¸šç®¡ç†ç³»ç»Ÿåç«¯æœåŠ¡çš„å®Œæ•´éƒ¨ç½²å’Œè¿ç»´æ–¹æ¡ˆï¼ŒåŒ…æ‹¬ç¯å¢ƒå‡†å¤‡ã€æœåŠ¡éƒ¨ç½²ã€ç›‘æ§å‘Šè­¦ã€å¤‡ä»½æ¢å¤ç­‰å…³é”®è¿ç»´æ“ä½œã€‚

**é€‚ç”¨ç‰ˆæœ¬**: v2.0.0  
**éƒ¨ç½²ç¯å¢ƒ**: Linux (Ubuntu 20.04+)  
**ç»´æŠ¤å›¢é˜Ÿ**: æ¹–åŒ—çœåœ°è´¨å±€ç¬¬ä¸‰åœ°è´¨å¤§é˜Ÿ

## ğŸ› ï¸ ç¯å¢ƒè¦æ±‚

### ç³»ç»Ÿè¦æ±‚
- **æ“ä½œç³»ç»Ÿ**: Ubuntu 20.04+ / CentOS 8+ / RHEL 8+
- **CPU**: 2æ ¸å¿ƒä»¥ä¸Š
- **å†…å­˜**: 4GBä»¥ä¸Š
- **å­˜å‚¨**: 50GBä»¥ä¸Šå¯ç”¨ç©ºé—´
- **ç½‘ç»œ**: ç¨³å®šçš„ç½‘ç»œè¿æ¥

### è½¯ä»¶ä¾èµ–
- **Node.js**: 16.x æˆ–æ›´é«˜ç‰ˆæœ¬
- **MySQL**: 8.0 æˆ–æ›´é«˜ç‰ˆæœ¬
- **Redis**: 6.0+ (å¯é€‰ï¼Œç”¨äºç¼“å­˜)
- **PM2**: è¿›ç¨‹ç®¡ç†å·¥å…·
- **Nginx**: åå‘ä»£ç†æœåŠ¡å™¨

## ğŸš€ éƒ¨ç½²æ–¹æ¡ˆ

### æ–¹æ¡ˆ1: ä¼ ç»Ÿéƒ¨ç½²

#### 1.1 ç¯å¢ƒå‡†å¤‡
```bash
# æ›´æ–°ç³»ç»ŸåŒ…
sudo apt update && sudo apt upgrade -y

# å®‰è£…Node.js
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs

# å®‰è£…MySQL
sudo apt install mysql-server -y
sudo mysql_secure_installation

# å®‰è£…PM2
sudo npm install -g pm2

# å®‰è£…Nginx
sudo apt install nginx -y
```

#### 1.2 æ•°æ®åº“é…ç½®
```bash
# ç™»å½•MySQL
sudo mysql -u root -p

# åˆ›å»ºæ•°æ®åº“å’Œç”¨æˆ·
CREATE DATABASE smart_property CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER 'smart_user'@'localhost' IDENTIFIED BY 'your_password';
GRANT ALL PRIVILEGES ON smart_property.* TO 'smart_user'@'localhost';
FLUSH PRIVILEGES;
EXIT;
```

#### 1.3 åº”ç”¨éƒ¨ç½²
```bash
# å…‹éš†ä»£ç 
git clone <repository_url> /opt/smart-property
cd /opt/smart-property

# å®‰è£…ä¾èµ–
npm install --production

# é…ç½®ç¯å¢ƒå˜é‡
cp .env.example .env
nano .env
```

#### 1.4 ç¯å¢ƒå˜é‡é…ç½®
```bash
# .env æ–‡ä»¶é…ç½®
NODE_ENV=production
PORT=3000
DB_HOST=localhost
DB_PORT=3306
DB_NAME=smart_property
DB_USER=smart_user
DB_PASSWORD=your_password
JWT_SECRET=your_jwt_secret
REDIS_URL=redis://localhost:6379
```

#### 1.5 å¯åŠ¨æœåŠ¡
```bash
# ä½¿ç”¨PM2å¯åŠ¨
pm2 start ecosystem.config.js

# è®¾ç½®å¼€æœºè‡ªå¯
pm2 startup
pm2 save
```

### æ–¹æ¡ˆ2: Dockeréƒ¨ç½²

#### 2.1 Dockerfile
```dockerfile
FROM node:18-alpine

WORKDIR /app

COPY package*.json ./
RUN npm ci --only=production

COPY . .

EXPOSE 3000

CMD ["npm", "start"]
```

#### 2.2 docker-compose.yml
```yaml
version: '3.8'

services:
  app:
    build: .
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - DB_HOST=mysql
      - DB_NAME=smart_property
      - DB_USER=smart_user
      - DB_PASSWORD=your_password
    depends_on:
      - mysql
      - redis
    restart: unless-stopped

  mysql:
    image: mysql:8.0
    environment:
      - MYSQL_ROOT_PASSWORD=root_password
      - MYSQL_DATABASE=smart_property
      - MYSQL_USER=smart_user
      - MYSQL_PASSWORD=your_password
    volumes:
      - mysql_data:/var/lib/mysql
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    volumes:
      - redis_data:/data
    restart: unless-stopped

  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./ssl:/etc/nginx/ssl
    depends_on:
      - app
    restart: unless-stopped

volumes:
  mysql_data:
  redis_data:
```

#### 2.3 éƒ¨ç½²å‘½ä»¤
```bash
# æ„å»ºå’Œå¯åŠ¨æœåŠ¡
docker-compose up -d

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
docker-compose ps

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f app
```

## ğŸ”§ Nginxé…ç½®

### åå‘ä»£ç†é…ç½®
```nginx
server {
    listen 80;
    server_name your-domain.com;

    # é‡å®šå‘åˆ°HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name your-domain.com;

    # SSLè¯ä¹¦é…ç½®
    ssl_certificate /etc/nginx/ssl/cert.pem;
    ssl_certificate_key /etc/nginx/ssl/key.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512;

    # åå‘ä»£ç†åˆ°Node.jsåº”ç”¨
    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    # é™æ€æ–‡ä»¶ç¼“å­˜
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # å®‰å…¨å¤´
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;
    add_header Content-Security-Policy "default-src 'self' http: https: data: blob: 'unsafe-inline'" always;
}
```

## ğŸ“Š ç›‘æ§å‘Šè­¦

### PM2ç›‘æ§é…ç½®
```javascript
// ecosystem.config.js
module.exports = {
  apps: [{
    name: 'smart-property-api',
    script: 'server.js',
    instances: 'max',
    exec_mode: 'cluster',
    env: {
      NODE_ENV: 'production',
      PORT: 3000
    },
    error_file: './logs/err.log',
    out_file: './logs/out.log',
    log_file: './logs/combined.log',
    time: true,
    max_memory_restart: '1G',
    node_args: '--max-old-space-size=1024'
  }]
};
```

### ç›‘æ§è„šæœ¬
```bash
#!/bin/bash
# monitor.sh

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
check_service() {
    if pm2 list | grep -q "smart-property-api.*online"; then
        echo "âœ… æœåŠ¡è¿è¡Œæ­£å¸¸"
        return 0
    else
        echo "âŒ æœåŠ¡å¼‚å¸¸"
        return 1
    fi
}

# æ£€æŸ¥æ•°æ®åº“è¿æ¥
check_database() {
    mysql -h localhost -u smart_user -p$DB_PASSWORD -e "SELECT 1" smart_property > /dev/null 2>&1
    if [ $? -eq 0 ]; then
        echo "âœ… æ•°æ®åº“è¿æ¥æ­£å¸¸"
        return 0
    else
        echo "âŒ æ•°æ®åº“è¿æ¥å¼‚å¸¸"
        return 1
    fi
}

# æ£€æŸ¥ç£ç›˜ç©ºé—´
check_disk() {
    usage=$(df / | awk 'NR==2 {print $5}' | sed 's/%//')
    if [ $usage -lt 80 ]; then
        echo "âœ… ç£ç›˜ç©ºé—´å……è¶³: ${usage}%"
        return 0
    else
        echo "âš ï¸ ç£ç›˜ç©ºé—´ä¸è¶³: ${usage}%"
        return 1
    fi
}

# æ£€æŸ¥å†…å­˜ä½¿ç”¨
check_memory() {
    usage=$(free | awk 'NR==2{printf "%.0f", $3*100/$2}')
    if [ $usage -lt 80 ]; then
        echo "âœ… å†…å­˜ä½¿ç”¨æ­£å¸¸: ${usage}%"
        return 0
    else
        echo "âš ï¸ å†…å­˜ä½¿ç”¨è¿‡é«˜: ${usage}%"
        return 1
    fi
}

# ä¸»æ£€æŸ¥å‡½æ•°
main() {
    echo "=== ç³»ç»Ÿç›‘æ§æ£€æŸ¥ $(date) ==="
    
    check_service
    check_database
    check_disk
    check_memory
    
    echo "=== æ£€æŸ¥å®Œæˆ ==="
}

main
```

### å‘Šè­¦é…ç½®
```bash
# è®¾ç½®å®šæ—¶æ£€æŸ¥
crontab -e

# æ¯5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
*/5 * * * * /opt/smart-property/scripts/monitor.sh >> /var/log/monitor.log 2>&1

# æ¯å¤©å‡Œæ™¨2ç‚¹å¤‡ä»½æ•°æ®åº“
0 2 * * * /opt/smart-property/scripts/backup.sh >> /var/log/backup.log 2>&1
```

## ğŸ’¾ å¤‡ä»½æ¢å¤

### æ•°æ®åº“å¤‡ä»½è„šæœ¬
```bash
#!/bin/bash
# backup.sh

BACKUP_DIR="/opt/backups"
DATE=$(date +%Y%m%d_%H%M%S)
DB_NAME="smart_property"
DB_USER="smart_user"
DB_PASSWORD="your_password"

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p $BACKUP_DIR

# å¤‡ä»½æ•°æ®åº“
mysqldump -h localhost -u $DB_USER -p$DB_PASSWORD $DB_NAME > $BACKUP_DIR/db_backup_$DATE.sql

# å‹ç¼©å¤‡ä»½æ–‡ä»¶
gzip $BACKUP_DIR/db_backup_$DATE.sql

# åˆ é™¤7å¤©å‰çš„å¤‡ä»½
find $BACKUP_DIR -name "db_backup_*.sql.gz" -mtime +7 -delete

echo "æ•°æ®åº“å¤‡ä»½å®Œæˆ: db_backup_$DATE.sql.gz"
```

### åº”ç”¨å¤‡ä»½è„šæœ¬
```bash
#!/bin/bash
# app_backup.sh

APP_DIR="/opt/smart-property"
BACKUP_DIR="/opt/backups"
DATE=$(date +%Y%m%d_%H%M%S)

# å¤‡ä»½åº”ç”¨ä»£ç 
tar -czf $BACKUP_DIR/app_backup_$DATE.tar.gz -C /opt smart-property

# åˆ é™¤7å¤©å‰çš„å¤‡ä»½
find $BACKUP_DIR -name "app_backup_*.tar.gz" -mtime +7 -delete

echo "åº”ç”¨å¤‡ä»½å®Œæˆ: app_backup_$DATE.tar.gz"
```

### æ¢å¤è„šæœ¬
```bash
#!/bin/bash
# restore.sh

BACKUP_FILE=$1
DB_NAME="smart_property"
DB_USER="smart_user"
DB_PASSWORD="your_password"

if [ -z "$BACKUP_FILE" ]; then
    echo "ä½¿ç”¨æ–¹æ³•: $0 <å¤‡ä»½æ–‡ä»¶è·¯å¾„>"
    exit 1
fi

# æ¢å¤æ•°æ®åº“
if [[ $BACKUP_FILE == *".sql.gz" ]]; then
    gunzip -c $BACKUP_FILE | mysql -h localhost -u $DB_USER -p$DB_PASSWORD $DB_NAME
    echo "æ•°æ®åº“æ¢å¤å®Œæˆ"
elif [[ $BACKUP_FILE == *".tar.gz" ]]; then
    tar -xzf $BACKUP_FILE -C /opt
    echo "åº”ç”¨æ¢å¤å®Œæˆ"
else
    echo "ä¸æ”¯æŒçš„å¤‡ä»½æ–‡ä»¶æ ¼å¼"
    exit 1
fi
```

## ğŸ”’ å®‰å…¨é…ç½®

### é˜²ç«å¢™é…ç½®
```bash
# å®‰è£…ufw
sudo apt install ufw -y

# é»˜è®¤ç­–ç•¥
sudo ufw default deny incoming
sudo ufw default allow outgoing

# å…è®¸SSH
sudo ufw allow ssh

# å…è®¸HTTPå’ŒHTTPS
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp

# å¯ç”¨é˜²ç«å¢™
sudo ufw enable
```

### SSLè¯ä¹¦é…ç½®
```bash
# ä½¿ç”¨Let's Encrypt
sudo apt install certbot python3-certbot-nginx -y

# è·å–è¯ä¹¦
sudo certbot --nginx -d your-domain.com

# è‡ªåŠ¨ç»­æœŸ
sudo crontab -e
# æ·»åŠ : 0 12 * * * /usr/bin/certbot renew --quiet
```

### å®‰å…¨åŠ å›º
```bash
# ç¦ç”¨rootç™»å½•
sudo nano /etc/ssh/sshd_config
# è®¾ç½®: PermitRootLogin no

# æ›´æ”¹SSHç«¯å£
# è®¾ç½®: Port 2222

# é‡å¯SSHæœåŠ¡
sudo systemctl restart ssh
```

## ğŸš¨ æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ

#### 1. æœåŠ¡æ— æ³•å¯åŠ¨
```bash
# æ£€æŸ¥ç«¯å£å ç”¨
sudo netstat -tlnp | grep :3000

# æ£€æŸ¥PM2çŠ¶æ€
pm2 status

# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
pm2 logs smart-property-api --err

# é‡å¯æœåŠ¡
pm2 restart smart-property-api
```

#### 2. æ•°æ®åº“è¿æ¥å¤±è´¥
```bash
# æ£€æŸ¥MySQLæœåŠ¡çŠ¶æ€
sudo systemctl status mysql

# æ£€æŸ¥æ•°æ®åº“è¿æ¥
mysql -h localhost -u smart_user -p smart_property

# æ£€æŸ¥é˜²ç«å¢™
sudo ufw status
```

#### 3. å†…å­˜ä¸è¶³
```bash
# æŸ¥çœ‹å†…å­˜ä½¿ç”¨
free -h

# æŸ¥çœ‹è¿›ç¨‹å†…å­˜ä½¿ç”¨
ps aux --sort=-%mem | head

# é‡å¯æœåŠ¡é‡Šæ”¾å†…å­˜
pm2 restart smart-property-api
```

#### 4. ç£ç›˜ç©ºé—´ä¸è¶³
```bash
# æŸ¥çœ‹ç£ç›˜ä½¿ç”¨
df -h

# æ¸…ç†æ—¥å¿—æ–‡ä»¶
sudo find /var/log -name "*.log" -mtime +30 -delete

# æ¸…ç†PM2æ—¥å¿—
pm2 flush
```

### æ—¥å¿—åˆ†æ
```bash
# æŸ¥çœ‹åº”ç”¨æ—¥å¿—
tail -f /opt/smart-property/logs/combined.log

# æŸ¥çœ‹Nginxæ—¥å¿—
tail -f /var/log/nginx/access.log
tail -f /var/log/nginx/error.log

# æŸ¥çœ‹ç³»ç»Ÿæ—¥å¿—
journalctl -u nginx -f
```

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### æ•°æ®åº“ä¼˜åŒ–
```sql
-- æ·»åŠ ç´¢å¼•
CREATE INDEX idx_dining_orders_user_date ON dining_orders(userId, diningDate);
CREATE INDEX idx_dining_orders_status ON dining_orders(diningStatus);
CREATE INDEX idx_dining_confirmation_logs_order ON dining_confirmation_logs(orderId);

-- ä¼˜åŒ–æŸ¥è¯¢
EXPLAIN SELECT * FROM dining_orders WHERE userId = ? AND diningDate = ?;
```

### åº”ç”¨ä¼˜åŒ–
```javascript
// è¿æ¥æ± é…ç½®
const dbConfig = {
  host: process.env.DB_HOST,
  user: process.env.DB_USER,
  password: process.env.DB_PASSWORD,
  database: process.env.DB_NAME,
  connectionLimit: 10,
  acquireTimeout: 60000,
  timeout: 60000,
  reconnect: true
};
```

### ç¼“å­˜é…ç½®
```javascript
// Redisç¼“å­˜é…ç½®
const redis = require('redis');
const client = redis.createClient({
  host: process.env.REDIS_HOST,
  port: process.env.REDIS_PORT,
  password: process.env.REDIS_PASSWORD,
  retry_strategy: (options) => {
    if (options.error && options.error.code === 'ECONNREFUSED') {
      return new Error('RedisæœåŠ¡å™¨è¿æ¥è¢«æ‹’ç»');
    }
    if (options.total_retry_time > 1000 * 60 * 60) {
      return new Error('é‡è¯•æ—¶é—´å·²ç”¨å®Œ');
    }
    if (options.attempt > 10) {
      return undefined;
    }
    return Math.min(options.attempt * 100, 3000);
  }
});
```

## ğŸ“‹ è¿ç»´æ£€æŸ¥æ¸…å•

### æ—¥å¸¸æ£€æŸ¥
- [ ] æœåŠ¡çŠ¶æ€æ£€æŸ¥
- [ ] æ•°æ®åº“è¿æ¥æ£€æŸ¥
- [ ] ç£ç›˜ç©ºé—´æ£€æŸ¥
- [ ] å†…å­˜ä½¿ç”¨æ£€æŸ¥
- [ ] æ—¥å¿—æ–‡ä»¶æ£€æŸ¥
- [ ] å¤‡ä»½çŠ¶æ€æ£€æŸ¥

### å‘¨æ£€æŸ¥
- [ ] å®‰å…¨æ›´æ–°æ£€æŸ¥
- [ ] æ€§èƒ½æŒ‡æ ‡åˆ†æ
- [ ] é”™è¯¯æ—¥å¿—åˆ†æ
- [ ] ç”¨æˆ·åé¦ˆæ£€æŸ¥
- [ ] å®¹é‡è§„åˆ’è¯„ä¼°

### æœˆæ£€æŸ¥
- [ ] å®Œæ•´ç³»ç»Ÿå¤‡ä»½
- [ ] å®‰å…¨æ¼æ´æ‰«æ
- [ ] æ€§èƒ½åŸºå‡†æµ‹è¯•
- [ ] ç¾éš¾æ¢å¤æ¼”ç»ƒ
- [ ] æ–‡æ¡£æ›´æ–°æ£€æŸ¥

## ğŸ“ è”ç³»æ”¯æŒ

- **æŠ€æœ¯æ”¯æŒ**: æ¹–åŒ—çœåœ°è´¨å±€ç¬¬ä¸‰åœ°è´¨å¤§é˜Ÿ
- **ç´§æ€¥è”ç³»**: 24å°æ—¶æŠ€æœ¯æ”¯æŒçƒ­çº¿
- **æ–‡æ¡£æ›´æ–°**: å®šæœŸæ›´æ–°ç»´æŠ¤

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0.0  
**åˆ›å»ºæ—¶é—´**: 2025å¹´1æœˆ  
**ç»´æŠ¤å›¢é˜Ÿ**: æ¹–åŒ—çœåœ°è´¨å±€ç¬¬ä¸‰åœ°è´¨å¤§é˜Ÿ
