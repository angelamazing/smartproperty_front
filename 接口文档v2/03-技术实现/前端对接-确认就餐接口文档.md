# 前端对接 - 确认就餐接口文档

## 📋 接口概述

本文档专门为前端开发人员提供确认就餐功能的API接口说明，包含完整的请求参数、响应格式、错误处理和使用示例。

**基础路径**: `/api/dining-confirmation`

**认证方式**: 所有接口都需要在请求头中携带JWT Token

## 🔐 认证配置

### 请求头设置
```javascript
const headers = {
  'Authorization': `Bearer ${token}`,
  'Content-Type': 'application/json'
};
```

### Token获取
```javascript
// 登录后获取token
const loginResponse = await fetch('/api/auth/login', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ username, password })
});
const { data: { token } } = await loginResponse.json();
```

## 📱 用户端接口

### 1. 获取用户就餐确认状态

**接口地址**: `GET /api/dining-confirmation/status`

**功能描述**: 获取用户指定日期的就餐确认状态，显示每个餐次的报餐和确认情况

**请求参数**:
```javascript
const params = {
  date: '2024-01-15'  // 可选，格式：YYYY-MM-DD，默认今日
};

const queryString = new URLSearchParams(params).toString();
const response = await fetch(`/api/dining-confirmation/status?${queryString}`, {
  headers: { 'Authorization': `Bearer ${token}` }
});
```

**响应数据结构**:
```javascript
{
  "success": true,
  "message": "获取就餐确认状态成功",
  "data": {
    "userId": "user_id_1",
    "userName": "张三",
    "department": "技术部",
    "queryDate": "2024-01-15",
    "mealConfirmationStatus": {
      "breakfast": {
        "isRegistered": true,           // 是否已报餐
        "orderId": "order_id_1",        // 订单ID
        "status": "confirmed",          // 报餐状态：pending/confirmed/completed/cancelled
        "diningStatus": "dined",        // 就餐状态：ordered/dined/cancelled
        "statusText": "已确认",         // 报餐状态中文
        "confirmationText": "已就餐",   // 就餐状态中文
        "actualDiningTime": "2024-01-15 08:30:00",  // 实际就餐时间
        "registerTime": "2024-01-15 07:00:00",      // 报餐时间
        "remark": "今日早餐"            // 备注
      },
      "lunch": {
        "isRegistered": true,
        "orderId": "order_id_2",
        "status": "confirmed",
        "diningStatus": "ordered",      // 已报餐但未确认就餐
        "statusText": "已确认",
        "confirmationText": "已报餐",
        "actualDiningTime": null,       // 未确认就餐，时间为空
        "registerTime": "2024-01-15 10:00:00",
        "remark": "今日午餐"
      },
      "dinner": {
        "isRegistered": false,           // 未报餐
        "orderId": null,
        "status": null,
        "diningStatus": null,
        "statusText": "未报餐",
        "confirmationText": "未确认",
        "actualDiningTime": null,
        "registerTime": null,
        "remark": null
      }
    },
    "summary": {
      "totalRegistered": 2,             // 总报餐数
      "totalConfirmed": 1,             // 总确认就餐数
      "pendingConfirmation": 1,         // 待确认就餐数
      "unregisteredCount": 1           // 未报餐数
    }
  }
}
```

**前端使用示例**:
```javascript
// Vue.js 示例
async fetchDiningStatus(date = null) {
  try {
    const params = date ? { date } : {};
    const queryString = new URLSearchParams(params).toString();
    
    const response = await fetch(`/api/dining-confirmation/status?${queryString}`, {
      headers: { 'Authorization': `Bearer ${this.token}` }
    });
    
    const result = await response.json();
    
    if (result.success) {
      this.diningStatus = result.data;
      this.updateMealStatusDisplay();
    } else {
      this.showError(result.message);
    }
  } catch (error) {
    this.showError('获取就餐状态失败');
  }
}

// 更新餐次状态显示
updateMealStatusDisplay() {
  const meals = ['breakfast', 'lunch', 'dinner'];
  meals.forEach(mealType => {
    const status = this.diningStatus.mealConfirmationStatus[mealType];
    this.updateMealCard(mealType, status);
  });
}
```

---

### 2. 用户手动确认就餐

**接口地址**: `POST /api/dining-confirmation/manual/:orderId`

**功能描述**: 用户自己确认已就餐

**请求参数**:
```javascript
const orderId = 'order_id_1';
const response = await fetch(`/api/dining-confirmation/manual/${orderId}`, {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${token}`,
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    confirmationType: 'manual'  // 可选，默认为manual
  })
});
```

**响应数据结构**:
```javascript
{
  "success": true,
  "message": "确认就餐成功",
  "data": {
    "orderId": "order_id_1",
    "confirmationType": "manual",
    "actualDiningTime": "2024-01-15 12:30:00",
    "message": "确认就餐成功"
  }
}
```

**前端使用示例**:
```javascript
// 确认就餐按钮点击事件
async confirmDining(orderId) {
  try {
    // 显示确认对话框
    const confirmed = await this.showConfirmDialog('确认已就餐？');
    if (!confirmed) return;

    // 显示加载状态
    this.showLoading('正在确认就餐...');

    const response = await fetch(`/api/dining-confirmation/manual/${orderId}`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${this.token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        confirmationType: 'manual'
      })
    });

    const result = await response.json();
    
    if (result.success) {
      this.showSuccess('确认就餐成功！');
      // 刷新状态
      await this.fetchDiningStatus();
    } else {
      this.showError(result.message);
    }
  } catch (error) {
    this.showError('确认就餐失败');
  } finally {
    this.hideLoading();
  }
}
```

---

### 3. 获取就餐确认历史记录

**接口地址**: `GET /api/dining-confirmation/history`

**功能描述**: 获取用户的就餐确认历史记录

**请求参数**:
```javascript
const params = {
  date: '2024-01-15',           // 单日查询
  startDate: '2024-01-01',      // 开始日期
  endDate: '2024-01-31',        // 结束日期
  diningStatus: 'dined',        // 就餐状态：ordered/dined/cancelled
  page: 1,                      // 页码
  pageSize: 20                  // 每页大小
};

const queryString = new URLSearchParams(params).toString();
const response = await fetch(`/api/dining-confirmation/history?${queryString}`, {
  headers: { 'Authorization': `Bearer ${token}` }
});
```

**响应数据结构**:
```javascript
{
  "success": true,
  "message": "获取就餐确认历史成功",
  "data": {
    "records": [
      {
        "orderId": "order_id_1",
        "diningDate": "2024-01-15",
        "mealType": "breakfast",
        "mealTypeName": "早餐",
        "status": "confirmed",
        "diningStatus": "dined",
        "statusText": "已确认",
        "confirmationText": "已就餐",
        "actualDiningTime": "2024-01-15 08:30:00",
        "registerTime": "2024-01-15 07:00:00",
        "remark": "今日早餐",
        "confirmationType": "manual",
        "confirmationTime": "2024-01-15 08:30:00",
        "confirmedBy": null
      }
    ],
    "total": 1,
    "page": 1,
    "pageSize": 20,
    "hasMore": false
  }
}
```

**前端使用示例**:
```javascript
// 获取历史记录
async fetchDiningHistory(filters = {}) {
  try {
    const params = {
      page: this.currentPage,
      pageSize: this.pageSize,
      ...filters
    };
    
    const queryString = new URLSearchParams(params).toString();
    const response = await fetch(`/api/dining-confirmation/history?${queryString}`, {
      headers: { 'Authorization': `Bearer ${this.token}` }
    });
    
    const result = await response.json();
    
    if (result.success) {
      this.historyRecords = result.data.records;
      this.totalRecords = result.data.total;
      this.hasMore = result.data.hasMore;
    } else {
      this.showError(result.message);
    }
  } catch (error) {
    this.showError('获取历史记录失败');
  }
}
```

## 👨‍💼 管理员端接口

### 4. 管理员代确认就餐

**接口地址**: `POST /api/dining-confirmation/admin/:orderId`

**功能描述**: 管理员代为确认用户已就餐

**权限要求**: 部门管理员、系统管理员、验证员

**请求参数**:
```javascript
const orderId = 'order_id_1';
const response = await fetch(`/api/dining-confirmation/admin/${orderId}`, {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${adminToken}`,
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    remark: '管理员代确认就餐'  // 可选
  })
});
```

**响应数据结构**:
```javascript
{
  "success": true,
  "message": "管理员代确认就餐成功",
  "data": {
    "orderId": "order_id_1",
    "confirmationType": "admin",
    "actualDiningTime": "2024-01-15 12:30:00",
    "confirmedBy": "admin_id",
    "message": "管理员代确认就餐成功"
  }
}
```

---

### 5. 批量确认就餐

**接口地址**: `POST /api/dining-confirmation/batch`

**功能描述**: 管理员批量确认多个订单的就餐状态

**权限要求**: 部门管理员、系统管理员、验证员

**请求参数**:
```javascript
const response = await fetch('/api/dining-confirmation/batch', {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${adminToken}`,
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    orderIds: ['order_id_1', 'order_id_2', 'order_id_3'],
    remark: '批量确认就餐'  // 可选
  })
});
```

**响应数据结构**:
```javascript
{
  "success": true,
  "message": "批量确认完成，成功 2 个",
  "data": {
    "successCount": 2,
    "totalCount": 3,
    "errors": [
      {
        "orderId": "order_id_3",
        "error": "该订单已确认就餐"
      }
    ]
  }
}
```

**前端使用示例**:
```javascript
// 批量确认就餐
async batchConfirmDining(selectedOrders) {
  try {
    const confirmed = await this.showConfirmDialog(
      `确认批量确认 ${selectedOrders.length} 个订单的就餐状态？`
    );
    if (!confirmed) return;

    this.showLoading('正在批量确认...');

    const response = await fetch('/api/dining-confirmation/batch', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${this.adminToken}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        orderIds: selectedOrders.map(order => order.orderId),
        remark: '批量确认就餐'
      })
    });

    const result = await response.json();
    
    if (result.success) {
      const { successCount, totalCount, errors } = result.data;
      this.showSuccess(`批量确认完成，成功 ${successCount}/${totalCount} 个`);
      
      if (errors.length > 0) {
        this.showErrors(errors);
      }
      
      // 刷新列表
      await this.fetchPendingOrders();
    } else {
      this.showError(result.message);
    }
  } catch (error) {
    this.showError('批量确认失败');
  } finally {
    this.hideLoading();
  }
}
```

---

### 6. 获取待确认就餐列表

**接口地址**: `GET /api/dining-confirmation/pending`

**功能描述**: 获取待确认就餐的订单列表

**权限要求**: 部门管理员、系统管理员、验证员

**请求参数**:
```javascript
const params = {
  date: '2024-01-15',           // 查询日期，默认今日
  departmentId: 'dept_id_1',    // 部门ID，可选
  mealType: 'lunch',            // 餐次类型：breakfast/lunch/dinner，可选
  page: 1,                      // 页码
  pageSize: 20                  // 每页大小
};

const queryString = new URLSearchParams(params).toString();
const response = await fetch(`/api/dining-confirmation/pending?${queryString}`, {
  headers: { 'Authorization': `Bearer ${adminToken}` }
});
```

**响应数据结构**:
```javascript
{
  "success": true,
  "message": "获取待确认就餐列表成功",
  "data": {
    "records": [
      {
        "orderId": "order_id_1",
        "deptName": "技术部",
        "userId": "user_id_1",
        "userName": "张三",
        "mealType": "lunch",
        "mealTypeName": "午餐",
        "diningDate": "2024-01-15",
        "registerTime": "2024-01-15 10:00:00",
        "remark": "今日午餐",
        "currentUserDept": "技术部"
      }
    ],
    "total": 1,
    "page": 1,
    "pageSize": 20,
    "hasMore": false
  }
}
```

---

### 7. 获取部门就餐确认统计

**接口地址**: `GET /api/dining-confirmation/stats`

**功能描述**: 获取部门就餐确认统计数据

**权限要求**: 部门管理员、系统管理员、验证员

**请求参数**:
```javascript
const params = {
  date: '2024-01-15',           // 查询日期，默认今日
  departmentId: 'dept_id_1'     // 部门ID，可选
};

const queryString = new URLSearchParams(params).toString();
const response = await fetch(`/api/dining-confirmation/stats?${queryString}`, {
  headers: { 'Authorization': `Bearer ${adminToken}` }
});
```

**响应数据结构**:
```javascript
{
  "success": true,
  "message": "获取部门就餐确认统计成功",
  "data": {
    "queryDate": "2024-01-15",
    "totalStats": {
      "totalOrders": 156,
      "pendingConfirmation": 45,
      "confirmedDining": 98,
      "cancelledOrders": 13
    },
    "mealStats": [
      {
        "mealType": "breakfast",
        "mealTypeName": "早餐",
        "totalOrders": 45,
        "pendingConfirmation": 12,
        "confirmedDining": 30,
        "cancelledOrders": 3
      },
      {
        "mealType": "lunch",
        "mealTypeName": "午餐",
        "totalOrders": 78,
        "pendingConfirmation": 25,
        "confirmedDining": 48,
        "cancelledOrders": 5
      },
      {
        "mealType": "dinner",
        "mealTypeName": "晚餐",
        "totalOrders": 33,
        "pendingConfirmation": 8,
        "confirmedDining": 20,
        "cancelledOrders": 5
      }
    ],
    "departmentStats": [
      {
        "deptName": "技术部",
        "totalOrders": 89,
        "pendingConfirmation": 25,
        "confirmedDining": 58,
        "cancelledOrders": 6
      },
      {
        "deptName": "人事部",
        "totalOrders": 45,
        "pendingConfirmation": 12,
        "confirmedDining": 28,
        "cancelledOrders": 5
      }
    ]
  }
}
```

## 🎨 前端UI组件建议

### 1. 用户端组件

#### 就餐状态卡片
```vue
<template>
  <div class="dining-status-card">
    <div class="meal-card" v-for="meal in meals" :key="meal.type">
      <div class="meal-header">
        <h3>{{ meal.name }}</h3>
        <span class="status-badge" :class="getStatusClass(meal.status)">
          {{ meal.statusText }}
        </span>
      </div>
      
      <div class="meal-info">
        <p v-if="meal.isRegistered">
          报餐时间: {{ formatTime(meal.registerTime) }}
        </p>
        <p v-if="meal.diningStatus === 'dined'">
          就餐时间: {{ formatTime(meal.actualDiningTime) }}
        </p>
      </div>
      
      <div class="meal-actions">
        <button 
          v-if="meal.isRegistered && meal.diningStatus === 'ordered'"
          @click="confirmDining(meal.orderId)"
          class="confirm-btn"
        >
          确认就餐
        </button>
        <span v-else-if="meal.diningStatus === 'dined'" class="confirmed-text">
          已确认就餐
        </span>
      </div>
    </div>
  </div>
</template>
```

#### 确认就餐按钮
```vue
<template>
  <button 
    @click="handleConfirmDining"
    :disabled="loading"
    class="confirm-dining-btn"
  >
    <span v-if="loading">确认中...</span>
    <span v-else>确认就餐</span>
  </button>
</template>

<script>
export default {
  methods: {
    async handleConfirmDining() {
      const confirmed = await this.$confirm('确认已就餐？', '提示', {
        confirmButtonText: '确认',
        cancelButtonText: '取消',
        type: 'warning'
      });
      
      if (confirmed) {
        await this.confirmDining(this.orderId);
      }
    }
  }
}
</script>
```

### 2. 管理员端组件

#### 待确认列表
```vue
<template>
  <div class="pending-confirmations">
    <div class="list-header">
      <h3>待确认就餐列表</h3>
      <div class="actions">
        <button @click="batchConfirm" :disabled="selectedOrders.length === 0">
          批量确认 ({{ selectedOrders.length }})
        </button>
      </div>
    </div>
    
    <el-table 
      :data="pendingOrders" 
      @selection-change="handleSelectionChange"
    >
      <el-table-column type="selection" width="55"></el-table-column>
      <el-table-column prop="userName" label="用户姓名"></el-table-column>
      <el-table-column prop="deptName" label="部门"></el-table-column>
      <el-table-column prop="mealTypeName" label="餐次"></el-table-column>
      <el-table-column prop="diningDate" label="就餐日期"></el-table-column>
      <el-table-column prop="registerTime" label="报餐时间"></el-table-column>
      <el-table-column label="操作">
        <template #default="scope">
          <el-button 
            size="small" 
            @click="confirmSingle(scope.row)"
          >
            确认就餐
          </el-button>
        </template>
      </el-table-column>
    </el-table>
  </div>
</template>
```

#### 统计图表
```vue
<template>
  <div class="dining-stats">
    <div class="stats-overview">
      <div class="stat-card">
        <h4>总报餐数</h4>
        <span class="stat-number">{{ stats.totalStats.totalOrders }}</span>
      </div>
      <div class="stat-card">
        <h4>待确认</h4>
        <span class="stat-number pending">{{ stats.totalStats.pendingConfirmation }}</span>
      </div>
      <div class="stat-card">
        <h4>已确认</h4>
        <span class="stat-number confirmed">{{ stats.totalStats.confirmedDining }}</span>
      </div>
    </div>
    
    <div class="meal-stats-chart">
      <h4>各餐次统计</h4>
      <div class="chart-container">
        <!-- 这里可以集成图表库，如 ECharts -->
      </div>
    </div>
  </div>
</template>
```

## 🚨 错误处理

### 常见错误码
```javascript
const errorCodes = {
  400: '请求参数错误',
  401: '未授权，请重新登录',
  403: '权限不足',
  404: '资源不存在',
  409: '业务冲突（如重复确认）',
  500: '服务器内部错误'
};
```

### 错误处理示例
```javascript
async handleApiCall(apiFunction) {
  try {
    const result = await apiFunction();
    return result;
  } catch (error) {
    if (error.response) {
      const { status, data } = error.response;
      switch (status) {
        case 401:
          this.$router.push('/login');
          break;
        case 403:
          this.showError('权限不足');
          break;
        case 409:
          this.showError(data.message || '操作冲突');
          break;
        default:
          this.showError(data.message || '操作失败');
      }
    } else {
      this.showError('网络错误，请稍后重试');
    }
  }
}
```

## 📱 移动端适配

### 响应式设计
```css
/* 移动端适配 */
@media (max-width: 768px) {
  .dining-status-card {
    padding: 10px;
  }
  
  .meal-card {
    margin-bottom: 15px;
    padding: 15px;
  }
  
  .confirm-btn {
    width: 100%;
    padding: 12px;
    font-size: 16px;
  }
}
```

### 触摸优化
```javascript
// 防止重复点击
let isConfirming = false;

async confirmDining(orderId) {
  if (isConfirming) return;
  
  isConfirming = true;
  try {
    await this.performConfirmDining(orderId);
  } finally {
    isConfirming = false;
  }
}
```

## 🔄 状态管理建议

### Vuex Store 示例
```javascript
// store/modules/diningConfirmation.js
export default {
  namespaced: true,
  state: {
    diningStatus: null,
    historyRecords: [],
    pendingOrders: [],
    stats: null
  },
  
  mutations: {
    SET_DINING_STATUS(state, status) {
      state.diningStatus = status;
    },
    UPDATE_MEAL_STATUS(state, { mealType, status }) {
      if (state.diningStatus) {
        state.diningStatus.mealConfirmationStatus[mealType] = status;
      }
    }
  },
  
  actions: {
    async fetchDiningStatus({ commit }, date) {
      const response = await api.getDiningStatus(date);
      commit('SET_DINING_STATUS', response.data);
      return response.data;
    },
    
    async confirmDining({ commit, dispatch }, orderId) {
      const response = await api.confirmDining(orderId);
      // 刷新状态
      await dispatch('fetchDiningStatus');
      return response.data;
    }
  }
};
```

## 📋 测试用例

### 用户端测试
```javascript
// 测试用例示例
describe('确认就餐功能', () => {
  test('获取就餐状态', async () => {
    const response = await fetchDiningStatus();
    expect(response.success).toBe(true);
    expect(response.data.mealConfirmationStatus).toBeDefined();
  });
  
  test('确认就餐', async () => {
    const response = await confirmDining('test_order_id');
    expect(response.success).toBe(true);
    expect(response.data.confirmationType).toBe('manual');
  });
});
```

---

**文档版本**: v1.0.0  
**创建时间**: 2025年1月  
**适用框架**: Vue.js 3.x, React, Angular  
**维护团队**: 湖北省地质局第三地质大队
