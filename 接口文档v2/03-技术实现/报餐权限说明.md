# 报餐权限说明文档

## 📋 权限概述

智慧物业管理系统实施了严格的报餐权限控制，确保只有具备相应权限的用户才能进行报餐操作。

**权限等级**: 部门管理员及以上  
**实施范围**: 所有报餐相关接口  
**安全级别**: 高

## 🔐 权限设置详情

### 1. 报餐权限要求

#### 允许报餐的角色
- **部门管理员** (`dept_admin`): 可以为本部门成员报餐
- **系统管理员** (`sys_admin`): 可以为任何部门成员报餐

#### 禁止报餐的角色
- **普通用户** (`user`): 无法进行任何报餐操作
- **其他角色**: 未明确授权的角色无法报餐

### 2. 权限验证机制

#### 路由层权限控制
```javascript
// 部门报餐接口 - 需要部门管理员权限
router.post('/department-order',
  deptAdminAuth,  // 部门管理员权限中间件
  validateRequest(schemas.diningEnhanced.createDepartmentOrder),
  diningControllerEnhanced.createDepartmentOrder
);

// 传统报餐接口 - 需要部门管理员权限
router.post('/dept-order',
  authenticateToken,
  requireDeptAdmin,  // 部门管理员权限验证
  validate(schemas.dining.submitDeptOrder),
  diningController.submitDeptOrder
);
```

#### 中间件实现
```javascript
// 部门管理员权限中间件
const deptAdminMiddleware = (req, res, next) => {
  const userRole = req.user.role;
  const allowedRoles = ['dept_admin', 'sys_admin'];
  
  if (!allowedRoles.includes(userRole)) {
    return res.status(403).json({
      success: false,
      message: '需要部门管理员权限',
      error: 'FORBIDDEN',
      requiredRoles: allowedRoles,
      currentRole: userRole
    });
  }
  
  next();
};
```

#### 服务层权限验证
```javascript
// 验证管理员权限（部门管理员或系统管理员）
const [adminRows] = await connection.execute(`
  SELECT u._id, u.role, u.departmentId, d.name as departmentName
  FROM users u
  LEFT JOIN departments d ON u.departmentId = d._id
  WHERE u._id = ? AND u.role IN ('dept_admin', 'sys_admin') AND u.status = 'active'
`, [adminUserId]);

if (adminRows.length === 0) {
  throw new Error('权限不足，需要部门管理员及以上权限才能为部门成员报餐');
}
```

## 🚫 权限限制说明

### 1. 普通用户限制

#### 无法执行的操作
- ❌ 为他人报餐
- ❌ 为自己报餐（需要通过部门管理员）
- ❌ 查看其他部门的报餐记录
- ❌ 修改报餐信息

#### 可以执行的操作
- ✅ 查看个人报餐状态
- ✅ 确认自己的就餐
- ✅ 查看个人就餐历史

### 2. 部门管理员限制

#### 权限范围
- ✅ 为本部门成员报餐
- ✅ 查看本部门报餐记录
- ✅ 管理本部门报餐状态
- ❌ 为其他部门成员报餐（除非是系统管理员）

#### 业务验证
```javascript
// 验证所有成员都属于同一部门
const departmentIds = [...new Set(memberRows.map(m => m.departmentId))];
if (departmentIds.length > 1 || departmentIds[0] !== registrant.departmentId) {
  throw new Error('只能为同部门成员报餐');
}
```

## 🔧 技术实现细节

### 1. 权限检查流程

```
用户请求报餐接口
   ↓
JWT Token验证
   ↓
角色权限检查 (dept_admin/sys_admin)
   ↓
部门权限验证 (只能为本部门成员报餐)
   ↓
业务逻辑验证 (成员存在性、重复报餐检查)
   ↓
执行报餐操作
```

### 2. 错误处理

#### 权限不足错误
```javascript
{
  "success": false,
  "message": "需要部门管理员权限",
  "error": "FORBIDDEN",
  "requiredRoles": ["dept_admin", "sys_admin"],
  "currentRole": "user"
}
```

#### 部门权限错误
```javascript
{
  "success": false,
  "message": "只能为同部门成员报餐",
  "error": "DEPARTMENT_MISMATCH"
}
```

### 3. 数据库权限设计

#### 用户角色表
```sql
-- 用户角色枚举
CREATE TABLE users (
  _id VARCHAR(36) PRIMARY KEY,
  role ENUM('user', 'dept_admin', 'sys_admin') NOT NULL,
  departmentId VARCHAR(36),
  status ENUM('active', 'inactive') DEFAULT 'active'
);
```

#### 报餐记录表
```sql
-- 报餐记录包含报餐人信息
CREATE TABLE dining_orders (
  _id VARCHAR(36) PRIMARY KEY,
  registrantId VARCHAR(36) NOT NULL,  -- 报餐人ID
  registrantName VARCHAR(100) NOT NULL,  -- 报餐人姓名
  memberIds JSON NOT NULL,  -- 被报餐成员ID列表
  diningDate DATE NOT NULL,
  mealType ENUM('breakfast', 'lunch', 'dinner') NOT NULL,
  status ENUM('pending', 'confirmed', 'cancelled') DEFAULT 'pending',
  createTime TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

## 📊 权限矩阵

| 操作 | 普通用户 | 部门管理员 | 系统管理员 |
|------|---------|-----------|-----------|
| 为自己报餐 | ❌ | ✅ | ✅ |
| 为部门成员报餐 | ❌ | ✅ | ✅ |
| 为其他部门报餐 | ❌ | ❌ | ✅ |
| 查看个人状态 | ✅ | ✅ | ✅ |
| 查看部门记录 | ❌ | ✅ | ✅ |
| 查看所有记录 | ❌ | ❌ | ✅ |
| 确认就餐 | ✅ | ✅ | ✅ |
| 管理员代确认 | ❌ | ✅ | ✅ |

## 🚨 安全考虑

### 1. 权限验证层级
- **路由层**: 使用中间件进行基础权限检查
- **控制器层**: 验证请求参数和用户身份
- **服务层**: 进行详细的业务权限验证
- **数据库层**: 通过外键约束确保数据完整性

### 2. 审计日志
```javascript
// 记录权限相关操作
logger.info('报餐权限检查', {
  userId: req.user.id,
  userRole: req.user.role,
  action: 'createDepartmentOrder',
  targetDepartment: departmentId,
  timestamp: new Date().toISOString()
});
```

### 3. 异常监控
- 监控权限拒绝的请求
- 记录异常权限访问尝试
- 定期审计权限使用情况

## 📝 使用指南

### 1. 部门管理员操作流程

#### 为部门成员报餐
1. **登录系统**: 使用部门管理员账号登录
2. **选择成员**: 选择要报餐的部门成员
3. **填写信息**: 选择日期、餐次等信息
4. **提交报餐**: 系统验证权限后执行报餐

#### 权限验证失败处理
- 检查用户角色是否为 `dept_admin` 或 `sys_admin`
- 确认用户状态为 `active`
- 验证目标成员是否属于同一部门

### 2. 普通用户操作流程

#### 查看报餐状态
1. **登录系统**: 使用普通用户账号登录
2. **查看状态**: 在个人中心查看报餐状态
3. **确认就餐**: 在就餐时间确认就餐

#### 无法报餐的处理
- 联系部门管理员代为报餐
- 确认部门管理员已为自己报餐
- 在就餐时间进行确认就餐

## 🔮 扩展建议

### 1. 权限细化
- 支持更细粒度的权限控制
- 支持临时权限授权
- 支持权限继承机制

### 2. 审计增强
- 详细的权限操作日志
- 权限使用统计分析
- 异常权限访问告警

### 3. 用户体验优化
- 清晰的权限提示信息
- 权限不足时的引导流程
- 权限申请和审批流程

---

**文档版本**: v1.0.0  
**创建时间**: 2025年1月  
**维护团队**: 湖北省地质局第三地质大队
