# 确认就餐接口文档

## 📋 接口概述

确认就餐接口提供报餐后的确认就餐功能，支持用户手动确认、管理员代确认、扫码确认等多种确认方式。通过确认就餐功能，系统可以准确记录用户的实际就餐情况，为餐厅管理提供数据支持。

**基础路径**: `/api/dining-confirmation`

**认证要求**: 所有接口都需要有效的JWT Token

## 🎯 业务流程

### 优化后的就餐确认流程

```
1. 用户报餐 (diningStatus: 'ordered')
   ↓
2. 管理员确认报餐 (可选步骤)
   ↓  
3. 用户确认就餐 (多种方式)
   - 方式A: 扫码确认 (diningStatus: 'dined', actualDiningTime: 扫码时间)
   - 方式B: 手动确认 (diningStatus: 'dined', actualDiningTime: 确认时间)
   - 方式C: 管理员代确认 (diningStatus: 'dined', actualDiningTime: 代确认时间)
   ↓
4. 完成就餐流程
```

### 确认类型说明

- **manual**: 用户手动确认就餐
- **qr**: 通过扫码确认就餐
- **admin**: 管理员代为确认就餐

## 🔐 接口列表

### 1. 用户手动确认就餐

**接口地址**: `POST /api/dining-confirmation/manual/:orderId`

**接口描述**: 用户自己确认已就餐

**请求头**:
```http
Authorization: Bearer {token}
Content-Type: application/json
```

**路径参数**:
```
orderId: string  // 订单ID
```

**请求参数**:
```json
{
  "confirmationType": "manual"  // 确认类型，可选，默认为manual
}
```

**响应示例**:
```json
{
  "success": true,
  "message": "确认就餐成功",
  "data": {
    "orderId": "order_id_1",
    "confirmationType": "manual",
    "actualDiningTime": "2024-01-15 12:30:00",
    "message": "确认就餐成功"
  }
}
```

**错误响应**:
```json
{
  "success": false,
  "message": "订单不存在或无权操作",
  "error": "NOT_FOUND"
}
```

---

### 2. 管理员代确认就餐

**接口地址**: `POST /api/dining-confirmation/admin/:orderId`

**接口描述**: 管理员代为确认用户已就餐（需要管理员权限）

**权限要求**: 部门管理员、系统管理员、验证员

**请求头**:
```http
Authorization: Bearer {token}
Content-Type: application/json
```

**路径参数**:
```
orderId: string  // 订单ID
```

**请求参数**:
```json
{
  "remark": "管理员代确认就餐"  // 备注信息，可选
}
```

**响应示例**:
```json
{
  "success": true,
  "message": "管理员代确认就餐成功",
  "data": {
    "orderId": "order_id_1",
    "confirmationType": "admin",
    "actualDiningTime": "2024-01-15 12:30:00",
    "confirmedBy": "admin_id",
    "message": "管理员代确认就餐成功"
  }
}
```

---

### 3. 批量确认就餐

**接口地址**: `POST /api/dining-confirmation/batch`

**接口描述**: 管理员批量确认多个订单的就餐状态（需要管理员权限）

**权限要求**: 部门管理员、系统管理员、验证员

**请求头**:
```http
Authorization: Bearer {token}
Content-Type: application/json
```

**请求参数**:
```json
{
  "orderIds": ["order_id_1", "order_id_2", "order_id_3"],  // 订单ID数组
  "remark": "批量确认就餐"  // 备注信息，可选
}
```

**响应示例**:
```json
{
  "success": true,
  "message": "批量确认完成，成功 2 个",
  "data": {
    "successCount": 2,
    "totalCount": 3,
    "errors": [
      {
        "orderId": "order_id_3",
        "error": "该订单已确认就餐"
      }
    ]
  }
}
```

---

### 4. 获取用户就餐确认状态

**接口地址**: `GET /api/dining-confirmation/status`

**接口描述**: 获取用户指定日期的就餐确认状态

**请求头**:
```http
Authorization: Bearer {token}
```

**查询参数**:
```
date: string  // 查询日期，格式：YYYY-MM-DD，默认今日
```

**响应示例**:
```json
{
  "success": true,
  "message": "获取就餐确认状态成功",
  "data": {
    "userId": "user_id_1",
    "userName": "张三",
    "department": "技术部",
    "queryDate": "2024-01-15",
    "mealConfirmationStatus": {
      "breakfast": {
        "isRegistered": true,
        "orderId": "order_id_1",
        "status": "confirmed",
        "diningStatus": "dined",
        "statusText": "已确认",
        "confirmationText": "已就餐",
        "actualDiningTime": "2024-01-15 08:30:00",
        "registerTime": "2024-01-15 07:00:00",
        "remark": "今日早餐"
      },
      "lunch": {
        "isRegistered": true,
        "orderId": "order_id_2",
        "status": "confirmed",
        "diningStatus": "ordered",
        "statusText": "已确认",
        "confirmationText": "已报餐",
        "actualDiningTime": null,
        "registerTime": "2024-01-15 10:00:00",
        "remark": "今日午餐"
      },
      "dinner": {
        "isRegistered": false,
        "orderId": null,
        "status": null,
        "diningStatus": null,
        "statusText": "未报餐",
        "confirmationText": "未确认",
        "actualDiningTime": null,
        "registerTime": null,
        "remark": null
      }
    },
    "summary": {
      "totalRegistered": 2,
      "totalConfirmed": 1,
      "pendingConfirmation": 1,
      "unregisteredCount": 1
    }
  }
}
```

---

### 5. 获取就餐确认历史记录

**接口地址**: `GET /api/dining-confirmation/history`

**接口描述**: 获取用户的就餐确认历史记录

**请求头**:
```http
Authorization: Bearer {token}
```

**查询参数**:
```
date: string          // 单日查询，格式：YYYY-MM-DD
startDate: string     // 开始日期，格式：YYYY-MM-DD
endDate: string       // 结束日期，格式：YYYY-MM-DD
diningStatus: string  // 就餐状态：ordered/dined/cancelled
page: number         // 页码，默认1
pageSize: number     // 每页大小，默认20
```

**响应示例**:
```json
{
  "success": true,
  "message": "获取就餐确认历史成功",
  "data": {
    "records": [
      {
        "orderId": "order_id_1",
        "diningDate": "2024-01-15",
        "mealType": "breakfast",
        "mealTypeName": "早餐",
        "status": "confirmed",
        "diningStatus": "dined",
        "statusText": "已确认",
        "confirmationText": "已就餐",
        "actualDiningTime": "2024-01-15 08:30:00",
        "registerTime": "2024-01-15 07:00:00",
        "remark": "今日早餐",
        "confirmationType": "manual",
        "confirmationTime": "2024-01-15 08:30:00",
        "confirmedBy": null
      }
    ],
    "total": 1,
    "page": 1,
    "pageSize": 20,
    "hasMore": false
  }
}
```

---

### 6. 获取待确认就餐列表（管理员功能）

**接口地址**: `GET /api/dining-confirmation/pending`

**接口描述**: 获取待确认就餐的订单列表（管理员功能）

**权限要求**: 部门管理员、系统管理员、验证员

**请求头**:
```http
Authorization: Bearer {token}
```

**查询参数**:
```
date: string         // 查询日期，格式：YYYY-MM-DD，默认今日
departmentId: string // 部门ID，可选
mealType: string     // 餐次类型：breakfast/lunch/dinner，可选
page: number        // 页码，默认1
pageSize: number    // 每页大小，默认20
```

**响应示例**:
```json
{
  "success": true,
  "message": "获取待确认就餐列表成功",
  "data": {
    "records": [
      {
        "orderId": "order_id_1",
        "deptName": "技术部",
        "userId": "user_id_1",
        "userName": "张三",
        "mealType": "lunch",
        "mealTypeName": "午餐",
        "diningDate": "2024-01-15",
        "registerTime": "2024-01-15 10:00:00",
        "remark": "今日午餐",
        "currentUserDept": "技术部"
      }
    ],
    "total": 1,
    "page": 1,
    "pageSize": 20,
    "hasMore": false
  }
}
```

---

### 7. 获取部门就餐确认统计（管理员功能）

**接口地址**: `GET /api/dining-confirmation/stats`

**接口描述**: 获取部门就餐确认统计数据（管理员功能）

**权限要求**: 部门管理员、系统管理员、验证员

**请求头**:
```http
Authorization: Bearer {token}
```

**查询参数**:
```
date: string         // 查询日期，格式：YYYY-MM-DD，默认今日
departmentId: string // 部门ID，可选
```

**响应示例**:
```json
{
  "success": true,
  "message": "获取部门就餐确认统计成功",
  "data": {
    "queryDate": "2024-01-15",
    "totalStats": {
      "totalOrders": 156,
      "pendingConfirmation": 45,
      "confirmedDining": 98,
      "cancelledOrders": 13
    },
    "mealStats": [
      {
        "mealType": "breakfast",
        "mealTypeName": "早餐",
        "totalOrders": 45,
        "pendingConfirmation": 12,
        "confirmedDining": 30,
        "cancelledOrders": 3
      },
      {
        "mealType": "lunch",
        "mealTypeName": "午餐",
        "totalOrders": 78,
        "pendingConfirmation": 25,
        "confirmedDining": 48,
        "cancelledOrders": 5
      },
      {
        "mealType": "dinner",
        "mealTypeName": "晚餐",
        "totalOrders": 33,
        "pendingConfirmation": 8,
        "confirmedDining": 20,
        "cancelledOrders": 5
      }
    ],
    "departmentStats": [
      {
        "deptName": "技术部",
        "totalOrders": 89,
        "pendingConfirmation": 25,
        "confirmedDining": 58,
        "cancelledOrders": 6
      },
      {
        "deptName": "人事部",
        "totalOrders": 45,
        "pendingConfirmation": 12,
        "confirmedDining": 28,
        "cancelledOrders": 5
      },
      {
        "deptName": "财务部",
        "totalOrders": 22,
        "pendingConfirmation": 8,
        "confirmedDining": 12,
        "cancelledOrders": 2
      }
    ]
  }
}
```

## 📊 数据库字段说明

### dining_orders表新增字段

| 字段名 | 类型 | 说明 | 示例值 |
|--------|------|------|--------|
| `actualDiningTime` | TIMESTAMP | 实际就餐时间 | 2024-01-15 12:30:00 |
| `diningStatus` | ENUM | 就餐状态 | ordered/dined/cancelled |
| `userId` | VARCHAR(36) | 用户ID | user_id_1 |
| `userName` | VARCHAR(50) | 用户姓名 | 张三 |

### dining_confirmation_logs表

| 字段名 | 类型 | 说明 | 示例值 |
|--------|------|------|--------|
| `_id` | VARCHAR(36) | 日志ID | log_id_1 |
| `orderId` | VARCHAR(36) | 订单ID | order_id_1 |
| `userId` | VARCHAR(36) | 用户ID | user_id_1 |
| `userName` | VARCHAR(50) | 用户姓名 | 张三 |
| `confirmationType` | ENUM | 确认类型 | manual/qr/admin |
| `confirmationTime` | TIMESTAMP | 确认时间 | 2024-01-15 12:30:00 |
| `remark` | TEXT | 备注信息 | 用户手动确认就餐 |
| `confirmedBy` | VARCHAR(36) | 确认人ID | admin_id |

## 🔧 业务规则

### 1. 确认就餐规则

- **时间限制**: 只能在就餐时间范围内确认就餐
  - 早餐: 6:00-10:00
  - 午餐: 11:00-14:00
  - 晚餐: 17:00-20:00
- **状态检查**: 只有状态为`ordered`的订单才能确认就餐
- **重复确认**: 已确认就餐的订单不能重复确认
- **权限控制**: 管理员可以代确认任何订单，用户只能确认自己的订单

### 2. 数据完整性

- **事务处理**: 确认就餐操作使用数据库事务，确保数据一致性
- **日志记录**: 所有确认操作都会记录到`dining_confirmation_logs`表
- **状态同步**: 确认就餐后自动更新`diningStatus`和`actualDiningTime`字段

### 3. 错误处理

- **参数验证**: 所有输入参数都会进行格式和内容验证
- **业务验证**: 检查订单状态、用户权限、时间限制等业务规则
- **错误回滚**: 操作失败时自动回滚数据库事务

## 🚀 使用示例

### 用户确认就餐流程

```javascript
// 1. 获取用户就餐状态
const statusResponse = await fetch('/api/dining-confirmation/status', {
  headers: {
    'Authorization': 'Bearer ' + token
  }
});

// 2. 用户手动确认就餐
const confirmResponse = await fetch('/api/dining-confirmation/manual/order_id_1', {
  method: 'POST',
  headers: {
    'Authorization': 'Bearer ' + token,
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    confirmationType: 'manual'
  })
});
```

### 管理员批量确认流程

```javascript
// 1. 获取待确认列表
const pendingResponse = await fetch('/api/dining-confirmation/pending', {
  headers: {
    'Authorization': 'Bearer ' + adminToken
  }
});

// 2. 批量确认就餐
const batchConfirmResponse = await fetch('/api/dining-confirmation/batch', {
  method: 'POST',
  headers: {
    'Authorization': 'Bearer ' + adminToken,
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    orderIds: ['order_id_1', 'order_id_2', 'order_id_3'],
    remark: '批量确认就餐'
  })
});
```

## 📈 业务价值

### 1. 提升管理效率

- **数据统计**: 自动统计各餐别就餐数据
- **状态跟踪**: 实时了解用户就餐状态
- **减少人工**: 减少人工验证和统计工作

### 2. 增强用户体验

- **多种确认方式**: 支持手动确认、扫码确认等多种方式
- **即时反馈**: 实时显示确认结果
- **历史查询**: 用户可以查看自己的就餐确认历史

### 3. 数据价值

- **就餐分析**: 提供详细的就餐数据分析
- **趋势预测**: 支持就餐趋势分析和预测
- **决策支持**: 为餐厅管理提供数据支持

## 🔮 扩展功能

### 1. 智能提醒

- **就餐提醒**: 在就餐时间前提醒用户确认就餐
- **未确认提醒**: 提醒用户及时确认已报餐的就餐

### 2. 数据分析

- **就餐率分析**: 分析各餐别的就餐率
- **用户行为分析**: 分析用户的就餐习惯
- **趋势预测**: 预测未来的就餐需求

### 3. 集成功能

- **扫码确认**: 与现有的扫码就餐功能集成
- **消息通知**: 集成消息通知功能
- **报表生成**: 生成详细的就餐确认报表

---

**文档版本**: v1.0.0  
**创建时间**: 2025年1月  
**维护团队**: 湖北省地质局第三地质大队
