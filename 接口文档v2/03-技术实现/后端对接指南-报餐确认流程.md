# 后端对接指南 - 报餐确认流程

## 快速概览

### 业务流程
```
报餐 → 订单生成(ordered) → 确认就餐 → 状态更新(dined) → 记录历史
```

### 关键参与者
- **报餐人员**: 部门管理员
- **确认人员**: 用户本人 或 管理员代确认
- **确认方式**: 手动点击 或 扫码确认

## 核心接口

### 1. 报餐接口
```http
POST /api/dining/dept-order
Authorization: Bearer {admin_token}
Content-Type: application/json

{
  "date": "2025-09-10",
  "mealType": "lunch",
  "memberIds": ["user_id"],
  "remark": "部门报餐"
}
```

**响应**:
```json
{
  "success": true,
  "data": {
    "orderId": "order_id",
    "memberCount": 1
  }
}
```

### 2. 用户手动确认
```http
POST /api/dining-confirmation/manual/{orderId}
Authorization: Bearer {user_token}
Content-Type: application/json

{
  "confirmationType": "manual",
  "remark": "用户手动确认就餐"
}
```

**响应**:
```json
{
  "success": true,
  "data": {
    "orderId": "order_id",
    "confirmationType": "manual",
    "actualDiningTime": "2025-09-10T12:30:00.000Z"
  }
}
```

### 3. 扫码确认
```http
POST /api/qr-scan/process
Authorization: Bearer {user_token}
Content-Type: application/json

{
  "qrCode": "qr_code_string",
  "userId": "user_id"
}
```

### 4. 管理员代确认
```http
POST /api/dining-confirmation/admin/{orderId}
Authorization: Bearer {admin_token}
Content-Type: application/json

{
  "confirmationType": "admin",
  "remark": "管理员代确认就餐"
}
```

### 5. 状态查询
```http
GET /api/dining/personal-status
Authorization: Bearer {user_token}
```

**响应**:
```json
{
  "success": true,
  "data": {
    "mealStatus": {
      "lunch": {
        "isRegistered": true,
        "diningStatus": "dined",
        "confirmationText": "已就餐",
        "actualDiningTime": "2025-09-10T12:30:00.000Z"
      }
    }
  }
}
```

## 数据库表结构

### dining_orders 表
```sql
CREATE TABLE dining_orders (
  id VARCHAR(36) PRIMARY KEY,
  userId VARCHAR(36) NOT NULL,
  userName VARCHAR(100) NOT NULL,
  date DATE NOT NULL,
  mealType ENUM('breakfast', 'lunch', 'dinner') NOT NULL,
  diningStatus ENUM('ordered', 'dined') DEFAULT 'ordered',
  actualDiningTime DATETIME NULL,
  createdAt DATETIME DEFAULT CURRENT_TIMESTAMP,
  updatedAt DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

### dining_confirmation_logs 表
```sql
CREATE TABLE dining_confirmation_logs (
  id VARCHAR(36) PRIMARY KEY,
  orderId VARCHAR(36) NOT NULL,
  confirmationType ENUM('manual', 'qr_scan', 'admin') NOT NULL,
  actualDiningTime DATETIME NOT NULL,
  confirmedBy VARCHAR(36) NOT NULL,
  remark TEXT,
  createdAt DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

## 状态流转

### 订单状态
- **ordered**: 已报餐，等待确认
- **dined**: 已确认就餐

### 状态变更
```
未报餐 → ordered → dined
```

## 权限控制

### 用户角色
- **普通用户**: 只能确认自己的订单
- **部门管理员**: 可以代确认本部门订单
- **系统管理员**: 可以代确认任何订单

### 权限验证
```javascript
// 所有接口都需要JWT Token验证
Authorization: Bearer {token}

// 管理员接口需要角色验证
// 自动验证用户角色权限
```

## 错误处理

### 常见错误码
- **400**: 请求参数错误
- **401**: 未授权
- **403**: 权限不足
- **404**: 订单不存在
- **409**: 订单已确认
- **500**: 服务器错误

### 错误响应格式
```json
{
  "success": false,
  "message": "错误描述",
  "error": "ERROR_CODE"
}
```

## 业务规则

### 确认规则
1. 一个订单只能确认一次
2. 用户只能确认自己的订单
3. 管理员可以代确认任何订单
4. 确认后状态不可逆转

### 时间规则
1. 报餐时间：提前一天或当天
2. 确认时间：就餐当天
3. 时间记录：使用UTC时间

## 完整流程示例

### 1. 部门管理员报餐
```javascript
// 登录获取管理员Token
const adminLogin = await axios.post('/api/auth/test-login-admin', {
  phoneNumber: '13800138001',
  password: 'admin123'
});
const adminToken = adminLogin.data.data.token;

// 为部门成员报餐
const orderResponse = await axios.post('/api/dining/dept-order', {
  date: '2025-09-10',
  mealType: 'lunch',
  memberIds: ['user_id'],
  remark: '部门报餐'
}, {
  headers: { 'Authorization': `Bearer ${adminToken}` }
});
```

### 2. 用户确认就餐
```javascript
// 用户登录获取Token
const userLogin = await axios.post('/api/auth/test-login', {
  phoneNumber: '13800138000',
  password: 'test123'
});
const userToken = userLogin.data.data.token;

// 手动确认就餐
const confirmResponse = await axios.post(`/api/dining-confirmation/manual/${orderId}`, {
  confirmationType: 'manual',
  remark: '用户手动确认就餐'
}, {
  headers: { 'Authorization': `Bearer ${userToken}` }
});
```

### 3. 查询确认状态
```javascript
// 查询个人状态
const statusResponse = await axios.get('/api/dining/personal-status', {
  headers: { 'Authorization': `Bearer ${userToken}` }
});

// 查询确认历史
const historyResponse = await axios.get('/api/dining-confirmation/history', {
  headers: { 'Authorization': `Bearer ${userToken}` }
});
```

## 测试验证

### 测试脚本
```bash
# 运行详细流程测试
node scripts/test_dining_flow_detailed.js

# 运行快速测试
node scripts/quick_test.js
```

### 测试覆盖
- ✅ 用户登录认证
- ✅ 部门管理员报餐
- ✅ 用户手动确认
- ✅ 扫码确认
- ✅ 管理员代确认
- ✅ 状态查询
- ✅ 历史记录

## 部署配置

### 环境要求
- Node.js 16+
- MySQL 8.0+
- 端口: 3000

### 启动服务
```bash
# 安装依赖
npm install

# 启动服务
node server.js
```

### 健康检查
```http
GET /health
```

**响应**:
```json
{
  "success": true,
  "message": "服务运行正常",
  "database": "已连接"
}
```

## 总结

这个报餐确认流程的核心特点：

1. **报餐**: 部门管理员为部门成员报餐
2. **确认**: 用户本人手动确认或扫码确认，管理员可代确认
3. **状态**: ordered → dined 的单向流转
4. **记录**: 完整的确认历史记录
5. **权限**: 基于角色的访问控制

所有接口都经过测试验证，可以正常使用。
