# 确认就餐接口统一文档

## 📋 文档概述

本文档整合了确认就餐功能的所有接口信息，为开发人员提供完整的API接口说明，包含后端接口规范、前端对接指南和快速参考。

**基础路径**: `/api/dining-confirmation`  
**认证方式**: JWT Token  
**文档版本**: v2.0.0  
**最后更新**: 2025年1月

## 🎯 业务流程

### 确认就餐流程
```
用户报餐 (diningStatus: 'ordered')
   ↓
管理员确认报餐 (可选步骤)
   ↓  
用户确认就餐 (多种方式)
   - 方式A: 扫码确认 (diningStatus: 'dined')
   - 方式B: 手动确认 (diningStatus: 'dined')
   - 方式C: 管理员代确认 (diningStatus: 'dined')
   ↓
完成就餐流程
```

### 确认类型说明
- **manual**: 用户手动确认就餐
- **qr**: 通过扫码确认就餐
- **admin**: 管理员代为确认就餐

## 🔐 认证配置

### 请求头设置
```javascript
const headers = {
  'Authorization': `Bearer ${token}`,
  'Content-Type': 'application/json'
};
```

### Token获取
```javascript
// 登录后获取token
const loginResponse = await fetch('/api/auth/login', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ username, password })
});
const { data: { token } } = await loginResponse.json();
```

## 📱 用户端接口

### 1. 获取用户就餐确认状态

**接口地址**: `GET /api/dining-confirmation/status`

**功能描述**: 获取用户指定日期的就餐确认状态，显示每个餐次的报餐和确认情况

**请求参数**:
```javascript
const params = {
  date: '2024-01-15'  // 可选，格式：YYYY-MM-DD，默认今日
};

const queryString = new URLSearchParams(params).toString();
const response = await fetch(`/api/dining-confirmation/status?${queryString}`, {
  headers: { 'Authorization': `Bearer ${token}` }
});
```

**响应数据结构**:
```javascript
{
  "success": true,
  "message": "获取就餐确认状态成功",
  "data": {
    "userId": "user_id_1",
    "userName": "张三",
    "department": "技术部",
    "queryDate": "2024-01-15",
    "mealConfirmationStatus": {
      "breakfast": {
        "isRegistered": true,           // 是否已报餐
        "orderId": "order_id_1",        // 订单ID
        "status": "confirmed",          // 报餐状态：pending/confirmed/completed/cancelled
        "diningStatus": "dined",        // 就餐状态：ordered/dined/cancelled
        "statusText": "已确认",         // 报餐状态中文
        "confirmationText": "已就餐",   // 就餐状态中文
        "actualDiningTime": "2024-01-15 08:30:00",  // 实际就餐时间
        "registerTime": "2024-01-15 07:00:00",      // 报餐时间
        "remark": "今日早餐"            // 备注
      },
      "lunch": {
        "isRegistered": true,
        "orderId": "order_id_2",
        "status": "confirmed",
        "diningStatus": "ordered",      // 已报餐但未确认就餐
        "statusText": "已确认",
        "confirmationText": "已报餐",
        "actualDiningTime": null,       // 未确认就餐，时间为空
        "registerTime": "2024-01-15 10:00:00",
        "remark": "今日午餐"
      },
      "dinner": {
        "isRegistered": false,           // 未报餐
        "orderId": null,
        "status": null,
        "diningStatus": null,
        "statusText": "未报餐",
        "confirmationText": "未确认",
        "actualDiningTime": null,
        "registerTime": null,
        "remark": null
      }
    },
    "summary": {
      "totalRegistered": 2,             // 总报餐数
      "totalConfirmed": 1,             // 总确认就餐数
      "pendingConfirmation": 1,         // 待确认就餐数
      "unregisteredCount": 1           // 未报餐数
    }
  }
}
```

**前端使用示例**:
```javascript
// Vue.js 示例
async fetchDiningStatus(date = null) {
  try {
    const params = date ? { date } : {};
    const queryString = new URLSearchParams(params).toString();
    
    const response = await fetch(`/api/dining-confirmation/status?${queryString}`, {
      headers: { 'Authorization': `Bearer ${this.token}` }
    });
    
    const result = await response.json();
    
    if (result.success) {
      this.diningStatus = result.data;
      this.updateMealStatusDisplay();
    } else {
      this.showError(result.message);
    }
  } catch (error) {
    this.showError('获取就餐状态失败');
  }
}

// 更新餐次状态显示
updateMealStatusDisplay() {
  const meals = ['breakfast', 'lunch', 'dinner'];
  meals.forEach(mealType => {
    const status = this.diningStatus.mealConfirmationStatus[mealType];
    this.updateMealCard(mealType, status);
  });
}
```

### 2. 用户手动确认就餐

**接口地址**: `POST /api/dining-confirmation/manual/:orderId`

**功能描述**: 用户自己确认已就餐

**请求参数**:
```javascript
const orderId = 'order_id_1';
const response = await fetch(`/api/dining-confirmation/manual/${orderId}`, {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${token}`,
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    confirmationType: 'manual'  // 可选，默认为manual
  })
});
```

**响应数据结构**:
```javascript
{
  "success": true,
  "message": "确认就餐成功",
  "data": {
    "orderId": "order_id_1",
    "confirmationType": "manual",
    "actualDiningTime": "2024-01-15 12:30:00",
    "message": "确认就餐成功"
  }
}
```

**前端使用示例**:
```javascript
// 确认就餐按钮点击事件
async confirmDining(orderId) {
  try {
    // 显示确认对话框
    const confirmed = await this.showConfirmDialog('确认已就餐？');
    if (!confirmed) return;

    // 显示加载状态
    this.showLoading('正在确认就餐...');

    const response = await fetch(`/api/dining-confirmation/manual/${orderId}`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${this.token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        confirmationType: 'manual'
      })
    });

    const result = await response.json();
    
    if (result.success) {
      this.showSuccess('确认就餐成功！');
      // 刷新状态
      await this.fetchDiningStatus();
    } else {
      this.showError(result.message);
    }
  } catch (error) {
    this.showError('确认就餐失败');
  } finally {
    this.hideLoading();
  }
}
```

### 3. 获取就餐确认历史记录

**接口地址**: `GET /api/dining-confirmation/history`

**功能描述**: 获取用户的就餐确认历史记录

**请求参数**:
```javascript
const params = {
  date: '2024-01-15',           // 单日查询
  startDate: '2024-01-01',      // 开始日期
  endDate: '2024-01-31',        // 结束日期
  diningStatus: 'dined',        // 就餐状态：ordered/dined/cancelled
  page: 1,                      // 页码
  pageSize: 20                  // 每页大小
};

const queryString = new URLSearchParams(params).toString();
const response = await fetch(`/api/dining-confirmation/history?${queryString}`, {
  headers: { 'Authorization': `Bearer ${token}` }
});
```

**响应数据结构**:
```javascript
{
  "success": true,
  "message": "获取就餐确认历史成功",
  "data": {
    "records": [
      {
        "orderId": "order_id_1",
        "diningDate": "2024-01-15",
        "mealType": "breakfast",
        "mealTypeName": "早餐",
        "status": "confirmed",
        "diningStatus": "dined",
        "statusText": "已确认",
        "confirmationText": "已就餐",
        "actualDiningTime": "2024-01-15 08:30:00",
        "registerTime": "2024-01-15 07:00:00",
        "remark": "今日早餐",
        "confirmationType": "manual",
        "confirmationTime": "2024-01-15 08:30:00",
        "confirmedBy": null
      }
    ],
    "total": 1,
    "page": 1,
    "pageSize": 20,
    "hasMore": false
  }
}
```

## 👨‍💼 管理员端接口

### 4. 管理员代确认就餐

**接口地址**: `POST /api/dining-confirmation/admin/:orderId`

**功能描述**: 管理员代为确认用户已就餐

**权限要求**: 部门管理员、系统管理员、验证员

**请求参数**:
```javascript
const orderId = 'order_id_1';
const response = await fetch(`/api/dining-confirmation/admin/${orderId}`, {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${adminToken}`,
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    remark: '管理员代确认就餐'  // 可选
  })
});
```

**响应数据结构**:
```javascript
{
  "success": true,
  "message": "管理员代确认就餐成功",
  "data": {
    "orderId": "order_id_1",
    "confirmationType": "admin",
    "actualDiningTime": "2024-01-15 12:30:00",
    "confirmedBy": "admin_id",
    "message": "管理员代确认就餐成功"
  }
}
```

### 5. 批量确认就餐

**接口地址**: `POST /api/dining-confirmation/batch`

**功能描述**: 管理员批量确认多个订单的就餐状态

**权限要求**: 部门管理员、系统管理员、验证员

**请求参数**:
```javascript
const response = await fetch('/api/dining-confirmation/batch', {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${adminToken}`,
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    orderIds: ['order_id_1', 'order_id_2', 'order_id_3'],
    remark: '批量确认就餐'  // 可选
  })
});
```

**响应数据结构**:
```javascript
{
  "success": true,
  "message": "批量确认完成，成功 2 个",
  "data": {
    "successCount": 2,
    "totalCount": 3,
    "errors": [
      {
        "orderId": "order_id_3",
        "error": "该订单已确认就餐"
      }
    ]
  }
}
```

### 6. 获取待确认就餐列表

**接口地址**: `GET /api/dining-confirmation/pending`

**功能描述**: 获取待确认就餐的订单列表

**权限要求**: 部门管理员、系统管理员、验证员

**请求参数**:
```javascript
const params = {
  date: '2024-01-15',           // 查询日期，默认今日
  departmentId: 'dept_id_1',    // 部门ID，可选
  mealType: 'lunch',            // 餐次类型：breakfast/lunch/dinner，可选
  page: 1,                      // 页码
  pageSize: 20                  // 每页大小
};

const queryString = new URLSearchParams(params).toString();
const response = await fetch(`/api/dining-confirmation/pending?${queryString}`, {
  headers: { 'Authorization': `Bearer ${adminToken}` }
});
```

### 7. 获取部门就餐确认统计

**接口地址**: `GET /api/dining-confirmation/stats`

**功能描述**: 获取部门就餐确认统计数据

**权限要求**: 部门管理员、系统管理员、验证员

**请求参数**:
```javascript
const params = {
  date: '2024-01-15',           // 查询日期，默认今日
  departmentId: 'dept_id_1'     // 部门ID，可选
};

const queryString = new URLSearchParams(params).toString();
const response = await fetch(`/api/dining-confirmation/stats?${queryString}`, {
  headers: { 'Authorization': `Bearer ${adminToken}` }
});
```

## 🎨 前端UI组件建议

### 状态显示组件
```vue
<template>
  <div class="meal-status">
    <div v-for="meal in meals" :key="meal.type" class="meal-card">
      <h3>{{ meal.name }}</h3>
      <span class="status">{{ meal.confirmationText }}</span>
      <button 
        v-if="meal.diningStatus === 'ordered'"
        @click="confirmDining(meal.orderId)"
      >
        确认就餐
      </button>
    </div>
  </div>
</template>
```

### 批量操作组件
```vue
<template>
  <div class="batch-actions">
    <el-checkbox 
      v-model="selectAll" 
      @change="handleSelectAll"
    >
      全选
    </el-checkbox>
    <el-button 
      @click="batchConfirm"
      :disabled="selectedOrders.length === 0"
    >
      批量确认 ({{ selectedOrders.length }})
    </el-button>
  </div>
</template>
```

## 🚨 错误处理

### 常见错误码
- `400`: 请求参数错误
- `401`: 未授权，需要重新登录
- `403`: 权限不足
- `409`: 业务冲突（如重复确认）

### 错误处理示例
```javascript
try {
  const response = await fetch('/api/dining-confirmation/status');
  const result = await response.json();
  
  if (!result.success) {
    throw new Error(result.message);
  }
  
  return result.data;
} catch (error) {
  if (error.message.includes('未授权')) {
    // 跳转到登录页
    router.push('/login');
  } else {
    // 显示错误提示
    showError(error.message);
  }
}
```

## 📱 移动端适配

### 响应式样式
```css
@media (max-width: 768px) {
  .meal-card {
    padding: 15px;
    margin-bottom: 10px;
  }
  
  .confirm-btn {
    width: 100%;
    padding: 12px;
  }
}
```

### 触摸优化
```javascript
// 防重复点击
let isProcessing = false;

async function handleConfirm() {
  if (isProcessing) return;
  
  isProcessing = true;
  try {
    await confirmDining();
  } finally {
    isProcessing = false;
  }
}
```

## 🔄 状态管理

### Vuex 示例
```javascript
// store
const state = {
  diningStatus: null,
  pendingOrders: []
};

const mutations = {
  SET_DINING_STATUS(state, status) {
    state.diningStatus = status;
  }
};

const actions = {
  async fetchDiningStatus({ commit }) {
    const response = await api.getDiningStatus();
    commit('SET_DINING_STATUS', response.data);
  }
};
```

## 📊 数据库字段说明

### dining_orders表新增字段
| 字段名 | 类型 | 说明 | 示例值 |
|--------|------|------|--------|
| `actualDiningTime` | TIMESTAMP | 实际就餐时间 | 2024-01-15 12:30:00 |
| `diningStatus` | ENUM | 就餐状态 | ordered/dined/cancelled |
| `userId` | VARCHAR(36) | 用户ID | user_id_1 |
| `userName` | VARCHAR(50) | 用户姓名 | 张三 |

### dining_confirmation_logs表
| 字段名 | 类型 | 说明 | 示例值 |
|--------|------|------|--------|
| `_id` | VARCHAR(36) | 日志ID | log_id_1 |
| `orderId` | VARCHAR(36) | 订单ID | order_id_1 |
| `userId` | VARCHAR(36) | 用户ID | user_id_1 |
| `userName` | VARCHAR(50) | 用户姓名 | 张三 |
| `confirmationType` | ENUM | 确认类型 | manual/qr/admin |
| `confirmationTime` | TIMESTAMP | 确认时间 | 2024-01-15 12:30:00 |
| `remark` | TEXT | 备注信息 | 用户手动确认就餐 |
| `confirmedBy` | VARCHAR(36) | 确认人ID | admin_id |

## 🔧 业务规则

### 1. 确认就餐规则
- **时间限制**: 只能在就餐时间范围内确认就餐
  - 早餐: 6:00-10:00
  - 午餐: 11:00-14:00
  - 晚餐: 17:00-20:00
- **状态检查**: 只有状态为`ordered`的订单才能确认就餐
- **重复确认**: 已确认就餐的订单不能重复确认
- **权限控制**: 管理员可以代确认任何订单，用户只能确认自己的订单

### 2. 数据完整性
- **事务处理**: 确认就餐操作使用数据库事务，确保数据一致性
- **日志记录**: 所有确认操作都会记录到`dining_confirmation_logs`表
- **状态同步**: 确认就餐后自动更新`diningStatus`和`actualDiningTime`字段

### 3. 错误处理
- **参数验证**: 所有输入参数都会进行格式和内容验证
- **业务验证**: 检查订单状态、用户权限、时间限制等业务规则
- **错误回滚**: 操作失败时自动回滚数据库事务

## 🚀 使用示例

### 用户确认就餐流程
```javascript
// 1. 获取用户就餐状态
const statusResponse = await fetch('/api/dining-confirmation/status', {
  headers: {
    'Authorization': 'Bearer ' + token
  }
});

// 2. 用户手动确认就餐
const confirmResponse = await fetch('/api/dining-confirmation/manual/order_id_1', {
  method: 'POST',
  headers: {
    'Authorization': 'Bearer ' + token,
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    confirmationType: 'manual'
  })
});
```

### 管理员批量确认流程
```javascript
// 1. 获取待确认列表
const pendingResponse = await fetch('/api/dining-confirmation/pending', {
  headers: {
    'Authorization': 'Bearer ' + adminToken
  }
});

// 2. 批量确认就餐
const batchConfirmResponse = await fetch('/api/dining-confirmation/batch', {
  method: 'POST',
  headers: {
    'Authorization': 'Bearer ' + adminToken,
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    orderIds: ['order_id_1', 'order_id_2', 'order_id_3'],
    remark: '批量确认就餐'
  })
});
```

## 📈 业务价值

### 1. 提升管理效率
- **数据统计**: 自动统计各餐别就餐数据
- **状态跟踪**: 实时了解用户就餐状态
- **减少人工**: 减少人工验证和统计工作

### 2. 增强用户体验
- **多种确认方式**: 支持手动确认、扫码确认等多种方式
- **即时反馈**: 实时显示确认结果
- **历史查询**: 用户可以查看自己的就餐确认历史

### 3. 数据价值
- **就餐分析**: 提供详细的就餐数据分析
- **趋势预测**: 支持就餐趋势分析和预测
- **决策支持**: 为餐厅管理提供数据支持

---

**文档版本**: v2.0.0  
**创建时间**: 2025年1月  
**适用框架**: Vue.js 3.x, React, Angular  
**维护团队**: 湖北省地质局第三地质大队
