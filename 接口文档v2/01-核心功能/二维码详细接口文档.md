# å‰ç«¯å¯¹æ¥æ–‡æ¡£ - äºŒç»´ç æ‰«ç ç¡®è®¤å°±é¤

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£ä¸ºå‰ç«¯å¼€å‘è€…æä¾›å®Œæ•´çš„äºŒç»´ç æ‰«ç ç¡®è®¤å°±é¤åŠŸèƒ½å¯¹æ¥æŒ‡å—ï¼ŒåŒ…æ‹¬Webå‰ç«¯å’Œå¾®ä¿¡å°ç¨‹åºå‰ç«¯çš„å®ç°æ–¹æ¡ˆã€‚

## ğŸ¯ åŠŸèƒ½æ¨¡å—

### 1. Webå‰ç«¯å¯¹æ¥
- äºŒç»´ç å›¾ç‰‡ç”Ÿæˆå’Œæ˜¾ç¤º
- ç”¨æˆ·æ‰«ç ç¡®è®¤å°±é¤
- ç»“æœå±•ç¤ºå’ŒçŠ¶æ€ç®¡ç†

### 2. å¾®ä¿¡å°ç¨‹åºå‰ç«¯å¯¹æ¥
- å›ºå®šäºŒç»´ç æ‰«ç è¿›å…¥å°ç¨‹åº
- å¾®ä¿¡ç™»å½•éªŒè¯
- è‡ªåŠ¨ç¡®è®¤å°±é¤
- ç»“æœå±•ç¤º

## ğŸŒ Webå‰ç«¯å¯¹æ¥

### 1. äºŒç»´ç ç”Ÿæˆå’Œæ˜¾ç¤º

#### 1.1 ç”Ÿæˆæ™®é€šäºŒç»´ç å›¾ç‰‡

**æ¥å£**: `GET /api/qr-scan/qr-codes/:qrCode/image`

**è¯·æ±‚ç¤ºä¾‹**:
```javascript
// ç”ŸæˆäºŒç»´ç å›¾ç‰‡
async function generateQRCodeImage(qrCode, options = {}) {
  try {
    const token = localStorage.getItem('token');
    const params = new URLSearchParams({
      width: options.width || 200,
      margin: options.margin || 2
    });
    
    const response = await fetch(`/api/qr-scan/qr-codes/${qrCode}/image?${params}`, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });
    
    const result = await response.json();
    
    if (result.success) {
      return result.data.imageDataURL;
    } else {
      throw new Error(result.message);
    }
  } catch (error) {
    console.error('ç”ŸæˆäºŒç»´ç å›¾ç‰‡å¤±è´¥:', error);
    throw error;
    }
}

// ä½¿ç”¨ç¤ºä¾‹
const qrCodeImage = await generateQRCodeImage('DINING_QR_MAIN_001', {
  width: 300,
  margin: 3
});

// æ˜¾ç¤ºäºŒç»´ç 
const img = document.createElement('img');
img.src = qrCodeImage;
img.style.width = '300px';
img.style.height = '300px';
document.body.appendChild(img);
```

#### 1.2 ç”ŸæˆåŒ…å«URLçš„äºŒç»´ç å›¾ç‰‡

**æ¥å£**: `GET /api/qr-scan/qr-codes/:qrCode/image-with-url`

**è¯·æ±‚ç¤ºä¾‹**:
```javascript
// ç”ŸæˆåŒ…å«URLçš„äºŒç»´ç å›¾ç‰‡
async function generateQRCodeWithURL(qrCode, baseURL = 'http://localhost:3000', options = {}) {
  try {
    const token = localStorage.getItem('token');
    const params = new URLSearchParams({
      width: options.width || 200,
      margin: options.margin || 2,
      baseURL: baseURL
    });
    
    const response = await fetch(`/api/qr-scan/qr-codes/${qrCode}/image-with-url?${params}`, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });
    
    const result = await response.json();
    
    if (result.success) {
      return {
        imageDataURL: result.data.imageDataURL,
        qrCodeURL: result.data.qrCodeURL
      };
    } else {
      throw new Error(result.message);
    }
  } catch (error) {
    console.error('ç”ŸæˆåŒ…å«URLçš„äºŒç»´ç å›¾ç‰‡å¤±è´¥:', error);
    throw error;
  }
}

// ä½¿ç”¨ç¤ºä¾‹
const qrResult = await generateQRCodeWithURL('DINING_QR_MAIN_001', 'https://your-domain.com', {
  width: 300,
  margin: 3
});

// æ˜¾ç¤ºäºŒç»´ç 
const img = document.createElement('img');
img.src = qrResult.imageDataURL;
img.style.width = '300px';
img.style.height = '300px';
document.body.appendChild(img);

// äºŒç»´ç URLï¼ˆç”¨æˆ·æ‰«ç åä¼šè·³è½¬åˆ°è¿™ä¸ªURLï¼‰
console.log('äºŒç»´ç URL:', qrResult.qrCodeURL);
```

#### 1.3 ç”Ÿæˆå®‰å…¨äºŒç»´ç å›¾ç‰‡

**æ¥å£**: `GET /api/qr-scan/qr-codes/:qrCode/image-secure`

**è¯·æ±‚ç¤ºä¾‹**:
```javascript
// ç”Ÿæˆå®‰å…¨äºŒç»´ç å›¾ç‰‡
async function generateSecureQRCode(qrCode, baseURL = 'http://localhost:3000', options = {}) {
  try {
    const token = localStorage.getItem('token');
    const params = new URLSearchParams({
      width: options.width || 200,
      margin: options.margin || 2,
      baseURL: baseURL
    });
    
    const response = await fetch(`/api/qr-scan/qr-codes/${qrCode}/image-secure?${params}`, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });
    
    const result = await response.json();
    
    if (result.success) {
      return {
        imageDataURL: result.data.imageDataURL,
        qrCodeURL: result.data.qrCodeURL,
        secureToken: result.data.secureToken,
        expiresAt: result.data.expiresAt
      };
    } else {
      throw new Error(result.message);
    }
  } catch (error) {
    console.error('ç”Ÿæˆå®‰å…¨äºŒç»´ç å›¾ç‰‡å¤±è´¥:', error);
    throw error;
  }
}

// ä½¿ç”¨ç¤ºä¾‹
const secureQRResult = await generateSecureQRCode('DINING_QR_MAIN_001', 'https://your-domain.com', {
  width: 300,
  margin: 3
});

// æ˜¾ç¤ºäºŒç»´ç 
const img = document.createElement('img');
img.src = secureQRResult.imageDataURL;
img.style.width = '300px';
img.style.height = '300px';
document.body.appendChild(img);

// å®‰å…¨ä¿¡æ¯
console.log('å®‰å…¨ä»¤ç‰Œ:', secureQRResult.secureToken);
console.log('è¿‡æœŸæ—¶é—´:', secureQRResult.expiresAt);
```

#### 1.4 ç”Ÿæˆå¾®ä¿¡å°ç¨‹åºç 

**æ¥å£**: `GET /api/qr-scan/qr-codes/:qrCode/image-wechat`

**è¯·æ±‚ç¤ºä¾‹**:
```javascript
// ç”Ÿæˆå¾®ä¿¡å°ç¨‹åºç 
async function generateWechatMiniProgramCode(qrCode, options = {}) {
  try {
    const token = localStorage.getItem('token');
    const params = new URLSearchParams({
      width: options.width || 200,
      margin: options.margin || 2
    });
    
    const response = await fetch(`/api/qr-scan/qr-codes/${qrCode}/image-wechat?${params}`, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });
    
    const result = await response.json();
    
    if (result.success) {
      return {
        imageDataURL: result.data.imageDataURL,
        miniProgramPath: result.data.miniProgramPath,
        scene: result.data.scene
      };
    } else {
      throw new Error(result.message);
    }
  } catch (error) {
    console.error('ç”Ÿæˆå¾®ä¿¡å°ç¨‹åºç å¤±è´¥:', error);
    throw error;
  }
}

// ä½¿ç”¨ç¤ºä¾‹
const wechatQRResult = await generateWechatMiniProgramCode('DINING_QR_MAIN_001', {
  width: 300,
  margin: 3
});

// æ˜¾ç¤ºäºŒç»´ç 
const img = document.createElement('img');
img.src = wechatQRResult.imageDataURL;
img.style.width = '300px';
img.style.height = '300px';
document.body.appendChild(img);

// å°ç¨‹åºä¿¡æ¯
console.log('å°ç¨‹åºè·¯å¾„:', wechatQRResult.miniProgramPath);
console.log('åœºæ™¯å€¼:', wechatQRResult.scene);
```

### 2. æ‰«ç ç¡®è®¤å°±é¤

#### 2.1 æ™®é€šæ‰«ç ç¡®è®¤

**æ¥å£**: `POST /api/qr-scan/scan`

**è¯·æ±‚ç¤ºä¾‹**:
```javascript
// æ‰«ç ç¡®è®¤å°±é¤
async function confirmDining(qrCode, scanTime) {
  try {
    const token = localStorage.getItem('token');
    
    const response = await fetch('/api/qr-scan/scan', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        qrCode: qrCode,
        scanTime: scanTime || new Date().toISOString()
      })
    });
    
    const result = await response.json();
    
    if (result.success) {
      return result.data;
    } else {
      throw new Error(result.message);
    }
  } catch (error) {
    console.error('æ‰«ç ç¡®è®¤å°±é¤å¤±è´¥:', error);
    throw error;
  }
}

// ä½¿ç”¨ç¤ºä¾‹
try {
  const result = await confirmDining('DINING_QR_MAIN_001');
  console.log('ç¡®è®¤æˆåŠŸ:', result);
  
  // æ˜¾ç¤ºæˆåŠŸä¿¡æ¯
  alert(`ç¡®è®¤æˆåŠŸï¼\né¤æ¬¡: ${result.mealTypeName}\næ—¥æœŸ: ${result.diningDate}\næ—¶é—´: ${result.scanTime}`);
} catch (error) {
  console.error('ç¡®è®¤å¤±è´¥:', error.message);
  alert(`ç¡®è®¤å¤±è´¥: ${error.message}`);
}
```

#### 2.2 å¾®ä¿¡å°ç¨‹åºæ‰«ç ç¡®è®¤

**æ¥å£**: `POST /api/qr-scan/wechat-scan`

**è¯·æ±‚ç¤ºä¾‹**:
```javascript
// å¾®ä¿¡å°ç¨‹åºæ‰«ç ç¡®è®¤å°±é¤
async function confirmWechatDining(qrCode, scanTime) {
  try {
    const token = localStorage.getItem('token');
    
    const response = await fetch('/api/qr-scan/wechat-scan', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        qrCode: qrCode,
        scanTime: scanTime || new Date().toISOString()
      })
    });
    
    const result = await response.json();
    
    if (result.success) {
      return result.data;
    } else {
      throw new Error(result.message);
    }
  } catch (error) {
    console.error('å¾®ä¿¡å°ç¨‹åºæ‰«ç ç¡®è®¤å°±é¤å¤±è´¥:', error);
    throw error;
  }
}

// ä½¿ç”¨ç¤ºä¾‹
try {
  const result = await confirmWechatDining('DINING_QR_MAIN_001');
  console.log('ç¡®è®¤æˆåŠŸ:', result);
  
  // æ˜¾ç¤ºæˆåŠŸä¿¡æ¯
  alert(`ç¡®è®¤æˆåŠŸï¼\nç”¨æˆ·: ${result.userName}\né¤æ¬¡: ${result.mealTypeName}\næ—¥æœŸ: ${result.diningDate}\næ—¶é—´: ${result.scanTime}`);
} catch (error) {
  console.error('ç¡®è®¤å¤±è´¥:', error.message);
  alert(`ç¡®è®¤å¤±è´¥: ${error.message}`);
}
```

### 3. å®Œæ•´çš„Webå‰ç«¯ç»„ä»¶ç¤ºä¾‹

```html
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äºŒç»´ç æ‰«ç ç¡®è®¤å°±é¤</title>
    <style>
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            font-family: Arial, sans-serif;
        }
        
        .qr-section {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        
        .qr-image {
            max-width: 300px;
            height: auto;
            margin: 20px 0;
        }
        
        .btn {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        
        .btn:hover {
            background-color: #0056b3;
        }
        
        .btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 4px;
        }
        
        .result.success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .result.error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        
        .loading {
            text-align: center;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>äºŒç»´ç æ‰«ç ç¡®è®¤å°±é¤</h1>
        
        <!-- äºŒç»´ç ç”ŸæˆåŒºåŸŸ -->
        <div class="qr-section">
            <h2>ç”ŸæˆäºŒç»´ç </h2>
            <div>
                <button class="btn" onclick="generateQRCode('normal')">ç”Ÿæˆæ™®é€šäºŒç»´ç </button>
                <button class="btn" onclick="generateQRCode('with-url')">ç”Ÿæˆå¸¦URLäºŒç»´ç </button>
                <button class="btn" onclick="generateQRCode('secure')">ç”Ÿæˆå®‰å…¨äºŒç»´ç </button>
                <button class="btn" onclick="generateQRCode('wechat')">ç”Ÿæˆå¾®ä¿¡å°ç¨‹åºç </button>
            </div>
            
            <div id="qr-container">
                <!-- äºŒç»´ç å›¾ç‰‡å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ -->
            </div>
        </div>
        
        <!-- æ‰«ç ç¡®è®¤åŒºåŸŸ -->
        <div class="qr-section">
            <h2>æ‰«ç ç¡®è®¤å°±é¤</h2>
            <div>
                <input type="text" id="qrCodeInput" placeholder="è¯·è¾“å…¥äºŒç»´ç æ ‡è¯†" value="DINING_QR_MAIN_001">
                <button class="btn" onclick="confirmDining()">ç¡®è®¤å°±é¤</button>
            </div>
            
            <div id="result-container">
                <!-- ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ -->
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let currentQRType = 'normal';
        let currentQRData = null;
        
        // ç”ŸæˆäºŒç»´ç 
        async function generateQRCode(type) {
            try {
                const qrCode = 'DINING_QR_MAIN_001';
                const container = document.getElementById('qr-container');
                const resultContainer = document.getElementById('result-container');
                
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                container.innerHTML = '<div class="loading">ç”Ÿæˆä¸­...</div>';
                resultContainer.innerHTML = '';
                
                let result;
                
                switch (type) {
                    case 'normal':
                        result = await generateQRCodeImage(qrCode, { width: 300, margin: 3 });
                        break;
                    case 'with-url':
                        result = await generateQRCodeWithURL(qrCode, window.location.origin, { width: 300, margin: 3 });
                        break;
                    case 'secure':
                        result = await generateSecureQRCode(qrCode, window.location.origin, { width: 300, margin: 3 });
                        break;
                    case 'wechat':
                        result = await generateWechatMiniProgramCode(qrCode, { width: 300, margin: 3 });
                        break;
                }
                
                // æ˜¾ç¤ºäºŒç»´ç å›¾ç‰‡
                const img = document.createElement('img');
                img.src = result.imageDataURL;
                img.className = 'qr-image';
                img.alt = 'äºŒç»´ç ';
                
                container.innerHTML = '';
                container.appendChild(img);
                
                // ä¿å­˜å½“å‰äºŒç»´ç æ•°æ®
                currentQRType = type;
                currentQRData = result;
                
                // æ˜¾ç¤ºäºŒç»´ç ä¿¡æ¯
                let info = `<p><strong>äºŒç»´ç ç±»å‹:</strong> ${type}</p>`;
                if (result.qrCodeURL) {
                    info += `<p><strong>äºŒç»´ç URL:</strong> ${result.qrCodeURL}</p>`;
                }
                if (result.secureToken) {
                    info += `<p><strong>å®‰å…¨ä»¤ç‰Œ:</strong> ${result.secureToken}</p>`;
                }
                if (result.expiresAt) {
                    info += `<p><strong>è¿‡æœŸæ—¶é—´:</strong> ${result.expiresAt}</p>`;
                }
                if (result.miniProgramPath) {
                    info += `<p><strong>å°ç¨‹åºè·¯å¾„:</strong> ${result.miniProgramPath}</p>`;
                }
                
                container.innerHTML += info;
                
            } catch (error) {
                console.error('ç”ŸæˆäºŒç»´ç å¤±è´¥:', error);
                document.getElementById('qr-container').innerHTML = `<div class="result error">ç”Ÿæˆå¤±è´¥: ${error.message}</div>`;
            }
        }
        
        // ç¡®è®¤å°±é¤
        async function confirmDining() {
            try {
                const qrCode = document.getElementById('qrCodeInput').value;
                const resultContainer = document.getElementById('result-container');
                
                if (!qrCode) {
                    resultContainer.innerHTML = '<div class="result error">è¯·è¾“å…¥äºŒç»´ç æ ‡è¯†</div>';
                    return;
                }
                
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                resultContainer.innerHTML = '<div class="loading">ç¡®è®¤ä¸­...</div>';
                
                let result;
                
                if (currentQRType === 'wechat') {
                    result = await confirmWechatDining(qrCode);
                } else {
                    result = await confirmDining(qrCode);
                }
                
                // æ˜¾ç¤ºæˆåŠŸç»“æœ
                const successHtml = `
                    <div class="result success">
                        <h3>âœ… ç¡®è®¤æˆåŠŸï¼</h3>
                        <p><strong>ç”¨æˆ·:</strong> ${result.userName}</p>
                        <p><strong>é¤æ¬¡:</strong> ${result.mealTypeName}</p>
                        <p><strong>æ—¥æœŸ:</strong> ${result.diningDate}</p>
                        <p><strong>æ—¶é—´:</strong> ${result.scanTime}</p>
                        <p><strong>çŠ¶æ€:</strong> ${result.diningStatus}</p>
                    </div>
                `;
                
                resultContainer.innerHTML = successHtml;
                
            } catch (error) {
                console.error('ç¡®è®¤å°±é¤å¤±è´¥:', error);
                document.getElementById('result-container').innerHTML = `<div class="result error">ç¡®è®¤å¤±è´¥: ${error.message}</div>`;
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶ç”Ÿæˆé»˜è®¤äºŒç»´ç 
        window.onload = function() {
            generateQRCode('normal');
        };
    </script>
</body>
</html>
```

## ğŸ“± å¾®ä¿¡å°ç¨‹åºå‰ç«¯å¯¹æ¥

### 1. å°ç¨‹åºé¡µé¢é…ç½®

#### 1.1 é¡µé¢é…ç½®æ–‡ä»¶

**æ–‡ä»¶**: `pages/dining-confirm/dining-confirm.json`
```json
{
  "navigationBarTitleText": "ç”¨é¤ç¡®è®¤",
  "navigationBarBackgroundColor": "#07c160",
  "navigationBarTextStyle": "white",
  "backgroundColor": "#f5f5f5"
}
```

#### 1.2 å°ç¨‹åºä¸»é…ç½®æ–‡ä»¶

**æ–‡ä»¶**: `app.json`
```json
{
  "pages": [
    "pages/index/index",
    "pages/dining-confirm/dining-confirm"
  ],
  "window": {
    "backgroundTextStyle": "light",
    "navigationBarBackgroundColor": "#07c160",
    "navigationBarTitleText": "æ™ºèƒ½ç”¨é¤ç³»ç»Ÿ",
    "navigationBarTextStyle": "white",
    "backgroundColor": "#f5f5f5"
  },
  "networkTimeout": {
    "request": 10000,
    "downloadFile": 10000
  },
  "debug": true
}
```

### 2. å°ç¨‹åºé¡µé¢é€»è¾‘

#### 2.1 é¡µé¢JavaScriptæ–‡ä»¶

**æ–‡ä»¶**: `pages/dining-confirm/dining-confirm.js`

```javascript
// å¾®ä¿¡å°ç¨‹åº - ç”¨é¤ç¡®è®¤é¡µé¢
Page({
  data: {
    qrCode: '',
    userInfo: null,
    isLoggedIn: false,
    scanResult: null,
    loading: false,
    baseURL: 'https://your-domain.com' // æ›¿æ¢ä¸ºå®é™…çš„åç«¯åŸŸå
  },

  onLoad(options) {
    // è·å–äºŒç»´ç å‚æ•°
    const { qrCode } = options;
    this.setData({ qrCode });
    
    // æ£€æŸ¥ç™»å½•çŠ¶æ€
    this.checkLoginStatus();
  },

  onShow() {
    // é¡µé¢æ˜¾ç¤ºæ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
    this.checkLoginStatus();
  },

  /**
   * æ£€æŸ¥ç™»å½•çŠ¶æ€
   */
  checkLoginStatus() {
    const token = wx.getStorageSync('token');
    const userInfo = wx.getStorageSync('userInfo');
    
    if (token && userInfo) {
      this.setData({
        isLoggedIn: true,
        userInfo: userInfo
      });
      
      // å¦‚æœå·²ç™»å½•ï¼Œè‡ªåŠ¨ç¡®è®¤å°±é¤
      this.confirmDining();
    } else {
      this.setData({
        isLoggedIn: false,
        userInfo: null
      });
    }
  },

  /**
   * å¾®ä¿¡ç™»å½•
   */
  async wechatLogin() {
    try {
      this.setData({ loading: true });
      
      // è·å–å¾®ä¿¡æˆæƒç 
      const { code } = await wx.login();
      
      // è·å–ç”¨æˆ·ä¿¡æ¯
      const { encryptedData, iv } = await wx.getUserProfile({
        desc: 'ç”¨äºç¡®è®¤ç”¨é¤èº«ä»½'
      });
      
      // è°ƒç”¨åç«¯ç™»å½•æ¥å£
      const response = await wx.request({
        url: `${this.data.baseURL}/api/auth/wechat-login`,
        method: 'POST',
        data: { 
          code, 
          encryptedData, 
          iv 
        }
      });
      
      const result = response.data;
      
      if (result.success) {
        // ä¿å­˜ç”¨æˆ·ä¿¡æ¯
        wx.setStorageSync('token', result.data.token);
        wx.setStorageSync('userInfo', result.data.userInfo);
        
        this.setData({
          isLoggedIn: true,
          userInfo: result.data.userInfo
        });
        
        // ç™»å½•æˆåŠŸåè‡ªåŠ¨ç¡®è®¤å°±é¤
        this.confirmDining();
      } else {
        wx.showToast({
          title: result.message || 'ç™»å½•å¤±è´¥',
          icon: 'error'
        });
      }
    } catch (error) {
      console.error('å¾®ä¿¡ç™»å½•å¤±è´¥:', error);
      wx.showToast({
        title: 'ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•',
        icon: 'error'
      });
    } finally {
      this.setData({ loading: false });
    }
  },

  /**
   * ç¡®è®¤å°±é¤
   */
  async confirmDining() {
    try {
      this.setData({ loading: true });
      
      const token = wx.getStorageSync('token');
      const scanTime = new Date().toISOString();
      
      // è°ƒç”¨åç«¯ç¡®è®¤å°±é¤æ¥å£
      const response = await wx.request({
        url: `${this.data.baseURL}/api/qr-scan/wechat-scan`,
        method: 'POST',
        header: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        data: {
          qrCode: this.data.qrCode,
          scanTime: scanTime
        }
      });
      
      const result = response.data;
      
      if (result.success) {
        this.setData({
          scanResult: {
            success: true,
            message: result.message,
            data: result.data
          }
        });
        
        wx.showToast({
          title: 'ç¡®è®¤æˆåŠŸï¼',
          icon: 'success'
        });
      } else {
        this.setData({
          scanResult: {
            success: false,
            message: result.message
          }
        });
        
        wx.showToast({
          title: result.message || 'ç¡®è®¤å¤±è´¥',
          icon: 'error'
        });
      }
    } catch (error) {
      console.error('ç¡®è®¤å°±é¤å¤±è´¥:', error);
      wx.showToast({
        title: 'ç¡®è®¤å¤±è´¥ï¼Œè¯·é‡è¯•',
        icon: 'error'
      });
    } finally {
      this.setData({ loading: false });
    }
  },

  /**
   * é‡æ–°ç¡®è®¤
   */
  retryConfirm() {
    this.setData({ scanResult: null });
    this.confirmDining();
  },

  /**
   * è¿”å›é¦–é¡µ
   */
  goHome() {
    wx.switchTab({
      url: '/pages/index/index'
    });
  }
});
```

#### 2.2 é¡µé¢æ¨¡æ¿æ–‡ä»¶

**æ–‡ä»¶**: `pages/dining-confirm/dining-confirm.wxml`

```xml
<!-- å¾®ä¿¡å°ç¨‹åº - ç”¨é¤ç¡®è®¤é¡µé¢æ¨¡æ¿ -->
<view class="container">
  <!-- é¡µé¢æ ‡é¢˜ -->
  <view class="header">
    <text class="title">ç”¨é¤ç¡®è®¤</text>
  </view>

  <!-- ç™»å½•çŠ¶æ€ -->
  <view class="login-section" wx:if="{{!isLoggedIn}}">
    <view class="login-prompt">
      <text class="prompt-text">è¯·å…ˆç™»å½•ä»¥ç¡®è®¤ç”¨é¤</text>
    </view>
    <button 
      class="login-btn" 
      bindtap="wechatLogin"
      loading="{{loading}}"
      disabled="{{loading}}"
    >
      {{loading ? 'ç™»å½•ä¸­...' : 'å¾®ä¿¡ç™»å½•'}}
    </button>
  </view>

  <!-- å·²ç™»å½•çŠ¶æ€ -->
  <view class="logged-in-section" wx:if="{{isLoggedIn}}">
    <!-- ç”¨æˆ·ä¿¡æ¯ -->
    <view class="user-info">
      <image class="avatar" src="{{userInfo.avatarUrl || '/images/default-avatar.png'}}" />
      <text class="user-name">{{userInfo.nickName}}</text>
    </view>

    <!-- äºŒç»´ç ä¿¡æ¯ -->
    <view class="qr-info">
      <text class="qr-label">äºŒç»´ç æ ‡è¯†ï¼š</text>
      <text class="qr-code">{{qrCode}}</text>
    </view>

    <!-- ç¡®è®¤æŒ‰é’® -->
    <button 
      class="confirm-btn" 
      bindtap="confirmDining"
      loading="{{loading}}"
      disabled="{{loading}}"
    >
      {{loading ? 'ç¡®è®¤ä¸­...' : 'ç¡®è®¤ç”¨é¤'}}
    </button>
  </view>

  <!-- ç¡®è®¤ç»“æœ -->
  <view class="result-section" wx:if="{{scanResult}}">
    <view class="result-card {{scanResult.success ? 'success' : 'error'}}">
      <view class="result-icon">
        <text class="icon">{{scanResult.success ? 'âœ…' : 'âŒ'}}</text>
      </view>
      <view class="result-content">
        <text class="result-title">{{scanResult.success ? 'ç¡®è®¤æˆåŠŸ' : 'ç¡®è®¤å¤±è´¥'}}</text>
        <text class="result-message">{{scanResult.message}}</text>
        
        <!-- æˆåŠŸæ—¶æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯ -->
        <view class="result-details" wx:if="{{scanResult.success && scanResult.data}}">
          <view class="detail-item">
            <text class="detail-label">é¤æ¬¡ï¼š</text>
            <text class="detail-value">{{scanResult.data.mealTypeName}}</text>
          </view>
          <view class="detail-item">
            <text class="detail-label">æ—¥æœŸï¼š</text>
            <text class="detail-value">{{scanResult.data.diningDate}}</text>
          </view>
          <view class="detail-item">
            <text class="detail-label">æ—¶é—´ï¼š</text>
            <text class="detail-value">{{scanResult.data.scanTime}}</text>
          </view>
        </view>
      </view>
    </view>

    <!-- æ“ä½œæŒ‰é’® -->
    <view class="action-buttons">
      <button class="retry-btn" bindtap="retryConfirm" wx:if="{{!scanResult.success}}">
        é‡æ–°ç¡®è®¤
      </button>
      <button class="home-btn" bindtap="goHome">
        è¿”å›é¦–é¡µ
      </button>
    </view>
  </view>
</view>
```

#### 2.3 é¡µé¢æ ·å¼æ–‡ä»¶

**æ–‡ä»¶**: `pages/dining-confirm/dining-confirm.wxss`

```css
/* å¾®ä¿¡å°ç¨‹åº - ç”¨é¤ç¡®è®¤é¡µé¢æ ·å¼ */
.container {
  padding: 40rpx;
  min-height: 100vh;
  background-color: #f5f5f5;
}

/* é¡µé¢æ ‡é¢˜ */
.header {
  text-align: center;
  margin-bottom: 60rpx;
}

.title {
  font-size: 48rpx;
  font-weight: bold;
  color: #333;
}

/* ç™»å½•éƒ¨åˆ† */
.login-section {
  text-align: center;
  padding: 80rpx 40rpx;
}

.login-prompt {
  margin-bottom: 60rpx;
}

.prompt-text {
  font-size: 32rpx;
  color: #666;
}

.login-btn {
  width: 400rpx;
  height: 88rpx;
  background-color: #07c160;
  color: white;
  border-radius: 44rpx;
  font-size: 32rpx;
  display: flex;
  align-items: center;
  justify-content: center;
}

.login-btn:disabled {
  background-color: #ccc;
}

/* å·²ç™»å½•éƒ¨åˆ† */
.logged-in-section {
  background-color: white;
  border-radius: 20rpx;
  padding: 40rpx;
  margin-bottom: 40rpx;
}

.user-info {
  display: flex;
  align-items: center;
  margin-bottom: 40rpx;
  padding-bottom: 40rpx;
  border-bottom: 1rpx solid #eee;
}

.avatar {
  width: 80rpx;
  height: 80rpx;
  border-radius: 40rpx;
  margin-right: 20rpx;
}

.user-name {
  font-size: 32rpx;
  color: #333;
  font-weight: bold;
}

.qr-info {
  margin-bottom: 40rpx;
}

.qr-label {
  font-size: 28rpx;
  color: #666;
}

.qr-code {
  font-size: 28rpx;
  color: #333;
  font-weight: bold;
  margin-left: 10rpx;
}

.confirm-btn {
  width: 100%;
  height: 88rpx;
  background-color: #07c160;
  color: white;
  border-radius: 44rpx;
  font-size: 32rpx;
  display: flex;
  align-items: center;
  justify-content: center;
}

.confirm-btn:disabled {
  background-color: #ccc;
}

/* ç»“æœéƒ¨åˆ† */
.result-section {
  background-color: white;
  border-radius: 20rpx;
  padding: 40rpx;
}

.result-card {
  text-align: center;
  padding: 40rpx;
  border-radius: 20rpx;
}

.result-card.success {
  background-color: #f0f9ff;
  border: 2rpx solid #07c160;
}

.result-card.error {
  background-color: #fff5f5;
  border: 2rpx solid #ff4757;
}

.result-icon {
  margin-bottom: 20rpx;
}

.icon {
  font-size: 80rpx;
}

.result-content {
  margin-bottom: 40rpx;
}

.result-title {
  font-size: 36rpx;
  font-weight: bold;
  color: #333;
  display: block;
  margin-bottom: 20rpx;
}

.result-message {
  font-size: 28rpx;
  color: #666;
  display: block;
}

.result-details {
  margin-top: 40rpx;
  text-align: left;
}

.detail-item {
  display: flex;
  margin-bottom: 20rpx;
}

.detail-label {
  font-size: 28rpx;
  color: #666;
  width: 120rpx;
}

.detail-value {
  font-size: 28rpx;
  color: #333;
  font-weight: bold;
}

/* æ“ä½œæŒ‰é’® */
.action-buttons {
  display: flex;
  gap: 20rpx;
}

.retry-btn {
  flex: 1;
  height: 88rpx;
  background-color: #ff4757;
  color: white;
  border-radius: 44rpx;
  font-size: 28rpx;
}

.home-btn {
  flex: 1;
  height: 88rpx;
  background-color: #007bff;
  color: white;
  border-radius: 44rpx;
  font-size: 28rpx;
}
```

### 3. å°ç¨‹åºä¸»å…¥å£æ–‡ä»¶

**æ–‡ä»¶**: `app.js`

```javascript
// å¾®ä¿¡å°ç¨‹åºä¸»å…¥å£
App({
  onLaunch() {
    console.log('å°ç¨‹åºå¯åŠ¨');
    
    // æ£€æŸ¥æ›´æ–°
    this.checkForUpdate();
  },

  onShow() {
    console.log('å°ç¨‹åºæ˜¾ç¤º');
  },

  onHide() {
    console.log('å°ç¨‹åºéšè—');
  },

  onError(error) {
    console.error('å°ç¨‹åºé”™è¯¯:', error);
  },

  /**
   * æ£€æŸ¥å°ç¨‹åºæ›´æ–°
   */
  checkForUpdate() {
    if (wx.canIUse('getUpdateManager')) {
      const updateManager = wx.getUpdateManager();
      
      updateManager.onCheckForUpdate((res) => {
        if (res.hasUpdate) {
          console.log('å‘ç°æ–°ç‰ˆæœ¬');
        }
      });
      
      updateManager.onUpdateReady(() => {
        wx.showModal({
          title: 'æ›´æ–°æç¤º',
          content: 'æ–°ç‰ˆæœ¬å·²ç»å‡†å¤‡å¥½ï¼Œæ˜¯å¦é‡å¯åº”ç”¨ï¼Ÿ',
          success: (res) => {
            if (res.confirm) {
              updateManager.applyUpdate();
            }
          }
        });
      });
      
      updateManager.onUpdateFailed(() => {
        console.error('æ–°ç‰ˆæœ¬ä¸‹è½½å¤±è´¥');
      });
    }
  },

  /**
   * å…¨å±€æ•°æ®
   */
  globalData: {
    userInfo: null,
    token: null,
    baseURL: 'https://your-domain.com' // æ›¿æ¢ä¸ºå®é™…çš„åç«¯åŸŸå
  }
});
```

## ğŸ”§ é…ç½®è¯´æ˜

### 1. ç¯å¢ƒé…ç½®

#### 1.1 å¼€å‘ç¯å¢ƒ
```javascript
// å¼€å‘ç¯å¢ƒé…ç½®
const config = {
  baseURL: 'http://localhost:3000',
  debug: true,
  timeout: 10000
};
```

#### 1.2 ç”Ÿäº§ç¯å¢ƒ
```javascript
// ç”Ÿäº§ç¯å¢ƒé…ç½®
const config = {
  baseURL: 'https://your-domain.com',
  debug: false,
  timeout: 10000
};
```

### 2. å¾®ä¿¡å°ç¨‹åºé…ç½®

#### 2.1 æœåŠ¡å™¨åŸŸåé…ç½®

éœ€è¦åœ¨å¾®ä¿¡å…¬ä¼—å¹³å°é…ç½®ä»¥ä¸‹åŸŸåï¼š

**requeståˆæ³•åŸŸå**:
- `https://your-domain.com` (åç«¯APIåŸŸå)

**downloadFileåˆæ³•åŸŸå**:
- `https://your-domain.com` (åç«¯APIåŸŸå)

#### 2.2 é¡µé¢è·¯å¾„é…ç½®

ç¡®ä¿åœ¨ `app.json` ä¸­æ­£ç¡®é…ç½®é¡µé¢è·¯å¾„ï¼š

```json
{
  "pages": [
    "pages/index/index",
    "pages/dining-confirm/dining-confirm"
  ]
}
```

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. å®‰å…¨æ³¨æ„äº‹é¡¹

- æ‰€æœ‰APIè°ƒç”¨éƒ½éœ€è¦JWT tokenéªŒè¯
- æ•æ„Ÿä¿¡æ¯ä¸è¦åœ¨å‰ç«¯ç¡¬ç¼–ç 
- ä½¿ç”¨HTTPSåè®®ä¿æŠ¤æ•°æ®ä¼ è¾“
- å®šæœŸæ›´æ–°tokenï¼Œé¿å…è¿‡æœŸ

### 2. é”™è¯¯å¤„ç†

- ç½‘ç»œè¯·æ±‚å¤±è´¥æ—¶æ˜¾ç¤ºå‹å¥½æç¤º
- ç™»å½•å¤±è´¥æ—¶å¼•å¯¼ç”¨æˆ·é‡æ–°ç™»å½•
- ç¡®è®¤å¤±è´¥æ—¶æ˜¾ç¤ºå…·ä½“é”™è¯¯åŸå› 
- æä¾›é‡è¯•æœºåˆ¶

### 3. ç”¨æˆ·ä½“éªŒ

- åŠ è½½çŠ¶æ€è¦æœ‰æ˜ç¡®çš„æç¤º
- æ“ä½œç»“æœè¦æœ‰æ¸…æ™°çš„åé¦ˆ
- é”™è¯¯ä¿¡æ¯è¦ç”¨æˆ·å‹å¥½
- ç•Œé¢è¦å“åº”å¼è®¾è®¡

### 4. æ€§èƒ½ä¼˜åŒ–

- åˆç†ä½¿ç”¨ç¼“å­˜æœºåˆ¶
- é¿å…é‡å¤è¯·æ±‚
- ä¼˜åŒ–å›¾ç‰‡åŠ è½½
- å‡å°‘ä¸å¿…è¦çš„æ¸²æŸ“

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·è”ç³»æŠ€æœ¯æ”¯æŒå›¢é˜Ÿï¼š
- é‚®ç®±: support@example.com
- ç”µè¯: 400-123-4567
- å¾®ä¿¡: tech_support
