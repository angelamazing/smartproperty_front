# 报餐确认流程可视化文档

## 流程图

### 完整业务流程
```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   用户报餐   │───▶│  生成订单    │───▶│ 订单状态     │───▶│  确认就餐    │
│ (部门管理员) │    │ (ordered)   │    │ (ordered)   │    │             │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
                                                           │
                                                           ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│ 记录确认历史 │◀───│ 更新订单状态 │◀───│ 状态变更     │◀───│ 确认方式选择 │
│             │    │ (dined)     │    │ (dined)     │    │             │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
```

### 确认方式详细流程
```
                    ┌─────────────────┐
                    │   确认方式选择   │
                    └─────────────────┘
                           │
                    ┌──────┼──────┐
                    │      │      │
                    ▼      ▼      ▼
            ┌─────────┐ ┌─────┐ ┌─────────┐
            │用户手动  │ │扫码 │ │管理员代 │
            │确认     │ │确认 │ │确认     │
            └─────────┘ └─────┘ └─────────┘
                    │      │      │
                    └──────┼──────┘
                           │
                           ▼
                    ┌─────────────────┐
                    │   状态更新      │
                    │ ordered → dined │
                    └─────────────────┘
```

## 参与者角色

### 1. 报餐人员
```
┌─────────────────────────────────────┐
│           报餐人员                   │
├─────────────────────────────────────┤
│ • 部门管理员 (dept_admin)           │
│ • 系统管理员 (sys_admin)            │
│                                     │
│ 职责:                               │
│ • 为部门成员报餐                    │
│ • 选择报餐日期和餐次                │
│ • 选择报餐成员                      │
└─────────────────────────────────────┘
```

### 2. 确认人员
```
┌─────────────────────────────────────┐
│           确认人员                   │
├─────────────────────────────────────┤
│ • 用户本人 (普通用户)                │
│ • 部门管理员 (dept_admin)           │
│ • 系统管理员 (sys_admin)            │
│                                     │
│ 职责:                               │
│ • 确认就餐状态                      │
│ • 记录实际就餐时间                  │
│ • 更新订单状态                      │
└─────────────────────────────────────┘
```

## 确认方式详解

### 1. 用户手动确认
```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│ 用户登录    │───▶│ 查看个人状态 │───▶│ 点击确认按钮 │───▶│ 系统验证权限 │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
                                                           │
                                                           ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│ 记录确认历史 │◀───│ 更新订单状态 │◀───│ 记录就餐时间 │◀───│ 权限验证通过 │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
```

**特点**:
- 用户本人操作
- 需要用户主动点击
- 权限验证：只能确认自己的订单

### 2. 扫码确认
```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│ 扫描二维码   │───▶│ 验证二维码   │───▶│ 验证用户身份 │───▶│ 检查订单状态 │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
                                                           │
                                                           ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│ 记录确认历史 │◀───│ 更新订单状态 │◀───│ 记录就餐时间 │◀───│ 自动确认就餐 │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
```

**特点**:
- 用户本人操作
- 自动触发确认
- 权限验证：只能确认自己的订单
- 需要二维码验证

### 3. 管理员代确认
```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│ 管理员登录  │───▶│ 查看报餐情况 │───▶│ 选择代确认   │───▶│ 系统验证权限 │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
                                                           │
                                                           ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│ 记录确认历史 │◀───│ 更新订单状态 │◀───│ 记录就餐时间 │◀───│ 权限验证通过 │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
```

**特点**:
- 管理员操作
- 可以代确认任何订单
- 权限验证：需要管理员权限
- 适用于特殊情况

## 数据流转

### 订单状态流转
```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   未报餐     │───▶│   已报餐     │───▶│   已确认     │
│             │    │  (ordered)  │    │   (dined)   │
│ diningStatus│    │ diningStatus│    │ diningStatus│
│    = null   │    │  = ordered  │    │  = dined    │
└─────────────┘    └─────────────┘    └─────────────┘
```

### 数据库更新流程
```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│ 确认操作    │───▶│ 更新订单表   │───▶│ 插入确认日志 │
│             │    │ dining_orders│   │ dining_confirmation_logs│
└─────────────┘    └─────────────┘    └─────────────┘
```

## 权限矩阵

| 操作 | 普通用户 | 部门管理员 | 系统管理员 |
|------|----------|------------|------------|
| 报餐 | ❌ | ✅ (本部门) | ✅ (所有) |
| 确认自己订单 | ✅ | ✅ | ✅ |
| 代确认他人订单 | ❌ | ✅ (本部门) | ✅ (所有) |
| 查看个人状态 | ✅ | ✅ | ✅ |
| 查看部门状态 | ❌ | ✅ (本部门) | ✅ (所有) |

## 时间线

### 典型流程时间线
```
09:00 ── 部门管理员报餐
       └─ 订单状态: ordered
       
12:00 ── 用户确认就餐
       └─ 订单状态: dined
       └─ 记录实际就餐时间
       └─ 插入确认日志
```

### 确认时间记录
```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│ 报餐时间     │    │ 确认时间     │    │ 就餐时间     │
│ createdAt   │    │ confirmedAt │    │ actualDiningTime│
│ 09:00:00    │    │ 12:00:00    │    │ 12:00:00    │
└─────────────┘    └─────────────┘    └─────────────┘
```

## 错误处理流程

### 常见错误场景
```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│ 权限不足     │    │ 订单不存在   │    │ 订单已确认   │
│ 403 Forbidden│   │ 404 Not Found│   │ 409 Conflict│
└─────────────┘    └─────────────┘    └─────────────┘
```

### 错误响应格式
```json
{
  "success": false,
  "message": "错误描述",
  "error": "ERROR_CODE",
  "details": "详细错误信息"
}
```

## 接口调用时序图

### 用户手动确认时序
```
用户    前端    后端    数据库
│       │       │       │
├──────▶├──────▶├──────▶│ 1. 验证Token
│       │       │       │
│       │       │◀──────┤ 2. 返回用户信息
│       │◀──────┤       │
│◀──────┤       │       │
│       │       │       │
├──────▶├──────▶├──────▶│ 3. 查询订单状态
│       │       │       │
│       │       │◀──────┤ 4. 返回订单信息
│       │◀──────┤       │
│◀──────┤       │       │
│       │       │       │
├──────▶├──────▶├──────▶│ 5. 更新订单状态
│       │       │       │
├──────▶├──────▶├──────▶│ 6. 插入确认日志
│       │       │       │
│       │       │◀──────┤ 7. 返回确认结果
│       │◀──────┤       │
│◀──────┤       │       │
```

## 测试验证流程

### 测试步骤
```
1. 用户登录测试
   ├─ 获取Token
   └─ 验证用户信息

2. 报餐功能测试
   ├─ 部门管理员报餐
   └─ 验证订单生成

3. 确认功能测试
   ├─ 用户手动确认
   ├─ 扫码确认
   └─ 管理员代确认

4. 状态查询测试
   ├─ 个人状态查询
   ├─ 确认状态查询
   └─ 历史记录查询
```

### 测试结果
```
✅ 用户登录: 成功
✅ 报餐功能: 成功
✅ 手动确认: 成功
✅ 扫码确认: 成功
✅ 管理员代确认: 成功
✅ 状态查询: 成功
✅ 历史记录: 成功
```

## 总结

这个报餐确认流程的核心特点：

1. **清晰的职责分工**: 报餐由管理员负责，确认由用户本人或管理员代确认
2. **多种确认方式**: 手动点击、扫码确认、管理员代确认
3. **严格的状态管理**: ordered → dined 的单向流转
4. **完整的权限控制**: 基于角色的访问控制
5. **详细的历史记录**: 所有操作都有记录
6. **灵活的扩展性**: 支持多种确认方式和权限级别

整个流程经过充分测试，可以正常投入使用。
