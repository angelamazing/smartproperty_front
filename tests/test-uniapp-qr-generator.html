<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>uniapp 二维码生成器测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        .test-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
        }
        .test-button {
            background: #2196f3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #1976d2;
        }
        .test-result {
            background: #f0f0f0;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 4px solid #2196f3;
        }
        .error {
            border-left-color: #f44336;
            background: #ffebee;
        }
        .success {
            border-left-color: #4caf50;
            background: #e8f5e8;
        }
        .qr-content {
            font-family: monospace;
            background: #f5f5f5;
            padding: 10px;
            border-radius: 3px;
            word-break: break-all;
            margin: 10px 0;
        }
        .qr-display {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            background: #f9f9f9;
            margin: 10px 0;
        }
        .platform-info {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>uniapp 二维码生成器测试</h1>
    <p>基于 <a href="https://blog.csdn.net/yehaocheng520/article/details/133020626" target="_blank">uniapp uv-Qrcode 插件</a> 的二维码生成方案</p>
    
    <div class="test-section">
        <div class="test-title">1. 环境检测</div>
        <button class="test-button" onclick="testEnvironmentDetection()">检测当前环境</button>
        <div id="env-result" class="test-result" style="display: none;"></div>
    </div>
    
    <div class="test-section">
        <div class="test-title">2. 测试固定二维码生成</div>
        <button class="test-button" onclick="testFixedQRGeneration()">生成固定二维码</button>
        <div id="fixed-qr-result" class="test-result" style="display: none;"></div>
    </div>
    
    <div class="test-section">
        <div class="test-title">3. 测试就餐确认二维码生成</div>
        <button class="test-button" onclick="testDiningConfirmQR()">生成就餐确认二维码</button>
        <div id="dining-qr-result" class="test-result" style="display: none;"></div>
    </div>
    
    <div class="test-section">
        <div class="test-title">4. 测试微信小程序码生成</div>
        <button class="test-button" onclick="testWechatMiniProgramQR()">生成微信小程序码</button>
        <div id="wechat-qr-result" class="test-result" style="display: none;"></div>
    </div>
    
    <div class="test-section">
        <div class="test-title">5. 测试保存功能</div>
        <button class="test-button" onclick="testSaveFunction()">测试保存功能</button>
        <div id="save-result" class="test-result" style="display: none;"></div>
    </div>

    <script>
        // 模拟 uniapp 环境
        if (typeof uni === 'undefined') {
            window.uni = {
                canvasToTempFilePath: function(options) {
                    return new Promise((resolve, reject) => {
                        setTimeout(() => {
                            resolve({
                                tempFilePath: 'mock_temp_file_path.png'
                            })
                        }, 1000)
                    })
                },
                saveImageToPhotosAlbum: function(options) {
                    return new Promise((resolve, reject) => {
                        setTimeout(() => {
                            resolve({})
                        }, 1000)
                    })
                }
            }
        }

        // 模拟微信小程序环境
        if (typeof wx === 'undefined') {
            window.wx = {
                getSystemInfoSync: function() {
                    return { platform: 'devtools' }
                }
            }
        }

        // 模拟 uniapp 二维码生成器
        const FIXED_QR_CODE_ID = 'DINING_CONFIRM_FIXED_001'
        
        const isUniApp = () => {
            return typeof uni !== 'undefined'
        }
        
        const isWechatMiniProgram = () => {
            return typeof wx !== 'undefined' && wx.getSystemInfoSync
        }

        const generateSceneToken = () => {
            const timestamp = Date.now()
            const random = Math.random().toString(36).substr(2, 9)
            return `dining_${timestamp}_${random}`
        }

        const generateDiningConfirmURL = (sceneToken, baseURL = '') => {
            const base = baseURL || (typeof window !== 'undefined' ? window.location.origin : '')
            return `${base}/pages/dining/external-scan?scene_token=${sceneToken}`
        }

        const generateWechatMiniProgramParams = (sceneToken) => {
            return `scene_token=${sceneToken}`
        }

        // 测试环境检测
        function testEnvironmentDetection() {
            const resultDiv = document.getElementById('env-result')
            resultDiv.style.display = 'block'
            
            const isUni = isUniApp()
            const isWechat = isWechatMiniProgram()
            const isWeb = typeof window !== 'undefined'
            
            let platform = '未知'
            let recommendation = ''
            
            if (isUni && isWechat) {
                platform = 'uniapp + 微信小程序'
                recommendation = '使用 uniapp 二维码组件，显示内容模式'
            } else if (isUni) {
                platform = 'uniapp'
                recommendation = '使用 uniapp 二维码组件，canvas 渲染模式'
            } else if (isWechat) {
                platform = '微信小程序'
                recommendation = '使用内容显示模式，直接返回二维码内容'
            } else if (isWeb) {
                platform = 'Web浏览器'
                recommendation = '使用图片生成模式，生成真正的二维码图片'
            }
            
            resultDiv.className = 'test-result success'
            resultDiv.innerHTML = `
                <h4>✅ 环境检测完成</h4>
                <div class="platform-info">
                    <p><strong>当前平台:</strong> ${platform}</p>
                    <p><strong>uni对象:</strong> ${isUni ? '存在' : '不存在'}</p>
                    <p><strong>wx对象:</strong> ${isWechat ? '存在' : '不存在'}</p>
                    <p><strong>window对象:</strong> ${isWeb ? '存在' : '不存在'}</p>
                </div>
                <p><strong>推荐方案:</strong> ${recommendation}</p>
                <p><strong>二维码显示:</strong> ${isUni ? '使用 uniapp 二维码组件' : (isWechat ? '显示内容文字' : '显示图片')}</p>
            `
        }

        // 测试固定二维码生成
        async function testFixedQRGeneration() {
            const resultDiv = document.getElementById('fixed-qr-result')
            resultDiv.style.display = 'block'
            resultDiv.className = 'test-result'
            resultDiv.innerHTML = '正在生成固定二维码...'
            
            try {
                const timestamp = Date.now()
                const qrContent = `${FIXED_QR_CODE_ID}_${timestamp}`
                
                const result = {
                    success: true,
                    data: {
                        qrCodeImage: qrContent,
                        content: qrContent,
                        qrCodeId: FIXED_QR_CODE_ID,
                        timestamp: timestamp,
                        type: 'fixed_dining_confirm',
                        platform: isUniApp() ? 'uniapp' : (isWechatMiniProgram() ? 'wechat_miniprogram' : 'web'),
                        canvasId: `qrcode_${timestamp}`,
                        size: '300rpx',
                        options: {
                            useDynamicSize: false,
                            errorCorrectLevel: 'Q',
                            margin: 10,
                            areaColor: "#fff"
                        }
                    }
                }
                
                resultDiv.className = 'test-result success'
                resultDiv.innerHTML = `
                    <h4>✅ 固定二维码生成成功</h4>
                    <div class="qr-display">
                        <h5>二维码内容（${result.data.platform} 环境）</h5>
                        <div class="qr-content">${result.data.content}</div>
                    </div>
                    <p><strong>生成时间:</strong> ${new Date(result.data.timestamp).toLocaleString()}</p>
                    <p><strong>平台:</strong> ${result.data.platform}</p>
                    <p><strong>Canvas ID:</strong> ${result.data.canvasId}</p>
                    <p><strong>尺寸:</strong> ${result.data.size}</p>
                    <p><strong>状态:</strong> 已生成，可直接使用</p>
                `
            } catch (error) {
                resultDiv.className = 'test-result error'
                resultDiv.innerHTML = `
                    <h4>❌ 固定二维码生成失败</h4>
                    <p><strong>错误信息:</strong> ${error.message}</p>
                `
            }
        }

        // 测试就餐确认二维码生成
        async function testDiningConfirmQR() {
            const resultDiv = document.getElementById('dining-qr-result')
            resultDiv.style.display = 'block'
            resultDiv.className = 'test-result'
            resultDiv.innerHTML = '正在生成就餐确认二维码...'
            
            try {
                const sceneToken = generateSceneToken()
                const content = generateDiningConfirmURL(sceneToken)
                
                const result = {
                    success: true,
                    data: {
                        qrCodeImage: content,
                        content: content,
                        sceneToken: sceneToken,
                        type: 'url',
                        platform: isUniApp() ? 'uniapp' : (isWechatMiniProgram() ? 'wechat_miniprogram' : 'web')
                    }
                }
                
                resultDiv.className = 'test-result success'
                resultDiv.innerHTML = `
                    <h4>✅ 就餐确认二维码生成成功</h4>
                    <div class="qr-display">
                        <h5>二维码内容</h5>
                        <div class="qr-content">${result.data.content}</div>
                    </div>
                    <p><strong>场景令牌:</strong></p>
                    <div class="qr-content">${result.data.sceneToken}</div>
                    <p><strong>类型:</strong> ${result.data.type}</p>
                    <p><strong>平台:</strong> ${result.data.platform}</p>
                `
            } catch (error) {
                resultDiv.className = 'test-result error'
                resultDiv.innerHTML = `
                    <h4>❌ 就餐确认二维码生成失败</h4>
                    <p><strong>错误信息:</strong> ${error.message}</p>
                `
            }
        }

        // 测试微信小程序码生成
        async function testWechatMiniProgramQR() {
            const resultDiv = document.getElementById('wechat-qr-result')
            resultDiv.style.display = 'block'
            resultDiv.className = 'test-result'
            resultDiv.innerHTML = '正在生成微信小程序码...'
            
            try {
                const sceneToken = generateSceneToken()
                const content = generateWechatMiniProgramParams(sceneToken)
                
                const result = {
                    success: true,
                    data: {
                        qrCodeImage: content,
                        content: content,
                        sceneToken: sceneToken,
                        type: 'wechat_miniprogram',
                        platform: isUniApp() ? 'uniapp' : (isWechatMiniProgram() ? 'wechat_miniprogram' : 'web')
                    }
                }
                
                resultDiv.className = 'test-result success'
                resultDiv.innerHTML = `
                    <h4>✅ 微信小程序码生成成功</h4>
                    <div class="qr-display">
                        <h5>小程序码参数</h5>
                        <div class="qr-content">${result.data.content}</div>
                    </div>
                    <p><strong>场景令牌:</strong></p>
                    <div class="qr-content">${result.data.sceneToken}</div>
                    <p><strong>类型:</strong> ${result.data.type}</p>
                    <p><strong>平台:</strong> ${result.data.platform}</p>
                `
            } catch (error) {
                resultDiv.className = 'test-result error'
                resultDiv.innerHTML = `
                    <h4>❌ 微信小程序码生成失败</h4>
                    <p><strong>错误信息:</strong> ${error.message}</p>
                `
            }
        }

        // 测试保存功能
        async function testSaveFunction() {
            const resultDiv = document.getElementById('save-result')
            resultDiv.style.display = 'block'
            resultDiv.className = 'test-result'
            resultDiv.innerHTML = '正在测试保存功能...'
            
            try {
                const isUni = isUniApp()
                const isWechat = isWechatMiniProgram()
                const isWeb = typeof window !== 'undefined'
                
                let saveMethod = ''
                let saveResult = ''
                
                if (isUni) {
                    saveMethod = 'uniapp 保存到相册'
                    // 模拟 uniapp 保存
                    await uni.canvasToTempFilePath({
                        canvasId: 'test_canvas'
                    })
                    await uni.saveImageToPhotosAlbum({
                        filePath: 'mock_temp_file_path.png'
                    })
                    saveResult = '模拟保存到相册成功'
                } else if (isWeb) {
                    saveMethod = 'Web 下载'
                    // 模拟 Web 下载
                    const link = document.createElement('a')
                    link.download = 'qrcode.png'
                    link.href = 'data:image/png;base64,mock_data'
                    document.body.appendChild(link)
                    link.click()
                    document.body.removeChild(link)
                    saveResult = '模拟下载成功'
                } else {
                    saveMethod = '不支持'
                    saveResult = '当前环境不支持保存功能'
                }
                
                resultDiv.className = 'test-result success'
                resultDiv.innerHTML = `
                    <h4>✅ 保存功能测试完成</h4>
                    <p><strong>保存方法:</strong> ${saveMethod}</p>
                    <p><strong>测试结果:</strong> ${saveResult}</p>
                    <p><strong>环境:</strong> ${isUni ? 'uniapp' : (isWechat ? '微信小程序' : 'Web浏览器')}</p>
                `
            } catch (error) {
                resultDiv.className = 'test-result error'
                resultDiv.innerHTML = `
                    <h4>❌ 保存功能测试失败</h4>
                    <p><strong>错误信息:</strong> ${error.message}</p>
                `
            }
        }
    </script>
</body>
</html>
