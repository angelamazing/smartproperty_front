<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>高质量二维码生成器测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        .test-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
        }
        .test-button {
            background: #2196f3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #1976d2;
        }
        .test-result {
            background: #f0f0f0;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 4px solid #2196f3;
        }
        .error {
            border-left-color: #f44336;
            background: #ffebee;
        }
        .success {
            border-left-color: #4caf50;
            background: #e8f5e8;
        }
        .qr-content {
            font-family: monospace;
            background: #f5f5f5;
            padding: 10px;
            border-radius: 3px;
            word-break: break-all;
            margin: 10px 0;
        }
        .qr-display {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            background: #f9f9f9;
            margin: 10px 0;
        }
        .qr-comparison {
            display: flex;
            gap: 20px;
            margin: 20px 0;
        }
        .qr-item {
            flex: 1;
            text-align: center;
        }
        .qr-item h4 {
            margin-bottom: 10px;
            color: #333;
        }
        .qr-canvas {
            border: 1px solid #ddd;
            border-radius: 5px;
            margin: 10px 0;
        }
        .quality-info {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .scale-info {
            background: #fff3e0;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>高质量二维码生成器测试</h1>
    <p>基于 <a href="https://www.cnblogs.com/whkl-m/p/10797776.html" target="_blank">QRCode.js 生成二维码</a> 的高质量解决方案</p>
    
    <div class="test-section">
        <div class="test-title">1. 环境检测和库加载</div>
        <button class="test-button" onclick="testEnvironmentAndLibrary()">检测环境和加载库</button>
        <div id="env-result" class="test-result" style="display: none;"></div>
    </div>
    
    <div class="test-section">
        <div class="test-title">2. 测试短字符串二维码生成</div>
        <button class="test-button" onclick="testShortStringQR()">生成短字符串二维码</button>
        <div id="short-qr-result" class="test-result" style="display: none;"></div>
    </div>
    
    <div class="test-section">
        <div class="test-title">3. 测试长字符串二维码生成（解决模糊问题）</div>
        <button class="test-button" onclick="testLongStringQR()">生成长字符串二维码</button>
        <div id="long-qr-result" class="test-result" style="display: none;"></div>
    </div>
    
    <div class="test-section">
        <div class="test-title">4. 二维码质量对比</div>
        <button class="test-button" onclick="testQualityComparison()">对比二维码质量</button>
        <div id="comparison-result" class="test-result" style="display: none;"></div>
    </div>
    
    <div class="test-section">
        <div class="test-title">5. 测试容错级别（解决长字符串报错）</div>
        <button class="test-button" onclick="testErrorCorrectionLevel()">测试容错级别</button>
        <div id="error-correction-result" class="test-result" style="display: none;"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/qrcode2@1.2.3/dist/qrcode.min.js"></script>
    <script>
        // 测试环境检测和库加载
        async function testEnvironmentAndLibrary() {
            const resultDiv = document.getElementById('env-result')
            resultDiv.style.display = 'block'
            resultDiv.className = 'test-result'
            resultDiv.innerHTML = '正在检测环境和加载库...'
            
            try {
                // 检测环境
                const isWeb = typeof window !== 'undefined' && typeof document !== 'undefined'
                const isUniApp = typeof uni !== 'undefined'
                const isWechat = typeof wx !== 'undefined' && wx.getSystemInfoSync
                
                // 检测qrcode2库
                const qrcode2Available = typeof QRCode !== 'undefined'
                
                let platform = '未知'
                if (isWeb) platform = 'Web浏览器'
                else if (isUniApp) platform = 'uniapp'
                else if (isWechat) platform = '微信小程序'
                
                resultDiv.className = 'test-result success'
                resultDiv.innerHTML = `
                    <h4>✅ 环境检测完成</h4>
                    <div class="quality-info">
                        <p><strong>当前平台:</strong> ${platform}</p>
                        <p><strong>qrcode2库:</strong> ${qrcode2Available ? '已加载' : '未加载'}</p>
                        <p><strong>Canvas支持:</strong> ${document.createElement('canvas').getContext ? '支持' : '不支持'}</p>
                        <p><strong>推荐方案:</strong> ${isWeb ? '使用qrcode2生成高质量二维码' : '使用内容显示模式'}</p>
                    </div>
                `
            } catch (error) {
                resultDiv.className = 'test-result error'
                resultDiv.innerHTML = `
                    <h4>❌ 环境检测失败</h4>
                    <p><strong>错误信息:</strong> ${error.message}</p>
                `
            }
        }

        // 测试短字符串二维码生成
        async function testShortStringQR() {
            const resultDiv = document.getElementById('short-qr-result')
            resultDiv.style.display = 'block'
            resultDiv.className = 'test-result'
            resultDiv.innerHTML = '正在生成短字符串二维码...'
            
            try {
                const shortContent = 'https://www.baidu.com'
                const canvasId = 'short-qr-canvas'
                
                // 创建canvas
                const canvas = document.createElement('canvas')
                canvas.id = canvasId
                canvas.width = 256
                canvas.height = 256
                canvas.style.width = '256px'
                canvas.style.height = '256px'
                canvas.style.border = '1px solid #ddd'
                canvas.style.borderRadius = '5px'
                
                // 生成二维码
                const qrCode = new QRCode(canvas, {
                    text: shortContent,
                    width: 256,
                    height: 256,
                    colorDark: "#000000",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H
                })
                
                // 等待生成完成
                await new Promise(resolve => setTimeout(resolve, 200))
                
                resultDiv.className = 'test-result success'
                resultDiv.innerHTML = `
                    <h4>✅ 短字符串二维码生成成功</h4>
                    <div class="qr-display">
                        <h5>二维码内容</h5>
                        <div class="qr-content">${shortContent}</div>
                        <div style="margin-top: 10px;">
                            <canvas id="${canvasId}" width="256" height="256" style="width: 256px; height: 256px; border: 1px solid #ddd; border-radius: 5px;"></canvas>
                        </div>
                    </div>
                    <p><strong>尺寸:</strong> 256x256px</p>
                    <p><strong>容错级别:</strong> H (最高)</p>
                    <p><strong>状态:</strong> 生成成功，显示清晰</p>
                `
                
                // 重新生成到新创建的canvas
                setTimeout(() => {
                    const newCanvas = document.getElementById(canvasId)
                    if (newCanvas) {
                        new QRCode(newCanvas, {
                            text: shortContent,
                            width: 256,
                            height: 256,
                            colorDark: "#000000",
                            colorLight: "#ffffff",
                            correctLevel: QRCode.CorrectLevel.H
                        })
                    }
                }, 100)
                
            } catch (error) {
                resultDiv.className = 'test-result error'
                resultDiv.innerHTML = `
                    <h4>❌ 短字符串二维码生成失败</h4>
                    <p><strong>错误信息:</strong> ${error.message}</p>
                `
            }
        }

        // 测试长字符串二维码生成（解决模糊问题）
        async function testLongStringQR() {
            const resultDiv = document.getElementById('long-qr-result')
            resultDiv.style.display = 'block'
            resultDiv.className = 'test-result'
            resultDiv.innerHTML = '正在生成长字符串二维码...'
            
            try {
                // 生成长字符串内容
                const longContent = `https://www.example.com/pages/dining/external-scan?scene_token=dining_${Date.now()}_${Math.random().toString(36).substr(2, 9)}&user_id=12345&timestamp=${Date.now()}&source=mobile&version=1.0&platform=wechat`
                
                const canvasId = 'long-qr-canvas'
                const scale = 5 // 放大5倍解决模糊问题
                const displaySize = 256
                const actualSize = displaySize * scale
                
                // 创建canvas
                const canvas = document.createElement('canvas')
                canvas.id = canvasId
                canvas.width = actualSize
                canvas.height = actualSize
                canvas.style.width = displaySize + 'px'
                canvas.style.height = displaySize + 'px'
                canvas.style.border = '1px solid #ddd'
                canvas.style.borderRadius = '5px'
                canvas.style.imageRendering = 'pixelated' // 防止模糊
                
                // 生成二维码（放大解决模糊问题）
                const qrCode = new QRCode(canvas, {
                    text: longContent,
                    width: actualSize,
                    height: actualSize,
                    colorDark: "#000000",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.Q // 使用Q级别避免长字符串报错
                })
                
                // 等待生成完成
                await new Promise(resolve => setTimeout(resolve, 500))
                
                resultDiv.className = 'test-result success'
                resultDiv.innerHTML = `
                    <h4>✅ 长字符串二维码生成成功</h4>
                    <div class="qr-display">
                        <h5>二维码内容（长字符串）</h5>
                        <div class="qr-content">${longContent}</div>
                        <div style="margin-top: 10px;">
                            <canvas id="${canvasId}" width="${actualSize}" height="${actualSize}" style="width: ${displaySize}px; height: ${displaySize}px; border: 1px solid #ddd; border-radius: 5px; image-rendering: pixelated;"></canvas>
                        </div>
                    </div>
                    <div class="scale-info">
                        <p><strong>显示尺寸:</strong> ${displaySize}x${displaySize}px</p>
                        <p><strong>实际渲染尺寸:</strong> ${actualSize}x${actualSize}px</p>
                        <p><strong>放大倍数:</strong> ${scale}x</p>
                        <p><strong>容错级别:</strong> Q (避免长字符串报错)</p>
                    </div>
                    <p><strong>状态:</strong> 生成成功，显示清晰，解决了模糊问题</p>
                `
                
                // 重新生成到新创建的canvas
                setTimeout(() => {
                    const newCanvas = document.getElementById(canvasId)
                    if (newCanvas) {
                        new QRCode(newCanvas, {
                            text: longContent,
                            width: actualSize,
                            height: actualSize,
                            colorDark: "#000000",
                            colorLight: "#ffffff",
                            correctLevel: QRCode.CorrectLevel.Q
                        })
                    }
                }, 100)
                
            } catch (error) {
                resultDiv.className = 'test-result error'
                resultDiv.innerHTML = `
                    <h4>❌ 长字符串二维码生成失败</h4>
                    <p><strong>错误信息:</strong> ${error.message}</p>
                    <p><strong>可能原因:</strong> 字符串过长，尝试降低容错级别</p>
                `
            }
        }

        // 测试二维码质量对比
        async function testQualityComparison() {
            const resultDiv = document.getElementById('comparison-result')
            resultDiv.style.display = 'block'
            resultDiv.className = 'test-result'
            resultDiv.innerHTML = '正在生成质量对比...'
            
            try {
                const content = 'https://www.example.com/pages/dining/external-scan?scene_token=dining_1234567890_abcdefghij'
                
                // 普通尺寸二维码
                const normalCanvas = document.createElement('canvas')
                normalCanvas.id = 'normal-qr-canvas'
                normalCanvas.width = 256
                normalCanvas.height = 256
                normalCanvas.style.width = '256px'
                normalCanvas.style.height = '256px'
                normalCanvas.style.border = '1px solid #ddd'
                normalCanvas.style.borderRadius = '5px'
                
                // 高质量二维码（放大5倍）
                const highQualityCanvas = document.createElement('canvas')
                highQualityCanvas.id = 'high-quality-qr-canvas'
                highQualityCanvas.width = 1280
                highQualityCanvas.height = 1280
                highQualityCanvas.style.width = '256px'
                highQualityCanvas.style.height = '256px'
                highQualityCanvas.style.border = '1px solid #ddd'
                highQualityCanvas.style.borderRadius = '5px'
                highQualityCanvas.style.imageRendering = 'pixelated'
                
                // 生成普通二维码
                new QRCode(normalCanvas, {
                    text: content,
                    width: 256,
                    height: 256,
                    colorDark: "#000000",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.Q
                })
                
                // 生成高质量二维码
                new QRCode(highQualityCanvas, {
                    text: content,
                    width: 1280,
                    height: 1280,
                    colorDark: "#000000",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.Q
                })
                
                // 等待生成完成
                await new Promise(resolve => setTimeout(resolve, 300))
                
                resultDiv.className = 'test-result success'
                resultDiv.innerHTML = `
                    <h4>✅ 二维码质量对比完成</h4>
                    <div class="qr-comparison">
                        <div class="qr-item">
                            <h4>普通尺寸 (256x256)</h4>
                            <canvas id="normal-qr-canvas" width="256" height="256" style="width: 256px; height: 256px; border: 1px solid #ddd; border-radius: 5px;"></canvas>
                            <p>可能显示模糊</p>
                        </div>
                        <div class="qr-item">
                            <h4>高质量 (1280x1280)</h4>
                            <canvas id="high-quality-qr-canvas" width="1280" height="1280" style="width: 256px; height: 256px; border: 1px solid #ddd; border-radius: 5px; image-rendering: pixelated;"></canvas>
                            <p>显示清晰</p>
                        </div>
                    </div>
                    <div class="quality-info">
                        <p><strong>对比说明:</strong></p>
                        <p>• 左侧：普通尺寸，可能在手机上显示模糊</p>
                        <p>• 右侧：高质量版本，放大5倍渲染后缩小显示，解决模糊问题</p>
                        <p>• 使用 image-rendering: pixelated 防止浏览器自动平滑处理</p>
                    </div>
                `
                
                // 重新生成到新创建的canvas
                setTimeout(() => {
                    const normalCanvas = document.getElementById('normal-qr-canvas')
                    const highQualityCanvas = document.getElementById('high-quality-qr-canvas')
                    
                    if (normalCanvas) {
                        new QRCode(normalCanvas, {
                            text: content,
                            width: 256,
                            height: 256,
                            colorDark: "#000000",
                            colorLight: "#ffffff",
                            correctLevel: QRCode.CorrectLevel.Q
                        })
                    }
                    
                    if (highQualityCanvas) {
                        new QRCode(highQualityCanvas, {
                            text: content,
                            width: 1280,
                            height: 1280,
                            colorDark: "#000000",
                            colorLight: "#ffffff",
                            correctLevel: QRCode.CorrectLevel.Q
                        })
                    }
                }, 100)
                
            } catch (error) {
                resultDiv.className = 'test-result error'
                resultDiv.innerHTML = `
                    <h4>❌ 质量对比失败</h4>
                    <p><strong>错误信息:</strong> ${error.message}</p>
                `
            }
        }

        // 测试容错级别
        async function testErrorCorrectionLevel() {
            const resultDiv = document.getElementById('error-correction-result')
            resultDiv.style.display = 'block'
            resultDiv.className = 'test-result'
            resultDiv.innerHTML = '正在测试容错级别...'
            
            try {
                // 生成长字符串内容
                const longContent = `https://www.example.com/pages/dining/external-scan?scene_token=dining_${Date.now()}_${Math.random().toString(36).substr(2, 9)}&user_id=12345&timestamp=${Date.now()}&source=mobile&version=1.0&platform=wechat&additional_params=very_long_string_to_test_error_correction_level`
                
                const levels = ['L', 'M', 'Q', 'H']
                const results = []
                
                for (const level of levels) {
                    try {
                        const canvas = document.createElement('canvas')
                        canvas.id = `test-canvas-${level}`
                        canvas.width = 256
                        canvas.height = 256
                        canvas.style.width = '128px'
                        canvas.style.height = '128px'
                        canvas.style.border = '1px solid #ddd'
                        canvas.style.borderRadius = '5px'
                        canvas.style.margin = '5px'
                        
                        new QRCode(canvas, {
                            text: longContent,
                            width: 256,
                            height: 256,
                            colorDark: "#000000",
                            colorLight: "#ffffff",
                            correctLevel: QRCode.CorrectLevel[level]
                        })
                        
                        results.push({
                            level: level,
                            success: true,
                            canvas: canvas
                        })
                    } catch (error) {
                        results.push({
                            level: level,
                            success: false,
                            error: error.message
                        })
                    }
                }
                
                // 等待生成完成
                await new Promise(resolve => setTimeout(resolve, 500))
                
                let canvasHtml = ''
                let successCount = 0
                
                results.forEach(result => {
                    if (result.success) {
                        successCount++
                        canvasHtml += `
                            <div style="display: inline-block; margin: 5px; text-align: center;">
                                <h5>级别 ${result.level}</h5>
                                <canvas id="test-canvas-${result.level}" width="256" height="256" style="width: 128px; height: 128px; border: 1px solid #ddd; border-radius: 5px;"></canvas>
                                <p style="color: green;">成功</p>
                            </div>
                        `
                    } else {
                        canvasHtml += `
                            <div style="display: inline-block; margin: 5px; text-align: center;">
                                <h5>级别 ${result.level}</h5>
                                <div style="width: 128px; height: 128px; border: 1px solid #ddd; border-radius: 5px; display: flex; align-items: center; justify-content: center; background: #ffebee;">
                                    <p style="color: red; font-size: 12px;">失败</p>
                                </div>
                                <p style="color: red; font-size: 10px;">${result.error}</p>
                            </div>
                        `
                    }
                })
                
                resultDiv.className = 'test-result success'
                resultDiv.innerHTML = `
                    <h4>✅ 容错级别测试完成</h4>
                    <div class="qr-display">
                        <h5>不同容错级别的测试结果</h5>
                        ${canvasHtml}
                    </div>
                    <div class="quality-info">
                        <p><strong>测试结果:</strong> ${successCount}/${levels.length} 个级别成功</p>
                        <p><strong>推荐设置:</strong> 对于长字符串，建议使用 Q 级别（平衡容错和容量）</p>
                        <p><strong>级别说明:</strong></p>
                        <p>• L (Low): 7% 容错，容量最大</p>
                        <p>• M (Medium): 15% 容错</p>
                        <p>• Q (Quartile): 25% 容错，推荐用于长字符串</p>
                        <p>• H (High): 30% 容错，容量最小</p>
                    </div>
                `
                
                // 重新生成到新创建的canvas
                setTimeout(() => {
                    results.forEach(result => {
                        if (result.success) {
                            const canvas = document.getElementById(`test-canvas-${result.level}`)
                            if (canvas) {
                                new QRCode(canvas, {
                                    text: longContent,
                                    width: 256,
                                    height: 256,
                                    colorDark: "#000000",
                                    colorLight: "#ffffff",
                                    correctLevel: QRCode.CorrectLevel[result.level]
                                })
                            }
                        }
                    })
                }, 100)
                
            } catch (error) {
                resultDiv.className = 'test-result error'
                resultDiv.innerHTML = `
                    <h4>❌ 容错级别测试失败</h4>
                    <p><strong>错误信息:</strong> ${error.message}</p>
                `
            }
        }
    </script>
</body>
</html>
