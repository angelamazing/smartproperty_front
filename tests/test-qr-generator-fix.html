<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>二维码生成器修复测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        .test-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
        }
        .test-button {
            background: #2196f3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #1976d2;
        }
        .test-result {
            background: #f0f0f0;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 4px solid #2196f3;
        }
        .error {
            border-left-color: #f44336;
            background: #ffebee;
        }
        .success {
            border-left-color: #4caf50;
            background: #e8f5e8;
        }
        .qr-content {
            font-family: monospace;
            background: #f5f5f5;
            padding: 10px;
            border-radius: 3px;
            word-break: break-all;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>二维码生成器修复测试</h1>
    
    <div class="test-section">
        <div class="test-title">1. 测试固定二维码生成</div>
        <button class="test-button" onclick="testFixedQRGeneration()">生成固定二维码</button>
        <div id="fixed-qr-result" class="test-result" style="display: none;"></div>
    </div>
    
    <div class="test-section">
        <div class="test-title">2. 测试二维码内容生成</div>
        <button class="test-button" onclick="testQRContentGeneration()">生成二维码内容</button>
        <div id="qr-content-result" class="test-result" style="display: none;"></div>
    </div>
    
    <div class="test-section">
        <div class="test-title">3. 测试微信小程序环境检测</div>
        <button class="test-button" onclick="testWechatEnvironment()">检测环境</button>
        <div id="wechat-env-result" class="test-result" style="display: none;"></div>
    </div>
    
    <div class="test-section">
        <div class="test-title">4. 测试扫码处理</div>
        <button class="test-button" onclick="testScanProcessing()">模拟扫码处理</button>
        <div id="scan-result" class="test-result" style="display: none;"></div>
    </div>

    <script>
        // 模拟微信小程序环境
        if (typeof wx === 'undefined') {
            window.wx = {
                getSystemInfoSync: function() {
                    return { platform: 'devtools' }
                }
            }
        }

        // 测试固定二维码生成
        async function testFixedQRGeneration() {
            const resultDiv = document.getElementById('fixed-qr-result')
            resultDiv.style.display = 'block'
            resultDiv.className = 'test-result'
            resultDiv.innerHTML = '正在生成固定二维码...'
            
            try {
                // 模拟固定二维码生成
                const timestamp = Date.now()
                const qrContent = `DINING_CONFIRM_FIXED_001_${timestamp}`
                
                resultDiv.className = 'test-result success'
                resultDiv.innerHTML = `
                    <h4>✅ 固定二维码生成成功</h4>
                    <p><strong>二维码内容:</strong></p>
                    <div class="qr-content">${qrContent}</div>
                    <p><strong>生成时间:</strong> ${new Date(timestamp).toLocaleString()}</p>
                    <p><strong>平台:</strong> 微信小程序</p>
                    <p><strong>状态:</strong> 已生成，可直接使用</p>
                `
            } catch (error) {
                resultDiv.className = 'test-result error'
                resultDiv.innerHTML = `
                    <h4>❌ 固定二维码生成失败</h4>
                    <p><strong>错误信息:</strong> ${error.message}</p>
                `
            }
        }

        // 测试二维码内容生成
        async function testQRContentGeneration() {
            const resultDiv = document.getElementById('qr-content-result')
            resultDiv.style.display = 'block'
            resultDiv.className = 'test-result'
            resultDiv.innerHTML = '正在生成二维码内容...'
            
            try {
                // 模拟二维码内容生成
                const sceneToken = `dining_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
                const qrContent = `pages/dining/external-scan?scene_token=${sceneToken}`
                
                resultDiv.className = 'test-result success'
                resultDiv.innerHTML = `
                    <h4>✅ 二维码内容生成成功</h4>
                    <p><strong>场景令牌:</strong></p>
                    <div class="qr-content">${sceneToken}</div>
                    <p><strong>二维码内容:</strong></p>
                    <div class="qr-content">${qrContent}</div>
                    <p><strong>类型:</strong> 外部扫码确认</p>
                `
            } catch (error) {
                resultDiv.className = 'test-result error'
                resultDiv.innerHTML = `
                    <h4>❌ 二维码内容生成失败</h4>
                    <p><strong>错误信息:</strong> ${error.message}</p>
                `
            }
        }

        // 测试微信小程序环境检测
        function testWechatEnvironment() {
            const resultDiv = document.getElementById('wechat-env-result')
            resultDiv.style.display = 'block'
            
            const isWechat = typeof wx !== 'undefined' && wx.getSystemInfoSync
            const platform = isWechat ? '微信小程序' : 'Web浏览器'
            
            resultDiv.className = 'test-result success'
            resultDiv.innerHTML = `
                <h4>✅ 环境检测完成</h4>
                <p><strong>当前平台:</strong> ${platform}</p>
                <p><strong>wx对象:</strong> ${typeof wx !== 'undefined' ? '存在' : '不存在'}</p>
                <p><strong>getSystemInfoSync:</strong> ${typeof wx !== 'undefined' && wx.getSystemInfoSync ? '存在' : '不存在'}</p>
                <p><strong>建议:</strong> ${isWechat ? '使用微信小程序二维码生成方案' : '使用Web二维码生成方案'}</p>
            `
        }

        // 测试扫码处理
        async function testScanProcessing() {
            const resultDiv = document.getElementById('scan-result')
            resultDiv.style.display = 'block'
            resultDiv.className = 'test-result'
            resultDiv.innerHTML = '正在模拟扫码处理...'
            
            try {
                // 模拟扫码处理
                const mockQRContent = `DINING_CONFIRM_FIXED_001_${Date.now()}`
                const now = new Date()
                const hour = now.getHours()
                
                let mealType = 'unknown'
                let mealName = '未知餐次'
                
                if (hour >= 6 && hour < 10) {
                    mealType = 'breakfast'
                    mealName = '早餐'
                } else if (hour >= 11 && hour < 14) {
                    mealType = 'lunch'
                    mealName = '午餐'
                } else if (hour >= 17 && hour < 20) {
                    mealType = 'dinner'
                    mealName = '晚餐'
                }
                
                const canScan = mealType !== 'unknown'
                
                resultDiv.className = canScan ? 'test-result success' : 'test-result error'
                resultDiv.innerHTML = `
                    <h4>${canScan ? '✅' : '❌'} 扫码处理${canScan ? '成功' : '失败'}</h4>
                    <p><strong>扫码内容:</strong></p>
                    <div class="qr-content">${mockQRContent}</div>
                    <p><strong>当前时间:</strong> ${now.toLocaleString()}</p>
                    <p><strong>餐次判断:</strong> ${mealName} (${mealType})</p>
                    <p><strong>是否可扫码:</strong> ${canScan ? '是' : '否'}</p>
                    <p><strong>处理结果:</strong> ${canScan ? '可以确认就餐' : '不在就餐时间内'}</p>
                `
            } catch (error) {
                resultDiv.className = 'test-result error'
                resultDiv.innerHTML = `
                    <h4>❌ 扫码处理失败</h4>
                    <p><strong>错误信息:</strong> ${error.message}</p>
                `
            }
        }
    </script>
</body>
</html>
