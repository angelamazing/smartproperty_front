# 场地预约系统 - 前端API对接文档

## 📋 概述

本文档详细说明场地预约系统的前端API对接方式，包括接口地址、参数、响应格式和完整的代码示例。

**基础URL**: `http://localhost:3000/api`  
**认证方式**: Bearer Token  
**数据格式**: JSON  

## 🔐 认证说明

所有API接口都需要在请求头中携带JWT Token：

```javascript
headers: {
  'Authorization': `Bearer ${token}`,
  'Content-Type': 'application/json'
}
```

### 获取Token方式

#### 1. 测试登录（开发环境推荐）
```javascript
// 普通用户测试登录
const loginResponse = await fetch('/api/auth/test-login', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    phoneNumber: '13800138000'
  })
});

const result = await loginResponse.json();
if (result.success) {
  const token = result.data.token;
  localStorage.setItem('token', token);
}
```

#### 2. 正式登录
```javascript
// 手机号密码登录
const loginResponse = await fetch('/api/auth/phone-password-login', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    phoneNumber: '13800138000',
    password: '123456'
  })
});
```

---

## 🏟️ 场地预约API接口

### 1. 获取场地列表

**接口地址**: `GET /api/reservation/venues`

**功能描述**: 获取可预约的场地列表，支持分页和筛选

**请求参数**:
| 参数名 | 类型 | 必填 | 说明 | 示例 |
|--------|------|------|------|------|
| date | string | 否 | 查询日期，格式：YYYY-MM-DD | 2025-09-17 |
| type | string | 否 | 场地类型筛选 | badminton, pingpong, basketball |
| page | number | 否 | 页码，默认1 | 1 |
| pageSize | number | 否 | 每页数量，默认20 | 20 |

**请求示例**:
```javascript
const getVenues = async (params = {}) => {
  try {
    const token = localStorage.getItem('token');
    const queryString = new URLSearchParams(params).toString();
    
    const response = await fetch(`/api/reservation/venues?${queryString}`, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });
    
    const result = await response.json();
    
    if (result.success) {
      return result.data;
    } else {
      throw new Error(result.message);
    }
  } catch (error) {
    console.error('获取场地列表失败:', error);
    throw error;
  }
};

// 使用示例
const venues = await getVenues({
  date: '2025-09-17',
  type: 'badminton',
  page: 1,
  pageSize: 20
});
```

**响应格式**:
```json
{
  "success": true,
  "message": "获取场地列表成功",
  "data": {
    "list": [
      {
        "_id": "626fb995-6d4a-4f95-83d2-f146dfe4b875",
        "name": "乒乓球台1号",
        "code": "TT001",
        "type": "pingpong",
        "capacity": 4,
        "location": "B区2楼",
        "price": "20.00",
        "description": "标准乒乓球台",
        "facilities": ["球拍", "乒乓球"],
        "openTime": "08:00:00",
        "closeTime": "22:00:00",
        "status": "open",
        "requireApproval": 0,
        "allowCancellation": 1,
        "minBookingHours": 1,
        "maxBookingHours": 3,
        "advanceBookingDays": 7,
        "today_reservations": 0
      }
    ],
    "total": 3,
    "page": 1,
    "pageSize": 20
  }
}
```

**响应字段说明**:
| 字段名 | 类型 | 说明 |
|--------|------|------|
| _id | string | 场地唯一ID |
| name | string | 场地名称 |
| code | string | 场地编码 |
| type | string | 场地类型 |
| capacity | number | 容纳人数 |
| location | string | 场地位置 |
| price | string | 价格（元/小时） |
| description | string | 场地描述 |
| facilities | array | 设施列表 |
| openTime | string | 开放时间 |
| closeTime | string | 关闭时间 |
| status | string | 场地状态（open/closed） |
| requireApproval | number | 是否需要审批（0-否，1-是） |
| allowCancellation | number | 是否允许取消（0-否，1-是） |
| minBookingHours | number | 最小预约时长（小时） |
| maxBookingHours | number | 最大预约时长（小时） |
| advanceBookingDays | number | 提前预约天数 |
| today_reservations | number | 今日预约次数 |

---

### 2. 获取场地详情

**接口地址**: `GET /api/venue/{venueId}`

**功能描述**: 获取指定场地的详细信息

**路径参数**:
- `venueId`: 场地ID

**请求示例**:
```javascript
const getVenueDetail = async (venueId) => {
  try {
    const token = localStorage.getItem('token');
    
    const response = await fetch(`/api/venue/${venueId}`, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });
    
    const result = await response.json();
    
    if (result.success) {
      return result.data;
    } else {
      throw new Error(result.message);
    }
  } catch (error) {
    console.error('获取场地详情失败:', error);
    throw error;
  }
};

// 使用示例
const venueDetail = await getVenueDetail('626fb995-6d4a-4f95-83d2-f146dfe4b875');
```

**响应格式**:
```json
{
  "success": true,
  "message": "获取场地详情成功",
  "data": {
    "_id": "626fb995-6d4a-4f95-83d2-f146dfe4b875",
    "name": "乒乓球台1号",
    "code": "TT001",
    "type": "pingpong",
    "capacity": 4,
    "location": "B区2楼",
    "price": "20.00",
    "description": "标准乒乓球台",
    "facilities": ["球拍", "乒乓球"],
    "openTime": "08:00:00",
    "closeTime": "22:00:00",
    "status": "open",
    "requireApproval": 0,
    "allowCancellation": 1,
    "minBookingHours": 1,
    "maxBookingHours": 3,
    "advanceBookingDays": 7
  }
}
```

---

### 3. 获取场地时间安排

**接口地址**: `GET /api/venue/{venueId}/schedule`

**功能描述**: 获取指定场地在指定日期的时间安排

**请求参数**:
| 参数名 | 类型 | 必填 | 说明 | 示例 |
|--------|------|------|------|------|
| date | string | 是 | 查询日期，格式：YYYY-MM-DD | 2025-09-17 |

**请求示例**:
```javascript
const getVenueSchedule = async (venueId, date) => {
  try {
    const token = localStorage.getItem('token');
    
    const response = await fetch(`/api/venue/${venueId}/schedule?date=${date}`, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });
    
    const result = await response.json();
    
    if (result.success) {
      return result.data;
    } else {
      throw new Error(result.message);
    }
  } catch (error) {
    console.error('获取场地时间安排失败:', error);
    throw error;
  }
};

// 使用示例
const schedule = await getVenueSchedule('626fb995-6d4a-4f95-83d2-f146dfe4b875', '2025-09-17');
```

---

### 4. 检查时间段可用性

**接口地址**: `GET /api/venue/check-availability`

**功能描述**: 检查指定场地在指定时间段的可用性

**请求参数**:
| 参数名 | 类型 | 必填 | 说明 | 示例 |
|--------|------|------|------|------|
| venueId | string | 是 | 场地ID | 626fb995-6d4a-4f95-83d2-f146dfe4b875 |
| date | string | 是 | 预约日期 | 2025-09-17 |
| startTime | string | 是 | 开始时间 | 14:00 |
| endTime | string | 是 | 结束时间 | 16:00 |

**请求示例**:
```javascript
const checkAvailability = async (venueId, date, startTime, endTime) => {
  try {
    const token = localStorage.getItem('token');
    const params = new URLSearchParams({
      venueId,
      date,
      startTime,
      endTime
    });
    
    const response = await fetch(`/api/venue/check-availability?${params.toString()}`, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });
    
    const result = await response.json();
    
    if (result.success) {
      return result.data;
    } else {
      throw new Error(result.message);
    }
  } catch (error) {
    console.error('检查可用性失败:', error);
    throw error;
  }
};

// 使用示例
const availability = await checkAvailability(
  '626fb995-6d4a-4f95-83d2-f146dfe4b875',
  '2025-09-17',
  '14:00',
  '16:00'
);
```

**响应格式**:
```json
{
  "success": true,
  "message": "时间段可用",
  "data": {
    "available": true
  }
}
```

或

```json
{
  "success": true,
  "message": "时间段不可用",
  "data": {
    "available": false,
    "reason": "该时间段已被预约"
  }
}
```

---

## 🎯 完整的前端实现示例

### Vue 3 Composition API 示例

```vue
<template>
  <div class="venue-booking">
    <!-- 场地列表 -->
    <div class="venue-list">
      <div v-for="venue in venues" :key="venue._id" class="venue-card">
        <h3>{{ venue.name }}</h3>
        <p>类型: {{ getVenueTypeLabel(venue.type) }}</p>
        <p>位置: {{ venue.location }}</p>
        <p>价格: ¥{{ venue.price }}/小时</p>
        <p>容量: {{ venue.capacity }}人</p>
        <p>今日预约: {{ venue.today_reservations }}次</p>
        <button @click="selectVenue(venue)">选择场地</button>
      </div>
    </div>
    
    <!-- 加载状态 -->
    <div v-if="loading" class="loading">加载中...</div>
    
    <!-- 错误信息 -->
    <div v-if="error" class="error">{{ error }}</div>
  </div>
</template>

<script setup>
import { ref, onMounted } from 'vue'

// 响应式数据
const venues = ref([])
const loading = ref(false)
const error = ref('')

// 场地类型标签映射
const venueTypeLabels = {
  'badminton': '羽毛球',
  'pingpong': '乒乓球',
  'basketball': '篮球',
  'meeting': '会议室',
  'other': '其他'
}

// 获取场地类型标签
const getVenueTypeLabel = (type) => {
  return venueTypeLabels[type] || type
}

// 获取场地列表
const loadVenues = async (params = {}) => {
  try {
    loading.value = true
    error.value = ''
    
    const token = localStorage.getItem('token')
    if (!token) {
      throw new Error('请先登录')
    }
    
    const queryString = new URLSearchParams(params).toString()
    
    const response = await fetch(`/api/reservation/venues?${queryString}`, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    })
    
    const result = await response.json()
    
    if (result.success) {
      venues.value = result.data.list
    } else {
      throw new Error(result.message)
    }
  } catch (err) {
    error.value = err.message
    console.error('加载场地失败:', err)
  } finally {
    loading.value = false
  }
}

// 选择场地
const selectVenue = (venue) => {
  console.log('选择场地:', venue)
  // 这里可以跳转到预约页面或打开预约弹窗
}

// 组件挂载时加载数据
onMounted(() => {
  loadVenues({
    date: '2025-09-17',
    type: '',
    page: 1,
    pageSize: 20
  })
})
</script>

<style scoped>
.venue-booking {
  padding: 20px;
}

.venue-list {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 20px;
  margin-bottom: 20px;
}

.venue-card {
  border: 1px solid #ddd;
  border-radius: 8px;
  padding: 16px;
  background: #fff;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.venue-card h3 {
  margin: 0 0 12px 0;
  color: #333;
}

.venue-card p {
  margin: 8px 0;
  color: #666;
}

.venue-card button {
  background: #007bff;
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 4px;
  cursor: pointer;
  margin-top: 12px;
}

.venue-card button:hover {
  background: #0056b3;
}

.loading {
  text-align: center;
  padding: 20px;
  color: #666;
}

.error {
  background: #f8d7da;
  color: #721c24;
  padding: 12px;
  border-radius: 4px;
  margin: 20px 0;
}
</style>
```

### React 示例

```jsx
import React, { useState, useEffect } from 'react'

const VenueBooking = () => {
  const [venues, setVenues] = useState([])
  const [loading, setLoading] = useState(false)
  const [error, setError] = useState('')

  // 场地类型标签映射
  const venueTypeLabels = {
    'badminton': '羽毛球',
    'pingpong': '乒乓球',
    'basketball': '篮球',
    'meeting': '会议室',
    'other': '其他'
  }

  // 获取场地类型标签
  const getVenueTypeLabel = (type) => {
    return venueTypeLabels[type] || type
  }

  // 获取场地列表
  const loadVenues = async (params = {}) => {
    try {
      setLoading(true)
      setError('')
      
      const token = localStorage.getItem('token')
      if (!token) {
        throw new Error('请先登录')
      }
      
      const queryString = new URLSearchParams(params).toString()
      
      const response = await fetch(`/api/reservation/venues?${queryString}`, {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      })
      
      const result = await response.json()
      
      if (result.success) {
        setVenues(result.data.list)
      } else {
        throw new Error(result.message)
      }
    } catch (err) {
      setError(err.message)
      console.error('加载场地失败:', err)
    } finally {
      setLoading(false)
    }
  }

  // 选择场地
  const selectVenue = (venue) => {
    console.log('选择场地:', venue)
    // 这里可以跳转到预约页面或打开预约弹窗
  }

  // 组件挂载时加载数据
  useEffect(() => {
    loadVenues({
      date: '2025-09-17',
      type: '',
      page: 1,
      pageSize: 20
    })
  }, [])

  return (
    <div className="venue-booking">
      {/* 场地列表 */}
      <div className="venue-list">
        {venues.map(venue => (
          <div key={venue._id} className="venue-card">
            <h3>{venue.name}</h3>
            <p>类型: {getVenueTypeLabel(venue.type)}</p>
            <p>位置: {venue.location}</p>
            <p>价格: ¥{venue.price}/小时</p>
            <p>容量: {venue.capacity}人</p>
            <p>今日预约: {venue.today_reservations}次</p>
            <button onClick={() => selectVenue(venue)}>选择场地</button>
          </div>
        ))}
      </div>
      
      {/* 加载状态 */}
      {loading && <div className="loading">加载中...</div>}
      
      {/* 错误信息 */}
      {error && <div className="error">{error}</div>}
    </div>
  )
}

export default VenueBooking
```

---

## ⚠️ 错误处理

### 常见错误码

| 错误码 | 错误信息 | 说明 |
|--------|---------|------|
| 401 | 未授权 | Token无效或已过期 |
| 403 | 禁止访问 | 权限不足 |
| 404 | 接口不存在 | 接口路径错误 |
| 500 | 服务器内部错误 | 后端服务异常 |

### 错误处理示例

```javascript
const handleApiError = (error) => {
  if (error.response) {
    // 服务器返回了错误状态码
    const { status, data } = error.response
    
    switch (status) {
      case 401:
        // Token过期，跳转到登录页
        localStorage.removeItem('token')
        window.location.href = '/login'
        break
      case 403:
        alert('权限不足，请联系管理员')
        break
      case 404:
        alert('接口不存在，请检查接口地址')
        break
      case 500:
        alert('服务器内部错误，请稍后重试')
        break
      default:
        alert(data.message || '请求失败')
    }
  } else if (error.request) {
    // 网络错误
    alert('网络连接失败，请检查网络设置')
  } else {
    // 其他错误
    alert(error.message || '未知错误')
  }
}
```

---

## 🔧 开发调试建议

### 1. 使用浏览器开发者工具
- 打开 Network 面板查看API请求
- 检查请求头是否包含正确的Authorization
- 查看响应数据格式是否正确

### 2. 测试接口
```javascript
// 在浏览器控制台中测试API
const testAPI = async () => {
  try {
    const response = await fetch('/api/reservation/venues?date=2025-09-17', {
      headers: {
        'Authorization': `Bearer ${localStorage.getItem('token')}`
      }
    })
    const data = await response.json()
    console.log('API响应:', data)
  } catch (error) {
    console.error('API错误:', error)
  }
}

testAPI()
```

### 3. 常见问题排查
1. **Token问题**: 确保localStorage中有有效的token
2. **CORS问题**: 确保前端和后端在同一域名下，或正确配置CORS
3. **接口路径**: 确保使用正确的接口路径 `/api/reservation/venues`
4. **参数格式**: 确保查询参数格式正确

---

## 📞 技术支持

如果在对接过程中遇到问题，请检查：
1. 后端服务是否正常运行（访问 `http://localhost:3000/health`）
2. 数据库连接是否正常
3. 接口路径是否正确
4. 请求参数格式是否正确

**联系方式**: 请联系后端开发团队获取技术支持。

---

*最后更新时间: 2025-09-17*
