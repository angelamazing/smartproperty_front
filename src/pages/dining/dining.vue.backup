<template>
  <view class="dining-container">
    <!-- é¡¶éƒ¨æ“ä½œæ  -->
    <view class="action-bar">
      <view class="action-tabs">
        <view 
          class="tab-item" 
          :class="{ active: currentTab === 'menu' }"
          @click="switchTab('menu')"
        >
          <text class="tab-text">ä»Šæ—¥èœå•</text>
        </view>
        <view 
          class="tab-item" 
          :class="{ active: currentTab === 'order' }"
          @click="switchTab('order')"
        >
          <text class="tab-text">éƒ¨é—¨æŠ¥é¤</text>
        </view>
        <view 
          class="tab-item" 
          :class="{ active: currentTab === 'record' }"
          @click="switchTab('record')"
        >
          <text class="tab-text">æŠ¥é¤è®°å½•</text>
        </view>
      </view>
    </view>

    <!-- ä»Šæ—¥èœå•æ ‡ç­¾é¡µ -->
    <view class="tab-content" v-if="currentTab === 'menu'">
      <view class="menu-header">
        <view class="date-selector">
          <button class="date-btn" @click="previousDate">
            <text class="date-icon">â—€</text>
          </button>
          <text class="current-date">{{ selectedDate }}</text>
          <button class="date-btn" @click="nextDate">
            <text class="date-icon">â–¶</text>
          </button>
        </view>
        <view class="meal-selector">
          <view
            class="meal-tab"
            :class="{ active: selectedMeal === meal.value }"
            v-for="meal in mealTypes || []"
            :key="meal.value"
            @click="selectMeal(meal.value)"
          >
            <text class="meal-text">{{ meal.label }}</text>
          </view>
        </view>
      </view>

             <view class="menu-content" v-if="currentMenu">
         <view class="menu-info">
           <text class="menu-title">{{ getMealTypeText(currentMenu.mealType) }}èœå•</text>
           <text class="menu-time">{{ currentMenu.mealTime }}</text>
           <text class="menu-status" :class="getStatusClass(currentMenu.publishStatus)">
             {{ getStatusText(currentMenu.publishStatus) }}
           </text>
         </view>

         <view class="dish-categories">
           <view 
             class="category-section" 
             v-for="category in dishCategories || []" 
             :key="category.value"
           >
             <view class="category-header">
               <text class="category-title">{{ category.label }}</text>
               <text class="dish-count">{{ getDishesByCategory(category.value).length }}é“</text>
             </view>
             <view class="dish-list" v-if="getDishesByCategory(category.value).length > 0">
               <view 
                 class="dish-item" 
                 v-for="dish in getDishesByCategory(category.value) || []" 
                 :key="dish._id || dish.id"
               >
                 <view class="dish-info">
                   <text class="dish-name">{{ dish.dishName || dish.name || 'æœªçŸ¥èœå“' }}</text>
                   <text class="dish-description">{{ dish.dishDescription || dish.description || '' }}</text>
                   <view class="dish-tags">
                     <text class="tag" v-if="dish.isSpicy">ğŸŒ¶ï¸ è¾£</text>
                     <text class="tag" v-if="dish.isVegetarian">ğŸ¥¬ ç´ </text>
                     <text class="tag" v-if="dish.isRecommended">â­ æ¨è</text>
                   </view>
                 </view>
                 <view class="dish-nutrition" v-if="dish.calories || dish.protein || dish.fat">
                   <text class="nutrition-item" v-if="dish.calories">çƒ­é‡: {{ dish.calories }}kcal</text>
                   <text class="nutrition-item" v-if="dish.protein">è›‹ç™½è´¨: {{ dish.protein }}g</text>
                   <text class="nutrition-item" v-if="dish.fat">è„‚è‚ª: {{ dish.fat }}g</text>
                 </view>
               </view>
             </view>
           </view>
         </view>
      </view>

      <view class="empty-menu" v-else>
        <view class="empty-icon">ğŸ½ï¸</view>
        <text class="empty-text">è¯¥æ—¥æœŸæš‚æ— èœå•</text>
        <text class="empty-desc">è¯·é€‰æ‹©å…¶ä»–æ—¥æœŸæˆ–é¤æ¬¡</text>
      </view>
    </view>

    <!-- éƒ¨é—¨æŠ¥é¤æ ‡ç­¾é¡µ -->
    <view class="tab-content" v-if="currentTab === 'order'">
      <!-- æƒé™æ£€æŸ¥æç¤º -->
      <view v-if="!hasDeptAdminPermission" class="permission-denied">
        <view class="permission-icon">ğŸš«</view>
        <text class="permission-title">æƒé™ä¸è¶³</text>
        <text class="permission-desc">éƒ¨é—¨æŠ¥é¤åŠŸèƒ½éœ€è¦éƒ¨é—¨ç®¡ç†å‘˜æˆ–ç³»ç»Ÿç®¡ç†å‘˜æƒé™</text>
        <view class="permission-info">
          <text class="info-item">å½“å‰è§’è‰²: {{ getRoleText(userRole) }}</text>
        </view>
      </view>

      <!-- éƒ¨é—¨æŠ¥é¤è¡¨å• -->
      <view v-else class="order-form">
          <view class="form-section">
            <text class="section-label">ç”¨é¤ä¿¡æ¯</text>
            <view class="form-row">
              <text class="form-label">ç”¨é¤æ—¥æœŸ</text>
              <picker
                mode="date"
                :value="orderForm.date"
                @change="onDateChange"
                class="form-picker"
              >
                <view class="picker-value">{{ orderForm.date }}</view>
              </picker>
            </view>
            <view class="form-row">
              <text class="form-label">ç”¨é¤ç±»å‹</text>
              <picker
                mode="selector"
                :range="mealTypeOptions"
                :value="mealTypeIndex"
                @change="onMealTypeChange"
                class="form-picker"
              >
                <view class="picker-value">{{ orderForm.mealType }}</view>
              </picker>
            </view>
          </view>

          <view class="form-section">
            <text class="section-label">éƒ¨é—¨æˆå‘˜</text>
            <view class="member-list">
              <!-- æˆå‘˜æ“ä½œå¤´éƒ¨ -->
              <view class="member-header">
                <view class="select-all">
                  <checkbox
                    :checked="isAllSelected"
                    @change="toggleSelectAll"
                    class="select-checkbox"
                  />
                  <text class="select-text">å…¨é€‰</text>
                </view>
                <text class="member-count">å·²é€‰æ‹© {{ selectedMembers.length }}/{{ (deptMembers || []).length }} äºº</text>
              </view>

              <!-- æœç´¢å’Œç­›é€‰ -->
              <view class="member-filters" v-if="(deptMembers || []).length > 5">
                <view class="search-box">
                  <input 
                    class="search-input" 
                    placeholder="æœç´¢æˆå‘˜å§“å" 
                    v-model="memberSearchText"
                    @input="onMemberSearch"
                  />
                  <view class="search-icon">ğŸ”</view>
                </view>
                <view class="role-filters">
                  <view 
                    class="role-filter-item" 
                    :class="{ active: currentRoleFilter === filter.value }"
                    v-for="filter in roleFilterOptions"
                    :key="filter.value"
                    @click="setRoleFilter(filter.value)"
                  >
                    {{ filter.label }}
                  </view>
                </view>
              </view>

              <!-- å¿«é€Ÿé€‰æ‹© -->
              <view class="quick-select" v-if="(deptMembers || []).length > 10">
                <text class="quick-select-label">å¿«é€Ÿé€‰æ‹©ï¼š</text>
                <view class="quick-select-actions">
                  <view class="quick-action" @click="selectByRole('å‘˜å·¥')">é€‰æ‹©æ‰€æœ‰å‘˜å·¥</view>
                  <view class="quick-action" @click="selectByRole('éƒ¨é—¨ç®¡ç†å‘˜')">é€‰æ‹©ç®¡ç†å‘˜</view>
                  <view class="quick-action" @click="selectVisible">é€‰æ‹©å½“å‰æ˜¾ç¤º</view>
                  <view class="quick-action" @click="clearSelection">æ¸…ç©ºé€‰æ‹©</view>
                </view>
              </view>

              <!-- æˆå‘˜åˆ—è¡¨å®¹å™¨ -->
              <view class="member-items-container">
                <scroll-view 
                  class="member-items-scroll" 
                  scroll-y="true"
                  :style="{ height: memberListHeight }"
                  @scrolltolower="loadMoreMembers"
                >
                  <view class="member-items">
                    <view
                      class="member-item"
                      v-for="member in filteredMembers"
                      :key="member._id"
                      @click="toggleMember(member._id)"
                      :class="{ selected: isMemberSelected(member._id) }"
                    >
                      <checkbox
                        :checked="isMemberSelected(member._id)"
                        class="member-checkbox"
                      />
                      <view class="member-avatar-wrapper">
                        <image
                          class="member-avatar"
                          :src="member.avatarUrl || '/static/logo.png'"
                          mode="aspectFill"
                          @error="handleAvatarError"
                        ></image>
                      </view>
                      <view class="member-info">
                        <text class="member-name">{{ member.name }}</text>
                        <text class="member-role">{{ member.role }}</text>
                        <text class="member-dept" v-if="member.department">{{ member.department }}</text>
                      </view>
                      <view class="member-status" :class="getMemberStatusClass(member._id)">
                        {{ getMemberStatusText(member._id) }}
                      </view>
                    </view>
                  </view>
                  
                  <!-- åŠ è½½æ›´å¤šæç¤º -->
                  <view class="load-more" v-if="hasMoreMembers && filteredMembers.length >= memberPageSize">
                    <text class="load-more-text">åŠ è½½æ›´å¤š...</text>
                  </view>
                  
                  <!-- æ— åŒ¹é…ç»“æœ -->
                  <view class="no-members" v-if="filteredMembers.length === 0 && memberSearchText">
                    <view class="no-members-icon">ğŸ‘¥</view>
                    <text class="no-members-text">æœªæ‰¾åˆ°åŒ¹é…çš„æˆå‘˜</text>
                    <text class="no-members-desc">è¯·å°è¯•å…¶ä»–æœç´¢å…³é”®è¯</text>
                  </view>
                </scroll-view>
              </view>

              <!-- é€‰ä¸­æˆå‘˜é¢„è§ˆ -->
              <view class="selected-members-preview" v-if="selectedMembers.length > 0">
                <view class="preview-header">
                  <text class="preview-title">å·²é€‰æ‹©æˆå‘˜ ({{ selectedMembers.length }})</text>
                  <view class="preview-toggle" @click="togglePreviewExpanded">
                    {{ isPreviewExpanded ? 'æ”¶èµ·' : 'å±•å¼€' }}
                  </view>
                </view>
                <view class="preview-content" v-if="isPreviewExpanded">
                  <view class="selected-member-tags">
                    <view 
                      class="selected-member-tag"
                      v-for="member in selectedMemberDetails"
                      :key="member._id"
                      @click="toggleMember(member._id)"
                    >
                      <text class="tag-name">{{ member.name }}</text>
                      <text class="tag-close">Ã—</text>
                    </view>
                  </view>
                </view>
              </view>
            </view>
          </view>

          <view class="form-section">
            <text class="section-label">å¤‡æ³¨ä¿¡æ¯</text>
            <textarea
              class="form-textarea"
              placeholder="è¯·è¾“å…¥ç‰¹æ®Šè¦æ±‚æˆ–å¤‡æ³¨ä¿¡æ¯"
              v-model="orderForm.remark"
              maxlength="200"
            ></textarea>
            <text class="char-count">{{ orderForm.remark.length }}/200</text>
          </view>

          <view class="form-actions">
            <button class="btn-secondary" @click="resetForm">é‡ç½®</button>
            <button
              class="btn-primary"
              @click="submitOrder"
              :disabled="!canSubmit || isSubmitting"
              :loading="isSubmitting"
            >
              {{ isSubmitting ? 'æäº¤ä¸­...' : 'æäº¤æŠ¥é¤' }}
            </button>
          </view>
        </view>
      </view>
    </view>

    <!-- æŠ¥é¤è®°å½•æ ‡ç­¾é¡µ -->
    <view class="tab-content" v-if="currentTab === 'record'">
      <view class="record-header">
        <text class="record-title">æŠ¥é¤è®°å½•</text>
        <view class="record-filters">
          <picker 
            mode="date" 
            :value="recordFilter.date" 
            @change="onRecordDateChange"
            class="filter-picker"
          >
            <view class="filter-value">{{ recordFilter.date }}</view>
          </picker>
          <picker 
            mode="selector" 
            :range="statusOptions" 
            :value="statusIndex" 
            @change="onStatusChange"
            class="filter-picker"
          >
            <view class="filter-value">{{ recordFilter.status }}</view>
          </picker>
        </view>
      </view>

      <view class="record-list" v-if="diningRecords && diningRecords.length > 0">
        <view 
          class="record-item" 
          v-for="record in diningRecords || []" 
          :key="record._id"
          @click="viewRecordDetail(record)"
        >
          <view class="record-header">
            <text class="record-date">{{ formatDate(record.diningDate) }}</text>
            <text class="record-status" :class="getStatusClass(record.status)">
              {{ getStatusText(record.status) }}
            </text>
          </view>
          <view class="record-content">
            <view class="record-info">
              <text class="record-type">{{ getMealTypeText(record.mealType) }}</text>
              <text class="record-count">{{ record.memberCount }}äºº</text>
            </view>
            <view class="record-members">
              <text class="members-text">{{ record.memberNames.join('ã€') }}</text>
            </view>
            <view class="record-time">
              <text class="time-label">æäº¤æ—¶é—´:</text>
              <text class="time-value">{{ formatTime(record.createTime) }}</text>
            </view>
          </view>
        </view>
      </view>

      <view class="empty-record" v-else>
        <view class="empty-icon">ğŸ“‹</view>
        <text class="empty-text">æš‚æ— æŠ¥é¤è®°å½•</text>
        <text class="empty-desc">å¼€å§‹ä¸ºéƒ¨é—¨æˆå‘˜æŠ¥é¤å§</text>
      </view>

      <!-- åŠ è½½æ›´å¤š -->
      <view class="load-more" v-if="hasMoreRecords">
        <button class="load-more-btn" @click="loadMoreRecords" :loading="isLoadingMore">
          {{ isLoadingMore ? 'åŠ è½½ä¸­...' : 'åŠ è½½æ›´å¤š' }}
        </button>
      </view>
    </view>

    <!-- åŠ è½½çŠ¶æ€ -->
    <view class="loading-container" v-if="isLoading">
      <view class="loading-spinner"></view>
      <text class="loading-text">åŠ è½½ä¸­...</text>
    </view>
 
</template>

<script>
import auth from '@/utils/auth.js'
import api from '@/utils/api.js'

export default {
  name: 'Dining',
  data() {
    return {
      currentTab: 'menu',
      isLoading: false,

      // æƒé™ç›¸å…³
      userRole: 'user',
      hasDeptAdminPermission: false,

      // æˆå‘˜åˆ—è¡¨æœç´¢å’Œç­›é€‰
      memberSearchText: '',
      currentRoleFilter: 'all',
      memberPageSize: 20,
      memberCurrentPage: 1,
      hasMoreMembers: false,
      isPreviewExpanded: false,

             // èœå•ç›¸å…³
       selectedDate: '',
       selectedMeal: 'lunch',
       currentMenu: null,
       
       // è¿‡æ»¤ç›¸å…³
       dishSearchText: '',
       selectedCategoryFilter: 'all',
       activeTagFilters: [],
       priceRange: {
         min: '',
         max: ''
       },

      // æŠ¥é¤è¡¨å•
      orderForm: {
        date: '',
        mealType: 'åˆé¤',
        remark: ''
      },

      // éƒ¨é—¨æˆå‘˜
      deptMembers: [],
      selectedMembers: [],

      // æŠ¥é¤è®°å½•
      diningRecords: [],
      recordFilter: {
        date: '',
        status: 'å…¨éƒ¨'
      },

      // åˆ†é¡µ
      page: 1,
      pageSize: 10,
      hasMoreRecords: true,
      isLoadingMore: false,

      // æäº¤çŠ¶æ€
      isSubmitting: false
    }
  },

  computed: {
    mealTypes() {
      return [
        { label: 'æ—©é¤', value: 'breakfast' },
        { label: 'åˆé¤', value: 'lunch' },
        { label: 'æ™šé¤', value: 'dinner' }
      ]
    },

    mealTypeOptions() {
      return this.mealTypes.map(item => item.label)
    },

    mealTypeIndex() {
      return this.mealTypes.findIndex(item => item.label === this.orderForm.mealType)
    },

         dishCategories() {
       // æ ¹æ®å®é™…APIè¿”å›çš„åˆ†ç±»åŠ¨æ€ç”Ÿæˆ
       if (!this.currentMenu || !this.currentMenu.dishes) {
         return [
           { label: 'ä¸»é£Ÿ', value: 'ä¸»é£Ÿ' },
           { label: 'ä¸»èœ', value: 'ä¸»èœ' },
           { label: 'ç´ èœ', value: 'ç´ èœ' },
           { label: 'æ±¤å“', value: 'æ±¤å“' },
           { label: 'é¥®å“', value: 'é¥®å“' },
           { label: 'å°é£Ÿ', value: 'å°é£Ÿ' }
         ]
       }
       
       // ä»èœå“æ•°æ®ä¸­æå–å®é™…å­˜åœ¨çš„åˆ†ç±»
       const categories = [...new Set(this.currentMenu.dishes.map(dish => 
         dish.categoryName || dish.category || 'æœªåˆ†ç±»'
       ))]
       
       return categories.map(category => ({
         label: category,
         value: category
       }))
     },
     
     // æ‰€æœ‰åˆ†ç±»åˆ—è¡¨ï¼ˆç”¨äºè¿‡æ»¤ï¼‰
     allCategories() {
       if (!this.currentMenu || !this.currentMenu.dishes) return []
       return [...new Set(this.currentMenu.dishes.map(dish => 
         dish.categoryName || dish.category || 'æœªåˆ†ç±»'
       ))]
     },
     
     // è¿‡æ»¤åçš„èœå“æ•°æ®
     filteredDishes() {
       if (!this.currentMenu || !this.currentMenu.dishes) return []
       
       let dishes = [...this.currentMenu.dishes]
       
       // 1. æœç´¢è¿‡æ»¤
       if (this.dishSearchText.trim()) {
         const searchText = this.dishSearchText.trim().toLowerCase()
         dishes = dishes.filter(dish => {
           const dishName = (dish.dishName || dish.name || '').toLowerCase()
           const description = (dish.dishDescription || dish.description || '').toLowerCase()
           return dishName.includes(searchText) || description.includes(searchText)
         })
       }
       
       // 2. åˆ†ç±»è¿‡æ»¤
       if (this.selectedCategoryFilter !== 'all') {
         dishes = dishes.filter(dish => {
           const dishCategory = dish.categoryName || dish.category || 'æœªåˆ†ç±»'
           return dishCategory === this.selectedCategoryFilter
         })
       }
       
       // 3. æ ‡ç­¾è¿‡æ»¤
       if (this.activeTagFilters.length > 0) {
         dishes = dishes.filter(dish => {
           return this.activeTagFilters.every(tag => {
             switch (tag) {
               case 'spicy':
                 return dish.isSpicy === true
               case 'vegetarian':
                 return dish.isVegetarian === true
               case 'recommended':
                 return dish.isRecommended === true
               default:
                 return true
             }
           })
         })
       }
       
       // 4. ä»·æ ¼è¿‡æ»¤
       if (this.priceRange.min !== '' || this.priceRange.max !== '') {
         dishes = dishes.filter(dish => {
           const price = dish.price || 0
           const min = this.priceRange.min !== '' ? parseFloat(this.priceRange.min) : 0
           const max = this.priceRange.max !== '' ? parseFloat(this.priceRange.max) : Infinity
           return price >= min && price <= max
         })
       }
       
       return dishes
     },

    statusOptions() {
      return ['å…¨éƒ¨', 'å¾…ç¡®è®¤', 'å·²ç¡®è®¤', 'å·²å®Œæˆ', 'å·²å–æ¶ˆ']
    },

    statusIndex() {
      return this.statusOptions.findIndex(item => item === this.recordFilter.status)
    },

    isAllSelected() {
      return (this.deptMembers || []).length > 0 && this.selectedMembers.length === (this.deptMembers || []).length
    },

        canSubmit() {
      const hasMembers = this.selectedMembers && this.selectedMembers.length > 0
      const hasDate = this.orderForm.date && this.orderForm.date.trim() !== ''
      const hasMealType = this.orderForm.mealType && this.orderForm.mealType.trim() !== ''

      console.log('canSubmitæ£€æŸ¥:', {
        hasMembers,
        hasDate,
        hasMealType,
        selectedMembers: this.selectedMembers,
        date: this.orderForm.date,
        mealType: this.orderForm.mealType
      })

      return hasMembers && hasDate && hasMealType
    },

    // è§’è‰²ç­›é€‰é€‰é¡¹
    roleFilterOptions() {
      return [
        { label: 'å…¨éƒ¨', value: 'all' },
        { label: 'å‘˜å·¥', value: 'å‘˜å·¥' },
        { label: 'ç®¡ç†å‘˜', value: 'éƒ¨é—¨ç®¡ç†å‘˜' },
        { label: 'å…¶ä»–', value: 'other' }
      ]
    },

    // ç­›é€‰åçš„æˆå‘˜åˆ—è¡¨
    filteredMembers() {
      let members = this.deptMembers || []
      
      // è§’è‰²ç­›é€‰
      if (this.currentRoleFilter !== 'all') {
        if (this.currentRoleFilter === 'other') {
          members = members.filter(member => 
            member.role !== 'å‘˜å·¥' && member.role !== 'éƒ¨é—¨ç®¡ç†å‘˜'
          )
        } else {
          members = members.filter(member => member.role === this.currentRoleFilter)
        }
      }
      
      // æœç´¢ç­›é€‰
      if (this.memberSearchText.trim()) {
        const searchText = this.memberSearchText.trim().toLowerCase()
        members = members.filter(member => 
          member.name.toLowerCase().includes(searchText) ||
          (member.department && member.department.toLowerCase().includes(searchText))
        )
      }
      
      return members
    },

    // æˆå‘˜åˆ—è¡¨é«˜åº¦ï¼ˆåŠ¨æ€è®¡ç®—ï¼‰
    memberListHeight() {
      const memberCount = this.filteredMembers.length
      if (memberCount === 0) return '200rpx'
      if (memberCount <= 3) return '300rpx'
      if (memberCount <= 6) return '400rpx'
      return '500rpx'
    },

    // å·²é€‰æ‹©çš„æˆå‘˜è¯¦æƒ…
    selectedMemberDetails() {
      const members = this.deptMembers || []
      return this.selectedMembers.map(id => 
        members.find(member => member._id === id)
      ).filter(Boolean)
    }
  },

  onLoad() {
    this.initPage()
  },

  onShow() {
    this.refreshData()
  },

  onPullDownRefresh() {
    this.refreshData().then(() => {
      uni.stopPullDownRefresh()
    })
  },

  onReachBottom() {
    if (this.currentTab === 'record' && this.hasMoreRecords && !this.isLoadingMore) {
      this.loadMoreRecords()
    }
  },

  methods: {
    /**
     * åˆå§‹åŒ–é¡µé¢
     */
    async initPage() {
      try {
        this.isLoading = true

        // æ£€æŸ¥ç”¨æˆ·æƒé™
        await this.checkUserPermission()

        // è®¾ç½®é»˜è®¤æ—¥æœŸä¸ºä»Šå¤©
        const today = new Date()
        this.selectedDate = this.formatDate(today)
        this.orderForm.date = this.formatDate(today)
        this.recordFilter.date = this.formatDate(today)

        // åŠ è½½åˆå§‹æ•°æ®
        await this.loadInitialData()
      } catch (error) {
        console.error('é¡µé¢åˆå§‹åŒ–å¤±è´¥:', error)
        uni.showToast({
          title: 'é¡µé¢åŠ è½½å¤±è´¥',
          icon: 'none'
        })
      } finally {
        this.isLoading = false
      }
    },

    /**
     * æ£€æŸ¥ç”¨æˆ·æƒé™
     */
    async checkUserPermission() {
      try {
        // è·å–ç”¨æˆ·ä¿¡æ¯
        const userInfo = auth.getUserInfo()
        if (userInfo) {
          this.userRole = userInfo.role || 'user'
          this.hasDeptAdminPermission = auth.isDeptAdmin()
        } else {
          // å¦‚æœæ²¡æœ‰ç”¨æˆ·ä¿¡æ¯ï¼Œå°è¯•é‡æ–°è·å–
          const result = await api.user.getInfo()
          if (result && result.success && result.data) {
            this.userRole = result.data.role || 'user'
            this.hasDeptAdminPermission = ['dept_admin', 'sys_admin'].includes(this.userRole)
            // æ›´æ–°æœ¬åœ°å­˜å‚¨çš„ç”¨æˆ·ä¿¡æ¯
            uni.setStorageSync('userInfo', result.data)
          }
        }

        console.log('ç”¨æˆ·è§’è‰²:', this.userRole, 'éƒ¨é—¨ç®¡ç†å‘˜æƒé™:', this.hasDeptAdminPermission)
      } catch (error) {
        console.error('æ£€æŸ¥ç”¨æˆ·æƒé™å¤±è´¥:', error)
        this.userRole = 'user'
        this.hasDeptAdminPermission = false
      }
    },

    /**
     * åŠ è½½åˆå§‹æ•°æ®
     */
    async loadInitialData() {
      try {
        // å¹¶è¡ŒåŠ è½½æ•°æ®
        const [menu, members, records] = await Promise.all([
          this.loadMenu(),
          this.loadDeptMembers(),
          this.loadDiningRecords()
        ])

        this.currentMenu = menu
        this.deptMembers = members
        this.diningRecords = records
      } catch (error) {
        console.error('åŠ è½½åˆå§‹æ•°æ®å¤±è´¥:', error)
      }
    },

    /**
     * åˆ·æ–°æ•°æ®
     */
    async refreshData() {
      try {
        switch (this.currentTab) {
          case 'menu':
            await this.loadMenu()
            break
          case 'order':
            await this.loadDeptMembers()
            break
          case 'record':
            this.page = 1
            this.hasMoreRecords = true
            await this.loadDiningRecords()
            break
        }
      } catch (error) {
        console.error('åˆ·æ–°æ•°æ®å¤±è´¥:', error)
      }
    },

    /**
     * åˆ‡æ¢æ ‡ç­¾é¡µ
     */
    switchTab(tab) {
      this.currentTab = tab
      this.refreshData()
    },

    /**
     * é€‰æ‹©æ—¥æœŸ
     */
    previousDate() {
      const date = new Date(this.selectedDate)
      date.setDate(date.getDate() - 1)
      this.selectedDate = this.formatDate(date)
      this.loadMenu()
    },

    nextDate() {
      const date = new Date(this.selectedDate)
      date.setDate(date.getDate() + 1)
      this.selectedDate = this.formatDate(date)
      this.loadMenu()
    },

    /**
     * é€‰æ‹©é¤æ¬¡
     */
    selectMeal(mealType) {
      this.selectedMeal = mealType
      this.loadMenu()
    },

    /**
     * åŠ è½½èœå•
     */
    async loadMenu() {
      try {
        console.log('æ­£åœ¨åŠ è½½èœå•ï¼Œå‚æ•°:', { date: this.selectedDate, mealType: this.selectedMeal })
        
        // ä½¿ç”¨æ­£ç¡®çš„ç®¡ç†å‘˜æ¥å£è·å–èœå•
        const result = await api.admin.getMenuByDate({
          date: this.selectedDate,
          mealType: this.selectedMeal
        })
        
        console.log('èœå•APIå“åº”:', result)
        
        if (result && result.success && result.data) {
          this.currentMenu = result.data
          console.log('èœå•åŠ è½½æˆåŠŸ:', this.currentMenu)
          
          // æ£€æŸ¥èœå“æ•°æ®ç»“æ„
          if (this.currentMenu.dishes && this.currentMenu.dishes.length > 0) {
            console.log('èœå“æ•°æ®:', this.currentMenu.dishes)
            this.currentMenu.dishes.forEach((dish, index) => {
              console.log(`èœå“${index}:`, dish.name || dish.dishName, 'åˆ†ç±»:', dish.category || dish.categoryName)
            })
          } else {
            console.log('æ²¡æœ‰èœå“æ•°æ®ï¼Œå°è¯•å•ç‹¬è·å–èœå“')
            
            // å¦‚æœèœå“æ•°æ®ä¸ºç©ºï¼Œå°è¯•å•ç‹¬è·å–èœå“åˆ—è¡¨
            if (this.currentMenu && this.currentMenu._id) {
              await this.loadMenuDishes(this.currentMenu._id)
            }
          }
        } else {
          this.currentMenu = null
          console.log('èœå•æ•°æ®ä¸ºç©ºæˆ–è¯·æ±‚å¤±è´¥:', result)
        }
      } catch (error) {
        console.error('åŠ è½½èœå•å¤±è´¥:', error)
        this.currentMenu = null
      }
    },

    /**
     * å•ç‹¬åŠ è½½èœå•èœå“æ•°æ®
     */
    async loadMenuDishes(menuId) {
      try {
        console.log('æ­£åœ¨åŠ è½½èœå•èœå“æ•°æ®ï¼Œèœå•ID:', menuId)
        const response = await api.admin.getMenuDishes(menuId)
        console.log('èœå“æ•°æ®APIå“åº”:', response)
        
        if (response && response.success && response.data) {
          // æ›´æ–°èœå•çš„èœå“æ•°æ®
          if (this.currentMenu) {
            this.currentMenu.dishes = response.data
            console.log('èœå“æ•°æ®åŠ è½½æˆåŠŸï¼Œæ•°é‡:', this.currentMenu.dishes.length)
          }
        } else {
          console.warn('è·å–èœå“æ•°æ®å¤±è´¥:', response?.message)
        }
      } catch (error) {
        console.error('åŠ è½½èœå“æ•°æ®å¤±è´¥:', error)
      }
    },

    /**
     * åŠ è½½éƒ¨é—¨æˆå‘˜
     */
    async loadDeptMembers() {
      try {
        const result = await api.dining.getDeptMembers()

        if (result && result.success) {
          this.deptMembers = result.data || []
          this.selectedMembers = []

          console.log('åŠ è½½éƒ¨é—¨æˆå‘˜æˆåŠŸ:', this.deptMembers.length, 'äºº')

          // å¦‚æœæ²¡æœ‰éƒ¨é—¨æˆå‘˜ï¼Œæ˜¾ç¤ºæç¤º
          if (this.deptMembers.length === 0) {
            uni.showToast({
              title: 'æš‚æ— éƒ¨é—¨æˆå‘˜æ•°æ®',
              icon: 'none',
              duration: 1500
            })
          }
        } else {
          throw new Error(result?.message || 'è·å–éƒ¨é—¨æˆå‘˜å¤±è´¥')
        }
      } catch (error) {
        console.error('åŠ è½½éƒ¨é—¨æˆå‘˜å¤±è´¥:', error)
        this.deptMembers = []

        let errorMessage = 'åŠ è½½éƒ¨é—¨æˆå‘˜å¤±è´¥'
        if (error.message) {
          if (error.message.includes('æƒé™')) {
            errorMessage = 'æƒé™ä¸è¶³ï¼Œæ— æ³•è·å–éƒ¨é—¨æˆå‘˜'
          } else if (error.message.includes('ç½‘ç»œ')) {
            errorMessage = 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ'
          } else {
            errorMessage = error.message
          }
        }

        uni.showToast({
          title: errorMessage,
          icon: 'none',
          duration: 2000
        })
      }
    },

    /**
     * åŠ è½½æŠ¥é¤è®°å½•
     */
    async loadDiningRecords() {
      try {
        const params = {
          date: this.recordFilter.date,
          status: this.recordFilter.status === 'å…¨éƒ¨' ? '' : this.recordFilter.status,
          page: this.page,
          pageSize: this.pageSize
        }
        
        const result = await api.dining.getRecords(params)
        
        if (this.page === 1) {
          this.diningRecords = result.data.records || []
        } else {
          this.diningRecords = [...this.diningRecords, ...(result.data.records || [])]
        }
        
        this.hasMoreRecords = result.data.hasMore || false
      } catch (error) {
        console.error('åŠ è½½æŠ¥é¤è®°å½•å¤±è´¥:', error)
        this.diningRecords = []
      }
    },

    /**
     * åŠ è½½æ›´å¤šè®°å½•
     */
    async loadMoreRecords() {
      if (this.isLoadingMore) return
      
      try {
        this.isLoadingMore = true
        this.page++
        await this.loadDiningRecords()
      } catch (error) {
        console.error('åŠ è½½æ›´å¤šè®°å½•å¤±è´¥:', error)
        this.page--
      } finally {
        this.isLoadingMore = false
      }
    },

    /**
     * åˆ‡æ¢å…¨é€‰
     */
    toggleSelectAll() {
      console.log('åˆ‡æ¢å…¨é€‰ï¼Œå½“å‰çŠ¶æ€:', this.isAllSelected, 'éƒ¨é—¨æˆå‘˜:', this.deptMembers)
      if (this.isAllSelected) {
        this.selectedMembers = []
      } else {
        // åˆ›å»ºæ–°æ•°ç»„ç¡®ä¿å“åº”æ€§
        this.selectedMembers = [...(this.deptMembers || []).map(member => member._id)]
      }
      console.log('å…¨é€‰åé€‰ä¸­:', this.selectedMembers)
      
      // å¼ºåˆ¶æ›´æ–°ç•Œé¢
      this.$forceUpdate()
    },

    /**
     * åˆ‡æ¢æˆå‘˜é€‰æ‹©
     */
    toggleMember(memberId) {
      console.log('åˆ‡æ¢æˆå‘˜é€‰æ‹©:', memberId, 'å½“å‰é€‰ä¸­:', this.selectedMembers)
      const index = this.selectedMembers.indexOf(memberId)
      if (index > -1) {
        // ä½¿ç”¨Vueçš„å“åº”å¼æ–¹æ³•
        this.$set(this.selectedMembers, index, null)
        this.selectedMembers = this.selectedMembers.filter(id => id !== null)
      } else {
        // åˆ›å»ºæ–°æ•°ç»„ç¡®ä¿å“åº”æ€§
        this.selectedMembers = [...this.selectedMembers, memberId]
      }
      console.log('åˆ‡æ¢åé€‰ä¸­:', this.selectedMembers)
      
      // å¼ºåˆ¶æ›´æ–°ç•Œé¢
      this.$forceUpdate()
    },

    /**
     * æ£€æŸ¥æˆå‘˜æ˜¯å¦è¢«é€‰ä¸­
     */
    isMemberSelected(memberId) {
      return this.selectedMembers.includes(memberId)
    },

    /**
     * è·å–æˆå‘˜çŠ¶æ€
     */
    getMemberStatusText(memberId) {
      // è¿™é‡Œå¯ä»¥æ ¹æ®å®é™…ä¸šåŠ¡é€»è¾‘åˆ¤æ–­æˆå‘˜çŠ¶æ€
      return 'å¯æŠ¥é¤'
    },

    getMemberStatusClass(memberId) {
      return 'status-available'
    },

    /**
     * è¡¨å•æ—¥æœŸå˜åŒ–
     */
    onDateChange(e) {
      this.orderForm.date = e.detail.value
    },

    /**
     * è¡¨å•é¤æ¬¡å˜åŒ–
     */
    onMealTypeChange(e) {
      this.orderForm.mealType = this.mealTypeOptions[e.detail.value]
    },

    /**
     * è®°å½•ç­›é€‰æ—¥æœŸå˜åŒ–
     */
    onRecordDateChange(e) {
      this.recordFilter.date = e.detail.value
      this.page = 1
      this.hasMoreRecords = true
      this.loadDiningRecords()
    },

    /**
     * è®°å½•ç­›é€‰çŠ¶æ€å˜åŒ–
     */
    onStatusChange(e) {
      this.recordFilter.status = this.statusOptions[e.detail.value]
      this.page = 1
      this.hasMoreRecords = true
      this.loadDiningRecords()
    },

    /**
     * é‡ç½®è¡¨å•
     */
    resetForm() {
      this.orderForm = {
        date: this.formatDate(new Date()),
        mealType: 'åˆé¤',
        remark: ''
      }
      this.selectedMembers = []
    },

    /**
     * æäº¤æŠ¥é¤
     */
    async submitOrder() {
      if (!this.canSubmit) return

      // å†æ¬¡æ£€æŸ¥æƒé™
      if (!this.hasDeptAdminPermission) {
        uni.showToast({
          title: 'æƒé™ä¸è¶³ï¼Œæ— æ³•æäº¤æŠ¥é¤',
          icon: 'none'
        })
        return
      }

      // æ•°æ®éªŒè¯
      if (this.selectedMembers.length === 0) {
        uni.showToast({
          title: 'è¯·è‡³å°‘é€‰æ‹©ä¸€ä½éƒ¨é—¨æˆå‘˜',
          icon: 'none'
        })
        return
      }

      if (!this.orderForm.date) {
        uni.showToast({
          title: 'è¯·é€‰æ‹©ç”¨é¤æ—¥æœŸ',
          icon: 'none'
        })
        return
      }

      if (!this.orderForm.mealType) {
        uni.showToast({
          title: 'è¯·é€‰æ‹©é¤æ¬¡ç±»å‹',
          icon: 'none'
        })
        return
      }

      // æ£€æŸ¥æ—¥æœŸæ˜¯å¦åˆç†
      const selectedDate = new Date(this.orderForm.date)
      const today = new Date()
      today.setHours(0, 0, 0, 0)

      if (selectedDate < today) {
        uni.showToast({
          title: 'ä¸èƒ½ä¸ºè¿‡å»çš„æ—¥æœŸæŠ¥é¤',
          icon: 'none'
        })
        return
      }

      try {
        this.isSubmitting = true

        const orderData = {
          date: this.orderForm.date,
          mealType: this.getMealTypeValue(this.orderForm.mealType),
          memberIds: this.selectedMembers,
          remark: this.orderForm.remark
        }

        console.log('æäº¤æŠ¥é¤æ•°æ®:', orderData)

        const result = await api.dining.submitDeptOrder(orderData)

        if (result && result.success) {
          const data = result.data || {}
          const successCount = data.successCount || this.selectedMembers.length
          const totalCount = data.totalCount || this.selectedMembers.length

          uni.showToast({
            title: `æŠ¥é¤æäº¤æˆåŠŸ (${successCount}/${totalCount})`,
            icon: 'success',
            duration: 2000
          })

          // é‡ç½®è¡¨å•
          this.resetForm()

          // åˆ·æ–°è®°å½•
          this.switchTab('record')
        } else {
          throw new Error(result?.message || 'æäº¤å¤±è´¥')
        }
      } catch (error) {
        console.error('æäº¤æŠ¥é¤å¤±è´¥:', error)

        let errorMessage = 'æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•'

        // å¤„ç†ç‰¹å®šé”™è¯¯ç±»å‹
        if (error.message) {
          if (error.message.includes('æƒé™')) {
            errorMessage = 'æƒé™ä¸è¶³ï¼Œè¯·è”ç³»ç®¡ç†å‘˜'
          } else if (error.message.includes('æ—¥æœŸ')) {
            errorMessage = 'æ—¥æœŸæ— æ•ˆï¼Œè¯·é‡æ–°é€‰æ‹©'
          } else if (error.message.includes('æˆå‘˜')) {
            errorMessage = 'æˆå‘˜ä¿¡æ¯æœ‰è¯¯ï¼Œè¯·é‡æ–°é€‰æ‹©'
          } else if (error.message.includes('ç½‘ç»œ') || error.message.includes('timeout')) {
            errorMessage = 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ'
          } else {
            errorMessage = error.message
          }
        }

        uni.showModal({
          title: 'æäº¤å¤±è´¥',
          content: errorMessage,
          showCancel: false,
          confirmText: 'ç¡®å®š'
        })
      } finally {
        this.isSubmitting = false
      }
    },

    /**
     * æŸ¥çœ‹è®°å½•è¯¦æƒ…
     */
    async viewRecordDetail(record) {
      console.log('æŸ¥çœ‹æŠ¥é¤è®°å½•è¯¦æƒ…:', record)
      
      // æ˜¾ç¤ºåŠ è½½æç¤º
      uni.showLoading({
        title: 'åŠ è½½è¯¦æƒ…ä¸­...'
      })
      
      try {
        // è°ƒç”¨åç«¯æ¥å£è·å–è¯¦ç»†çš„äººå‘˜åå•
        const result = await api.dining.getRecordDetail(record._id)
        console.log('è·å–è®°å½•è¯¦æƒ…ç»“æœ:', result)
        
        uni.hideLoading()
        
        if (result && result.success && result.data) {
          const detailData = result.data
          const memberNames = detailData.memberNames && detailData.memberNames.length > 0 
            ? detailData.memberNames.join('ã€') 
            : 'æ— æˆå‘˜ä¿¡æ¯'
          
          const statusText = this.getStatusText(detailData.status || record.status)
          const mealTypeText = this.getMealTypeText(detailData.mealType || record.mealType)
          const createTime = this.formatTime(detailData.createTime || record.createTime)
          
          // æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯æ¨¡æ€æ¡†
          uni.showModal({
            title: 'æŠ¥é¤è®°å½•è¯¦æƒ…',
            content: `ç”¨é¤æ—¥æœŸ: ${detailData.diningDate || record.diningDate}\né¤æ¬¡ç±»å‹: ${mealTypeText}\nç”¨é¤äººæ•°: ${detailData.memberCount || record.memberCount}äºº\nç”¨é¤æˆå‘˜: ${memberNames}\nè®¢å•çŠ¶æ€: ${statusText}\næäº¤æ—¶é—´: ${createTime}\nå¤‡æ³¨ä¿¡æ¯: ${detailData.remark || record.remark || 'æ— '}`,
            showCancel: false,
            confirmText: 'ç¡®å®š'
          })
        } else {
          // æ¥å£è°ƒç”¨å¤±è´¥ï¼Œä½¿ç”¨åŸæœ‰æ•°æ®æ˜¾ç¤º
          console.warn('è·å–è®°å½•è¯¦æƒ…å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®')
          this.showRecordDetailFallback(record)
        }
      } catch (error) {
        console.error('è·å–æŠ¥é¤è®°å½•è¯¦æƒ…å¤±è´¥:', error)
        uni.hideLoading()
        
        // ç½‘ç»œé”™è¯¯æˆ–å…¶ä»–å¼‚å¸¸ï¼Œè¯¢é—®ç”¨æˆ·æ˜¯å¦æŸ¥çœ‹åŸºæœ¬ä¿¡æ¯
        uni.showModal({
          title: 'è·å–è¯¦æƒ…å¤±è´¥',
          content: 'æ— æ³•è·å–å®Œæ•´çš„äººå‘˜åå•ä¿¡æ¯ï¼Œæ˜¯å¦æŸ¥çœ‹åŸºæœ¬è®°å½•ä¿¡æ¯ï¼Ÿ',
          success: (res) => {
            if (res.confirm) {
              this.showRecordDetailFallback(record)
            }
          }
        })
      }
    },

    /**
     * æ˜¾ç¤ºè®°å½•è¯¦æƒ…çš„å¤‡ç”¨æ–¹æ³•ï¼ˆå½“æ¥å£è°ƒç”¨å¤±è´¥æ—¶ä½¿ç”¨ï¼‰
     */
    showRecordDetailFallback(record) {
      const memberNames = record.memberNames ? record.memberNames.join('ã€') : 'æ— æˆå‘˜ä¿¡æ¯'
      const statusText = this.getStatusText(record.status)
      const mealTypeText = this.getMealTypeText(record.mealType)
      const createTime = this.formatTime(record.createTime)
      
      uni.showModal({
        title: 'æŠ¥é¤è®°å½•è¯¦æƒ…ï¼ˆåŸºæœ¬ä¿¡æ¯ï¼‰',
        content: `ç”¨é¤æ—¥æœŸ: ${record.diningDate}\né¤æ¬¡ç±»å‹: ${mealTypeText}\nç”¨é¤äººæ•°: ${record.memberCount}äºº\nç”¨é¤æˆå‘˜: ${memberNames}\nè®¢å•çŠ¶æ€: ${statusText}\næäº¤æ—¶é—´: ${createTime}\nå¤‡æ³¨ä¿¡æ¯: ${record.remark || 'æ— '}`,
        showCancel: false,
        confirmText: 'ç¡®å®š'
      })
    },

    /**
     * è·å–é¤æ¬¡ç±»å‹å€¼
     */
    getMealTypeValue(mealTypeText) {
      const meal = this.mealTypes.find(item => item.label === mealTypeText)
      return meal ? meal.value : 'lunch'
    },

    /**
     * æ ¹æ®åˆ†ç±»è·å–èœå“
     */
    getDishesByCategory(category) {
      if (!this.currentMenu || !this.currentMenu.dishes) return []
      
      // ä¿®å¤å­—æ®µåŒ¹é…ï¼šä½¿ç”¨æ­£ç¡®çš„å­—æ®µå
      const dishes = this.currentMenu.dishes.filter(dish => {
        const dishCategory = dish.categoryName || dish.category || 'æœªåˆ†ç±»'
        return dishCategory === category
      })
      
      console.log(`åˆ†ç±»"${category}"çš„èœå“:`, dishes)
      return dishes
    },

    /**
     * è·å–é¤æ¬¡ç±»å‹æ–‡æœ¬
     */
    getMealTypeText(mealType) {
      const meal = this.mealTypes.find(item => item.value === mealType)
      return meal ? meal.label : 'æœªçŸ¥é¤æ¬¡'
    },

    /**
     * è·å–çŠ¶æ€æ–‡æœ¬
     */
    getStatusText(status) {
      const statusMap = {
        'draft': 'è‰ç¨¿',
        'published': 'å·²å‘å¸ƒ',
        'confirmed': 'å·²ç¡®è®¤',
        'completed': 'å·²å®Œæˆ',
        'cancelled': 'å·²å–æ¶ˆ',
        'pending': 'å¾…ç¡®è®¤'
      }
      return statusMap[status] || 'æœªçŸ¥çŠ¶æ€'
    },

    /**
     * è·å–çŠ¶æ€æ ·å¼ç±»
     */
    getStatusClass(status) {
      return `status-${status}`
    },

    /**
     * æ ¼å¼åŒ–æ—¥æœŸ
     */
    formatDate(date) {
      const d = new Date(date)
      const year = d.getFullYear()
      const month = String(d.getMonth() + 1).padStart(2, '0')
      const day = String(d.getDate()).padStart(2, '0')
      return `${year}-${month}-${day}`
    },

    /**
     * æ ¼å¼åŒ–æ—¶é—´
     */
    formatTime(time) {
      if (!time) return ''

      const date = new Date(time)
      const month = String(date.getMonth() + 1).padStart(2, '0')
      const day = String(date.getDate()).padStart(2, '0')
      const hour = String(date.getHours()).padStart(2, '0')
      const minute = String(date.getMinutes()).padStart(2, '0')

      return `${month}-${day} ${hour}:${minute}`
    },

    /**
     * è·å–è§’è‰²æ–‡æœ¬
     */
    getRoleText(role) {
      const roleMap = {
        'user': 'æ™®é€šç”¨æˆ·',
        'dept_admin': 'éƒ¨é—¨ç®¡ç†å‘˜',
        'sys_admin': 'ç³»ç»Ÿç®¡ç†å‘˜',
        'verifier': 'éªŒè¯å‘˜',
        'guest': 'æ¸¸å®¢'
      }
      return roleMap[role] || 'æœªçŸ¥è§’è‰²'
    },

    /**
     * å¤´åƒåŠ è½½å¤±è´¥å¤„ç†
     */
    handleAvatarError(e) {
      console.log('å¤´åƒåŠ è½½å¤±è´¥:', e)
      // å¯ä»¥è®¾ç½®é»˜è®¤å¤´åƒ
      e.target.src = '/static/logo.png'
    },

    /**
     * æˆå‘˜æœç´¢
     */
    onMemberSearch() {
      console.log('æœç´¢æˆå‘˜:', this.memberSearchText)
      // æœç´¢é€»è¾‘ç”± computed å±æ€§ filteredMembers å¤„ç†
    },

    /**
     * è®¾ç½®è§’è‰²ç­›é€‰
     */
    setRoleFilter(role) {
      console.log('è®¾ç½®è§’è‰²ç­›é€‰:', role)
      this.currentRoleFilter = role
    },

    /**
     * æŒ‰è§’è‰²é€‰æ‹©æˆå‘˜
     */
    selectByRole(role) {
      console.log('æŒ‰è§’è‰²é€‰æ‹©æˆå‘˜:', role)
      const members = this.deptMembers || []
      const roleMembers = members.filter(member => member.role === role)
      const roleIds = roleMembers.map(member => member._id)
      
      // åˆå¹¶åˆ°ç°æœ‰é€‰æ‹©ä¸­
      const newSelected = [...new Set([...this.selectedMembers, ...roleIds])]
      this.selectedMembers = newSelected
      
      uni.showToast({
        title: `å·²é€‰æ‹©${roleMembers.length}ä¸ª${role}`,
        icon: 'success'
      })
      
      this.$forceUpdate()
    },

    /**
     * é€‰æ‹©å½“å‰æ˜¾ç¤ºçš„æ‰€æœ‰æˆå‘˜
     */
    selectVisible() {
      console.log('é€‰æ‹©å½“å‰æ˜¾ç¤ºçš„æˆå‘˜')
      const visibleIds = this.filteredMembers.map(member => member._id)
      const newSelected = [...new Set([...this.selectedMembers, ...visibleIds])]
      this.selectedMembers = newSelected
      
      uni.showToast({
        title: `å·²é€‰æ‹©${visibleIds.length}ä¸ªæˆå‘˜`,
        icon: 'success'
      })
      
      this.$forceUpdate()
    },

    /**
     * æ¸…ç©ºé€‰æ‹©
     */
    clearSelection() {
      console.log('æ¸…ç©ºé€‰æ‹©')
      this.selectedMembers = []
      uni.showToast({
        title: 'å·²æ¸…ç©ºé€‰æ‹©',
        icon: 'success'
      })
      this.$forceUpdate()
    },

    /**
     * åŠ è½½æ›´å¤šæˆå‘˜
     */
    loadMoreMembers() {
      console.log('åŠ è½½æ›´å¤šæˆå‘˜')
      // è¿™é‡Œå¯ä»¥å®ç°åˆ†é¡µåŠ è½½é€»è¾‘
      // å½“å‰ä¸ºç®€å•å®ç°ï¼Œå®é™…å¯èƒ½éœ€è¦è°ƒç”¨API
    },

    /**
     * åˆ‡æ¢é¢„è§ˆå±•å¼€çŠ¶æ€
     */
    togglePreviewExpanded() {
      this.isPreviewExpanded = !this.isPreviewExpanded
    },

    /**
     * é‡ç½®è¿‡æ»¤å™¨
     */
    resetFilters() {
      this.dishSearchText = ''
      this.selectedCategoryFilter = 'all'
      this.activeTagFilters = []
      this.priceRange = { min: '', max: '' }
      this.loadMenu() // é‡æ–°åŠ è½½èœå•ä»¥åº”ç”¨æ–°çš„è¿‡æ»¤æ¡ä»¶
    },

    /**
     * ä»·æ ¼è¿‡æ»¤è¾“å…¥å˜åŒ–
     */
    onPriceFilterChange() {
      // è¿™é‡Œå¯ä»¥æ·»åŠ ä»·æ ¼è¿‡æ»¤çš„é€»è¾‘ï¼Œä¾‹å¦‚å®æ—¶æ›´æ–° filteredDishes
      // ä¾‹å¦‚ï¼šthis.loadMenu()
    }
  }
}
</script>

<style lang="scss" scoped>
.dining-container {
  height: 100vh;
  background: #f8f9fa;
  overflow: hidden;
}

/* æ“ä½œæ  */
.action-bar {
  background: #fff;
  padding: 20rpx;
  margin-bottom: 20rpx;
  box-shadow: 0 2rpx 10rpx rgba(0, 0, 0, 0.1);
  position: sticky;
  top: 0;
  z-index: 10;
}

.action-tabs {
  display: flex;
  background: #f8f9fa;
  border-radius: 16rpx;
  padding: 8rpx;
}

.tab-item {
  flex: 1;
  text-align: center;
  padding: 20rpx;
  border-radius: 12rpx;
  transition: all 0.3s ease;
}

.tab-item.active {
  background: #667eea;
  color: #fff;
}

.tab-text {
  font-size: 28rpx;
  font-weight: 500;
}

/* æ ‡ç­¾é¡µå†…å®¹ */
.tab-content {
  padding: 20rpx;
  height: calc(100vh - 140rpx);
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
}

/* èœå•å¤´éƒ¨ */
.menu-header {
  background: #fff;
  border-radius: 20rpx;
  padding: 30rpx;
  margin-bottom: 20rpx;
  box-shadow: 0 4rpx 20rpx rgba(0, 0, 0, 0.1);
}

.date-selector {
  display: flex;
  align-items: center;
  justify-content: center;
  margin-bottom: 30rpx;
}

.date-btn {
  background: #f8f9fa;
  border: none;
  border-radius: 50%;
  width: 60rpx;
  height: 60rpx;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 20rpx;
}

.date-icon {
  font-size: 24rpx;
  color: #666;
}

.current-date {
  font-size: 32rpx;
  font-weight: 600;
  color: #333;
}

.meal-selector {
  display: flex;
  gap: 20rpx;
}

.meal-tab {
  flex: 1;
  text-align: center;
  padding: 20rpx;
  background: #f8f9fa;
  border-radius: 12rpx;
  transition: all 0.3s ease;
}

.meal-tab.active {
  background: #667eea;
  color: #fff;
}

.meal-text {
  font-size: 26rpx;
  font-weight: 500;
}

/* èœå•å†…å®¹ */
.menu-content {
  background: #fff;
  border-radius: 20rpx;
  padding: 30rpx;
  box-shadow: 0 4rpx 20rpx rgba(0, 0, 0, 0.1);
}

.menu-info {
  display: flex;
  align-items: center;
  margin-bottom: 30rpx;
  padding-bottom: 20rpx;
  border-bottom: 2rpx solid #f0f0f0;
}

.menu-title {
  font-size: 32rpx;
  font-weight: 600;
  color: #333;
  flex: 1;
}

.menu-time {
  font-size: 24rpx;
  color: #666;
  margin-right: 20rpx;
}

.menu-status {
  padding: 8rpx 16rpx;
  border-radius: 20rpx;
  font-size: 22rpx;
}

.status-published {
  background: #d4edda;
  color: #155724;
}

.status-draft {
  background: #f8d7da;
  color: #721c24;
}

/* èœå“åˆ†ç±» */
.dish-categories {
  display: flex;
  flex-direction: column;
  gap: 30rpx;
}

.category-section {
  background: #f8f9fa;
  border-radius: 16rpx;
  padding: 20rpx;
}

.category-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20rpx;
}

.category-title {
  font-size: 28rpx;
  font-weight: 600;
  color: #333;
}

.dish-count {
  font-size: 22rpx;
  color: #666;
}

.dish-list {
  display: flex;
  flex-direction: column;
  gap: 15rpx;
}

.dish-item {
  background: #fff;
  border-radius: 12rpx;
  padding: 20rpx;
}

.dish-info {
  margin-bottom: 15rpx;
}

.dish-name {
  display: block;
  font-size: 26rpx;
  font-weight: 600;
  color: #333;
  margin-bottom: 8rpx;
}

.dish-description {
  font-size: 22rpx;
  color: #666;
  line-height: 1.4;
  margin-bottom: 10rpx;
}

.dish-tags {
  display: flex;
  gap: 10rpx;
}

.tag {
  font-size: 20rpx;
  color: #667eea;
  background: rgba(102, 126, 234, 0.1);
  padding: 4rpx 12rpx;
  border-radius: 12rpx;
}

.dish-nutrition {
  display: flex;
  gap: 20rpx;
}

.nutrition-item {
  font-size: 20rpx;
  color: #999;
}

/* ç©ºèœå•çŠ¶æ€ */
.empty-menu {
  text-align: center;
  padding: 100rpx 40rpx;
}

.empty-icon {
  font-size: 120rpx;
  margin-bottom: 30rpx;
  opacity: 0.5;
}

.empty-text {
  display: block;
  font-size: 28rpx;
  color: #333;
  margin-bottom: 15rpx;
}

.empty-desc {
  font-size: 24rpx;
  color: #666;
}

/* æƒé™ä¸è¶³æç¤º */
.permission-denied {
  text-align: center;
  padding: 100rpx 40rpx;
}

.permission-icon {
  font-size: 120rpx;
  margin-bottom: 30rpx;
  opacity: 0.5;
}

.permission-title {
  display: block;
  font-size: 32rpx;
  font-weight: 600;
  color: #333;
  margin-bottom: 15rpx;
}

.permission-desc {
  font-size: 26rpx;
  color: #666;
  line-height: 1.4;
  margin-bottom: 30rpx;
}

.permission-info {
  background: #f8f9fa;
  border-radius: 12rpx;
  padding: 20rpx;
}

.info-item {
  font-size: 24rpx;
  color: #333;
}

/* æŠ¥é¤è¡¨å• */
.order-header {
  text-align: center;
  margin-bottom: 30rpx;
}

.order-title {
  display: block;
  font-size: 36rpx;
  font-weight: 600;
  color: #333;
  margin-bottom: 10rpx;
}

.order-subtitle {
  font-size: 24rpx;
  color: #666;
}

.order-form {
  background: #fff;
  border-radius: 20rpx;
  padding: 30rpx;
  box-shadow: 0 4rpx 20rpx rgba(0, 0, 0, 0.1);
}

.form-section {
  margin-bottom: 40rpx;
}

.section-label {
  display: block;
  font-size: 28rpx;
  font-weight: 600;
  color: #333;
  margin-bottom: 20rpx;
}

.form-row {
  display: flex;
  align-items: center;
  margin-bottom: 20rpx;
}

.form-label {
  width: 160rpx;
  font-size: 26rpx;
  color: #333;
}

.form-picker {
  flex: 1;
}

.picker-value {
  background: #f8f9fa;
  border: 2rpx solid #e9ecef;
  border-radius: 12rpx;
  padding: 20rpx;
  font-size: 26rpx;
  color: #333;
}

.form-textarea {
  width: 100%;
  height: 120rpx;
  background: #f8f9fa;
  border: 2rpx solid #e9ecef;
  border-radius: 12rpx;
  padding: 20rpx;
  font-size: 26rpx;
  color: #333;
  margin-bottom: 10rpx;
}

.char-count {
  text-align: right;
  font-size: 22rpx;
  color: #999;
}

/* éƒ¨é—¨æˆå‘˜ */
.member-list {
  background: #f8f9fa;
  border-radius: 16rpx;
  padding: 20rpx;
}

.member-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20rpx;
  padding-bottom: 20rpx;
  border-bottom: 2rpx solid #e9ecef;
}

.select-all {
  display: flex;
  align-items: center;
}

.select-checkbox {
  margin-right: 10rpx;
}

.select-text {
  font-size: 26rpx;
  color: #333;
}

.member-count {
  font-size: 22rpx;
  color: #666;
}

.member-items {
  display: flex;
  flex-direction: column;
  gap: 15rpx;
}

.member-item {
  display: flex;
  align-items: center;
  background: #fff;
  border-radius: 12rpx;
  padding: 20rpx;
  transition: all 0.3s ease;
}

.member-item:active {
  transform: scale(0.98);
}

.member-checkbox {
  margin-right: 20rpx;
}

.member-avatar-wrapper {
  width: 60rpx;
  height: 60rpx;
  border-radius: 50%;
  margin-right: 20rpx;
  overflow: hidden;
  background: #f0f0f0;
  display: flex;
  align-items: center;
  justify-content: center;
}

.member-avatar {
  width: 100%;
  height: 100%;
  border-radius: 50%;
}

.member-info {
  flex: 1;
}

.member-name {
  display: block;
  font-size: 26rpx;
  color: #333;
  margin-bottom: 5rpx;
}

.member-role {
  font-size: 22rpx;
  color: #666;
}

.member-status {
  padding: 6rpx 12rpx;
  border-radius: 16rpx;
  font-size: 20rpx;
}

.status-available {
  background: #d4edda;
  color: #155724;
}

/* è¡¨å•æ“ä½œ */
.form-actions {
  display: flex;
  gap: 20rpx;
  margin-top: 40rpx;
  padding-top: 20rpx;
}

.btn-secondary,
.btn-primary {
  flex: 1;
  height: 88rpx;
  border: none;
  border-radius: 16rpx;
  font-size: 28rpx;
  font-weight: 600;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.btn-secondary {
  background: #f8f9fa;
  color: #666;
}

.btn-primary {
  background: #667eea;
  color: #fff;
}

.btn-primary:disabled {
  background: #ccc;
  color: #999;
}

.btn-secondary:active,
.btn-primary:active {
  transform: scale(0.98);
}

/* æŠ¥é¤è®°å½• */
.record-header {
  background: #fff;
  border-radius: 20rpx;
  padding: 30rpx;
  margin-bottom: 20rpx;
  box-shadow: 0 4rpx 20rpx rgba(0, 0, 0, 0.1);
}

.record-title {
  display: block;
  font-size: 32rpx;
  font-weight: 600;
  color: #333;
  margin-bottom: 20rpx;
}

.record-filters {
  display: flex;
  gap: 20rpx;
}

.filter-picker {
  flex: 1;
}

.filter-value {
  background: #f8f9fa;
  border: 2rpx solid #e9ecef;
  border-radius: 12rpx;
  padding: 20rpx;
  font-size: 24rpx;
  color: #333;
  text-align: center;
}

/* è®°å½•åˆ—è¡¨ */
.record-list {
  display: flex;
  flex-direction: column;
  gap: 20rpx;
}

.record-item {
  background: #fff;
  border-radius: 20rpx;
  padding: 30rpx;
  box-shadow: 0 4rpx 20rpx rgba(0, 0, 0, 0.1);
  transition: all 0.3s ease;
}

.record-item:active {
  transform: scale(0.98);
}

.record-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20rpx;
}

.record-date {
  font-size: 28rpx;
  font-weight: 600;
  color: #333;
}

.record-status {
  padding: 8rpx 16rpx;
  border-radius: 20rpx;
  font-size: 22rpx;
}

.record-content {
  display: flex;
  flex-direction: column;
  gap: 15rpx;
}

.record-info {
  display: flex;
  gap: 20rpx;
}

.record-type {
  font-size: 24rpx;
  color: #333;
}

.record-count {
  font-size: 24rpx;
  color: #667eea;
  font-weight: 600;
}

.record-members {
  background: #f8f9fa;
  border-radius: 12rpx;
  padding: 15rpx;
}

.members-text {
  font-size: 24rpx;
  color: #333;
  line-height: 1.4;
}

.record-time {
  display: flex;
  gap: 10rpx;
}

.time-label {
  font-size: 22rpx;
  color: #666;
}

.time-value {
  font-size: 22rpx;
  color: #333;
}

/* ç©ºè®°å½•çŠ¶æ€ */
.empty-record {
  text-align: center;
  padding: 100rpx 40rpx;
}

/* åŠ è½½æ›´å¤š */
.load-more {
  text-align: center;
  padding: 40rpx;
}

.load-more-btn {
  background: #f8f9fa;
  border: 2rpx solid #e9ecef;
  border-radius: 16rpx;
  padding: 20rpx 40rpx;
  font-size: 26rpx;
  color: #666;
}

/* åŠ è½½çŠ¶æ€ */
.loading-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 100rpx 40rpx;
}

.loading-spinner {
  width: 60rpx;
  height: 60rpx;
  border: 4rpx solid #f3f3f3;
  border-top: 4rpx solid #667eea;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin-bottom: 20rpx;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.loading-text {
  font-size: 26rpx;
  color: #666;
}

/* æœç´¢å’Œç­›é€‰æ ·å¼ */
.member-filters {
  margin-bottom: 20rpx;
}

.search-box {
  position: relative;
  margin-bottom: 20rpx;
}

.search-input {
  width: 100%;
  padding: 20rpx 60rpx 20rpx 20rpx;
  border: 2rpx solid #e0e0e0;
  border-radius: 8rpx;
  font-size: 28rpx;
  background: #fafafa;
  box-sizing: border-box;
}

.search-input:focus {
  border-color: #2196f3;
  background: #fff;
}

.search-icon {
  position: absolute;
  right: 20rpx;
  top: 50%;
  transform: translateY(-50%);
  font-size: 32rpx;
  color: #999;
}

.role-filters {
  display: flex;
  gap: 20rpx;
  flex-wrap: wrap;
}

.role-filter-item {
  padding: 12rpx 24rpx;
  border: 2rpx solid #e0e0e0;
  border-radius: 20rpx;
  font-size: 24rpx;
  color: #666;
  background: #fff;
  transition: all 0.3s ease;
}

.role-filter-item.active {
  background: #2196f3;
  color: #fff;
  border-color: #2196f3;
}

.role-filter-item:active {
  transform: scale(0.95);
}

/* å¿«é€Ÿé€‰æ‹©æ ·å¼ */
.quick-select {
  margin-bottom: 20rpx;
  padding: 20rpx;
  background: #f0f7ff;
  border-radius: 8rpx;
  border: 2rpx solid #e3f2fd;
}

.quick-select-label {
  font-size: 26rpx;
  color: #333;
  margin-bottom: 15rpx;
  display: block;
}

.quick-select-actions {
  display: flex;
  gap: 15rpx;
  flex-wrap: wrap;
}

.quick-action {
  padding: 8rpx 16rpx;
  background: #2196f3;
  color: #fff;
  font-size: 22rpx;
  border-radius: 6rpx;
  transition: all 0.3s ease;
}

.quick-action:active {
  background: #1976d2;
  transform: scale(0.95);
}

/* æˆå‘˜åˆ—è¡¨å®¹å™¨ */
.member-items-container {
  border: 2rpx solid #f0f0f0;
  border-radius: 8rpx;
  background: #fafafa;
}

.member-items-scroll {
  width: 100%;
}

.member-item.selected {
  background: #e3f2fd !important;
  border-color: #2196f3 !important;
  box-shadow: 0 4rpx 8rpx rgba(33,150,243,0.15);
}

.member-item:active {
  transform: scale(0.98);
}

.member-dept {
  font-size: 22rpx;
  color: #999;
}

/* åŠ è½½æ›´å¤š */
.load-more {
  padding: 30rpx;
  text-align: center;
}

.load-more-text {
  font-size: 26rpx;
  color: #999;
}

/* æ— åŒ¹é…ç»“æœ */
.no-members {
  padding: 60rpx 20rpx;
  text-align: center;
}

.no-members-icon {
  font-size: 80rpx;
  margin-bottom: 20rpx;
}

.no-members-text {
  font-size: 28rpx;
  color: #666;
  margin-bottom: 10rpx;
  display: block;
}

.no-members-desc {
  font-size: 24rpx;
  color: #999;
  display: block;
}

/* é€‰ä¸­æˆå‘˜é¢„è§ˆ */
.selected-members-preview {
  margin-top: 20rpx;
  border: 2rpx solid #e3f2fd;
  border-radius: 8rpx;
  background: #f8fdff;
}

.preview-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20rpx;
  border-bottom: 2rpx solid #e3f2fd;
}

.preview-title {
  font-size: 26rpx;
  color: #333;
  font-weight: 500;
}

.preview-toggle {
  font-size: 24rpx;
  color: #2196f3;
  padding: 8rpx 16rpx;
  border: 2rpx solid #2196f3;
  border-radius: 6rpx;
  transition: all 0.3s ease;
}

.preview-toggle:active {
  background: #2196f3;
  color: #fff;
}

.preview-content {
  padding: 20rpx;
}

.selected-member-tags {
  display: flex;
  flex-wrap: wrap;
  gap: 12rpx;
}

.selected-member-tag {
  display: flex;
  align-items: center;
  gap: 8rpx;
  padding: 8rpx 12rpx;
  background: #2196f3;
  color: #fff;
  border-radius: 20rpx;
  font-size: 24rpx;
  transition: all 0.3s ease;
}

.selected-member-tag:active {
  background: #1976d2;
  transform: scale(0.95);
}

.tag-name {
  font-size: 22rpx;
}

.tag-close {
  font-size: 28rpx;
  font-weight: bold;
  margin-left: 4rpx;
}

/* ä»·æ ¼è¿‡æ»¤ */
.price-filter {
  margin-top: 20rpx;
  padding: 20rpx;
  background: #f8f9fa;
  border-radius: 12rpx;
  border: 2rpx solid #e9ecef;
}

.price-label {
  font-size: 26rpx;
  color: #333;
  margin-bottom: 15rpx;
  display: block;
}

.price-range {
  display: flex;
  align-items: center;
  gap: 10rpx;
}

.price-input {
  flex: 1;
  padding: 10rpx 20rpx;
  border: 2rpx solid #e0e0e0;
  border-radius: 8rpx;
  font-size: 26rpx;
  color: #333;
  background: #fff;
}

.price-separator {
  font-size: 26rpx;
  color: #666;
}

/* é‡ç½®æŒ‰é’® */
.reset-filters {
  margin-top: 20rpx;
  padding: 15rpx 30rpx;
  background: #f8f9fa;
  border: 2rpx solid #e9ecef;
  border-radius: 12rpx;
  font-size: 26rpx;
  color: #666;
  text-align: center;
  transition: all 0.3s ease;
}

.reset-filters:active {
  background: #e9ecef;
  transform: scale(0.98);
}

.reset-text {
  font-size: 26rpx;
  font-weight: 500;
}

/* è¿‡æ»¤å·¥å…·æ  */
.filter-toolbar {
  margin-bottom: 30rpx;
  padding: 20rpx;
  background: #f8f9fa;
  border-radius: 16rpx;
  border: 2rpx solid #e9ecef;
}

/* æœç´¢å®¹å™¨ */
.search-container {
  position: relative;
  margin-bottom: 20rpx;
}

.search-input {
  width: 100%;
  padding: 20rpx 60rpx 20rpx 20rpx;
  border: 2rpx solid #e0e0e0;
  border-radius: 12rpx;
  font-size: 26rpx;
  background: #fff;
  box-sizing: border-box;
}

.search-input:focus {
  border-color: #667eea;
  outline: none;
}

.search-icon {
  position: absolute;
  right: 20rpx;
  top: 50%;
  transform: translateY(-50%);
  font-size: 28rpx;
  color: #999;
}

/* åˆ†ç±»è¿‡æ»¤ */
.category-filters {
  display: flex;
  gap: 15rpx;
  margin-bottom: 20rpx;
  flex-wrap: wrap;
}

.category-filter-item {
  padding: 12rpx 24rpx;
  border: 2rpx solid #e0e0e0;
  border-radius: 20rpx;
  font-size: 24rpx;
  color: #666;
  background: #fff;
  transition: all 0.3s ease;
}

.category-filter-item.active {
  background: #667eea;
  color: #fff;
  border-color: #667eea;
}

.category-filter-item:active {
  transform: scale(0.95);
}

/* æ ‡ç­¾è¿‡æ»¤ */
.tag-filters {
  display: flex;
  gap: 15rpx;
  margin-bottom: 20rpx;
  flex-wrap: wrap;
}

.tag-filter-item {
  padding: 10rpx 20rpx;
  border: 2rpx solid #e0e0e0;
  border-radius: 16rpx;
  font-size: 22rpx;
  color: #666;
  background: #fff;
  transition: all 0.3s ease;
}

.tag-filter-item.active {
  background: #28a745;
  color: #fff;
  border-color: #28a745;
}

.tag-filter-item:active {
  transform: scale(0.95);
}
</style>
