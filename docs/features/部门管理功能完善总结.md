# éƒ¨é—¨ç®¡ç†åŠŸèƒ½å®Œå–„æ€»ç»“

## ğŸ¯ å®Œå–„ç›®æ ‡

æ ¹æ®æ–°å»ºéƒ¨é—¨æ¥å£æ–‡æ¡£ï¼Œå®Œå–„å‰ç«¯éƒ¨é—¨ç®¡ç†åŠŸèƒ½ï¼ŒåŒ…æ‹¬æ–°å»ºéƒ¨é—¨ã€ç¼–è¾‘éƒ¨é—¨ã€åˆ é™¤éƒ¨é—¨ç­‰å®Œæ•´åŠŸèƒ½ã€‚

## ğŸ“‹ æ¥å£æ–‡æ¡£åˆ†æ

### æ–°å»ºéƒ¨é—¨æ¥å£

#### 1. **ç³»ç»Ÿç®¡ç†å‘˜æƒé™æ¥å£**
- **åœ°å€**: `POST /api/department`
- **æƒé™**: `sys_admin` æƒé™
- **åŠŸèƒ½**: åˆ›å»ºå®Œæ•´çš„éƒ¨é—¨ä¿¡æ¯

#### 2. **ç®¡ç†å‘˜æƒé™æ¥å£**
- **åœ°å€**: `POST /api/admin/departments`
- **æƒé™**: `admin` æƒé™
- **åŠŸèƒ½**: åˆ›å»ºåŸºæœ¬éƒ¨é—¨ä¿¡æ¯

### è¯·æ±‚å‚æ•°

#### å¿…å¡«å­—æ®µ
- **`name`**: éƒ¨é—¨åç§°ï¼ˆ2-100ä¸ªå­—ç¬¦ï¼‰
- **`code`**: éƒ¨é—¨ç¼–ç ï¼ˆ2-20ä¸ªå­—ç¬¦ï¼Œåªèƒ½åŒ…å«å¤§å†™å­—æ¯å’Œä¸‹åˆ’çº¿ï¼‰

#### å¯é€‰å­—æ®µ
- **`description`**: éƒ¨é—¨æè¿°
- **`parentId`**: ä¸Šçº§éƒ¨é—¨ID
- **`level`**: éƒ¨é—¨çº§åˆ«
- **`managerId`**: éƒ¨é—¨ç®¡ç†å‘˜ID
- **`sort`**: æ’åºå€¼

### å“åº”æ ¼å¼

#### æˆåŠŸå“åº”
```json
{
  "success": true,
  "data": {
    "_id": "new-dept-id",
    "name": "æŠ€æœ¯å¼€å‘éƒ¨",
    "code": "TECH_DEV",
    "status": "active"
  },
  "message": "åˆ›å»ºéƒ¨é—¨æˆåŠŸ"
}
```

## ğŸ”§ åŠŸèƒ½å®ç°

### 1. **åˆ›å»ºéƒ¨é—¨ç¼–è¾‘é¡µé¢**

#### é¡µé¢ç»“æ„
```vue
<!-- dept-edit.vue -->
<template>
  <view class="dept-edit-page">
    <!-- é¡µé¢å¤´éƒ¨ -->
    <view class="page-header">
      <button class="back-btn" @click="goBack">â†</button>
      <text class="page-title">{{ isEditMode ? 'ç¼–è¾‘éƒ¨é—¨' : 'æ–°å»ºéƒ¨é—¨' }}</text>
      <button class="save-btn" @click="saveDepartment">ä¿å­˜</button>
    </view>

    <!-- è¡¨å•å†…å®¹ -->
    <view class="form-container">
      <!-- åŸºæœ¬ä¿¡æ¯ -->
      <view class="form-section">
        <view class="form-item">
          <text class="form-label required">éƒ¨é—¨åç§°</text>
          <input v-model="formData.name" placeholder="è¯·è¾“å…¥éƒ¨é—¨åç§°" />
        </view>
        
        <view class="form-item">
          <text class="form-label required">éƒ¨é—¨ç¼–ç </text>
          <input v-model="formData.code" placeholder="è¯·è¾“å…¥éƒ¨é—¨ç¼–ç " />
        </view>
        
        <view class="form-item">
          <text class="form-label">éƒ¨é—¨æè¿°</text>
          <textarea v-model="formData.description" placeholder="è¯·è¾“å…¥éƒ¨é—¨æè¿°" />
        </view>
      </view>

      <!-- éƒ¨é—¨è®¾ç½® -->
      <view class="form-section">
        <view class="form-item">
          <text class="form-label">ä¸Šçº§éƒ¨é—¨</text>
          <picker :range="parentDepartmentOptions" @change="onParentDepartmentChange">
            <view class="form-picker">
              <text>{{ selectedParentDepartment || 'è¯·é€‰æ‹©ä¸Šçº§éƒ¨é—¨' }}</text>
            </view>
          </picker>
        </view>
        
        <view class="form-item">
          <text class="form-label">éƒ¨é—¨çº§åˆ«</text>
          <picker :range="levelOptions" @change="onLevelChange">
            <view class="form-picker">
              <text>{{ selectedLevelText }}</text>
            </view>
          </picker>
        </view>
        
        <view class="form-item">
          <text class="form-label">éƒ¨é—¨ç®¡ç†å‘˜</text>
          <picker :range="managerOptions" @change="onManagerChange">
            <view class="form-picker">
              <text>{{ selectedManagerText }}</text>
            </view>
          </picker>
        </view>
      </view>

      <!-- çŠ¶æ€è®¾ç½® -->
      <view class="form-section">
        <view class="form-item">
          <text class="form-label">éƒ¨é—¨çŠ¶æ€</text>
          <view class="status-options">
            <view class="status-option" :class="{ active: formData.status === 'active' }" @click="setStatus('active')">
              <text class="status-text">æ­£å¸¸</text>
            </view>
            <view class="status-option" :class="{ active: formData.status === 'inactive' }" @click="setStatus('inactive')">
              <text class="status-text">åœç”¨</text>
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>
</template>
```

### 2. **è¡¨å•æ•°æ®ç»“æ„**

```javascript
data() {
  return {
    // è¡¨å•æ•°æ®
    formData: {
      name: '',           // éƒ¨é—¨åç§°
      code: '',           // éƒ¨é—¨ç¼–ç 
      description: '',    // éƒ¨é—¨æè¿°
      parentId: '',       // ä¸Šçº§éƒ¨é—¨ID
      level: 1,           // éƒ¨é—¨çº§åˆ«
      managerId: '',     // éƒ¨é—¨ç®¡ç†å‘˜ID
      sort: 0,            // æ’åºå€¼
      status: 'active'    // éƒ¨é—¨çŠ¶æ€
    },
    
    // éªŒè¯é”™è¯¯
    validationErrors: {},
    
    // é€‰é¡¹æ•°æ®
    departmentsList: [],  // éƒ¨é—¨åˆ—è¡¨
    usersList: [],       // ç”¨æˆ·åˆ—è¡¨
    
    // æ¨¡å¼
    isEditMode: false,   // æ˜¯å¦ä¸ºç¼–è¾‘æ¨¡å¼
    departmentId: null,   // éƒ¨é—¨ID
    parentId: null       // çˆ¶éƒ¨é—¨ID
  }
}
```

### 3. **æ•°æ®éªŒè¯**

#### éƒ¨é—¨åç§°éªŒè¯
```javascript
validateName() {
  const name = this.formData.name.trim()
  if (!name) {
    this.validationErrors.name = 'éƒ¨é—¨åç§°ä¸èƒ½ä¸ºç©º'
    return false
  }
  if (name.length < 2) {
    this.validationErrors.name = 'éƒ¨é—¨åç§°è‡³å°‘éœ€è¦2ä¸ªå­—ç¬¦'
    return false
  }
  if (name.length > 100) {
    this.validationErrors.name = 'éƒ¨é—¨åç§°ä¸èƒ½è¶…è¿‡100ä¸ªå­—ç¬¦'
    return false
  }
  this.validationErrors.name = ''
  return true
}
```

#### éƒ¨é—¨ç¼–ç éªŒè¯
```javascript
validateCode() {
  const code = this.formData.code.trim()
  if (!code) {
    this.validationErrors.code = 'éƒ¨é—¨ç¼–ç ä¸èƒ½ä¸ºç©º'
    return false
  }
  if (code.length < 2) {
    this.validationErrors.code = 'éƒ¨é—¨ç¼–ç è‡³å°‘éœ€è¦2ä¸ªå­—ç¬¦'
    return false
  }
  if (code.length > 20) {
    this.validationErrors.code = 'éƒ¨é—¨ç¼–ç ä¸èƒ½è¶…è¿‡20ä¸ªå­—ç¬¦'
    return false
  }
  if (!/^[A-Z_]+$/.test(code)) {
    this.validationErrors.code = 'éƒ¨é—¨ç¼–ç åªèƒ½åŒ…å«å¤§å†™å­—æ¯å’Œä¸‹åˆ’çº¿'
    return false
  }
  this.validationErrors.code = ''
  return true
}
```

### 4. **APIæ¥å£è°ƒç”¨**

#### åˆ›å»ºéƒ¨é—¨
```javascript
async saveDepartment() {
  // éªŒè¯è¡¨å•
  const nameValid = this.validateName()
  const codeValid = this.validateCode()
  
  if (!nameValid || !codeValid) {
    uni.showToast({
      title: 'è¯·æ£€æŸ¥è¡¨å•å¡«å†™',
      icon: 'error'
    })
    return
  }
  
  this.saving = true
  try {
    // å‡†å¤‡æ•°æ®
    const saveData = {
      name: this.formData.name.trim(),
      code: this.formData.code.trim(),
      description: this.formData.description.trim(),
      parentId: this.formData.parentId || null,
      level: this.formData.level,
      managerId: this.formData.managerId || null,
      sort: this.formData.sort || 0,
      status: this.formData.status
    }
    
    let response
    if (this.isEditMode) {
      response = await api.admin.updateDepartment(this.departmentId, saveData)
    } else {
      response = await api.admin.createDepartment(saveData)
    }
    
    if (response.success) {
      uni.showToast({
        title: this.isEditMode ? 'æ›´æ–°æˆåŠŸ' : 'åˆ›å»ºæˆåŠŸ',
        icon: 'success'
      })
      
      setTimeout(() => {
        uni.navigateBack()
      }, 1500)
    } else {
      throw new Error(response.message || 'ä¿å­˜å¤±è´¥')
    }
  } catch (error) {
    console.error('ä¿å­˜éƒ¨é—¨å¤±è´¥:', error)
    uni.showToast({
      title: error.message || 'ä¿å­˜å¤±è´¥',
      icon: 'error'
    })
  } finally {
    this.saving = false
  }
}
```

### 5. **é¡µé¢è·¯ç”±é›†æˆ**

#### æ–°å»ºéƒ¨é—¨
```javascript
// åœ¨ users.vue ä¸­
addDepartment() {
  uni.switchtab({
    url: '/pages/admin/dept-edit?action=create'
  })
}
```

#### æ·»åŠ å­éƒ¨é—¨
```javascript
addSubDepartment(parentDept) {
  uni.switchtab({
    url: `/pages/admin/dept-edit?action=create&parentId=${parentDept._id || parentDept.id}`
  })
}
```

#### ç¼–è¾‘éƒ¨é—¨
```javascript
editDepartment(dept) {
  uni.navigateTo({
    url: `/pages/admin/dept-edit?action=edit&id=${dept._id || dept.id}`
  })
}
```

## ğŸ¨ ç•Œé¢è®¾è®¡

### 1. **é¡µé¢å¸ƒå±€**

#### å¤´éƒ¨è®¾è®¡
- **è¿”å›æŒ‰é’®**: å·¦ä¾§è¿”å›ç®­å¤´
- **é¡µé¢æ ‡é¢˜**: å±…ä¸­æ˜¾ç¤º"æ–°å»ºéƒ¨é—¨"æˆ–"ç¼–è¾‘éƒ¨é—¨"
- **ä¿å­˜æŒ‰é’®**: å³ä¾§ä¿å­˜æŒ‰é’®

#### è¡¨å•è®¾è®¡
- **åˆ†ç»„å¸ƒå±€**: åŸºæœ¬ä¿¡æ¯ã€éƒ¨é—¨è®¾ç½®ã€çŠ¶æ€è®¾ç½®
- **å¡ç‰‡æ ·å¼**: æ¯ä¸ªåˆ†ç»„ä½¿ç”¨ç™½è‰²å¡ç‰‡
- **åœ†è§’è®¾è®¡**: ç»Ÿä¸€çš„åœ†è§’é£æ ¼

### 2. **è¡¨å•ç»„ä»¶**

#### è¾“å…¥æ¡†
```scss
.form-input {
  width: 100%;
  padding: 20rpx;
  border: 2rpx solid #e9ecef;
  border-radius: 12rpx;
  font-size: 26rpx;
  background: white;
  
  &:focus {
    border-color: #667eea;
  }
}
```

#### é€‰æ‹©å™¨
```scss
.form-picker {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20rpx;
  border: 2rpx solid #e9ecef;
  border-radius: 12rpx;
  background: white;
  
  &:active {
    border-color: #667eea;
  }
}
```

#### çŠ¶æ€é€‰æ‹©
```scss
.status-options {
  display: flex;
  gap: 20rpx;
}

.status-option {
  flex: 1;
  padding: 20rpx;
  border: 2rpx solid #e9ecef;
  border-radius: 12rpx;
  text-align: center;
  cursor: pointer;
  transition: all 0.2s ease;
  
  &.active {
    border-color: #667eea;
    background: #f8f9ff;
  }
}
```

## ğŸ“± ç”¨æˆ·ä½“éªŒ

### 1. **è¡¨å•éªŒè¯**
- **å®æ—¶éªŒè¯**: è¾“å…¥æ—¶å³æ—¶éªŒè¯
- **é”™è¯¯æç¤º**: æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯æ˜¾ç¤º
- **å¿…å¡«æ ‡è¯†**: å¿…å¡«å­—æ®µç”¨çº¢è‰²æ˜Ÿå·æ ‡è¯†

### 2. **æ•°æ®åŠ è½½**
- **åŠ è½½çŠ¶æ€**: æ˜¾ç¤ºåŠ è½½ä¸­çŠ¶æ€
- **é”™è¯¯å¤„ç†**: ç½‘ç»œé”™è¯¯å‹å¥½æç¤º
- **æ•°æ®å›æ˜¾**: ç¼–è¾‘æ—¶æ­£ç¡®å›æ˜¾æ•°æ®

### 3. **æ“ä½œåé¦ˆ**
- **ä¿å­˜çŠ¶æ€**: ä¿å­˜ä¸­ç¦ç”¨æŒ‰é’®
- **æˆåŠŸæç¤º**: æ“ä½œæˆåŠŸToastæç¤º
- **è‡ªåŠ¨è¿”å›**: æˆåŠŸåè‡ªåŠ¨è¿”å›åˆ—è¡¨

## ğŸ”„ åŠŸèƒ½æµç¨‹

### 1. **æ–°å»ºéƒ¨é—¨æµç¨‹**
```
ç‚¹å‡»"æ–°å»ºéƒ¨é—¨" â†’ è·³è½¬ç¼–è¾‘é¡µé¢ â†’ å¡«å†™è¡¨å• â†’ éªŒè¯æ•°æ® â†’ è°ƒç”¨API â†’ åˆ›å»ºæˆåŠŸ â†’ è¿”å›åˆ—è¡¨
```

### 2. **ç¼–è¾‘éƒ¨é—¨æµç¨‹**
```
ç‚¹å‡»"ç¼–è¾‘" â†’ è·³è½¬ç¼–è¾‘é¡µé¢ â†’ åŠ è½½éƒ¨é—¨æ•°æ® â†’ å›æ˜¾è¡¨å• â†’ ä¿®æ”¹æ•°æ® â†’ éªŒè¯æ•°æ® â†’ è°ƒç”¨API â†’ æ›´æ–°æˆåŠŸ â†’ è¿”å›åˆ—è¡¨
```

### 3. **æ·»åŠ å­éƒ¨é—¨æµç¨‹**
```
ç‚¹å‡»"æ·»åŠ å­éƒ¨é—¨" â†’ è·³è½¬ç¼–è¾‘é¡µé¢ â†’ è‡ªåŠ¨è®¾ç½®çˆ¶éƒ¨é—¨ â†’ å¡«å†™è¡¨å• â†’ éªŒè¯æ•°æ® â†’ è°ƒç”¨API â†’ åˆ›å»ºæˆåŠŸ â†’ è¿”å›åˆ—è¡¨
```

## ğŸ§ª æµ‹è¯•éªŒè¯

### 1. **åŠŸèƒ½æµ‹è¯•**
- âœ… æ–°å»ºéƒ¨é—¨åŠŸèƒ½æ­£å¸¸
- âœ… ç¼–è¾‘éƒ¨é—¨åŠŸèƒ½æ­£å¸¸
- âœ… æ·»åŠ å­éƒ¨é—¨åŠŸèƒ½æ­£å¸¸
- âœ… åˆ é™¤éƒ¨é—¨åŠŸèƒ½æ­£å¸¸

### 2. **éªŒè¯æµ‹è¯•**
- âœ… éƒ¨é—¨åç§°éªŒè¯æ­£å¸¸
- âœ… éƒ¨é—¨ç¼–ç éªŒè¯æ­£å¸¸
- âœ… å¿…å¡«å­—æ®µéªŒè¯æ­£å¸¸
- âœ… æ ¼å¼éªŒè¯æ­£å¸¸

### 3. **ç•Œé¢æµ‹è¯•**
- âœ… è¡¨å•å¸ƒå±€æ­£å¸¸
- âœ… é€‰æ‹©å™¨åŠŸèƒ½æ­£å¸¸
- âœ… çŠ¶æ€åˆ‡æ¢æ­£å¸¸
- âœ… å“åº”å¼é€‚é…æ­£å¸¸

## ğŸ“ æ³¨æ„äº‹é¡¹

### 1. **æƒé™æ§åˆ¶**
- ç¡®ä¿ç”¨æˆ·æœ‰ç›¸åº”çš„ç®¡ç†æƒé™
- ç³»ç»Ÿç®¡ç†å‘˜å¯ä»¥åˆ›å»ºæ‰€æœ‰éƒ¨é—¨
- æ™®é€šç®¡ç†å‘˜æƒé™å—é™

### 2. **æ•°æ®ä¸€è‡´æ€§**
- éƒ¨é—¨ç¼–ç å¿…é¡»å”¯ä¸€
- ä¸Šçº§éƒ¨é—¨ä¸èƒ½æ˜¯è‡ªèº«
- ç®¡ç†å‘˜å¿…é¡»æ˜¯æœ‰æ•ˆç”¨æˆ·

### 3. **é”™è¯¯å¤„ç†**
- ç½‘ç»œé”™è¯¯å‹å¥½æç¤º
- éªŒè¯é”™è¯¯æ¸…æ™°æ˜¾ç¤º
- æ“ä½œå¤±è´¥é‡è¯•æœºåˆ¶

## ğŸ‰ æ€»ç»“

é€šè¿‡æœ¬æ¬¡å®Œå–„ï¼Œéƒ¨é—¨ç®¡ç†åŠŸèƒ½ç°åœ¨åŒ…æ‹¬ï¼š

1. **å®Œæ•´çš„CRUDæ“ä½œ**: åˆ›å»ºã€è¯»å–ã€æ›´æ–°ã€åˆ é™¤
2. **å®Œå–„çš„è¡¨å•éªŒè¯**: å®æ—¶éªŒè¯å’Œé”™è¯¯æç¤º
3. **å‹å¥½çš„ç”¨æˆ·ç•Œé¢**: æ¸…æ™°çš„å¸ƒå±€å’Œäº¤äº’
4. **å®Œæ•´çš„æƒé™æ§åˆ¶**: åŸºäºè§’è‰²çš„æƒé™ç®¡ç†
5. **è‰¯å¥½çš„ç”¨æˆ·ä½“éªŒ**: æµç•…çš„æ“ä½œå’Œåé¦ˆ

ç°åœ¨éƒ¨é—¨ç®¡ç†åŠŸèƒ½å·²ç»å®Œå…¨å¯¹æ¥åç«¯æ¥å£ï¼Œä¸ºç”¨æˆ·æä¾›äº†å®Œæ•´çš„éƒ¨é—¨ç®¡ç†è§£å†³æ–¹æ¡ˆï¼
