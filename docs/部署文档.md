# 智慧物业管理系统 - 部署文档

## 📋 文档概述

本文档详细说明智慧物业管理系统的部署流程，包括开发模式和生产模式的配置、构建、部署等完整流程。

**文档版本**：v1.0.0  
**最后更新**：2024年1月15日  
**适用环境**：Windows、macOS、Linux

---

## 🏗️ 系统架构

### 整体架构
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   前端应用      │    │   后端服务      │    │   数据库        │
│   (Uni-app)     │◄──►│   (Node.js)     │◄──►│   (MySQL)       │
│                 │    │                 │    │                 │
│ • H5            │    │ • Express API   │    │ • 用户数据      │
│ • 小程序        │    │ • JWT认证       │    │ • 报餐数据      │
│ • APP           │    │ • 文件上传      │    │ • 预约数据      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### 技术栈
- **前端**：Vue 3 + Uni-app + Vite
- **后端**：Node.js + Express + MySQL
- **认证**：JWT Token + 微信授权
- **部署**：支持多平台部署

---

## 🛠️ 环境要求

### 开发环境
- **Node.js**：>= 16.0.0
- **npm**：>= 8.0.0
- **Git**：>= 2.0.0
- **IDE**：VS Code（推荐）

### 生产环境
- **服务器**：Linux/Windows Server
- **Node.js**：>= 16.0.0
- **MySQL**：>= 8.0
- **Nginx**：>= 1.18（可选，用于反向代理）

### 平台支持
- **H5**：现代浏览器（Chrome、Firefox、Safari、Edge）
- **小程序**：微信小程序
- **APP**：iOS、Android

---

## 🚀 开发模式部署

### 1. 环境准备

#### 安装Node.js
```bash
# 下载并安装Node.js 16+
# 访问 https://nodejs.org/ 下载LTS版本

# 验证安装
node --version
npm --version
```

#### 安装项目依赖
```bash
# 克隆项目
git clone <项目地址>
cd my-vue3-project

# 安装依赖
npm install
```

### 2. 配置开发环境

#### 后端服务配置
确保后端服务在 `http://localhost:3000` 运行：

```bash
# 在后端项目目录中
cd backend
npm install
npm start
```

#### 前端环境配置
系统会自动检测开发环境：

```javascript
// src/utils/api.js 中的环境检测逻辑
const isLocalhost = currentUrl.includes('localhost') ||
                   currentUrl.includes('127.0.0.1') ||
                   currentUrl.includes('192.168.') ||
                   currentUrl.includes('10.0.') ||
                   currentUrl.includes('172.')

if (isLocalhost) {
  return API_CONFIG.DEV_BASE_URL // http://localhost:3000
}
```

### 3. 启动开发服务器

#### H5开发
```bash
# 启动H5开发服务器
npm run dev:h5

# 访问地址：http://localhost:8080
```

#### 微信小程序开发
```bash
# 启动小程序开发服务器
npm run dev:mp-weixin

# 使用微信开发者工具打开 dist/dev/mp-weixin 目录
```

#### APP开发
```bash
# 启动APP开发服务器
npm run dev:app-plus

# 使用HBuilderX运行到手机或模拟器
```

### 4. 开发环境验证

#### 检查环境切换
1. 打开浏览器开发者工具
2. 查看控制台输出，应该显示：
   ```
   当前为开发环境，使用本地开发服务器: http://localhost:3000
   ```

#### 测试API连接
```javascript
// 在浏览器控制台中测试
fetch('http://localhost:3000/health')
  .then(response => response.json())
  .then(data => console.log('后端服务正常:', data))
```

#### 测试登录功能
使用测试登录接口：
```javascript
// 普通用户测试登录
fetch('http://localhost:3000/api/auth/test-login', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({ role: 'user' })
})
```

---

## 🏭 生产模式部署

### 1. 构建应用

#### H5版本构建
```bash
# 构建H5版本
npm run build:h5

# 构建产物位于 dist/build/h5/ 目录
```

#### 微信小程序构建
```bash
# 构建小程序版本
npm run build:mp-weixin

# 构建产物位于 dist/build/mp-weixin/ 目录
```

#### APP版本构建
```bash
# 构建APP版本
npm run build:app-plus

# 构建产物位于 dist/build/app-plus/ 目录
```

### 2. 生产环境配置

#### 环境变量配置
创建生产环境配置文件：

```bash
# .env.production
NODE_ENV=production
VUE_APP_API_BASE_URL=https://jcdtnpaompjy.sealosbja.site
VUE_APP_VERSION=1.0.0
```

#### API地址配置
生产环境会自动使用生产API地址：

```javascript
// src/utils/api.js
const API_CONFIG = {
  PROD_BASE_URL: 'https://jcdtnpaompjy.sealosbja.site',
  DEV_BASE_URL: 'http://localhost:3000'
}

// 生产环境检测
if (!isLocalhost) {
  return API_CONFIG.PROD_BASE_URL
}
```

### 3. 部署方式

#### 方式一：静态文件部署

**H5部署到Web服务器**：
```bash
# 1. 构建H5版本
npm run build:h5

# 2. 将 dist/build/h5/ 目录内容上传到Web服务器
# 3. 配置Web服务器（Nginx/Apache）指向该目录
```

**Nginx配置示例**：
```nginx
server {
    listen 80;
    server_name your-domain.com;
    root /path/to/dist/build/h5;
    index index.html;

    # 处理Vue Router的history模式
    location / {
        try_files $uri $uri/ /index.html;
    }

    # 静态资源缓存
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}
```

#### 方式二：CDN部署

**上传到CDN**：
```bash
# 1. 构建应用
npm run build:h5

# 2. 上传到CDN（如阿里云OSS、腾讯云COS等）
# 3. 配置CDN域名和缓存策略
```

#### 方式三：容器化部署

**Docker部署**：
```dockerfile
# Dockerfile
FROM nginx:alpine

# 复制构建产物
COPY dist/build/h5 /usr/share/nginx/html

# 复制Nginx配置
COPY nginx.conf /etc/nginx/nginx.conf

EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]
```

```bash
# 构建Docker镜像
docker build -t property-management-frontend .

# 运行容器
docker run -d -p 80:80 property-management-frontend
```

### 4. 小程序部署

#### 微信小程序发布
```bash
# 1. 构建小程序版本
npm run build:mp-weixin

# 2. 使用微信开发者工具打开 dist/build/mp-weixin 目录
# 3. 在微信开发者工具中点击"上传"
# 4. 在微信公众平台提交审核
# 5. 审核通过后发布
```

#### 小程序配置
```json
// manifest.json 小程序配置
{
  "mp-weixin": {
    "appid": "your-miniprogram-appid",
    "setting": {
      "urlCheck": false,
      "es6": true,
      "enhance": true,
      "postcss": true,
      "minified": true
    },
    "usingComponents": true
  }
}
```

### 5. APP部署

#### Android APP
```bash
# 1. 构建APP版本
npm run build:app-plus

# 2. 使用HBuilderX打开项目
# 3. 选择"发行" -> "原生App-云打包"
# 4. 配置打包参数并提交打包
# 5. 下载APK文件进行安装
```

#### iOS APP
```bash
# 1. 构建APP版本
npm run build:app-plus

# 2. 使用HBuilderX打开项目
# 3. 选择"发行" -> "原生App-云打包"
# 4. 选择iOS平台并配置证书
# 5. 提交打包并下载IPA文件
```

---

## 🔧 环境配置详解

### 开发环境配置

#### 自动环境检测
系统通过以下方式自动检测环境：

```javascript
// 1. URL检测（优先级最高）
const currentUrl = window.location?.href || ''
const isLocalhost = currentUrl.includes('localhost') ||
                   currentUrl.includes('127.0.0.1') ||
                   currentUrl.includes('192.168.') ||
                   currentUrl.includes('10.0.') ||
                   currentUrl.includes('172.')

// 2. 环境变量检测
const isDev = process.env.NODE_ENV === 'development' ||
              process.env.UNI_PLATFORM === 'h5' ||
              process.env.UNI_PLATFORM === 'app-plus'

// 3. 默认规则
if (isLocalhost) {
  return API_CONFIG.DEV_BASE_URL
} else {
  return API_CONFIG.PROD_BASE_URL
}
```

#### 开发环境特性
- **热重载**：代码修改后自动刷新
- **调试工具**：支持Vue DevTools
- **错误提示**：详细的错误信息和堆栈
- **测试登录**：支持测试用户登录
- **本地存储**：数据存储在浏览器本地

### 生产环境配置

#### 生产环境特性
- **代码压缩**：JavaScript和CSS文件压缩
- **资源优化**：图片压缩和格式优化
- **缓存策略**：静态资源长期缓存
- **错误处理**：用户友好的错误提示
- **性能监控**：集成性能监控工具

#### 安全配置
```javascript
// 生产环境安全配置
const securityConfig = {
  // 禁用调试信息
  debug: false,
  
  // 启用错误报告
  errorReporting: true,
  
  // 配置CSP
  contentSecurityPolicy: {
    'default-src': "'self'",
    'script-src': "'self' 'unsafe-inline'",
    'style-src': "'self' 'unsafe-inline'",
    'img-src': "'self' data: https:",
    'connect-src': "'self' https://jcdtnpaompjy.sealosbja.site"
  }
}
```

---

## 📊 监控和维护

### 性能监控

#### 前端性能监控
```javascript
// 页面加载时间监控
window.addEventListener('load', () => {
  const loadTime = performance.now()
  console.log(`页面加载时间: ${loadTime}ms`)
})

// API请求监控
const originalRequest = uni.request
uni.request = function(options) {
  const startTime = Date.now()
  
  return originalRequest.call(this, {
    ...options,
    success: (res) => {
      const duration = Date.now() - startTime
      console.log(`API请求耗时: ${duration}ms`)
      options.success && options.success(res)
    }
  })
}
```

#### 错误监控
```javascript
// 全局错误捕获
window.addEventListener('error', (event) => {
  console.error('全局错误:', event.error)
  // 发送错误报告到监控服务
})

// Promise错误捕获
window.addEventListener('unhandledrejection', (event) => {
  console.error('未处理的Promise错误:', event.reason)
  // 发送错误报告到监控服务
})
```

### 日志管理

#### 开发环境日志
```javascript
// 开发环境详细日志
if (process.env.NODE_ENV === 'development') {
  console.log('API请求:', requestData)
  console.log('API响应:', responseData)
  console.log('用户操作:', userAction)
}
```

#### 生产环境日志
```javascript
// 生产环境简化日志
if (process.env.NODE_ENV === 'production') {
  console.log('关键操作:', importantAction)
  console.error('错误信息:', errorMessage)
}
```

---

## 🚨 故障排除

### 常见问题

#### 1. 环境切换失败
**问题**：开发环境仍然请求生产API
**解决方案**：
```bash
# 检查URL是否包含localhost
echo $HOSTNAME

# 清除浏览器缓存
# Chrome: Ctrl+Shift+Delete
# Firefox: Ctrl+Shift+Delete

# 重启开发服务器
npm run dev:h5
```

#### 2. API请求失败
**问题**：API请求返回网络错误
**解决方案**：
```bash
# 检查后端服务状态
curl http://localhost:3000/health

# 检查防火墙设置
# Windows: 检查Windows防火墙
# Linux: sudo ufw status

# 检查端口占用
netstat -ano | findstr :3000
```

#### 3. 构建失败
**问题**：npm run build 失败
**解决方案**：
```bash
# 清除缓存
npm cache clean --force
rm -rf node_modules package-lock.json

# 重新安装依赖
npm install

# 检查Node.js版本
node --version
```

#### 4. 小程序上传失败
**问题**：微信小程序上传失败
**解决方案**：
- 检查appid配置是否正确
- 确认微信开发者工具版本
- 检查代码包大小是否超限
- 确认网络连接正常

### 调试技巧

#### 1. 网络调试
```javascript
// 开启详细网络日志
localStorage.setItem('debug', 'true')

// 查看API请求详情
console.log('API请求详情:', {
  url: requestUrl,
  method: requestMethod,
  headers: requestHeaders,
  data: requestData
})
```

#### 2. 状态调试
```javascript
// 查看应用状态
console.log('用户信息:', this.userInfo)
console.log('登录状态:', this.isLoggedIn)
console.log('权限信息:', this.permissions)
```

#### 3. 性能调试
```javascript
// 性能分析
const observer = new PerformanceObserver((list) => {
  list.getEntries().forEach((entry) => {
    console.log(`${entry.name}: ${entry.duration}ms`)
  })
})
observer.observe({ entryTypes: ['measure', 'navigation'] })
```

---

## 📋 部署检查清单

### 开发环境检查
- [ ] Node.js版本 >= 16.0.0
- [ ] npm版本 >= 8.0.0
- [ ] 项目依赖安装完成
- [ ] 后端服务正常运行
- [ ] 环境自动切换正常
- [ ] 测试登录功能正常
- [ ] 热重载功能正常

### 生产环境检查
- [ ] 代码构建成功
- [ ] 静态资源优化完成
- [ ] API地址配置正确
- [ ] 错误处理配置完成
- [ ] 缓存策略配置完成
- [ ] 安全配置检查通过
- [ ] 性能监控配置完成

### 小程序部署检查
- [ ] 小程序构建成功
- [ ] appid配置正确
- [ ] 代码包大小符合要求
- [ ] 功能测试通过
- [ ] 微信审核通过

### APP部署检查
- [ ] APP构建成功
- [ ] 证书配置正确
- [ ] 权限配置完成
- [ ] 功能测试通过
- [ ] 应用商店审核通过

---

## 📞 技术支持

### 联系方式
- **开发团队**：dev@example.com
- **技术支持**：support@example.com
- **紧急联系**：emergency@example.com

### 文档更新
- **版本控制**：Git
- **更新频率**：随代码更新
- **维护者**：开发团队

### 问题反馈
- **Bug报告**：使用项目Issue系统
- **功能建议**：使用项目Issue系统
- **文档问题**：联系开发团队

---

*最后更新：2024年1月15日*  
*文档版本：v1.0.0*  
*维护者：开发团队*
