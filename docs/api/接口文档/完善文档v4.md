# 前端测试登录对接文档

## 概述

本文档专门为前端开发人员提供测试登录接口的详细说明，包含所有可用的测试登录方式和完整的代码示例。

## 测试登录接口列表

### 1. 普通用户测试登录

**接口**: `POST /api/auth/test-login`

**功能**: 获取普通用户权限进行测试

**请求参数**: 无

**响应示例**:
```json
{
  "success": true,
  "message": "测试登录成功",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "userInfo": {
      "_id": "test-user-id",
      "nickName": "测试用户",
      "role": "user",
      "permissions": ["user.view"]
    }
  }
}
```

### 2. 部门管理员测试登录

**接口**: `POST /api/auth/test-login-admin`

**功能**: 获取部门管理员权限进行测试

**请求参数**: 无

**响应示例**:
```json
{
  "success": true,
  "message": "部门管理员测试登录成功",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "userInfo": {
      "_id": "12e4db1e-8ff5-4c68-a7ed-8e239885f401",
      "nickName": "部门管理员测试",
      "role": "dept_admin",
      "department": "技术部",
      "permissions": ["user.view", "dining.manage", "reservation.audit", "venue.manage"]
    }
  }
}
```

### 3. 系统管理员测试登录

**接口**: `POST /api/auth/test-login-sys-admin`

**功能**: 获取系统管理员权限进行测试

**请求参数**: 无

**响应示例**:
```json
{
  "success": true,
  "message": "系统管理员测试登录成功",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "userInfo": {
      "_id": "sys-admin-id",
      "nickName": "系统管理员",
      "role": "sys_admin",
      "permissions": ["user.manage", "system.manage", "dining.manage", "reservation.manage", "venue.manage", "verification.manage"]
    }
  }
}
```

### 4. 指定部门的部门管理员登录 ⭐

**接口**: `POST /api/auth/test-login-dept-admin`

**功能**: 登录指定部门的部门管理员

**请求参数**:
```json
{
  "departmentCode": "GEO_DATA"
}
```

**部门代码列表**:
| 代码 | 部门名称 | 管理员手机号 |
|------|----------|-------------|
| `GEO_DATA` | 地质数据中心 | 13800001001 |
| `GEO_ENG` | 地质工程中心 | 13800001002 |
| `ECO_ENV` | 生态环境中心 | 13800001003 |
| `GEO_ENV` | 地质环境中心 | 13800001004 |
| `GEO_SURVEY` | 地质调查中心 | 13800001005 |
| `HUANGMEI` | 黄梅分站 | 13800001006 |
| `MINING_CO` | 矿业有限责任公司 | 13800001007 |
| `PROPERTY` | 物业中心 | 13800001008 |
| `ADMIN` | 机关科室 | 13800001009 |
| `TECH` | 技术部 | 13800000001 |

**响应示例**:
```json
{
  "success": true,
  "message": "地质数据中心管理员测试登录成功",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "userInfo": {
      "_id": "c8b1cbc0-49aa-432a-bfed-b7792db4e4d0",
      "nickName": "地质数据中心管理员",
      "role": "dept_admin",
      "department": "地质数据中心",
      "departmentCode": "GEO_DATA",
      "phoneNumber": "13800001001",
      "permissions": ["user.view", "dining.manage", "reservation.audit", "venue.manage"]
    }
  }
}
```

## 前端集成代码示例

### 1. JavaScript Fetch API

```javascript
class TestLoginAPI {
  constructor(baseURL = 'http://localhost:3000') {
    this.baseURL = baseURL;
    this.token = null;
  }

  // 普通用户登录
  async loginUser() {
    const response = await fetch(`${this.baseURL}/api/auth/test-login`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    });
    return this.handleResponse(response);
  }

  // 部门管理员登录
  async loginDeptAdmin() {
    const response = await fetch(`${this.baseURL}/api/auth/test-login-admin`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    });
    return this.handleResponse(response);
  }

  // 系统管理员登录
  async loginSysAdmin() {
    const response = await fetch(`${this.baseURL}/api/auth/test-login-sys-admin`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    });
    return this.handleResponse(response);
  }

  // 指定部门管理员登录
  async loginSpecificDeptAdmin(departmentCode) {
    const response = await fetch(`${this.baseURL}/api/auth/test-login-dept-admin`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ departmentCode })
    });
    return this.handleResponse(response);
  }

  async handleResponse(response) {
    const data = await response.json();
    if (data.success) {
      this.token = data.data.token;
      return data.data;
    }
    throw new Error(data.message);
  }

  // 获取认证头
  getAuthHeaders() {
    return this.token ? { 'Authorization': `Bearer ${this.token}` } : {};
  }
}

// 使用示例
const api = new TestLoginAPI();

// 登录地质数据中心管理员
try {
  const userInfo = await api.loginSpecificDeptAdmin('GEO_DATA');
  console.log('登录成功:', userInfo);
  
  // 使用token调用其他API
  const response = await fetch('http://localhost:3000/api/dining/enhanced/dept-members', {
    headers: api.getAuthHeaders()
  });
} catch (error) {
  console.error('登录失败:', error.message);
}
```

### 2. Axios 示例

```javascript
import axios from 'axios';

const api = axios.create({
  baseURL: 'http://localhost:3000',
  timeout: 10000
});

// 请求拦截器 - 自动添加token
api.interceptors.request.use(config => {
  const token = localStorage.getItem('token');
  if (token) {
    config.headers.Authorization = `Bearer ${token}`;
  }
  return config;
});

// 测试登录方法
export const testLogin = {
  // 普通用户登录
  async user() {
    const response = await api.post('/api/auth/test-login');
    localStorage.setItem('token', response.data.data.token);
    return response.data.data;
  },

  // 部门管理员登录
  async deptAdmin() {
    const response = await api.post('/api/auth/test-login-admin');
    localStorage.setItem('token', response.data.data.token);
    return response.data.data;
  },

  // 系统管理员登录
  async sysAdmin() {
    const response = await api.post('/api/auth/test-login-sys-admin');
    localStorage.setItem('token', response.data.data.token);
    return response.data.data;
  },

  // 指定部门管理员登录
  async specificDeptAdmin(departmentCode) {
    const response = await api.post('/api/auth/test-login-dept-admin', {
      departmentCode
    });
    localStorage.setItem('token', response.data.data.token);
    return response.data.data;
  }
};

// 使用示例
try {
  // 登录地质数据中心管理员
  const userInfo = await testLogin.specificDeptAdmin('GEO_DATA');
  console.log('登录成功:', userInfo);
  
  // 调用其他API
  const members = await api.get('/api/dining/enhanced/dept-members');
  console.log('部门成员:', members.data);
} catch (error) {
  console.error('操作失败:', error.response?.data?.message || error.message);
}
```

### 3. Vue.js 组件示例

```vue
<template>
  <div class="test-login">
    <h2>测试登录</h2>
    
    <!-- 角色选择 -->
    <div class="role-selector">
      <button @click="loginAsUser">普通用户</button>
      <button @click="loginAsDeptAdmin">部门管理员</button>
      <button @click="loginAsSysAdmin">系统管理员</button>
    </div>

    <!-- 部门选择 -->
    <div class="department-selector" v-if="showDeptSelector">
      <h3>选择部门</h3>
      <select v-model="selectedDept" @change="loginAsSpecificDeptAdmin">
        <option value="">请选择部门</option>
        <option value="GEO_DATA">地质数据中心</option>
        <option value="GEO_ENG">地质工程中心</option>
        <option value="ECO_ENV">生态环境中心</option>
        <option value="GEO_ENV">地质环境中心</option>
        <option value="GEO_SURVEY">地质调查中心</option>
        <option value="HUANGMEI">黄梅分站</option>
        <option value="MINING_CO">矿业有限责任公司</option>
        <option value="PROPERTY">物业中心</option>
        <option value="ADMIN">机关科室</option>
        <option value="TECH">技术部</option>
      </select>
    </div>

    <!-- 用户信息显示 -->
    <div class="user-info" v-if="userInfo">
      <h3>当前用户信息</h3>
      <p><strong>姓名:</strong> {{ userInfo.nickName }}</p>
      <p><strong>角色:</strong> {{ userInfo.role }}</p>
      <p><strong>部门:</strong> {{ userInfo.department }}</p>
      <p><strong>权限:</strong> {{ userInfo.permissions.join(', ') }}</p>
    </div>
  </div>
</template>

<script>
import axios from 'axios';

export default {
  name: 'TestLogin',
  data() {
    return {
      userInfo: null,
      selectedDept: '',
      showDeptSelector: false
    };
  },
  methods: {
    async loginAsUser() {
      try {
        const response = await axios.post('/api/auth/test-login');
        this.userInfo = response.data.data;
        this.showDeptSelector = false;
        this.$message.success('普通用户登录成功');
      } catch (error) {
        this.$message.error('登录失败: ' + error.response?.data?.message);
      }
    },

    async loginAsDeptAdmin() {
      try {
        const response = await axios.post('/api/auth/test-login-admin');
        this.userInfo = response.data.data;
        this.showDeptSelector = true;
        this.$message.success('部门管理员登录成功');
      } catch (error) {
        this.$message.error('登录失败: ' + error.response?.data?.message);
      }
    },

    async loginAsSysAdmin() {
      try {
        const response = await axios.post('/api/auth/test-login-sys-admin');
        this.userInfo = response.data.data;
        this.showDeptSelector = false;
        this.$message.success('系统管理员登录成功');
      } catch (error) {
        this.$message.error('登录失败: ' + error.response?.data?.message);
      }
    },

    async loginAsSpecificDeptAdmin() {
      if (!this.selectedDept) return;
      
      try {
        const response = await axios.post('/api/auth/test-login-dept-admin', {
          departmentCode: this.selectedDept
        });
        this.userInfo = response.data.data;
        this.$message.success(`${this.userInfo.department}管理员登录成功`);
      } catch (error) {
        this.$message.error('登录失败: ' + error.response?.data?.message);
      }
    }
  }
};
</script>
```

### 4. React Hook 示例

```jsx
import { useState, useCallback } from 'react';
import axios from 'axios';

const useTestLogin = () => {
  const [userInfo, setUserInfo] = useState(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);

  const login = useCallback(async (loginType, departmentCode = null) => {
    setLoading(true);
    setError(null);
    
    try {
      let response;
      
      switch (loginType) {
        case 'user':
          response = await axios.post('/api/auth/test-login');
          break;
        case 'deptAdmin':
          response = await axios.post('/api/auth/test-login-admin');
          break;
        case 'sysAdmin':
          response = await axios.post('/api/auth/test-login-sys-admin');
          break;
        case 'specificDeptAdmin':
          response = await axios.post('/api/auth/test-login-dept-admin', {
            departmentCode
          });
          break;
        default:
          throw new Error('无效的登录类型');
      }
      
      setUserInfo(response.data.data);
      localStorage.setItem('token', response.data.data.token);
      return response.data.data;
      
    } catch (err) {
      const errorMessage = err.response?.data?.message || err.message;
      setError(errorMessage);
      throw new Error(errorMessage);
    } finally {
      setLoading(false);
    }
  }, []);

  return {
    userInfo,
    loading,
    error,
    login
  };
};

// 使用示例
const TestLoginComponent = () => {
  const { userInfo, loading, error, login } = useTestLogin();

  const handleLogin = async (type, deptCode = null) => {
    try {
      await login(type, deptCode);
      console.log('登录成功');
    } catch (err) {
      console.error('登录失败:', err.message);
    }
  };

  return (
    <div>
      <h2>测试登录</h2>
      
      <div>
        <button onClick={() => handleLogin('user')} disabled={loading}>
          普通用户登录
        </button>
        <button onClick={() => handleLogin('deptAdmin')} disabled={loading}>
          部门管理员登录
        </button>
        <button onClick={() => handleLogin('sysAdmin')} disabled={loading}>
          系统管理员登录
        </button>
      </div>

      <div>
        <h3>指定部门登录</h3>
        <button onClick={() => handleLogin('specificDeptAdmin', 'GEO_DATA')} disabled={loading}>
          地质数据中心管理员
        </button>
        <button onClick={() => handleLogin('specificDeptAdmin', 'GEO_ENG')} disabled={loading}>
          地质工程中心管理员
        </button>
        {/* 更多部门按钮... */}
      </div>

      {error && <div style={{color: 'red'}}>错误: {error}</div>}
      
      {userInfo && (
        <div>
          <h3>用户信息</h3>
          <p>姓名: {userInfo.nickName}</p>
          <p>角色: {userInfo.role}</p>
          <p>部门: {userInfo.department}</p>
        </div>
      )}
    </div>
  );
};
```

## 测试场景建议

### 1. 权限测试
```javascript
// 测试不同角色的权限
const testPermissions = async () => {
  // 1. 普通用户 - 只能查看自己的信息
  await api.loginUser();
  // 尝试访问管理员接口应该返回403
  
  // 2. 部门管理员 - 可以管理本部门
  await api.loginSpecificDeptAdmin('GEO_DATA');
  // 可以访问部门成员、报餐等接口
  
  // 3. 系统管理员 - 可以访问所有接口
  await api.loginSysAdmin();
  // 可以访问所有管理接口
};
```

### 2. 部门隔离测试
```javascript
// 测试部门权限隔离
const testDepartmentIsolation = async () => {
  // 登录地质数据中心管理员
  await api.loginSpecificDeptAdmin('GEO_DATA');
  const geoDataMembers = await api.get('/api/dining/enhanced/dept-members');
  
  // 登录地质工程中心管理员
  await api.loginSpecificDeptAdmin('GEO_ENG');
  const geoEngMembers = await api.get('/api/dining/enhanced/dept-members');
  
  // 验证两个部门看到的成员不同
  console.assert(geoDataMembers.data.length !== geoEngMembers.data.length);
};
```

## 注意事项

1. **仅开发环境**: 所有测试登录接口仅在开发环境可用，生产环境会返回403错误
2. **Token有效期**: 测试Token有效期为24小时
3. **权限控制**: 不同角色有不同的权限，请根据实际需求选择合适的登录方式
4. **部门隔离**: 部门管理员只能管理本部门的数据，无法跨部门操作
5. **数据一致性**: 测试数据会定期清理，请勿在生产环境使用测试接口

## 快速开始

1. 启动后端服务: `node server.js`
2. 选择适合的测试登录接口
3. 使用返回的token调用其他API
4. 根据用户角色测试相应的功能权限

## 技术支持

如有问题，请查看：
- 完整API文档: `接口文档/部门报餐功能对接文档.md`
- 前端集成示例: `接口文档/前端集成示例.js`
- 测试脚本: `接口文档/部门管理员登录测试示例.js`
