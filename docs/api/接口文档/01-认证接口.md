# 认证接口文档

## 📋 接口概述

认证接口提供用户登录、Token管理、身份验证等功能。

**基础路径**: `/api/auth`

## 🔐 接口列表

### 1. 微信授权登录

**接口地址**: `POST /api/auth/wechat-login`

**接口描述**: 通过微信授权码进行登录

**请求参数**:
```json
{
  "code": "string",           // 微信授权码
  "encryptedData": "string",  // 加密的用户数据
  "iv": "string"             // 加密算法的初始向量
}
```

**响应示例**:
```json
{
  "success": true,
  "message": "登录成功",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "user": {
      "_id": "user_id",
      "nickName": "用户昵称",
      "avatarUrl": "头像URL",
      "role": "user",
      "department": "部门名称"
    },
    "expiresIn": 604800
  }
}
```

**错误响应**:
```json
{
  "success": false,
  "message": "登录失败",
  "error": "微信授权码无效"
}
```

---

### 2. 手机号验证码登录

**接口地址**: `POST /api/auth/phone-login`

**接口描述**: 通过手机号和验证码进行登录

**请求参数**:
```json
{
  "phoneNumber": "string",  // 手机号
  "code": "string"          // 验证码
}
```

**响应示例**:
```json
{
  "success": true,
  "message": "登录成功",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "user": {
      "_id": "user_id",
      "nickName": "用户昵称",
      "phoneNumber": "13800138000",
      "role": "user",
      "department": "部门名称"
    },
    "expiresIn": 604800
  }
}
```

---

### 3. 发送验证码

**接口地址**: `POST /api/auth/send-verification-code`

**接口描述**: 向指定手机号发送验证码

**请求参数**:
```json
{
  "phoneNumber": "string",  // 手机号
  "type": "string"          // 验证码类型：login/register/reset
}
```

**响应示例**:
```json
{
  "success": true,
  "message": "验证码发送成功",
  "data": {
    "phoneNumber": "13800138000",
    "expireTime": "2024-01-01T00:05:00.000Z"
  }
}
```

**注意事项**:
- 验证码有效期：5分钟
- 发送间隔：1分钟
- 同一手机号每天最多发送10次

---

### 4. Token验证

**接口地址**: `POST /api/auth/validate-token`

**接口描述**: 验证Token是否有效

**请求参数**:
```json
{
  "token": "string"  // JWT Token
}
```

**响应示例**:
```json
{
  "success": true,
  "message": "Token有效",
  "data": {
    "valid": true,
    "user": {
      "_id": "user_id",
      "nickName": "用户昵称",
      "role": "user"
    },
    "expiresAt": "2024-01-08T00:00:00.000Z"
  }
}
```

---

### 5. 测试登录（开发环境）

**接口地址**: `POST /api/auth/test-login`

**接口描述**: 开发环境下的测试登录接口

**请求参数**:
```json
{
  "phoneNumber": "string"  // 手机号
}
```

**响应示例**:
```json
{
  "success": true,
  "message": "测试登录成功",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "user": {
      "_id": "test_user_id",
      "nickName": "测试用户",
      "role": "user",
      "isTestUser": true
    },
    "expiresIn": 86400
  }
}
```

---

### 6. 部门管理员测试登录（开发环境）

**接口地址**: `POST /api/auth/test-login-admin`

**接口描述**: 开发环境下的部门管理员测试登录

**请求参数**:
```json
{
  "phoneNumber": "string"  // 手机号
}
```

**响应示例**:
```json
{
  "success": true,
  "message": "测试登录成功",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "user": {
      "_id": "admin_user_id",
      "nickName": "部门管理员",
      "role": "dept_admin",
      "isAdminTest": true
    },
    "expiresIn": 86400
  }
}
```

---

### 7. 系统管理员测试登录（开发环境）

**接口地址**: `POST /api/auth/test-login-sys-admin`

**接口描述**: 开发环境下的系统管理员测试登录

**请求参数**:
```json
{
  "phoneNumber": "string"  // 手机号
}
```

**响应示例**:
```json
{
  "success": true,
  "message": "测试登录成功",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "user": {
      "_id": "sys_admin_id",
      "nickName": "系统管理员",
      "role": "sys_admin",
      "isSysAdminTest": true
    },
    "expiresIn": 86400
  }
}
```

---

### 8. 用户登出

**接口地址**: `POST /api/auth/logout`

**接口描述**: 用户登出，清除Token

**请求头**:
```http
Authorization: Bearer {token}  // 可选，如果提供则清除指定Token
```

**响应示例**:
```json
{
  "success": true,
  "message": "登出成功"
}
```

---

### 9. 刷新Token

**接口地址**: `POST /api/auth/refresh-token`

**接口描述**: 刷新即将过期的Token

**请求参数**:
```json
{
  "refreshToken": "string"  // 刷新Token
}
```

**响应示例**:
```json
{
  "success": true,
  "message": "Token刷新成功",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "refreshToken": "new_refresh_token",
    "expiresIn": 604800
  }
}
```

## 🔒 安全说明

### Token安全
- Token有效期：7天
- 刷新Token有效期：30天
- Token存储在HttpOnly Cookie中，防止XSS攻击

### 验证码安全
- 验证码长度：6位数字
- 验证码有效期：5分钟
- 发送频率限制：1分钟间隔
- 每日发送限制：10次

### 登录安全
- 密码错误5次后锁定账户30分钟
- 支持异地登录检测
- 登录日志记录

## 📱 前端集成示例

### JavaScript示例

```javascript
// 手机号登录
async function phoneLogin(phoneNumber, code) {
  try {
    const response = await fetch('/api/auth/phone-login', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ phoneNumber, code })
    });
    
    const result = await response.json();
    
    if (result.success) {
      // 保存Token
      localStorage.setItem('token', result.data.token);
      localStorage.setItem('user', JSON.stringify(result.data.user));
      return result.data;
    } else {
      throw new Error(result.message);
    }
  } catch (error) {
    console.error('登录失败:', error);
    throw error;
  }
}

// 发送验证码
async function sendVerificationCode(phoneNumber, type = 'login') {
  try {
    const response = await fetch('/api/auth/send-verification-code', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ phoneNumber, type })
    });
    
    const result = await response.json();
    
    if (result.success) {
      return result.data;
    } else {
      throw new Error(result.message);
    }
  } catch (error) {
    console.error('发送验证码失败:', error);
    throw error;
  }
}

// 验证Token
async function validateToken(token) {
  try {
    const response = await fetch('/api/auth/validate-token', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ token })
    });
    
    const result = await response.json();
    return result.success && result.data.valid;
  } catch (error) {
    console.error('Token验证失败:', error);
    return false;
  }
}
```

### 微信小程序示例

```javascript
// 微信登录
async function wechatLogin() {
  try {
    // 获取微信授权码
    const { code } = await wx.login();
    
    // 获取用户信息
    const { encryptedData, iv } = await wx.getUserProfile({
      desc: '用于完善用户资料'
    });
    
    // 调用后端接口
    const response = await wx.request({
      url: 'https://api.example.com/api/auth/wechat-login',
      method: 'POST',
      data: { code, encryptedData, iv }
    });
    
    const result = response.data;
    
    if (result.success) {
      // 保存用户信息
      wx.setStorageSync('token', result.data.token);
      wx.setStorageSync('user', result.data.user);
      return result.data;
    } else {
      throw new Error(result.message);
    }
  } catch (error) {
    console.error('微信登录失败:', error);
    throw error;
  }
}
```

## ⚠️ 注意事项

1. **测试接口**: 测试登录接口仅在开发环境可用，生产环境会自动禁用
2. **Token存储**: 建议将Token存储在HttpOnly Cookie中，提高安全性
3. **错误处理**: 所有接口都有统一的错误处理，前端需要处理各种错误情况
4. **频率限制**: 验证码发送有频率限制，避免恶意请求
5. **安全提醒**: 生产环境请使用HTTPS协议，保护数据传输安全
