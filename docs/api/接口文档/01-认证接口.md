# è®¤è¯æ¥å£æ–‡æ¡£

## ğŸ“‹ æ¥å£æ¦‚è¿°

è®¤è¯æ¥å£æä¾›ç”¨æˆ·ç™»å½•ã€Tokenç®¡ç†ã€èº«ä»½éªŒè¯ç­‰åŠŸèƒ½ã€‚

**åŸºç¡€è·¯å¾„**: `/api/auth`

## ğŸ” æ¥å£åˆ—è¡¨

### 1. å¾®ä¿¡æˆæƒç™»å½•

**æ¥å£åœ°å€**: `POST /api/auth/wechat-login`

**æ¥å£æè¿°**: é€šè¿‡å¾®ä¿¡æˆæƒç è¿›è¡Œç™»å½•

**è¯·æ±‚å‚æ•°**:
```json
{
  "code": "string",           // å¾®ä¿¡æˆæƒç 
  "encryptedData": "string",  // åŠ å¯†çš„ç”¨æˆ·æ•°æ®
  "iv": "string"             // åŠ å¯†ç®—æ³•çš„åˆå§‹å‘é‡
}
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "success": true,
  "message": "ç™»å½•æˆåŠŸ",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "user": {
      "_id": "user_id",
      "nickName": "ç”¨æˆ·æ˜µç§°",
      "avatarUrl": "å¤´åƒURL",
      "role": "user",
      "department": "éƒ¨é—¨åç§°"
    },
    "expiresIn": 604800
  }
}
```

**é”™è¯¯å“åº”**:
```json
{
  "success": false,
  "message": "ç™»å½•å¤±è´¥",
  "error": "å¾®ä¿¡æˆæƒç æ— æ•ˆ"
}
```

---

### 2. æ‰‹æœºå·éªŒè¯ç ç™»å½•

**æ¥å£åœ°å€**: `POST /api/auth/phone-login`

**æ¥å£æè¿°**: é€šè¿‡æ‰‹æœºå·å’ŒéªŒè¯ç è¿›è¡Œç™»å½•

**è¯·æ±‚å‚æ•°**:
```json
{
  "phoneNumber": "string",  // æ‰‹æœºå·
  "code": "string"          // éªŒè¯ç 
}
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "success": true,
  "message": "ç™»å½•æˆåŠŸ",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "user": {
      "_id": "user_id",
      "nickName": "ç”¨æˆ·æ˜µç§°",
      "phoneNumber": "13800138000",
      "role": "user",
      "department": "éƒ¨é—¨åç§°"
    },
    "expiresIn": 604800
  }
}
```

---

### 3. å‘é€éªŒè¯ç 

**æ¥å£åœ°å€**: `POST /api/auth/send-verification-code`

**æ¥å£æè¿°**: å‘æŒ‡å®šæ‰‹æœºå·å‘é€éªŒè¯ç 

**è¯·æ±‚å‚æ•°**:
```json
{
  "phoneNumber": "string",  // æ‰‹æœºå·
  "type": "string"          // éªŒè¯ç ç±»å‹ï¼šlogin/register/reset
}
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "success": true,
  "message": "éªŒè¯ç å‘é€æˆåŠŸ",
  "data": {
    "phoneNumber": "13800138000",
    "expireTime": "2024-01-01T00:05:00.000Z"
  }
}
```

**æ³¨æ„äº‹é¡¹**:
- éªŒè¯ç æœ‰æ•ˆæœŸï¼š5åˆ†é’Ÿ
- å‘é€é—´éš”ï¼š1åˆ†é’Ÿ
- åŒä¸€æ‰‹æœºå·æ¯å¤©æœ€å¤šå‘é€10æ¬¡

---

### 4. TokenéªŒè¯

**æ¥å£åœ°å€**: `POST /api/auth/validate-token`

**æ¥å£æè¿°**: éªŒè¯Tokenæ˜¯å¦æœ‰æ•ˆ

**è¯·æ±‚å‚æ•°**:
```json
{
  "token": "string"  // JWT Token
}
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "success": true,
  "message": "Tokenæœ‰æ•ˆ",
  "data": {
    "valid": true,
    "user": {
      "_id": "user_id",
      "nickName": "ç”¨æˆ·æ˜µç§°",
      "role": "user"
    },
    "expiresAt": "2024-01-08T00:00:00.000Z"
  }
}
```

---

### 5. æµ‹è¯•ç™»å½•ï¼ˆå¼€å‘ç¯å¢ƒï¼‰

**æ¥å£åœ°å€**: `POST /api/auth/test-login`

**æ¥å£æè¿°**: å¼€å‘ç¯å¢ƒä¸‹çš„æµ‹è¯•ç™»å½•æ¥å£

**è¯·æ±‚å‚æ•°**:
```json
{
  "phoneNumber": "string"  // æ‰‹æœºå·
}
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "success": true,
  "message": "æµ‹è¯•ç™»å½•æˆåŠŸ",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "user": {
      "_id": "test_user_id",
      "nickName": "æµ‹è¯•ç”¨æˆ·",
      "role": "user",
      "isTestUser": true
    },
    "expiresIn": 86400
  }
}
```

---

### 6. éƒ¨é—¨ç®¡ç†å‘˜æµ‹è¯•ç™»å½•ï¼ˆå¼€å‘ç¯å¢ƒï¼‰

**æ¥å£åœ°å€**: `POST /api/auth/test-login-admin`

**æ¥å£æè¿°**: å¼€å‘ç¯å¢ƒä¸‹çš„éƒ¨é—¨ç®¡ç†å‘˜æµ‹è¯•ç™»å½•

**è¯·æ±‚å‚æ•°**:
```json
{
  "phoneNumber": "string"  // æ‰‹æœºå·
}
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "success": true,
  "message": "æµ‹è¯•ç™»å½•æˆåŠŸ",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "user": {
      "_id": "admin_user_id",
      "nickName": "éƒ¨é—¨ç®¡ç†å‘˜",
      "role": "dept_admin",
      "isAdminTest": true
    },
    "expiresIn": 86400
  }
}
```

---

### 7. ç³»ç»Ÿç®¡ç†å‘˜æµ‹è¯•ç™»å½•ï¼ˆå¼€å‘ç¯å¢ƒï¼‰

**æ¥å£åœ°å€**: `POST /api/auth/test-login-sys-admin`

**æ¥å£æè¿°**: å¼€å‘ç¯å¢ƒä¸‹çš„ç³»ç»Ÿç®¡ç†å‘˜æµ‹è¯•ç™»å½•

**è¯·æ±‚å‚æ•°**:
```json
{
  "phoneNumber": "string"  // æ‰‹æœºå·
}
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "success": true,
  "message": "æµ‹è¯•ç™»å½•æˆåŠŸ",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "user": {
      "_id": "sys_admin_id",
      "nickName": "ç³»ç»Ÿç®¡ç†å‘˜",
      "role": "sys_admin",
      "isSysAdminTest": true
    },
    "expiresIn": 86400
  }
}
```

---

### 8. ç”¨æˆ·ç™»å‡º

**æ¥å£åœ°å€**: `POST /api/auth/logout`

**æ¥å£æè¿°**: ç”¨æˆ·ç™»å‡ºï¼Œæ¸…é™¤Token

**è¯·æ±‚å¤´**:
```http
Authorization: Bearer {token}  // å¯é€‰ï¼Œå¦‚æœæä¾›åˆ™æ¸…é™¤æŒ‡å®šToken
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "success": true,
  "message": "ç™»å‡ºæˆåŠŸ"
}
```

---

### 9. åˆ·æ–°Token

**æ¥å£åœ°å€**: `POST /api/auth/refresh-token`

**æ¥å£æè¿°**: åˆ·æ–°å³å°†è¿‡æœŸçš„Token

**è¯·æ±‚å‚æ•°**:
```json
{
  "refreshToken": "string"  // åˆ·æ–°Token
}
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "success": true,
  "message": "Tokenåˆ·æ–°æˆåŠŸ",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "refreshToken": "new_refresh_token",
    "expiresIn": 604800
  }
}
```

## ğŸ”’ å®‰å…¨è¯´æ˜

### Tokenå®‰å…¨
- Tokenæœ‰æ•ˆæœŸï¼š7å¤©
- åˆ·æ–°Tokenæœ‰æ•ˆæœŸï¼š30å¤©
- Tokenå­˜å‚¨åœ¨HttpOnly Cookieä¸­ï¼Œé˜²æ­¢XSSæ”»å‡»

### éªŒè¯ç å®‰å…¨
- éªŒè¯ç é•¿åº¦ï¼š6ä½æ•°å­—
- éªŒè¯ç æœ‰æ•ˆæœŸï¼š5åˆ†é’Ÿ
- å‘é€é¢‘ç‡é™åˆ¶ï¼š1åˆ†é’Ÿé—´éš”
- æ¯æ—¥å‘é€é™åˆ¶ï¼š10æ¬¡

### ç™»å½•å®‰å…¨
- å¯†ç é”™è¯¯5æ¬¡åé”å®šè´¦æˆ·30åˆ†é’Ÿ
- æ”¯æŒå¼‚åœ°ç™»å½•æ£€æµ‹
- ç™»å½•æ—¥å¿—è®°å½•

## ğŸ“± å‰ç«¯é›†æˆç¤ºä¾‹

### JavaScriptç¤ºä¾‹

```javascript
// æ‰‹æœºå·ç™»å½•
async function phoneLogin(phoneNumber, code) {
  try {
    const response = await fetch('/api/auth/phone-login', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ phoneNumber, code })
    });
    
    const result = await response.json();
    
    if (result.success) {
      // ä¿å­˜Token
      localStorage.setItem('token', result.data.token);
      localStorage.setItem('user', JSON.stringify(result.data.user));
      return result.data;
    } else {
      throw new Error(result.message);
    }
  } catch (error) {
    console.error('ç™»å½•å¤±è´¥:', error);
    throw error;
  }
}

// å‘é€éªŒè¯ç 
async function sendVerificationCode(phoneNumber, type = 'login') {
  try {
    const response = await fetch('/api/auth/send-verification-code', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ phoneNumber, type })
    });
    
    const result = await response.json();
    
    if (result.success) {
      return result.data;
    } else {
      throw new Error(result.message);
    }
  } catch (error) {
    console.error('å‘é€éªŒè¯ç å¤±è´¥:', error);
    throw error;
  }
}

// éªŒè¯Token
async function validateToken(token) {
  try {
    const response = await fetch('/api/auth/validate-token', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ token })
    });
    
    const result = await response.json();
    return result.success && result.data.valid;
  } catch (error) {
    console.error('TokenéªŒè¯å¤±è´¥:', error);
    return false;
  }
}
```

### å¾®ä¿¡å°ç¨‹åºç¤ºä¾‹

```javascript
// å¾®ä¿¡ç™»å½•
async function wechatLogin() {
  try {
    // è·å–å¾®ä¿¡æˆæƒç 
    const { code } = await wx.login();
    
    // è·å–ç”¨æˆ·ä¿¡æ¯
    const { encryptedData, iv } = await wx.getUserProfile({
      desc: 'ç”¨äºå®Œå–„ç”¨æˆ·èµ„æ–™'
    });
    
    // è°ƒç”¨åç«¯æ¥å£
    const response = await wx.request({
      url: 'https://api.example.com/api/auth/wechat-login',
      method: 'POST',
      data: { code, encryptedData, iv }
    });
    
    const result = response.data;
    
    if (result.success) {
      // ä¿å­˜ç”¨æˆ·ä¿¡æ¯
      wx.setStorageSync('token', result.data.token);
      wx.setStorageSync('user', result.data.user);
      return result.data;
    } else {
      throw new Error(result.message);
    }
  } catch (error) {
    console.error('å¾®ä¿¡ç™»å½•å¤±è´¥:', error);
    throw error;
  }
}
```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **æµ‹è¯•æ¥å£**: æµ‹è¯•ç™»å½•æ¥å£ä»…åœ¨å¼€å‘ç¯å¢ƒå¯ç”¨ï¼Œç”Ÿäº§ç¯å¢ƒä¼šè‡ªåŠ¨ç¦ç”¨
2. **Tokenå­˜å‚¨**: å»ºè®®å°†Tokenå­˜å‚¨åœ¨HttpOnly Cookieä¸­ï¼Œæé«˜å®‰å…¨æ€§
3. **é”™è¯¯å¤„ç†**: æ‰€æœ‰æ¥å£éƒ½æœ‰ç»Ÿä¸€çš„é”™è¯¯å¤„ç†ï¼Œå‰ç«¯éœ€è¦å¤„ç†å„ç§é”™è¯¯æƒ…å†µ
4. **é¢‘ç‡é™åˆ¶**: éªŒè¯ç å‘é€æœ‰é¢‘ç‡é™åˆ¶ï¼Œé¿å…æ¶æ„è¯·æ±‚
5. **å®‰å…¨æé†’**: ç”Ÿäº§ç¯å¢ƒè¯·ä½¿ç”¨HTTPSåè®®ï¼Œä¿æŠ¤æ•°æ®ä¼ è¾“å®‰å…¨
