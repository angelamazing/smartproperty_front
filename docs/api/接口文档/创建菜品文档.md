# 菜品创建接口文档

## 📋 接口概述

**接口名称**: 创建菜品  
**接口路径**: `POST /api/admin/dishes`  
**请求方式**: `POST`  
**接口描述**: 管理员创建新菜品，支持完整的菜品信息录入  
**权限要求**: 需要管理员权限（`requireDeptAdmin`）

## 🔐 权限验证

- **身份验证**: 需要有效的 JWT Token
- **权限要求**: 部门管理员权限
- **Token 格式**: `Bearer <token>`

## 📥 请求参数

### 请求头
```http
Content-Type: application/json
Authorization: Bearer <your-jwt-token>
```

### 请求体参数

| 参数名 | 类型 | 必填 | 默认值 | 说明 | 示例 |
|--------|------|------|--------|------|------|
| name | string | ✅ | - | 菜品名称，最大100字符 | "宫保鸡丁" |
| categoryId | string | ✅ | - | 菜品分类ID | "2" |
| description | string | ❌ | null | 菜品描述，最大500字符 | "经典川菜，麻辣鲜香" |
| price | number | ❌ | 0 | 菜品价格，必须≥0 | 25.5 |
| image | string | ❌ | null | 菜品图片URL | "https://example.com/dish.jpg" |
| calories | number | ❌ | null | 卡路里含量 | 350 |
| protein | number | ❌ | null | 蛋白质含量(g) | 25.5 |
| fat | number | ❌ | null | 脂肪含量(g) | 15.2 |
| carbohydrate | number | ❌ | null | 碳水化合物含量(g) | 45.8 |
| tags | array | ❌ | [] | 菜品标签数组 | ["川菜", "辣", "下饭"] |
| status | string | ❌ | "active" | 菜品状态 | "active" 或 "inactive" |
| isRecommended | boolean | ❌ | false | 是否推荐菜品 | true 或 false |

### 参数验证规则

#### 必填字段验证
- `name`: 不能为空，最大长度100字符
- `categoryId`: 不能为空

#### 可选字段验证
- `description`: 最大长度500字符
- `price`: 必须≥0的浮点数
- `image`: 必须是有效的URL格式
- `calories`: 必须≥0的浮点数
- `protein`: 必须≥0的浮点数
- `fat`: 必须≥0的浮点数
- `carbohydrate`: 必须≥0的浮点数
- `tags`: 必须是数组格式
- `status`: 只能是 "active" 或 "inactive"
- `isRecommended`: 必须是布尔值

## 📤 响应格式

### 成功响应

**HTTP状态码**: `200 OK`

```json
{
  "success": true,
  "message": "创建菜品成功",
  "code": "200",
  "timestamp": "2025-09-04T12:00:00.000Z",
  "data": {
    "id": "dish-uuid-here",
    "name": "宫保鸡丁",
    "price": 25.5,
    "status": "active"
  }
}
```

### 错误响应

#### 参数验证错误
**HTTP状态码**: `400 Bad Request`

```json
{
  "success": false,
  "message": "参数验证失败",
  "code": "400",
  "timestamp": "2025-09-04T12:00:00.000Z",
  "errors": [
    {
      "field": "name",
      "message": "菜品名称不能为空且不超过100字符"
    },
    {
      "field": "price",
      "message": "价格必须大于等于0"
    }
  ]
}
```

#### 权限不足
**HTTP状态码**: `403 Forbidden`

```json
{
  "success": false,
  "message": "权限不足",
  "code": "403",
  "timestamp": "2025-09-04T12:00:00.000Z"
}
```

#### 服务器错误
**HTTP状态码**: `500 Internal Server Error`

```json
{
  "success": false,
  "message": "创建菜品失败",
  "code": "500",
  "timestamp": "2025-09-04T12:00:00.000Z",
  "error": "具体错误信息"
}
```

## 💡 使用示例

### 示例1: 创建基础菜品

```bash
curl -X POST http://localhost:3000/api/admin/dishes \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer your-jwt-token" \
  -d '{
    "name": "宫保鸡丁",
    "categoryId": "2",
    "description": "经典川菜，麻辣鲜香",
    "price": 25.5
  }'
```

**响应**:
```json
{
  "success": true,
  "message": "创建菜品成功",
  "data": {
    "id": "dish-uuid-here",
    "name": "宫保鸡丁",
    "price": 25.5,
    "status": "active"
  }
}
```

### 示例2: 创建完整信息菜品

```bash
curl -X POST http://localhost:3000/api/admin/dishes \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer your-jwt-token" \
  -d '{
    "name": "红烧肉",
    "categoryId": "1",
    "description": "肥瘦相间的五花肉，色泽红亮，口感软糯",
    "price": 35.0,
    "image": "https://example.com/hongshao-rou.jpg",
    "calories": 450,
    "protein": 28.5,
    "fat": 32.1,
    "carbohydrate": 8.5,
    "tags": ["鲁菜", "经典", "下饭"],
    "status": "active",
    "isRecommended": true
  }'
```

### 示例3: 创建简单菜品（最少参数）

```bash
curl -X POST http://localhost:3000/api/admin/dishes \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer your-jwt-token" \
  -d '{
    "name": "白米饭",
    "categoryId": "3"
  }'
```

## 🔧 技术实现细节

### 数据库表结构

```sql
CREATE TABLE dishes (
  _id VARCHAR(36) PRIMARY KEY,
  name VARCHAR(100) NOT NULL,
  categoryId VARCHAR(36) NOT NULL,
  description TEXT,
  price DECIMAL(10,2) DEFAULT 0,
  image VARCHAR(500),
  calories DECIMAL(8,2),
  protein DECIMAL(8,2),
  fat DECIMAL(8,2),
  carbohydrate DECIMAL(8,2),
  tags JSON,
  status ENUM('active', 'inactive') DEFAULT 'active',
  isRecommended TINYINT(1) DEFAULT 0,
  createTime DATETIME DEFAULT CURRENT_TIMESTAMP,
  updateTime DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  createBy VARCHAR(36),
  updateBy VARCHAR(36)
);
```

### 参数处理逻辑

1. **参数验证**: 使用 `express-validator` 进行输入验证
2. **数据清理**: 将 `undefined` 值转换为 `null`
3. **类型转换**: 布尔值转换为数字（0/1）
4. **默认值处理**: 为可选字段提供合适的默认值

### 错误处理

- **参数验证错误**: 返回详细的字段验证信息
- **数据库错误**: 记录错误日志并返回通用错误信息
- **权限错误**: 返回权限不足提示

## 📊 状态码说明

| 状态码 | 说明 | 场景 |
|--------|------|------|
| 200 | 成功 | 菜品创建成功 |
| 400 | 请求错误 | 参数验证失败 |
| 401 | 未授权 | Token无效或过期 |
| 403 | 禁止访问 | 权限不足 |
| 500 | 服务器错误 | 数据库操作失败或其他系统错误 |

## 🚨 注意事项

### 1. 参数要求
- 所有必填字段必须提供
- 数值类型字段不能为负数
- 字符串字段不能超过最大长度限制

### 2. 数据格式
- 价格使用浮点数，支持小数点
- 营养成分使用浮点数，精确到小数点后2位
- 标签使用JSON数组格式

### 3. 权限控制
- 只有部门管理员可以创建菜品
- 需要有效的JWT Token
- Token必须包含正确的权限信息

### 4. 性能考虑
- 图片URL建议使用CDN地址
- 大量标签可能影响查询性能
- 建议定期清理无效的菜品数据

## 🔄 相关接口

- **获取菜品列表**: `GET /api/admin/dishes`
- **获取菜品详情**: `GET /api/admin/dishes/:dishId`
- **更新菜品**: `PUT /api/admin/dishes/:dishId`
- **删除菜品**: `DELETE /api/admin/dishes/:dishId`
- **获取菜品分类**: `GET /api/admin/dish-categories`

## 📝 更新日志

### v1.0.0 (2025-09-04)
- ✅ 初始版本发布
- ✅ 支持完整的菜品信息创建
- ✅ 添加参数验证和错误处理
- ✅ 修复参数绑定错误问题
- ✅ 完善文档和示例

---

**最后更新**: 2025-09-04  
**文档版本**: v1.0.0  
**维护人员**: 开发团队
