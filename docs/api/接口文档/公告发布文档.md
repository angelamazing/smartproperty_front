# 公告发布接口文档

## 概述

本文档描述了公告管理系统的完整API接口，包括公告的创建、查询、更新、删除、发布等操作。系统支持多种公告类型、优先级设置、定时发布等功能。

## 基础信息

- **基础URL**: `http://localhost:3000/api/admin`
- **认证方式**: Bearer Token (JWT)
- **内容类型**: `application/json`
- **字符编码**: UTF-8

## 认证说明

所有接口都需要在请求头中携带有效的JWT Token：

```http
Authorization: Bearer <your-jwt-token>
```

获取Token的方式：
```http
POST /api/auth/test-login-admin
Content-Type: application/json

{
  "phoneNumber": "13800000001",
  "password": "admin123"
}
```

## 接口列表

### 1. 获取公告列表

**接口地址**: `GET /api/admin/notices`

**功能描述**: 分页获取公告列表，支持多种筛选条件

**请求参数**:

| 参数名 | 类型 | 必填 | 默认值 | 说明 |
|--------|------|------|--------|------|
| page | number | 否 | 1 | 页码 |
| pageSize | number | 否 | 20 | 每页数量 |
| status | string | 否 | - | 公告状态：draft(草稿)、published(已发布)、archived(已归档) |
| type | string | 否 | - | 公告类型：info(信息)、warning(警告)、error(错误)、success(成功) |
| keyword | string | 否 | - | 搜索关键词（标题或内容） |

**请求示例**:
```http
GET /api/admin/notices?page=1&pageSize=10&status=published&type=info&keyword=重要
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

**响应示例**:
```json
{
  "success": true,
  "message": "获取公告列表成功",
  "data": {
    "records": [
      {
        "_id": "notice-001",
        "title": "系统维护通知",
        "content": "系统将于今晚进行维护...",
        "type": "info",
        "priority": 1,
        "status": "published",
        "startTime": "2025-01-01T00:00:00.000Z",
        "endTime": "2025-01-31T23:59:59.000Z",
        "targetUsers": ["user-001", "user-002"],
        "isSticky": true,
        "viewCount": 150,
        "publisherId": "admin-001",
        "publisherName": "系统管理员",
        "publishTime": "2025-01-01T10:00:00.000Z",
        "createTime": "2025-01-01T09:00:00.000Z",
        "updateTime": "2025-01-01T10:00:00.000Z"
      }
    ],
    "total": 25,
    "page": 1,
    "pageSize": 10
  },
  "timestamp": "2025-01-01T12:00:00.000Z"
}
```

### 2. 获取公告详情

**接口地址**: `GET /api/admin/notices/{noticeId}`

**功能描述**: 根据公告ID获取公告详细信息

**路径参数**:

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| noticeId | string | 是 | 公告唯一标识符 |

**请求示例**:
```http
GET /api/admin/notices/notice-001
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

**响应示例**:
```json
{
  "success": true,
  "message": "获取公告详情成功",
  "data": {
    "_id": "notice-001",
    "title": "系统维护通知",
    "content": "系统将于今晚进行维护，预计维护时间2小时...",
    "type": "info",
    "priority": 1,
    "status": "published",
    "startTime": "2025-01-01T00:00:00.000Z",
    "endTime": "2025-01-31T23:59:59.000Z",
    "targetUsers": ["user-001", "user-002"],
    "isSticky": true,
    "viewCount": 150,
    "publisherId": "admin-001",
    "publisherName": "系统管理员",
    "publishTime": "2025-01-01T10:00:00.000Z",
    "createTime": "2025-01-01T09:00:00.000Z",
    "updateTime": "2025-01-01T10:00:00.000Z"
  },
  "timestamp": "2025-01-01T12:00:00.000Z"
}
```

### 3. 创建公告

**接口地址**: `POST /api/admin/notices`

**功能描述**: 创建新的公告

**请求体参数**:

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| title | string | 是 | 公告标题，最大200字符 |
| content | string | 是 | 公告内容 |
| type | string | 否 | 公告类型：info(信息)、warning(警告)、error(错误)、success(成功)，默认info |
| priority | number | 否 | 优先级：0-5，数字越大优先级越高，默认0 |
| status | string | 否 | 状态：draft(草稿)、published(已发布)、archived(已归档)，默认draft |
| startTime | string | 否 | 开始时间，ISO 8601格式 |
| endTime | string | 否 | 结束时间，ISO 8601格式 |
| targetUsers | array | 否 | 目标用户ID数组 |
| isSticky | boolean | 否 | 是否置顶，默认false |
| publisherId | string | 否 | 发布者ID |
| publisherName | string | 否 | 发布者姓名 |

**请求示例**:
```http
POST /api/admin/notices
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
Content-Type: application/json

{
  "title": "重要系统更新通知",
  "content": "系统将于本周六进行重要更新，请提前保存数据。",
  "type": "warning",
  "priority": 3,
  "status": "draft",
  "startTime": "2025-01-01T00:00:00.000Z",
  "endTime": "2025-01-31T23:59:59.000Z",
  "targetUsers": ["user-001", "user-002"],
  "isSticky": true,
  "publisherId": "admin-001",
  "publisherName": "系统管理员"
}
```

**响应示例**:
```json
{
  "success": true,
  "message": "创建公告成功",
  "data": {
    "_id": "notice-002",
    "title": "重要系统更新通知",
    "content": "系统将于本周六进行重要更新，请提前保存数据。",
    "type": "warning",
    "priority": 3,
    "status": "draft",
    "startTime": "2025-01-01T00:00:00.000Z",
    "endTime": "2025-01-31T23:59:59.000Z",
    "targetUsers": ["user-001", "user-002"],
    "isSticky": true,
    "publisherId": "admin-001",
    "publisherName": "系统管理员",
    "publishTime": null,
    "createTime": "2025-01-01T12:00:00.000Z",
    "updateTime": "2025-01-01T12:00:00.000Z"
  },
  "timestamp": "2025-01-01T12:00:00.000Z"
}
```

### 4. 更新公告

**接口地址**: `PUT /api/admin/notices/{noticeId}`

**功能描述**: 更新指定公告的信息

**路径参数**:

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| noticeId | string | 是 | 公告唯一标识符 |

**请求体参数**: 与创建公告相同，所有字段都是可选的

**请求示例**:
```http
PUT /api/admin/notices/notice-002
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
Content-Type: application/json

{
  "title": "重要系统更新通知（已修改）",
  "priority": 5,
  "status": "published"
}
```

**响应示例**:
```json
{
  "success": true,
  "message": "更新公告成功",
  "data": {
    "_id": "notice-002",
    "title": "重要系统更新通知（已修改）",
    "content": "系统将于本周六进行重要更新，请提前保存数据。",
    "type": "warning",
    "priority": 5,
    "status": "published",
    "startTime": "2025-01-01T00:00:00.000Z",
    "endTime": "2025-01-31T23:59:59.000Z",
    "targetUsers": ["user-001", "user-002"],
    "isSticky": true,
    "publisherId": "admin-001",
    "publisherName": "系统管理员",
    "publishTime": "2025-01-01T12:05:00.000Z",
    "createTime": "2025-01-01T12:00:00.000Z",
    "updateTime": "2025-01-01T12:05:00.000Z"
  },
  "timestamp": "2025-01-01T12:05:00.000Z"
}
```

### 5. 删除公告

**接口地址**: `DELETE /api/admin/notices/{noticeId}`

**功能描述**: 删除指定的公告

**路径参数**:

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| noticeId | string | 是 | 公告唯一标识符 |

**请求示例**:
```http
DELETE /api/admin/notices/notice-002
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

**响应示例**:
```json
{
  "success": true,
  "message": "公告删除成功",
  "timestamp": "2025-01-01T12:10:00.000Z"
}
```

### 6. 发布公告

**接口地址**: `POST /api/admin/notices/{noticeId}/publish`

**功能描述**: 将草稿状态的公告发布

**路径参数**:

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| noticeId | string | 是 | 公告唯一标识符 |

**请求示例**:
```http
POST /api/admin/notices/notice-002/publish
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

**响应示例**:
```json
{
  "success": true,
  "message": "公告发布成功",
  "data": {
    "_id": "notice-002",
    "status": "published",
    "publishTime": "2025-01-01T12:15:00.000Z",
    "updateTime": "2025-01-01T12:15:00.000Z"
  },
  "timestamp": "2025-01-01T12:15:00.000Z"
}
```

### 7. 取消发布公告

**接口地址**: `POST /api/admin/notices/{noticeId}/unpublish`

**功能描述**: 将已发布的公告取消发布，转为草稿状态

**路径参数**:

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| noticeId | string | 是 | 公告唯一标识符 |

**请求示例**:
```http
POST /api/admin/notices/notice-002/unpublish
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

**响应示例**:
```json
{
  "success": true,
  "message": "公告取消发布成功",
  "data": {
    "_id": "notice-002",
    "status": "draft",
    "publishTime": null,
    "updateTime": "2025-01-01T12:20:00.000Z"
  },
  "timestamp": "2025-01-01T12:20:00.000Z"
}
```

### 8. 批量删除公告

**接口地址**: `POST /api/admin/notices/batch-delete`

**功能描述**: 批量删除多个公告

**请求体参数**:

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| noticeIds | array | 是 | 要删除的公告ID数组 |

**请求示例**:
```http
POST /api/admin/notices/batch-delete
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
Content-Type: application/json

{
  "noticeIds": ["notice-001", "notice-002", "notice-003"]
}
```

**响应示例**:
```json
{
  "success": true,
  "message": "批量删除公告成功",
  "data": {
    "deletedCount": 3,
    "deletedIds": ["notice-001", "notice-002", "notice-003"]
  },
  "timestamp": "2025-01-01T12:25:00.000Z"
}
```

## 数据字典

### 公告状态 (status)

| 值 | 说明 |
|----|------|
| draft | 草稿 |
| published | 已发布 |
| archived | 已归档 |

### 公告类型 (type)

| 值 | 说明 |
|----|------|
| info | 信息 |
| warning | 警告 |
| error | 错误 |
| success | 成功 |

### 优先级 (priority)

| 值 | 说明 |
|----|------|
| 0 | 最低优先级 |
| 1 | 低优先级 |
| 2 | 普通优先级 |
| 3 | 高优先级 |
| 4 | 较高优先级 |
| 5 | 最高优先级 |

## 错误码说明

| 错误码 | 说明 |
|--------|------|
| 400 | 请求参数错误 |
| 401 | 未授权，Token无效或过期 |
| 403 | 权限不足 |
| 404 | 资源不存在 |
| 500 | 服务器内部错误 |

## 错误响应格式

```json
{
  "success": false,
  "message": "错误描述信息",
  "code": "400",
  "timestamp": "2025-01-01T12:00:00.000Z"
}
```

## 注意事项

1. **认证要求**: 所有接口都需要有效的JWT Token
2. **权限控制**: 只有管理员角色才能访问这些接口
3. **数据验证**: 所有输入数据都会进行严格验证
4. **时间格式**: 时间字段统一使用ISO 8601格式
5. **分页限制**: 单次查询最多返回100条记录
6. **内容长度**: 公告标题最大200字符，内容无限制
7. **状态流转**: 公告状态只能按 draft → published → archived 流转

## 测试用例

### 完整流程测试

```javascript
// 1. 登录获取Token
const loginResponse = await fetch('/api/auth/test-login-admin', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    phoneNumber: '13800000001',
    password: 'admin123'
  })
});
const { data: { token } } = await loginResponse.json();

// 2. 创建公告
const createResponse = await fetch('/api/admin/notices', {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${token}`,
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    title: '测试公告',
    content: '这是一个测试公告',
    type: 'info',
    priority: 1
  })
});

// 3. 发布公告
const noticeId = createResponse.data._id;
await fetch(`/api/admin/notices/${noticeId}/publish`, {
  method: 'POST',
  headers: { 'Authorization': `Bearer ${token}` }
});

// 4. 获取公告列表
const listResponse = await fetch('/api/admin/notices?status=published', {
  headers: { 'Authorization': `Bearer ${token}` }
});
```

## 更新日志

- **v1.0.0** (2025-01-01): 初始版本，包含完整的CRUD操作
- **v1.0.1** (2025-01-01): 修复删除功能数据库查询问题
- **v1.0.2** (2025-01-01): 优化错误处理和响应格式
