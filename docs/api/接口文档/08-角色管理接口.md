# 角色管理接口文档

## 📋 接口概述

角色管理接口提供角色的增删改查、权限分配、用户角色管理等功能。

**基础路径**: `/api/admin/roles`

**认证要求**: 所有接口都需要有效的JWT Token和系统管理员权限

## 🔐 接口列表

### 1. 获取角色列表

**接口地址**: `GET /api/admin/roles`

**接口描述**: 获取角色列表，支持分页和筛选

**请求头**:
```http
Authorization: Bearer {token}
```

**查询参数**:
```
page: number          // 页码，默认1
size: number          // 每页数量，默认20，最大100
status: string        // 状态筛选：active/disabled（可选）
keyword: string       // 关键词搜索（角色名称/描述）
```

**响应示例**:
```json
{
  "success": true,
  "message": "获取角色列表成功",
  "data": {
    "list": [
      {
        "_id": "role_id_1",
        "name": "系统管理员",
        "code": "sys_admin",
        "description": "拥有系统所有权限",
        "level": 3,
        "permissions": [
          "user:read", "user:create", "user:update", "user:delete",
          "role:read", "role:create", "role:update", "role:delete",
          "system:read", "system:update", "system:admin"
        ],
        "status": "active",
        "userCount": 2,
        "createTime": "2024-01-01T00:00:00.000Z",
        "updateTime": "2024-01-15T10:30:00.000Z"
      },
      {
        "_id": "role_id_2",
        "name": "部门管理员",
        "code": "dept_admin",
        "description": "管理本部门用户和查看统计数据",
        "level": 1,
        "permissions": [
          "user:read", "user:update",
          "dining:read", "dining:stats",
          "reservation:read", "reservation:stats"
        ],
        "status": "active",
        "userCount": 15,
        "createTime": "2024-01-01T00:00:00.000Z",
        "updateTime": "2024-01-15T10:30:00.000Z"
      }
    ],
    "pagination": {
      "page": 1,
      "size": 20,
      "total": 8,
      "totalPages": 1
    }
  }
}
```

---

### 2. 获取角色详情

**接口地址**: `GET /api/admin/roles/:roleId`

**接口描述**: 获取指定角色的详细信息

**请求头**:
```http
Authorization: Bearer {token}
```

**路径参数**:
```
roleId: string  // 角色ID
```

**响应示例**:
```json
{
  "success": true,
  "message": "获取角色详情成功",
  "data": {
    "_id": "role_id_1",
    "name": "系统管理员",
    "code": "sys_admin",
    "description": "拥有系统所有权限",
    "level": 3,
    "permissions": [
      "user:read", "user:create", "user:update", "user:delete",
      "role:read", "role:create", "role:update", "role:delete",
      "system:read", "system:update", "system:admin"
    ],
    "status": "active",
    "userCount": 2,
    "assignedUsers": [
      {
        "_id": "user_id_1",
        "nickName": "张三",
        "realName": "张三",
        "phoneNumber": "13800138000"
      }
    ],
    "createTime": "2024-01-01T00:00:00.000Z",
    "updateTime": "2024-01-15T10:30:00.000Z"
  }
}
```

---

### 3. 创建角色

**接口地址**: `POST /api/admin/roles`

**接口描述**: 创建新角色

**请求头**:
```http
Authorization: Bearer {token}
Content-Type: application/json
```

**请求参数**:
```json
{
  "name": "内容编辑员",
  "code": "content_editor",
  "description": "负责内容编辑和审核",
  "level": 2,
  "permissions": [
    "menu:read", "menu:create", "menu:update",
    "dish:read", "dish:create", "dish:update",
    "content:read", "content:create", "content:update"
  ]
}
```

**响应示例**:
```json
{
  "success": true,
  "message": "角色创建成功",
  "data": {
    "roleId": "role_id_3",
    "name": "内容编辑员",
    "code": "content_editor",
    "createTime": "2024-01-15T16:30:00.000Z"
  }
}
```

---

### 4. 更新角色信息

**接口地址**: `PUT /api/admin/roles/:roleId`

**接口描述**: 更新角色信息

**请求头**:
```http
Authorization: Bearer {token}
Content-Type: application/json
```

**路径参数**:
```
roleId: string  // 角色ID
```

**请求参数**:
```json
{
  "name": "高级内容编辑员",
  "description": "负责高级内容编辑和审核，拥有更多权限",
  "permissions": [
    "menu:read", "menu:create", "menu:update", "menu:delete",
    "dish:read", "dish:create", "dish:update", "dish:delete",
    "content:read", "content:create", "content:update", "content:delete"
  ]
}
```

**响应示例**:
```json
{
  "success": true,
  "message": "角色信息更新成功",
  "data": {
    "roleId": "role_id_3",
    "updateTime": "2024-01-15T16:30:00.000Z",
    "updatedFields": ["name", "description", "permissions"]
  }
}
```

---

### 5. 删除角色

**接口地址**: `DELETE /api/admin/roles/:roleId`

**接口描述**: 删除角色（软删除）

**请求头**:
```http
Authorization: Bearer {token}
```

**路径参数**:
```
roleId: string  // 角色ID
```

**响应示例**:
```json
{
  "success": true,
  "message": "角色删除成功",
  "data": {
    "roleId": "role_id_3",
    "deleteTime": "2024-01-15T16:30:00.000Z",
    "deletedBy": "admin_id"
  }
}
```

---

### 6. 分配角色给用户

**接口地址**: `POST /api/admin/roles/assign`

**接口描述**: 将角色分配给指定用户

**请求头**:
```http
Authorization: Bearer {token}
Content-Type: application/json
```

**请求参数**:
```json
{
  "userId": "user_id_2",
  "roleId": "role_id_3"
}
```

**响应示例**:
```json
{
  "success": true,
  "message": "角色分配成功",
  "data": {
    "userId": "user_id_2",
    "roleId": "role_id_3",
    "roleName": "内容编辑员",
    "assignTime": "2024-01-15T16:30:00.000Z",
    "assignedBy": "admin_id"
  }
}
```

---

### 7. 批量分配角色

**接口地址**: `POST /api/admin/roles/batch-assign`

**接口描述**: 批量分配角色给多个用户

**请求头**:
```http
Authorization: Bearer {token}
Content-Type: application/json
```

**请求参数**:
```json
{
  "assignments": [
    {
      "userId": "user_id_2",
      "roleId": "role_id_3"
    },
    {
      "userId": "user_id_3",
      "roleId": "role_id_3"
    }
  ]
}
```

**响应示例**:
```json
{
  "success": true,
  "message": "批量角色分配成功",
  "data": {
    "successCount": 2,
    "failedCount": 0,
    "assignments": [
      {
        "userId": "user_id_2",
        "roleId": "role_id_3",
        "status": "success"
      },
      {
        "userId": "user_id_3",
        "roleId": "role_id_3",
        "status": "success"
      }
    ],
    "assignTime": "2024-01-15T16:30:00.000Z"
  }
}
```

---

### 8. 撤销用户角色

**接口地址**: `DELETE /api/admin/roles/assign`

**接口描述**: 撤销用户的角色分配

**请求头**:
```http
Authorization: Bearer {token}
Content-Type: application/json
```

**请求参数**:
```json
{
  "userId": "user_id_2",
  "roleId": "role_id_3"
}
```

**响应示例**:
```json
{
  "success": true,
  "message": "角色撤销成功",
  "data": {
    "userId": "user_id_2",
    "roleId": "role_id_3",
    "roleName": "内容编辑员",
    "revokeTime": "2024-01-15T16:30:00.000Z",
    "revokedBy": "admin_id"
  }
}
```

---

### 9. 获取权限列表

**接口地址**: `GET /api/admin/roles/permissions`

**接口描述**: 获取系统所有可用权限列表

**请求头**:
```http
Authorization: Bearer {token}
```

**响应示例**:
```json
{
  "success": true,
  "message": "获取权限列表成功",
  "data": [
    {
      "module": "用户管理",
      "permissions": [
        {
          "code": "user:read",
          "name": "查看用户",
          "description": "查看用户列表和详情"
        },
        {
          "code": "user:create",
          "name": "创建用户",
          "description": "创建新用户"
        },
        {
          "code": "user:update",
          "name": "更新用户",
          "description": "修改用户信息"
        },
        {
          "code": "user:delete",
          "name": "删除用户",
          "description": "删除用户"
        }
      ]
    },
    {
      "module": "角色管理",
      "permissions": [
        {
          "code": "role:read",
          "name": "查看角色",
          "description": "查看角色列表和详情"
        },
        {
          "code": "role:create",
          "name": "创建角色",
          "description": "创建新角色"
        },
        {
          "code": "role:update",
          "name": "更新角色",
          "description": "修改角色信息"
        },
        {
          "code": "role:delete",
          "name": "删除角色",
          "description": "删除角色"
        }
      ]
    },
    {
      "module": "菜单管理",
      "permissions": [
        {
          "code": "menu:read",
          "name": "查看菜单",
          "description": "查看菜单列表和详情"
        },
        {
          "code": "menu:create",
          "name": "创建菜单",
          "description": "创建新菜单"
        },
        {
          "code": "menu:update",
          "name": "更新菜单",
          "description": "修改菜单信息"
        },
        {
          "code": "menu:delete",
          "name": "删除菜单",
          "description": "删除菜单"
        }
      ]
    }
  ]
}
```

---

### 10. 获取角色权限

**接口地址**: `GET /api/admin/roles/:roleId/permissions`

**接口描述**: 获取指定角色的权限详情

**请求头**:
```http
Authorization: Bearer {token}
```

**路径参数**:
```
roleId: string  // 角色ID
```

**响应示例**:
```json
{
  "success": true,
  "message": "获取角色权限成功",
  "data": {
    "roleId": "role_id_3",
    "roleName": "内容编辑员",
    "permissions": [
      {
        "code": "menu:read",
        "name": "查看菜单",
        "description": "查看菜单列表和详情",
        "granted": true
      },
      {
        "code": "menu:create",
        "name": "创建菜单",
        "description": "创建新菜单",
        "granted": true
      },
      {
        "code": "menu:update",
        "name": "更新菜单",
        "description": "修改菜单信息",
        "granted": true
      },
      {
        "code": "menu:delete",
        "name": "删除菜单",
        "description": "删除菜单",
        "granted": false
      }
    ]
  }
}
```

---

### 11. 更新角色权限

**接口地址**: `PUT /api/admin/roles/:roleId/permissions`

**接口描述**: 更新指定角色的权限

**请求头**:
```http
Authorization: Bearer {token}
Content-Type: application/json
```

**路径参数**:
```
roleId: string  // 角色ID
```

**请求参数**:
```json
{
  "permissions": [
    "menu:read", "menu:create", "menu:update", "menu:delete",
    "dish:read", "dish:create", "dish:update", "dish:delete"
  ]
}
```

**响应示例**:
```json
{
  "success": true,
  "message": "角色权限更新成功",
  "data": {
    "roleId": "role_id_3",
    "updatedPermissions": [
      "menu:read", "menu:create", "menu:update", "menu:delete",
      "dish:read", "dish:create", "dish:update", "dish:delete"
    ],
    "updateTime": "2024-01-15T16:30:00.000Z",
    "updatedBy": "admin_id"
  }
}
```

---

## 📱 前端集成示例

### JavaScript示例

```javascript
// 获取角色列表
async function getRolesList(params = {}) {
  try {
    const token = localStorage.getItem('token');
    const queryString = new URLSearchParams(params).toString();
    
    const response = await fetch(`/api/admin/roles?${queryString}`, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`
      }
    });
    
    const result = await response.json();
    
    if (result.success) {
      return result.data;
    } else {
      throw new Error(result.message);
    }
  } catch (error) {
    console.error('获取角色列表失败:', error);
    throw error;
  }
}

// 创建角色
async function createRole(roleData) {
  try {
    const token = localStorage.getItem('token');
    const response = await fetch('/api/admin/roles', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(roleData)
    });
    
    const result = await response.json();
    
    if (result.success) {
      return result.data;
    } else {
      throw new Error(result.message);
    }
  } catch (error) {
    console.error('创建角色失败:', error);
    throw error;
  }
}

// 分配角色
async function assignRole(userId, roleId) {
  try {
    const token = localStorage.getItem('token');
    const response = await fetch('/api/admin/roles/assign', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ userId, roleId })
    });
    
    const result = await response.json();
    
    if (result.success) {
      return result.data;
    } else {
      throw new Error(result.message);
    }
  } catch (error) {
    console.error('分配角色失败:', error);
    throw error;
  }
}

// 获取权限列表
async function getPermissionsList() {
  try {
    const token = localStorage.getItem('token');
    const response = await fetch('/api/admin/roles/permissions', {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`
      }
    });
    
    const result = await response.json();
    
    if (result.success) {
      return result.data;
    } else {
      throw new Error(result.message);
    }
  } catch (error) {
    console.error('获取权限列表失败:', error);
    throw error;
  }
}
```

## 🔒 权限说明

### 角色管理权限

| 操作 | 所需权限 | 说明 |
|------|----------|------|
| 查看角色 | `role:read` | 查看角色列表和详情 |
| 创建角色 | `role:create` | 创建新角色 |
| 编辑角色 | `role:update` | 修改角色信息 |
| 删除角色 | `role:delete` | 删除角色 |
| 分配角色 | `role:assign` | 给用户分配角色 |
| 管理权限 | `role:permission` | 管理角色权限 |

### 角色等级说明

| 等级 | 角色类型 | 权限范围 | 说明 |
|------|----------|----------|------|
| 1 | 部门管理员 | 本部门 | 只能管理本部门用户和查看统计数据 |
| 2 | 功能管理员 | 指定功能 | 可以管理指定功能模块 |
| 3 | 系统管理员 | 全系统 | 拥有系统所有权限 |

## ⚠️ 注意事项

1. **权限继承**: 高级别角色自动拥有低级别角色的权限
2. **角色删除**: 删除角色前需要确保没有用户使用该角色
3. **权限冲突**: 同一用户不能同时拥有冲突的角色
4. **系统角色**: 系统内置角色（如系统管理员）不能删除
5. **权限验证**: 所有权限操作都会进行严格验证
6. **操作日志**: 所有角色操作都会记录详细日志，便于审计
7. **批量操作**: 批量分配角色操作有数量限制，避免一次性处理过多数据
8. **权限缓存**: 角色权限变更后，相关用户的权限缓存会自动更新
