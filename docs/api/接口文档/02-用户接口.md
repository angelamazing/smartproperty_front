# 用户接口文档

## 📋 接口概述

用户接口提供用户信息管理、权限控制、个人资料更新等功能。

**基础路径**: `/api/user`

**认证要求**: 所有接口都需要有效的JWT Token

## 🔐 接口列表

### 1. 获取用户统计数据

**接口地址**: `GET /api/user/stats`

**接口描述**: 获取当前用户的统计数据

**请求头**:
```http
Authorization: Bearer {token}
```

**响应示例**:
```json
{
  "success": true,
  "message": "获取用户统计成功",
  "data": {
    "totalOrders": 25,        // 总报餐次数
    "thisMonthOrders": 8,     // 本月报餐次数
    "totalReservations": 12,  // 总预约次数
    "thisMonthReservations": 3, // 本月预约次数
    "lastOrderDate": "2024-01-15", // 最后报餐日期
    "lastReservationDate": "2024-01-10" // 最后预约日期
  }
}
```

---

### 2. 获取当前用户信息

**接口地址**: `GET /api/user/info`

**接口描述**: 获取当前登录用户的详细信息

**请求头**:
```http
Authorization: Bearer {token}
```

**响应示例**:
```json
{
  "success": true,
  "message": "获取用户信息成功",
  "data": {
    "_id": "user_id",
    "nickName": "张三",
    "realName": "张三",
    "avatarUrl": "https://example.com/avatar.jpg",
    "phoneNumber": "13800138000",
    "email": "zhangsan@example.com",
    "gender": 1,
    "department": "技术部",
    "departmentId": "dept_id",
    "position": "软件工程师",
    "employeeId": "EMP001",
    "joinDate": "2023-01-01",
    "role": "user",
    "status": "active",
    "createTime": "2023-01-01T00:00:00.000Z",
    "lastLoginTime": "2024-01-15T10:30:00.000Z",
    "loginCount": 156
  }
}
```

---

### 3. 更新用户头像

**接口地址**: `PUT /api/user/avatar`

**接口描述**: 更新当前用户的头像

**请求头**:
```http
Authorization: Bearer {token}
Content-Type: multipart/form-data
```

**请求参数**:
```form-data
avatar: File  // 头像文件，支持jpg/png格式，最大2MB
```

**响应示例**:
```json
{
  "success": true,
  "message": "头像更新成功",
  "data": {
    "avatarUrl": "https://example.com/new-avatar.jpg",
    "updateTime": "2024-01-15T15:30:00.000Z"
  }
}
```

---

### 4. 更新用户资料

**接口地址**: `PUT /api/user/profile`

**接口描述**: 更新当前用户的个人资料

**请求头**:
```http
Authorization: Bearer {token}
Content-Type: application/json
```

**请求参数**:
```json
{
  "nickName": "string",      // 昵称（可选）
  "realName": "string",      // 真实姓名（可选）
  "email": "string",         // 邮箱（可选）
  "gender": 1,               // 性别：0-未知，1-男，2-女（可选）
  "position": "string"       // 职位（可选）
}
```

**响应示例**:
```json
{
  "success": true,
  "message": "用户资料更新成功",
  "data": {
    "updateTime": "2024-01-15T15:30:00.000Z",
    "updatedFields": ["nickName", "email"]
  }
}
```

---

## 👥 管理员功能接口

### 5. 获取用户列表（部门管理员及以上权限）

**接口地址**: `GET /api/user/list`

**接口描述**: 获取用户列表，支持分页和筛选

**请求头**:
```http
Authorization: Bearer {token}
```

**查询参数**:
```
page: number          // 页码，默认1
size: number          // 每页数量，默认20，最大100
departmentId: string  // 部门ID筛选（可选）
role: string          // 角色筛选（可选）
status: string        // 状态筛选（可选）
keyword: string       // 关键词搜索（姓名/手机号/邮箱）
```

**响应示例**:
```json
{
  "success": true,
  "message": "获取用户列表成功",
  "data": {
    "list": [
      {
        "_id": "user_id_1",
        "nickName": "张三",
        "realName": "张三",
        "phoneNumber": "13800138000",
        "email": "zhangsan@example.com",
        "department": "技术部",
        "position": "软件工程师",
        "role": "user",
        "status": "active",
        "createTime": "2023-01-01T00:00:00.000Z",
        "lastLoginTime": "2024-01-15T10:30:00.000Z"
      }
    ],
    "pagination": {
      "page": 1,
      "size": 20,
      "total": 45,
      "totalPages": 3
    }
  }
}
```

---

### 6. 获取指定用户信息（部门管理员及以上权限）

**接口地址**: `GET /api/user/:userId`

**接口描述**: 获取指定用户的详细信息

**请求头**:
```http
Authorization: Bearer {token}
```

**路径参数**:
```
userId: string  // 用户ID
```

**响应示例**:
```json
{
  "success": true,
  "message": "获取用户信息成功",
  "data": {
    "_id": "user_id",
    "nickName": "张三",
    "realName": "张三",
    "avatarUrl": "https://example.com/avatar.jpg",
    "phoneNumber": "13800138000",
    "email": "zhangsan@example.com",
    "gender": 1,
    "country": "中国",
    "province": "广东省",
    "city": "深圳市",
    "department": "技术部",
    "departmentId": "dept_id",
    "position": "软件工程师",
    "employeeId": "EMP001",
    "joinDate": "2023-01-01",
    "role": "user",
    "status": "active",
    "remark": "优秀员工",
    "createTime": "2023-01-01T00:00:00.000Z",
    "updateTime": "2024-01-15T15:30:00.000Z",
    "lastLoginTime": "2024-01-15T10:30:00.000Z",
    "loginCount": 156,
    "createBy": "admin_id",
    "updateBy": "admin_id"
  }
}
```

---

### 7. 更新用户状态（部门管理员及以上权限）

**接口地址**: `PUT /api/user/:userId/status`

**接口描述**: 更新指定用户的状态

**请求头**:
```http
Authorization: Bearer {token}
Content-Type: application/json
```

**路径参数**:
```
userId: string  // 用户ID
```

**请求参数**:
```json
{
  "status": "string"  // 新状态：active/inactive
}
```

**响应示例**:
```json
{
  "success": true,
  "message": "用户状态更新成功",
  "data": {
    "userId": "user_id",
    "oldStatus": "active",
    "newStatus": "inactive",
    "updateTime": "2024-01-15T15:30:00.000Z",
    "updateBy": "admin_id"
  }
}
```

---

### 8. 批量更新用户状态（部门管理员及以上权限）

**接口地址**: `PUT /api/user/batch/status`

**接口描述**: 批量更新多个用户的状态

**请求头**:
```http
Authorization: Bearer {token}
Content-Type: application/json
```

**请求参数**:
```json
{
  "userIds": ["user_id_1", "user_id_2", "user_id_3"],  // 用户ID数组
  "status": "active"  // 新状态：active/inactive
}
```

**响应示例**:
```json
{
  "success": true,
  "message": "批量更新用户状态成功",
  "data": {
    "updatedCount": 3,
    "failedCount": 0,
    "failedUserIds": [],
    "updateTime": "2024-01-15T15:30:00.000Z",
    "updateBy": "admin_id"
  }
}
```

---

## 🔐 系统管理员功能接口

### 9. 更新用户角色（系统管理员权限）

**接口地址**: `PUT /api/user/:userId/role`

**接口描述**: 更新指定用户的角色

**请求头**:
```http
Authorization: Bearer {token}
Content-Type: application/json
```

**路径参数**:
```
userId: string  // 用户ID
```

**请求参数**:
```json
{
  "role": "string"  // 新角色：user/dept_admin/admin/sys_admin/verifier
}
```

**响应示例**:
```json
{
  "success": true,
  "message": "用户角色更新成功",
  "data": {
    "userId": "user_id",
    "oldRole": "user",
    "newRole": "dept_admin",
    "updateTime": "2024-01-15T15:30:00.000Z",
    "updateBy": "sys_admin_id"
  }
}
```

---

### 10. 重置用户密码（系统管理员权限）

**接口地址**: `PUT /api/user/:userId/reset-password`

**接口描述**: 重置指定用户的密码

**请求头**:
```http
Authorization: Bearer {token}
Content-Type: application/json
```

**路径参数**:
```
userId: string  // 用户ID
```

**请求参数**:
```json
{
  "newPassword": "string"  // 新密码，长度6-20位
}
```

**响应示例**:
```json
{
  "success": true,
  "message": "用户密码重置成功",
  "data": {
    "userId": "user_id",
    "resetTime": "2024-01-15T15:30:00.000Z",
    "resetBy": "sys_admin_id"
  }
}
```

---

### 11. 删除用户（系统管理员权限）

**接口地址**: `DELETE /api/user/:userId`

**接口描述**: 删除指定用户（软删除）

**请求头**:
```http
Authorization: Bearer {token}
```

**路径参数**:
```
userId: string  // 用户ID
```

**响应示例**:
```json
{
  "success": true,
  "message": "用户删除成功",
  "data": {
    "userId": "user_id",
    "deleteTime": "2024-01-15T15:30:00.000Z",
    "deleteBy": "sys_admin_id"
  }
}
```

---

## 📊 用户角色说明

### 角色权限等级

| 角色 | 权限等级 | 功能描述 |
|------|----------|----------|
| `user` | 1 | 普通用户，可进行报餐、预约等基础操作 |
| `dept_admin` | 2 | 部门管理员，可管理本部门用户和查看统计数据 |
| `admin` | 3 | 管理员，可进行系统管理和用户管理 |
| `sys_admin` | 4 | 系统管理员，拥有所有权限，包括角色管理 |
| `verifier` | 1 | 验证员，专门用于用餐验证等操作 |

### 权限验证

```javascript
// 检查用户权限
function checkPermission(userRole, requiredRole) {
  const roleLevels = {
    'user': 1,
    'dept_admin': 2,
    'admin': 3,
    'sys_admin': 4,
    'verifier': 1
  };
  
  return roleLevels[userRole] >= roleLevels[requiredRole];
}
```

## 📱 前端集成示例

### JavaScript示例

```javascript
// 获取用户信息
async function getUserInfo() {
  try {
    const token = localStorage.getItem('token');
    const response = await fetch('/api/user/info', {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`
      }
    });
    
    const result = await response.json();
    
    if (result.success) {
      return result.data;
    } else {
      throw new Error(result.message);
    }
  } catch (error) {
    console.error('获取用户信息失败:', error);
    throw error;
  }
}

// 更新用户资料
async function updateUserProfile(profileData) {
  try {
    const token = localStorage.getItem('token');
    const response = await fetch('/api/user/profile', {
      method: 'PUT',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(profileData)
    });
    
    const result = await response.json();
    
    if (result.success) {
      return result.data;
    } else {
      throw new Error(result.message);
    }
  } catch (error) {
    console.error('更新用户资料失败:', error);
    throw error;
  }
}

// 上传头像
async function uploadAvatar(file) {
  try {
    const token = localStorage.getItem('token');
    const formData = new FormData();
    formData.append('avatar', file);
    
    const response = await fetch('/api/user/avatar', {
      method: 'PUT',
      headers: {
        'Authorization': `Bearer ${token}`
      },
      body: formData
    });
    
    const result = await response.json();
    
    if (result.success) {
      return result.data;
    } else {
      throw new Error(result.message);
    }
  } catch (error) {
    console.error('上传头像失败:', error);
    throw error;
  }
}

// 获取用户列表（管理员功能）
async function getUserList(params = {}) {
  try {
    const token = localStorage.getItem('token');
    const queryString = new URLSearchParams(params).toString();
    
    const response = await fetch(`/api/user/list?${queryString}`, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`
      }
    });
    
    const result = await response.json();
    
    if (result.success) {
      return result.data;
    } else {
      throw new Error(result.message);
    }
  } catch (error) {
    console.error('获取用户列表失败:', error);
    throw error;
  }
}
```

### 微信小程序示例

```javascript
// 获取用户信息
async function getUserInfo() {
  try {
    const token = wx.getStorageSync('token');
    const response = await wx.request({
      url: 'https://api.example.com/api/user/info',
      method: 'GET',
      header: {
        'Authorization': `Bearer ${token}`
      }
    });
    
    const result = response.data;
    
    if (result.success) {
      return result.data;
    } else {
      throw new Error(result.message);
    }
  } catch (error) {
    console.error('获取用户信息失败:', error);
    throw error;
  }
}

// 更新用户资料
async function updateUserProfile(profileData) {
  try {
    const token = wx.getStorageSync('token');
    const response = await wx.request({
      url: 'https://api.example.com/api/user/profile',
      method: 'PUT',
      header: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      data: profileData
    });
    
    const result = response.data;
    
    if (result.success) {
      return result.data;
    } else {
      throw new Error(result.message);
    }
  } catch (error) {
    console.error('更新用户资料失败:', error);
    throw error;
  }
}
```

## ⚠️ 注意事项

1. **权限控制**: 管理员功能需要相应的权限等级，前端需要根据用户角色显示/隐藏功能
2. **文件上传**: 头像上传支持jpg/png格式，最大2MB
3. **状态管理**: 用户状态变更会记录操作日志，便于审计
4. **软删除**: 删除用户采用软删除方式，数据不会真正丢失
5. **角色变更**: 角色变更需要谨慎操作，建议在变更前确认用户理解权限变化
6. **数据验证**: 所有输入数据都会进行验证，前端也需要进行相应的验证
7. **错误处理**: 接口返回详细的错误信息，前端需要妥善处理各种错误情况
