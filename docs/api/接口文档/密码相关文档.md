# 密码管理接口文档

## 📋 接口概述

密码管理接口提供用户密码修改、管理员密码重置等功能。

**基础路径**: `/api/user`

**认证要求**: 所有接口都需要有效的JWT Token

## 🔐 接口列表

### 1. 用户修改密码

**接口地址**: `PUT /api/user/change-password`

**接口描述**: 用户验证旧密码后修改为新密码

**权限要求**: 用户登录认证

**请求头**:
```http
Authorization: Bearer {token}
Content-Type: application/json
```

**请求参数**:
```json
{
  "oldPassword": "string",  // 旧密码，必填，6-20位
  "newPassword": "string"   // 新密码，必填，6-20位
}
```

**参数说明**:
| 参数名 | 类型 | 必填 | 说明 | 验证规则 |
|--------|------|------|------|----------|
| oldPassword | string | ✅ | 旧密码 | 长度6-20位，不能为空 |
| newPassword | string | ✅ | 新密码 | 长度6-20位，不能为空 |

**成功响应**:
```json
{
  "success": true,
  "message": "密码修改成功",
  "code": "200",
  "timestamp": "2025-09-06T04:30:08.000Z"
}
```

**错误响应**:
```json
{
  "success": false,
  "message": "旧密码不正确",
  "code": "400",
  "timestamp": "2025-09-06T04:30:08.000Z"
}
```

**常见错误码**:
- `400`: 旧密码不正确
- `404`: 用户不存在
- `422`: 参数验证失败
- `500`: 服务器内部错误

---

### 2. 管理员重置用户密码

**接口地址**: `PUT /api/user/:userId/reset-password`

**接口描述**: 管理员直接重置指定用户的密码

**权限要求**: 系统管理员权限

**请求头**:
```http
Authorization: Bearer {token}
Content-Type: application/json
```

**路径参数**:
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| userId | string | ✅ | 用户ID |

**请求参数**:
```json
{
  "newPassword": "string"  // 新密码，必填，6-20位
}
```

**参数说明**:
| 参数名 | 类型 | 必填 | 说明 | 验证规则 |
|--------|------|------|------|----------|
| newPassword | string | ✅ | 新密码 | 长度6-20位，不能为空 |

**成功响应**:
```json
{
  "success": true,
  "message": "用户密码重置成功",
  "code": "200",
  "timestamp": "2025-09-06T04:29:59.416Z",
  "data": {
    "userId": "e87abd4e-f5ad-4012-926c-bb616b260c6b",
    "resetTime": "2025-09-06T04:29:59.416Z",
    "resetBy": "e87abd4e-f5ad-4012-926c-bb616b260c6b"
  }
}
```

**错误响应**:
```json
{
  "success": false,
  "message": "用户不存在",
  "code": "404",
  "timestamp": "2025-09-06T04:30:08.000Z"
}
```

**常见错误码**:
- `403`: 权限不足，需要系统管理员权限
- `404`: 用户不存在
- `422`: 参数验证失败
- `500`: 服务器内部错误

---

## 📱 前端集成示例

### JavaScript/TypeScript 示例

#### 1. 用户修改密码

```javascript
/**
 * 修改用户密码
 * @param {string} oldPassword - 旧密码
 * @param {string} newPassword - 新密码
 * @returns {Promise<Object>} 响应结果
 */
async function changePassword(oldPassword, newPassword) {
  try {
    const token = localStorage.getItem('token'); // 从本地存储获取token
    
    const response = await fetch('/api/user/change-password', {
      method: 'PUT',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        oldPassword,
        newPassword
      })
    });
    
    const result = await response.json();
    
    if (result.success) {
      console.log('密码修改成功');
      return result;
    } else {
      console.error('密码修改失败:', result.message);
      throw new Error(result.message);
    }
  } catch (error) {
    console.error('修改密码请求失败:', error);
    throw error;
  }
}

// 使用示例
changePassword('oldPassword123', 'newPassword456')
  .then(result => {
    console.log('密码修改成功:', result);
    // 可以显示成功提示
  })
  .catch(error => {
    console.error('密码修改失败:', error.message);
    // 可以显示错误提示
  });
```

#### 2. 管理员重置密码

```javascript
/**
 * 重置用户密码（管理员功能）
 * @param {string} userId - 用户ID
 * @param {string} newPassword - 新密码
 * @returns {Promise<Object>} 响应结果
 */
async function resetUserPassword(userId, newPassword) {
  try {
    const token = localStorage.getItem('token'); // 从本地存储获取token
    
    const response = await fetch(`/api/user/${userId}/reset-password`, {
      method: 'PUT',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        newPassword
      })
    });
    
    const result = await response.json();
    
    if (result.success) {
      console.log('密码重置成功');
      return result;
    } else {
      console.error('密码重置失败:', result.message);
      throw new Error(result.message);
    }
  } catch (error) {
    console.error('重置密码请求失败:', error);
    throw error;
  }
}

// 使用示例
resetUserPassword('user-id-123', 'newPassword456')
  .then(result => {
    console.log('密码重置成功:', result);
    // 可以显示成功提示
  })
  .catch(error => {
    console.error('密码重置失败:', error.message);
    // 可以显示错误提示
  });
```

### Vue.js 示例

#### 1. 密码修改组件

```vue
<template>
  <div class="change-password-form">
    <h3>修改密码</h3>
    <form @submit.prevent="handleChangePassword">
      <div class="form-group">
        <label for="oldPassword">旧密码:</label>
        <input
          id="oldPassword"
          v-model="form.oldPassword"
          type="password"
          required
          minlength="6"
          maxlength="20"
          placeholder="请输入旧密码"
        />
      </div>
      
      <div class="form-group">
        <label for="newPassword">新密码:</label>
        <input
          id="newPassword"
          v-model="form.newPassword"
          type="password"
          required
          minlength="6"
          maxlength="20"
          placeholder="请输入新密码"
        />
      </div>
      
      <div class="form-group">
        <label for="confirmPassword">确认新密码:</label>
        <input
          id="confirmPassword"
          v-model="form.confirmPassword"
          type="password"
          required
          minlength="6"
          maxlength="20"
          placeholder="请再次输入新密码"
        />
      </div>
      
      <button type="submit" :disabled="loading">
        {{ loading ? '修改中...' : '修改密码' }}
      </button>
      
      <div v-if="message" :class="messageType">
        {{ message }}
      </div>
    </form>
  </div>
</template>

<script>
export default {
  name: 'ChangePassword',
  data() {
    return {
      form: {
        oldPassword: '',
        newPassword: '',
        confirmPassword: ''
      },
      loading: false,
      message: '',
      messageType: ''
    };
  },
  methods: {
    async handleChangePassword() {
      // 验证密码确认
      if (this.form.newPassword !== this.form.confirmPassword) {
        this.showMessage('两次输入的密码不一致', 'error');
        return;
      }
      
      // 验证密码长度
      if (this.form.newPassword.length < 6 || this.form.newPassword.length > 20) {
        this.showMessage('密码长度必须在6-20位之间', 'error');
        return;
      }
      
      this.loading = true;
      
      try {
        const token = this.$store.getters.token; // 从Vuex获取token
        
        const response = await this.$http.put('/api/user/change-password', {
          oldPassword: this.form.oldPassword,
          newPassword: this.form.newPassword
        }, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (response.data.success) {
          this.showMessage('密码修改成功', 'success');
          this.resetForm();
        } else {
          this.showMessage(response.data.message, 'error');
        }
      } catch (error) {
        const errorMessage = error.response?.data?.message || '密码修改失败';
        this.showMessage(errorMessage, 'error');
      } finally {
        this.loading = false;
      }
    },
    
    showMessage(text, type) {
      this.message = text;
      this.messageType = type;
      setTimeout(() => {
        this.message = '';
        this.messageType = '';
      }, 3000);
    },
    
    resetForm() {
      this.form = {
        oldPassword: '',
        newPassword: '',
        confirmPassword: ''
      };
    }
  }
};
</script>

<style scoped>
.change-password-form {
  max-width: 400px;
  margin: 0 auto;
  padding: 20px;
}

.form-group {
  margin-bottom: 15px;
}

.form-group label {
  display: block;
  margin-bottom: 5px;
  font-weight: bold;
}

.form-group input {
  width: 100%;
  padding: 8px;
  border: 1px solid #ddd;
  border-radius: 4px;
}

button {
  width: 100%;
  padding: 10px;
  background-color: #007bff;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}

button:disabled {
  background-color: #ccc;
  cursor: not-allowed;
}

.success {
  color: green;
  margin-top: 10px;
}

.error {
  color: red;
  margin-top: 10px;
}
</style>
```

#### 2. 管理员重置密码组件

```vue
<template>
  <div class="reset-password-form">
    <h3>重置用户密码</h3>
    <form @submit.prevent="handleResetPassword">
      <div class="form-group">
        <label for="userId">用户ID:</label>
        <input
          id="userId"
          v-model="form.userId"
          type="text"
          required
          placeholder="请输入用户ID"
        />
      </div>
      
      <div class="form-group">
        <label for="newPassword">新密码:</label>
        <input
          id="newPassword"
          v-model="form.newPassword"
          type="password"
          required
          minlength="6"
          maxlength="20"
          placeholder="请输入新密码"
        />
      </div>
      
      <button type="submit" :disabled="loading">
        {{ loading ? '重置中...' : '重置密码' }}
      </button>
      
      <div v-if="message" :class="messageType">
        {{ message }}
      </div>
    </form>
  </div>
</template>

<script>
export default {
  name: 'ResetPassword',
  data() {
    return {
      form: {
        userId: '',
        newPassword: ''
      },
      loading: false,
      message: '',
      messageType: ''
    };
  },
  methods: {
    async handleResetPassword() {
      // 验证密码长度
      if (this.form.newPassword.length < 6 || this.form.newPassword.length > 20) {
        this.showMessage('密码长度必须在6-20位之间', 'error');
        return;
      }
      
      this.loading = true;
      
      try {
        const token = this.$store.getters.token; // 从Vuex获取token
        
        const response = await this.$http.put(`/api/user/${this.form.userId}/reset-password`, {
          newPassword: this.form.newPassword
        }, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (response.data.success) {
          this.showMessage('密码重置成功', 'success');
          this.resetForm();
        } else {
          this.showMessage(response.data.message, 'error');
        }
      } catch (error) {
        const errorMessage = error.response?.data?.message || '密码重置失败';
        this.showMessage(errorMessage, 'error');
      } finally {
        this.loading = false;
      }
    },
    
    showMessage(text, type) {
      this.message = text;
      this.messageType = type;
      setTimeout(() => {
        this.message = '';
        this.messageType = '';
      }, 3000);
    },
    
    resetForm() {
      this.form = {
        userId: '',
        newPassword: ''
      };
    }
  }
};
</script>
```

### React 示例

#### 1. 密码修改Hook

```javascript
import { useState } from 'react';

export const useChangePassword = () => {
  const [loading, setLoading] = useState(false);
  const [message, setMessage] = useState('');
  const [messageType, setMessageType] = useState('');

  const changePassword = async (oldPassword, newPassword) => {
    setLoading(true);
    setMessage('');

    try {
      const token = localStorage.getItem('token');
      
      const response = await fetch('/api/user/change-password', {
        method: 'PUT',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          oldPassword,
          newPassword
        })
      });

      const result = await response.json();

      if (result.success) {
        setMessage('密码修改成功');
        setMessageType('success');
        return result;
      } else {
        setMessage(result.message);
        setMessageType('error');
        throw new Error(result.message);
      }
    } catch (error) {
      const errorMessage = error.message || '密码修改失败';
      setMessage(errorMessage);
      setMessageType('error');
      throw error;
    } finally {
      setLoading(false);
    }
  };

  return {
    changePassword,
    loading,
    message,
    messageType
  };
};
```

#### 2. 密码修改组件

```jsx
import React, { useState } from 'react';
import { useChangePassword } from './hooks/useChangePassword';

const ChangePasswordForm = () => {
  const [form, setForm] = useState({
    oldPassword: '',
    newPassword: '',
    confirmPassword: ''
  });
  
  const { changePassword, loading, message, messageType } = useChangePassword();

  const handleSubmit = async (e) => {
    e.preventDefault();
    
    // 验证密码确认
    if (form.newPassword !== form.confirmPassword) {
      alert('两次输入的密码不一致');
      return;
    }
    
    // 验证密码长度
    if (form.newPassword.length < 6 || form.newPassword.length > 20) {
      alert('密码长度必须在6-20位之间');
      return;
    }
    
    try {
      await changePassword(form.oldPassword, form.newPassword);
      // 清空表单
      setForm({
        oldPassword: '',
        newPassword: '',
        confirmPassword: ''
      });
    } catch (error) {
      // 错误已经在hook中处理
    }
  };

  const handleChange = (e) => {
    setForm({
      ...form,
      [e.target.name]: e.target.value
    });
  };

  return (
    <div className="change-password-form">
      <h3>修改密码</h3>
      <form onSubmit={handleSubmit}>
        <div className="form-group">
          <label htmlFor="oldPassword">旧密码:</label>
          <input
            id="oldPassword"
            name="oldPassword"
            type="password"
            value={form.oldPassword}
            onChange={handleChange}
            required
            minLength={6}
            maxLength={20}
            placeholder="请输入旧密码"
          />
        </div>
        
        <div className="form-group">
          <label htmlFor="newPassword">新密码:</label>
          <input
            id="newPassword"
            name="newPassword"
            type="password"
            value={form.newPassword}
            onChange={handleChange}
            required
            minLength={6}
            maxLength={20}
            placeholder="请输入新密码"
          />
        </div>
        
        <div className="form-group">
          <label htmlFor="confirmPassword">确认新密码:</label>
          <input
            id="confirmPassword"
            name="confirmPassword"
            type="password"
            value={form.confirmPassword}
            onChange={handleChange}
            required
            minLength={6}
            maxLength={20}
            placeholder="请再次输入新密码"
          />
        </div>
        
        <button type="submit" disabled={loading}>
          {loading ? '修改中...' : '修改密码'}
        </button>
        
        {message && (
          <div className={`message ${messageType}`}>
            {message}
          </div>
        )}
      </form>
    </div>
  );
};

export default ChangePasswordForm;
```

## 🔒 安全注意事项

### 1. 密码强度要求
- 密码长度：6-20位
- 建议包含字母和数字
- 避免使用过于简单的密码

### 2. 前端验证
- 在发送请求前进行客户端验证
- 确保两次输入的密码一致
- 验证密码长度和格式

### 3. 错误处理
- 妥善处理各种错误情况
- 向用户显示友好的错误信息
- 记录错误日志用于调试

### 4. 用户体验
- 提供清晰的加载状态
- 显示操作结果反馈
- 操作成功后清空表单

## 📝 测试用例

### 1. 用户修改密码测试

```javascript
// 测试用例1：正常修改密码
await changePassword('oldPassword123', 'newPassword456');
// 预期：成功

// 测试用例2：旧密码错误
await changePassword('wrongPassword', 'newPassword456');
// 预期：返回400错误，提示"旧密码不正确"

// 测试用例3：新密码长度不足
await changePassword('oldPassword123', '123');
// 预期：返回422错误，提示"密码长度至少6位"

// 测试用例4：新密码长度过长
await changePassword('oldPassword123', 'a'.repeat(21));
// 预期：返回422错误，提示"密码长度不能超过20位"
```

### 2. 管理员重置密码测试

```javascript
// 测试用例1：正常重置密码
await resetUserPassword('user-id-123', 'newPassword456');
// 预期：成功

// 测试用例2：用户不存在
await resetUserPassword('non-existent-user', 'newPassword456');
// 预期：返回404错误，提示"用户不存在"

// 测试用例3：权限不足
// 使用非管理员token
await resetUserPassword('user-id-123', 'newPassword456');
// 预期：返回403错误，提示"权限不足"
```

## 📞 技术支持

如果在对接过程中遇到问题，请检查：

1. **Token有效性**：确保JWT Token未过期且有效
2. **权限验证**：确保用户具有相应的操作权限
3. **参数格式**：确保请求参数格式正确
4. **网络连接**：确保网络连接正常
5. **服务器状态**：确保后端服务正常运行

---

**文档版本**: v1.0  
**最后更新**: 2025-09-06  
**维护人员**: 后端开发团队
