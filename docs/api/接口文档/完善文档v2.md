# 智慧物业管理系统 - 部门管理API文档 v3.0

## 📋 概述

本文档描述了智慧物业管理系统的部门管理功能API接口，包括部门管理、部门管理员权限控制、增强版报餐功能等。系统支持9个部门的独立管理，每个部门都有专门的管理员负责报餐。

## 🔐 认证说明

所有API接口都需要在请求头中携带JWT Token：

```http
Authorization: Bearer {your_jwt_token}
```

### 获取Token的方式

#### 1. 测试登录（开发环境）
```http
POST /api/auth/test-login-admin
Content-Type: application/json

{
  "phoneNumber": "13800001001",
  "password": "123456"
}
```

#### 2. 手机号登录（生产环境）
```http
POST /api/auth/phone-login
Content-Type: application/json

{
  "phoneNumber": "13800001001",
  "verificationCode": "123456"
}
```

## 🏢 部门管理接口

### 1. 获取部门列表

**接口地址**: `GET /api/department/list`

**接口描述**: 获取所有部门列表，包含部门管理员信息

**请求头**:
```http
Authorization: Bearer {token}
```

**查询参数**:
- `status` (可选): 部门状态，默认 `active`
- `includeManager` (可选): 是否包含管理员信息，默认 `true`

**响应示例**:
```json
{
  "success": true,
  "message": "获取部门列表成功",
  "data": [
    {
      "_id": "ab217f4f-d436-4b0e-98bf-62db1d9620a2",
      "name": "地质数据中心",
      "code": "GEO_DATA",
      "description": "负责地质数据的收集、整理、分析和应用",
      "level": 1,
      "status": "active",
      "createTime": "2025-09-01T16:33:23.000Z",
      "updateTime": "2025-09-01T16:34:07.000Z",
      "manager": {
        "_id": "c8b1cbc0-49aa-432a-bfed-b7792db4e4d0",
        "name": "地质数据中心管理员",
        "phone": "13800001001",
        "email": "zhangdata@example.com"
      }
    }
  ]
}
```

### 2. 获取当前用户部门信息

**接口地址**: `GET /api/department/my`

**接口描述**: 获取当前登录用户的部门信息

**请求头**:
```http
Authorization: Bearer {token}
```

**响应示例**:
```json
{
  "success": true,
  "message": "获取部门信息成功",
  "data": {
    "userId": "c8b1cbc0-49aa-432a-bfed-b7792db4e4d0",
    "departmentId": "ab217f4f-d436-4b0e-98bf-62db1d9620a2",
    "departmentName": "地质数据中心",
    "departmentCode": "GEO_DATA",
    "departmentDescription": "负责地质数据的收集、整理、分析和应用",
    "role": "dept_admin",
    "isDepartmentAdmin": true
  }
}
```

### 3. 获取部门详情

**接口地址**: `GET /api/department/{departmentId}`

**接口描述**: 获取指定部门的详细信息

**路径参数**:
- `departmentId`: 部门ID

**响应示例**:
```json
{
  "success": true,
  "message": "获取部门详情成功",
  "data": {
    "_id": "ab217f4f-d436-4b0e-98bf-62db1d9620a2",
    "name": "地质数据中心",
    "code": "GEO_DATA",
    "description": "负责地质数据的收集、整理、分析和应用",
    "level": 1,
    "status": "active",
    "createTime": "2025-09-01T16:33:23.000Z",
    "updateTime": "2025-09-01T16:34:07.000Z",
    "memberCount": 15,
    "manager": {
      "_id": "c8b1cbc0-49aa-432a-bfed-b7792db4e4d0",
      "name": "地质数据中心管理员",
      "phone": "13800001001",
      "email": "zhangdata@example.com",
      "position": "部门管理员"
    }
  }
}
```

### 4. 获取部门成员列表

**接口地址**: `GET /api/department/{departmentId}/members`

**接口描述**: 获取指定部门的成员列表（部门管理员只能查看本部门成员）

**路径参数**:
- `departmentId`: 部门ID

**查询参数**:
- `page` (可选): 页码，默认 1
- `pageSize` (可选): 每页数量，默认 20
- `status` (可选): 用户状态，默认 `active`
- `role` (可选): 用户角色
- `keyword` (可选): 搜索关键词

**响应示例**:
```json
{
  "success": true,
  "message": "获取部门成员成功",
  "data": {
    "list": [
      {
        "_id": "c8b1cbc0-49aa-432a-bfed-b7792db4e4d0",
        "nickName": "地质数据中心管理员",
        "realName": null,
        "avatarUrl": null,
        "phoneNumber": "13800001001",
        "email": "zhangdata@example.com",
        "position": "部门管理员",
        "employeeId": "EMP001",
        "role": "dept_admin",
        "status": "active",
        "joinDate": null,
        "createTime": "2025-09-01T16:34:07.000Z",
        "lastLoginTime": "2025-09-02T00:43:36.000Z"
      }
    ],
    "total": 1,
    "page": 1,
    "pageSize": 20,
    "totalPages": 1
  }
}
```

### 5. 获取部门管理员专用信息

**接口地址**: `GET /api/department/admin/my-info`

**接口描述**: 获取部门管理员的部门详细信息（仅部门管理员可访问）

**权限要求**: 部门管理员 (`dept_admin`)

**响应示例**:
```json
{
  "success": true,
  "message": "获取部门信息成功",
  "data": {
    "userId": "c8b1cbc0-49aa-432a-bfed-b7792db4e4d0",
    "departmentId": "ab217f4f-d436-4b0e-98bf-62db1d9620a2",
    "departmentName": "地质数据中心",
    "departmentCode": "GEO_DATA",
    "departmentDescription": "负责地质数据的收集、整理、分析和应用",
    "role": "dept_admin",
    "isDepartmentAdmin": true,
    "memberCount": 15,
    "members": [
      {
        "_id": "c8b1cbc0-49aa-432a-bfed-b7792db4e4d0",
        "nickName": "地质数据中心管理员",
        "role": "部门管理员",
        "avatarUrl": null,
        "employeeId": "EMP001",
        "position": "部门管理员",
        "phoneNumber": "13800001001",
        "email": "zhangdata@example.com",
        "status": "active",
        "joinDate": null,
        "createTime": "2025-09-01T16:34:07.000Z",
        "lastLoginTime": "2025-09-02T00:43:36.000Z"
      }
    ]
  }
}
```

## 🍽️ 增强版报餐接口

### 1. 获取部门成员列表（报餐用）

**接口地址**: `GET /api/dining/enhanced/dept-members`

**接口描述**: 获取当前用户所在部门的成员列表，用于报餐选择

**请求头**:
```http
Authorization: Bearer {token}
```

**查询参数**:
- `includeInactive` (可选): 是否包含非活跃用户，默认 `false`
- `keyword` (可选): 搜索关键词

**响应示例**:
```json
{
  "success": true,
  "message": "获取部门成员成功",
  "data": [
    {
      "_id": "c8b1cbc0-49aa-432a-bfed-b7792db4e4d0",
      "name": "地质数据中心管理员",
      "realName": null,
      "role": "部门管理员",
      "avatarUrl": null,
      "employeeId": "EMP001",
      "position": "部门管理员",
      "phoneNumber": "13800001001",
      "email": "zhangdata@example.com",
      "status": "active",
      "isDepartmentAdmin": true
    }
  ]
}
```

### 2. 部门报餐

**接口地址**: `POST /api/dining/enhanced/department-order`

**接口描述**: 部门管理员为部门成员报餐

**权限要求**: 部门管理员 (`dept_admin`)

**请求头**:
```http
Authorization: Bearer {token}
Content-Type: application/json
```

**请求参数**:
```json
{
  "date": "2025-09-02",
  "mealType": "lunch",
  "members": [
    {
      "userId": "c8b1cbc0-49aa-432a-bfed-b7792db4e4d0"
    },
    {
      "userId": "another-user-id"
    }
  ]
}
```

**参数说明**:
- `date`: 报餐日期，格式：YYYY-MM-DD
- `mealType`: 餐次类型，可选值：`breakfast`、`lunch`、`dinner`
- `members`: 报餐成员列表，每个成员包含 `userId`

**响应示例**:
```json
{
  "success": true,
  "message": "成功为 2 名部门成员报餐",
  "data": {
    "success": true,
    "message": "成功为 2 名部门成员报餐",
    "orders": [
      {
        "orderId": "order-uuid-1",
        "userId": "c8b1cbc0-49aa-432a-bfed-b7792db4e4d0",
        "userName": "地质数据中心管理员",
        "status": "confirmed"
      },
      {
        "orderId": "order-uuid-2",
        "userId": "another-user-id",
        "userName": "张三",
        "status": "confirmed"
      }
    ],
    "departmentName": "地质数据中心"
  }
}
```

### 3. 获取部门报餐记录

**接口地址**: `GET /api/dining/enhanced/department-orders`

**接口描述**: 获取部门报餐记录列表

**权限要求**: 部门管理员 (`dept_admin`)

**查询参数**:
- `page` (可选): 页码，默认 1
- `pageSize` (可选): 每页数量，默认 20
- `date` (可选): 指定日期，格式：YYYY-MM-DD
- `mealType` (可选): 餐次类型
- `startDate` (可选): 开始日期
- `endDate` (可选): 结束日期

**响应示例**:
```json
{
  "success": true,
  "message": "获取部门报餐记录成功",
  "data": {
    "list": [
      {
        "_id": "order-uuid-1",
        "userId": "c8b1cbc0-49aa-432a-bfed-b7792db4e4d0",
        "userName": "地质数据中心管理员",
        "realName": null,
        "employeeId": "EMP001",
        "position": "部门管理员",
        "publishDate": "2025-09-02",
        "mealType": "lunch",
        "menuName": "2025-09-02 午餐菜单",
        "orderTime": "2025-09-02T08:30:00.000Z",
        "status": "confirmed",
        "orderBy": "c8b1cbc0-49aa-432a-bfed-b7792db4e4d0"
      }
    ],
    "total": 1,
    "page": 1,
    "pageSize": 20,
    "totalPages": 1,
    "departmentName": "地质数据中心"
  }
}
```

### 4. 获取部门报餐统计

**接口地址**: `GET /api/dining/enhanced/department-stats`

**接口描述**: 获取部门报餐统计数据

**权限要求**: 部门管理员 (`dept_admin`)

**查询参数**:
- `startDate` (可选): 开始日期，格式：YYYY-MM-DD
- `endDate` (可选): 结束日期，格式：YYYY-MM-DD

**响应示例**:
```json
{
  "success": true,
  "message": "获取部门报餐统计成功",
  "data": {
    "departmentName": "地质数据中心",
    "totalMembers": 15,
    "totalOrders": 45,
    "uniqueUsers": 12,
    "orderDays": 5,
    "mealTypeStats": {
      "breakfast": 15,
      "lunch": 20,
      "dinner": 10
    },
    "participationRate": 80
  }
}
```

### 5. 获取部门报餐概览

**接口地址**: `GET /api/dining/enhanced/department-overview`

**接口描述**: 获取部门报餐概览，包含今日报餐情况和成员状态

**权限要求**: 部门管理员 (`dept_admin`)

**响应示例**:
```json
{
  "success": true,
  "message": "获取部门报餐概览成功",
  "data": {
    "date": "2025-09-02",
    "departmentName": "地质数据中心",
    "totalMembers": 15,
    "todayStats": {
      "totalOrders": 8,
      "uniqueUsers": 8,
      "participationRate": 53,
      "mealTypeStats": {
        "breakfast": 3,
        "lunch": 5,
        "dinner": 0
      }
    },
    "members": [
      {
        "_id": "c8b1cbc0-49aa-432a-bfed-b7792db4e4d0",
        "name": "地质数据中心管理员",
        "realName": null,
        "role": "部门管理员",
        "avatarUrl": null,
        "employeeId": "EMP001",
        "position": "部门管理员",
        "phoneNumber": "13800001001",
        "email": "zhangdata@example.com",
        "status": "active",
        "isDepartmentAdmin": true,
        "hasOrdered": true,
        "orderInfo": {
          "mealType": "lunch",
          "orderTime": "2025-09-02T08:30:00.000Z",
          "status": "confirmed"
        }
      }
    ]
  }
}
```

## 🔒 权限说明

### 角色权限等级

| 角色 | 权限等级 | 功能描述 |
|------|----------|----------|
| `user` | 1 | 普通用户，可进行报餐、预约等基础操作 |
| `dept_admin` | 2 | 部门管理员，可管理本部门用户和查看统计数据 |
| `admin` | 3 | 管理员，可进行系统管理和用户管理 |
| `sys_admin` | 4 | 系统管理员，拥有所有权限，包括角色管理 |
| `verifier` | 1 | 验证员，专门用于用餐验证等操作 |

### 部门管理员权限

部门管理员 (`dept_admin`) 具有以下权限：

1. **部门管理权限**：
   - 查看本部门信息
   - 查看本部门成员列表
   - 获取本部门统计数据

2. **报餐管理权限**：
   - 为本部门成员报餐
   - 查看本部门报餐记录
   - 获取本部门报餐统计
   - 查看本部门报餐概览

3. **权限限制**：
   - 只能管理本部门，无法跨部门操作
   - 无法访问其他部门的成员信息
   - 无法为其他部门成员报餐

## 📊 部门信息

### 支持的部门列表

| 部门名称 | 部门编码 | 管理员手机号 | 描述 |
|----------|----------|--------------|------|
| 地质数据中心 | GEO_DATA | 13800001001 | 负责地质数据的收集、整理、分析和应用 |
| 地质工程中心 | GEO_ENG | 13800001002 | 负责地质工程项目的规划、设计和实施 |
| 生态环境中心 | ECO_ENV | 13800001003 | 负责生态环境监测、评估和保护工作 |
| 地质环境中心 | GEO_ENV | 13800001004 | 负责地质环境调查、评价和治理 |
| 地质调查中心 | GEO_SURVEY | 13800001005 | 负责地质调查、勘探和资源评价 |
| 黄梅分站 | HUANGMEI | 13800001006 | 黄梅地区分站，负责区域地质工作 |
| 矿业有限责任公司 | MINING_CO | 13800001007 | 负责矿业开发、生产和经营管理 |
| 物业中心 | PROPERTY | 13800001008 | 负责物业管理、维护和服务工作 |
| 机关科室 | ADMIN | 13800001009 | 负责行政管理、人事财务等机关工作 |

## ⚠️ 错误处理

### 常见错误码

| 错误码 | 说明 | 解决方案 |
|--------|------|----------|
| 401 | 未授权 | 检查Token是否有效，重新登录 |
| 403 | 权限不足 | 确认用户角色是否有相应权限 |
| 404 | 资源不存在 | 检查请求的资源ID是否正确 |
| 422 | 参数验证失败 | 检查请求参数格式和必填项 |
| 500 | 服务器内部错误 | 联系技术支持 |

### 错误响应格式

```json
{
  "success": false,
  "message": "错误描述",
  "code": "错误码",
  "error": "详细错误信息",
  "timestamp": "2025-09-02T00:43:36.492Z"
}
```

## 🚀 前端集成示例

### 1. 登录获取Token

```javascript
// 登录获取Token
async function login(phoneNumber, password) {
  try {
    const response = await fetch('/api/auth/test-login-admin', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        phoneNumber,
        password
      })
    });
    
    const result = await response.json();
    
    if (result.success) {
      const token = result.data.token;
      localStorage.setItem('token', token);
      return result.data.userInfo;
    } else {
      throw new Error(result.message);
    }
  } catch (error) {
    console.error('登录失败:', error);
    throw error;
  }
}
```

### 2. 获取部门列表

```javascript
// 获取部门列表
async function getDepartments() {
  try {
    const token = localStorage.getItem('token');
    const response = await fetch('/api/department/list', {
      headers: {
        'Authorization': `Bearer ${token}`
      }
    });
    
    const result = await response.json();
    
    if (result.success) {
      return result.data;
    } else {
      throw new Error(result.message);
    }
  } catch (error) {
    console.error('获取部门列表失败:', error);
    throw error;
  }
}
```

### 3. 部门报餐

```javascript
// 部门报餐
async function createDepartmentOrder(date, mealType, memberIds) {
  try {
    const token = localStorage.getItem('token');
    const response = await fetch('/api/dining/enhanced/department-order', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        date,
        mealType,
        members: memberIds.map(id => ({ userId: id }))
      })
    });
    
    const result = await response.json();
    
    if (result.success) {
      return result.data;
    } else {
      throw new Error(result.message);
    }
  } catch (error) {
    console.error('部门报餐失败:', error);
    throw error;
  }
}
```

### 4. 获取部门报餐概览

```javascript
// 获取部门报餐概览
async function getDepartmentOverview() {
  try {
    const token = localStorage.getItem('token');
    const response = await fetch('/api/dining/enhanced/department-overview', {
      headers: {
        'Authorization': `Bearer ${token}`
      }
    });
    
    const result = await response.json();
    
    if (result.success) {
      return result.data;
    } else {
      throw new Error(result.message);
    }
  } catch (error) {
    console.error('获取部门报餐概览失败:', error);
    throw error;
  }
}
```

## 📝 注意事项

1. **Token管理**：Token有效期为7天，过期后需要重新登录
2. **权限验证**：所有接口都会验证用户权限，确保数据安全
3. **参数验证**：请求参数会进行严格验证，请确保格式正确
4. **错误处理**：建议前端实现统一的错误处理机制
5. **分页查询**：列表接口支持分页，建议合理设置pageSize
6. **日期格式**：所有日期参数使用YYYY-MM-DD格式
7. **时区处理**：服务器使用UTC+8时区，前端显示时请注意时区转换

## 🔄 更新日志

### v3.0 (2025-09-02)
- 新增部门管理功能
- 新增部门管理员权限控制
- 新增增强版报餐功能
- 支持9个部门的独立管理
- 完善权限隔离机制

---

**技术支持**: 如有问题请联系开发团队
**文档版本**: v3.0
**最后更新**: 2025-09-02
