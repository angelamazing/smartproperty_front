# 报餐接口文档

## 📋 接口概述

报餐接口提供菜单查询、部门报餐、记录管理、订单确认等报餐相关功能。

**基础路径**: `/api/dining`

**认证要求**: 所有接口都需要有效的JWT Token

## 🔐 接口列表

### 1. 获取菜单信息

**接口地址**: `GET /api/dining/menu`

**接口描述**: 获取指定日期的菜单信息

**请求头**:
```http
Authorization: Bearer {token}
```

**查询参数**:
```
date: string      // 日期，格式：YYYY-MM-DD，默认今日
mealType: string  // 餐次类型：breakfast/lunch/dinner（可选）
```

**响应示例**:
```json
{
  "success": true,
  "message": "获取菜单成功",
  "data": {
    "date": "2024-01-15",
    "menus": [
      {
        "_id": "menu_id_1",
        "mealType": "lunch",
        "mealTime": "11:30-13:00",
        "publishDate": "2024-01-15",
        "dishes": [
          {
            "_id": "dish_id_1",
            "name": "宫保鸡丁",
            "price": 15.0,
            "category": "荤菜",
            "image": "https://example.com/dish1.jpg"
          },
          {
            "_id": "dish_id_2",
            "name": "麻婆豆腐",
            "price": 12.0,
            "category": "素菜",
            "image": "https://example.com/dish2.jpg"
          }
        ],
        "capacity": 300,
        "currentOrders": 245,
        "publishStatus": "published",
        "nutritionInfo": {
          "calories": 850,
          "protein": 45.2,
          "fat": 28.5,
          "carbohydrate": 65.8
        }
      }
    ]
  }
}
```

**无菜单时的响应**:
```json
{
  "success": true,
  "message": "获取菜单成功",
  "data": {
    "date": "2024-01-15",
    "menus": []
  }
}
```

---

### 2. 获取部门成员

**接口地址**: `GET /api/dining/dept-members`

**接口描述**: 获取当前用户所在部门的成员列表

**请求头**:
```http
Authorization: Bearer {token}
```

**响应示例**:
```json
{
  "success": true,
  "message": "获取部门成员成功",
  "data": [
    {
      "_id": "user_id_1",
      "nickName": "张三",
      "realName": "张三",
      "avatarUrl": "https://example.com/avatar1.jpg",
      "employeeId": "EMP001",
      "position": "软件工程师"
    },
    {
      "_id": "user_id_2",
      "nickName": "李四",
      "realName": "李四",
      "avatarUrl": "https://example.com/avatar2.jpg",
      "employeeId": "EMP002",
      "position": "产品经理"
    }
  ]
}
```

---

### 3. 提交部门报餐

**接口地址**: `POST /api/dining/dept-order`

**接口描述**: 提交部门报餐订单

**请求头**:
```http
Authorization: Bearer {token}
Content-Type: application/json
```

**请求参数**:
```json
{
  "menuId": "string",           // 菜单ID
  "diningDate": "2024-01-15",  // 用餐日期
  "mealType": "lunch",         // 餐次类型
  "memberIds": ["user_id_1", "user_id_2"],  // 报餐成员ID数组
  "memberNames": ["张三", "李四"],           // 报餐成员姓名数组
  "memberCount": 2,             // 报餐人数
  "totalAmount": 54.0,         // 总金额
  "remark": "部门聚餐"          // 备注（可选）
}
```

**响应示例**:
```json
{
  "success": true,
  "message": "报餐订单提交成功",
  "data": {
    "orderId": "order_id_123",
    "diningDate": "2024-01-15",
    "mealType": "lunch",
    "memberCount": 2,
    "totalAmount": 54.0,
    "status": "pending",
    "createTime": "2024-01-15T10:30:00.000Z"
  }
}
```

**错误响应**:
```json
{
  "success": false,
  "message": "报餐失败",
  "error": "菜单容量已满"
}
```

---

### 4. 获取报餐记录

**接口地址**: `GET /api/dining/records`

**接口描述**: 获取用户的报餐记录

**请求头**:
```http
Authorization: Bearer {token}
```

**查询参数**:
```
page: number          // 页码，默认1
size: number          // 每页数量，默认20，最大100
startDate: string     // 开始日期，格式：YYYY-MM-DD（可选）
endDate: string       // 结束日期，格式：YYYY-MM-DD（可选）
mealType: string      // 餐次类型筛选（可选）
status: string        // 状态筛选（可选）
```

**响应示例**:
```json
{
  "success": true,
  "message": "获取报餐记录成功",
  "data": {
    "list": [
      {
        "_id": "order_id_1",
        "menuId": "menu_id_1",
        "diningDate": "2024-01-15",
        "mealType": "lunch",
        "mealTime": "11:30-13:00",
        "memberCount": 2,
        "totalAmount": 54.0,
        "status": "confirmed",
        "createTime": "2024-01-15T10:30:00.000Z",
        "confirmTime": "2024-01-15T11:00:00.000Z",
        "confirmedBy": "admin_id",
        "menu": {
          "dishes": [
            {
              "name": "宫保鸡丁",
              "price": 15.0
            },
            {
              "name": "麻婆豆腐",
              "price": 12.0
            }
          ]
        }
      }
    ],
    "pagination": {
      "page": 1,
      "size": 20,
      "total": 25,
      "totalPages": 2
    }
  }
}
```

---

### 5. 获取报餐记录详情

**接口地址**: `GET /api/dining/records/:recordId/detail`

**接口描述**: 获取指定报餐记录的详细信息

**请求头**:
```http
Authorization: Bearer {token}
```

**路径参数**:
```
recordId: string  // 报餐记录ID
```

**响应示例**:
```json
{
  "success": true,
  "message": "获取报餐记录详情成功",
  "data": {
    "_id": "order_id_1",
    "menuId": "menu_id_1",
    "registrantId": "user_id_1",
    "registrantName": "张三",
    "diningDate": "2024-01-15",
    "mealType": "lunch",
    "mealTime": "11:30-13:00",
    "memberIds": ["user_id_1", "user_id_2"],
    "memberNames": ["张三", "李四"],
    "memberCount": 2,
    "totalAmount": 54.0,
    "status": "confirmed",
    "remark": "部门聚餐",
    "createTime": "2024-01-15T10:30:00.000Z",
    "confirmTime": "2024-01-15T11:00:00.000Z",
    "confirmedBy": "admin_id",
    "menu": {
      "dishes": [
        {
          "name": "宫保鸡丁",
          "price": 15.0,
          "category": "荤菜"
        },
        {
          "name": "麻婆豆腐",
          "price": 12.0,
          "category": "素菜"
        }
      ],
      "nutritionInfo": {
        "calories": 850,
        "protein": 45.2,
        "fat": 28.5,
        "carbohydrate": 65.8
      }
    },
    "deptInfo": {
      "deptId": "dept_id_1",
      "deptName": "技术部"
    }
  }
}
```

---

### 6. 取消报餐订单

**接口地址**: `PUT /api/dining/orders/:orderId/cancel`

**接口描述**: 取消指定的报餐订单

**请求头**:
```http
Authorization: Bearer {token}
Content-Type: application/json
```

**路径参数**:
```
orderId: string  // 订单ID
```

**请求参数**:
```json
{
  "reason": "string"  // 取消原因（可选）
}
```

**响应示例**:
```json
{
  "success": true,
  "message": "订单取消成功",
  "data": {
    "orderId": "order_id_1",
    "oldStatus": "confirmed",
    "newStatus": "cancelled",
    "cancelTime": "2024-01-15T14:30:00.000Z",
    "cancelReason": "临时有事"
  }
}
```

---

## 👥 管理员功能接口

### 7. 获取报餐统计（管理员功能）

**接口地址**: `GET /api/dining/stats`

**接口描述**: 获取今日报餐统计数据（需要部门管理员权限）

**请求头**:
```http
Authorization: Bearer {token}
```

**响应示例**:
```json
{
  "success": true,
  "message": "获取报餐统计成功",
  "data": {
    "today": {
      "totalOrders": 156,
      "confirmedOrders": 145,
      "pendingOrders": 11,
      "cancelledOrders": 0,
      "totalAmount": 2340.5
    },
    "byMealType": {
      "breakfast": {
        "orders": 45,
        "amount": 180.0
      },
      "lunch": {
        "orders": 78,
        "amount": 1170.0
      },
      "dinner": {
        "orders": 33,
        "amount": 990.5
      }
    },
    "byDepartment": [
      {
        "deptName": "技术部",
        "orders": 89,
        "amount": 1335.0
      },
      {
        "deptName": "人事部",
        "orders": 45,
        "amount": 675.0
      },
      {
        "deptName": "财务部",
        "orders": 22,
        "amount": 330.5
      }
    ]
  }
}
```

---

### 8. 确认报餐订单（管理员功能）

**接口地址**: `PUT /api/dining/orders/:orderId/confirm`

**接口描述**: 确认指定的报餐订单（需要部门管理员权限）

**请求头**:
```http
Authorization: Bearer {token}
Content-Type: application/json
```

**路径参数**:
```
orderId: string  // 订单ID
```

**请求参数**:
```json
{
  "remark": "string"  // 确认备注（可选）
}
```

**响应示例**:
```json
{
  "success": true,
  "message": "订单确认成功",
  "data": {
    "orderId": "order_id_1",
    "oldStatus": "pending",
    "newStatus": "confirmed",
    "confirmTime": "2024-01-15T11:00:00.000Z",
    "confirmedBy": "admin_id",
    "remark": "已确认"
  }
}
```

---

### 9. 批量确认报餐订单（管理员功能）

**接口地址**: `PUT /api/dining/orders/batch/confirm`

**接口描述**: 批量确认多个报餐订单（需要部门管理员权限）

**请求头**:
```http
Authorization: Bearer {token}
Content-Type: application/json
```

**请求参数**:
```json
{
  "orderIds": ["order_id_1", "order_id_2", "order_id_3"]  // 订单ID数组
}
```

**响应示例**:
```json
{
  "success": true,
  "message": "批量确认成功",
  "data": {
    "confirmedCount": 3,
    "failedCount": 0,
    "failedOrderIds": [],
    "confirmTime": "2024-01-15T11:00:00.000Z",
    "confirmedBy": "admin_id"
  }
}
```

---

## 📊 数据结构说明

### 餐次类型 (mealType)

| 值 | 说明 | 时间范围 |
|----|------|----------|
| `breakfast` | 早餐 | 07:00-09:00 |
| `lunch` | 午餐 | 11:30-13:00 |
| `dinner` | 晚餐 | 17:30-19:00 |

### 订单状态 (status)

| 值 | 说明 | 描述 |
|----|------|------|
| `pending` | 待确认 | 报餐订单已提交，等待管理员确认 |
| `confirmed` | 已确认 | 报餐订单已确认，可以正常用餐 |
| `completed` | 已完成 | 用餐完成，订单结束 |
| `cancelled` | 已取消 | 报餐订单已取消 |

### 菜品分类 (category)

| 值 | 说明 | 描述 |
|----|------|------|
| `荤菜` | 荤菜 | 肉类菜品 |
| `素菜` | 素菜 | 蔬菜类菜品 |
| `主食` | 主食 | 米饭、面条等 |
| `汤类` | 汤类 | 各种汤品 |
| `饮品` | 饮品 | 饮料、茶水等 |

## 📱 前端集成示例

### JavaScript示例

```javascript
// 获取菜单信息
async function getMenu(date = null, mealType = null) {
  try {
    const token = localStorage.getItem('token');
    const params = new URLSearchParams();
    
    if (date) params.append('date', date);
    if (mealType) params.append('mealType', mealType);
    
    const response = await fetch(`/api/dining/menu?${params.toString()}`, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`
      }
    });
    
    const result = await response.json();
    
    if (result.success) {
      return result.data;
    } else {
      throw new Error(result.message);
    }
  } catch (error) {
    console.error('获取菜单失败:', error);
    throw error;
  }
}

// 提交部门报餐
async function submitDeptOrder(orderData) {
  try {
    const token = localStorage.getItem('token');
    const response = await fetch('/api/dining/dept-order', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(orderData)
    });
    
    const result = await response.json();
    
    if (result.success) {
      return result.data;
    } else {
      throw new Error(result.message);
    }
  } catch (error) {
    console.error('提交报餐失败:', error);
    throw error;
  }
}

// 获取报餐记录
async function getDiningRecords(params = {}) {
  try {
    const token = localStorage.getItem('token');
    const queryString = new URLSearchParams(params).toString();
    
    const response = await fetch(`/api/dining/records?${queryString}`, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`
      }
    });
    
    const result = await response.json();
    
    if (result.success) {
      return result.data;
    } else {
      throw new Error(result.message);
    }
  } catch (error) {
    console.error('获取报餐记录失败:', error);
    throw error;
  }
}

// 取消报餐订单
async function cancelDiningOrder(orderId, reason = '') {
  try {
    const token = localStorage.getItem('token');
    const response = await fetch(`/api/dining/orders/${orderId}/cancel`, {
      method: 'PUT',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ reason })
    });
    
    const result = await response.json();
    
    if (result.success) {
      return result.data;
    } else {
      throw new Error(result.message);
    }
  } catch (error) {
    console.error('取消订单失败:', error);
    throw error;
  }
}
```

### 微信小程序示例

```javascript
// 获取菜单信息
async function getMenu(date = null, mealType = null) {
  try {
    const token = wx.getStorageSync('token');
    const params = {};
    
    if (date) params.date = date;
    if (mealType) params.mealType = mealType;
    
    const response = await wx.request({
      url: 'https://api.example.com/api/dining/menu',
      method: 'GET',
      header: {
        'Authorization': `Bearer ${token}`
      },
      data: params
    });
    
    const result = response.data;
    
    if (result.success) {
      return result.data;
    } else {
      throw new Error(result.message);
    }
  } catch (error) {
    console.error('获取菜单失败:', error);
    throw error;
  }
}

// 提交部门报餐
async function submitDeptOrder(orderData) {
  try {
    const token = wx.getStorageSync('token');
    const response = await wx.request({
      url: 'https://api.example.com/api/dining/dept-order',
      method: 'POST',
      header: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      data: orderData
    });
    
    const result = response.data;
    
    if (result.success) {
      return result.data;
    } else {
      throw new Error(result.message);
    }
  } catch (error) {
    console.error('提交报餐失败:', error);
    throw error;
  }
}
```

### React组件示例

```jsx
import React, { useState, useEffect } from 'react';

// 菜单选择组件
function MenuSelection() {
  const [menu, setMenu] = useState(null);
  const [selectedDishes, setSelectedDishes] = useState([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    fetchMenu();
  }, []);

  const fetchMenu = async () => {
    try {
      setLoading(true);
      const data = await getMenu();
      setMenu(data);
    } catch (error) {
      console.error('获取菜单失败:', error);
    } finally {
      setLoading(false);
    }
  };

  const handleDishSelect = (dish) => {
    setSelectedDishes(prev => {
      const existing = prev.find(d => d._id === dish._id);
      if (existing) {
        return prev.filter(d => d._id !== dish._id);
      } else {
        return [...prev, dish];
      }
    });
  };

  const calculateTotal = () => {
    return selectedDishes.reduce((sum, dish) => sum + dish.price, 0);
  };

  if (loading) return <div>加载中...</div>;
  if (!menu || menu.menus.length === 0) return <div>今日暂无菜单</div>;

  return (
    <div className="menu-selection">
      <h3>今日菜单</h3>
      {menu.menus.map((meal) => (
        <div key={meal._id} className="meal-section">
          <h4>{getMealTypeName(meal.mealType)} - {meal.mealTime}</h4>
          <div className="dishes-grid">
            {meal.dishes.map((dish) => (
              <div 
                key={dish._id} 
                className={`dish-item ${selectedDishes.find(d => d._id === dish._id) ? 'selected' : ''}`}
                onClick={() => handleDishSelect(dish)}
              >
                <img src={dish.image} alt={dish.name} />
                <h5>{dish.name}</h5>
                <p className="price">¥{dish.price}</p>
                <p className="category">{dish.category}</p>
              </div>
            ))}
          </div>
        </div>
      ))}
      
      {selectedDishes.length > 0 && (
        <div className="selection-summary">
          <h4>已选择 ({selectedDishes.length} 道菜)</h4>
          <div className="selected-dishes">
            {selectedDishes.map((dish) => (
              <span key={dish._id} className="selected-dish">
                {dish.name} ¥{dish.price}
              </span>
            ))}
          </div>
          <div className="total-amount">
            总计: ¥{calculateTotal()}
          </div>
        </div>
      )}
    </div>
  );
}

// 获取餐次名称
function getMealTypeName(mealType) {
  const mealTypeNames = {
    'breakfast': '早餐',
    'lunch': '午餐',
    'dinner': '晚餐'
  };
  return mealTypeNames[mealType] || mealType;
}
```

## 🔄 业务流程说明

### 报餐流程

1. **查看菜单**: 用户查看当日发布的菜单
2. **选择菜品**: 用户选择想要报餐的菜品
3. **提交订单**: 用户提交报餐订单，状态为 `pending`
4. **管理员确认**: 管理员确认订单，状态变为 `confirmed`
5. **用餐**: 用户按时间到餐厅用餐
6. **完成**: 用餐完成后，订单状态变为 `completed`

### 取消流程

1. **申请取消**: 用户在用餐前申请取消订单
2. **管理员审核**: 管理员审核取消申请
3. **订单取消**: 订单状态变为 `cancelled`

## ⚠️ 注意事项

1. **权限控制**: 管理员功能需要部门管理员权限，前端需要根据用户角色控制显示
2. **时间限制**: 报餐需要在用餐时间前完成，取消也需要提前申请
3. **容量控制**: 菜单有容量限制，达到容量后无法继续报餐
4. **状态管理**: 订单状态变更会记录操作日志，便于审计
5. **数据验证**: 所有输入数据都会进行验证，前端也需要进行相应的验证
6. **错误处理**: 接口返回详细的错误信息，前端需要妥善处理各种错误情况
7. **实时更新**: 菜单容量和订单状态会实时更新，建议定期刷新数据
