# 系统接口文档

## 📋 接口概述

系统接口提供统计数据、菜单信息、系统公告、最近活动等系统级功能。

**基础路径**: `/api/system`

**认证要求**: 所有接口都需要有效的JWT Token

## 🔐 接口列表

### 1. 获取今日统计

**接口地址**: `GET /api/system/today-stats`

**接口描述**: 获取今日系统的统计数据

**请求头**:
```http
Authorization: Bearer {token}
```

**响应示例**:
```json
{
  "success": true,
  "message": "获取今日统计成功",
  "data": {
    "diningCount": 156,        // 今日报餐次数
    "reservationCount": 23,    // 今日预约次数
    "verificationCount": 89,   // 今日验证次数
    "menuCount": 3,            // 今日菜单数量
    "date": "2024-01-15"      // 统计日期
  }
}
```

**错误响应**:
```json
{
  "success": false,
  "message": "获取今日统计失败",
  "error": "数据库连接失败"
}
```

---

### 2. 获取今日菜单

**接口地址**: `GET /api/system/today-menu`

**接口描述**: 获取今日发布的菜单信息

**请求头**:
```http
Authorization: Bearer {token}
```

**响应示例**:
```json
{
  "success": true,
  "message": "获取今日菜单成功",
  "data": {
    "message": "今日菜单",
    "menus": [
      {
        "_id": "menu_id_1",
        "mealType": "breakfast",
        "mealTime": "07:00-09:00",
        "publishDate": "2024-01-15",
        "dishes": [
          {
            "name": "包子",
            "price": 2.5
          },
          {
            "name": "豆浆",
            "price": 3.0
          },
          {
            "name": "油条",
            "price": 1.5
          }
        ],
        "capacity": 200,
        "currentOrders": 156,
        "publishStatus": "published"
      },
      {
        "_id": "menu_id_2",
        "mealType": "lunch",
        "mealTime": "11:30-13:00",
        "publishDate": "2024-01-15",
        "dishes": [
          {
            "name": "宫保鸡丁",
            "price": 15.0
          },
          {
            "name": "麻婆豆腐",
            "price": 12.0
          },
          {
            "name": "青菜汤",
            "price": 8.0
          }
        ],
        "capacity": 300,
        "currentOrders": 245,
        "publishStatus": "published"
      },
      {
        "_id": "menu_id_3",
        "mealType": "dinner",
        "mealTime": "17:30-19:00",
        "publishDate": "2024-01-15",
        "dishes": [
          {
            "name": "红烧肉",
            "price": 18.0
          },
          {
            "name": "清蒸鱼",
            "price": 22.0
          },
          {
            "name": "蒜蓉青菜",
            "price": 10.0
          }
        ],
        "capacity": 250,
        "currentOrders": 189,
        "publishStatus": "published"
      }
    ]
  }
}
```

**无菜单时的响应**:
```json
{
  "success": true,
  "message": "获取今日菜单成功",
  "data": {
    "message": "今日暂无菜单",
    "menus": []
  }
}
```

---

### 3. 获取最近活动

**接口地址**: `GET /api/system/recent-activities`

**接口描述**: 获取系统最近的报餐和预约活动（需要部门管理员权限）

**请求头**:
```http
Authorization: Bearer {token}
```

**查询参数**:
```
limit: number  // 返回活动数量，默认10，最大50
```

**响应示例**:
```json
{
  "success": true,
  "message": "获取最近活动成功",
  "data": [
    {
      "type": "dining",
      "date": "2024-01-15",
      "mealType": "lunch",
      "userName": "张三",
      "status": "confirmed",
      "action": "报餐"
    },
    {
      "type": "reservation",
      "date": "2024-01-15",
      "venueName": "会议室A",
      "userName": "李四",
      "status": "approved",
      "action": "场地预约"
    },
    {
      "type": "dining",
      "date": "2024-01-14",
      "mealType": "dinner",
      "userName": "王五",
      "status": "completed",
      "action": "报餐"
    }
  ]
}
```

**权限不足时的响应**:
```json
{
  "success": false,
  "message": "权限不足",
  "error": "需要部门管理员权限"
}
```

---

### 4. 获取系统公告

**接口地址**: `GET /api/system/notice`

**接口描述**: 获取最新的系统公告信息

**请求头**:
```http
Authorization: Bearer {token}
```

**响应示例**:
```json
{
  "success": true,
  "message": "获取系统公告成功",
  "data": {
    "content": "系统将于今晚22:00-24:00进行维护升级，期间可能影响部分功能使用，请提前做好准备。",
    "time": "2024-01-15T10:00:00.000Z",
    "type": "warning",
    "title": "系统维护通知"
  }
}
```

**无公告时的响应**:
```json
{
  "success": true,
  "message": "获取系统公告成功",
  "data": {
    "content": "系统运行正常，暂无重要公告",
    "time": "2024-01-15T15:30:00.000Z",
    "type": "info",
    "title": "系统公告"
  }
}
```

---

## 📊 数据结构说明

### 餐次类型 (mealType)

| 值 | 说明 | 时间范围 |
|----|------|----------|
| `breakfast` | 早餐 | 07:00-09:00 |
| `lunch` | 午餐 | 11:30-13:00 |
| `dinner` | 晚餐 | 17:30-19:00 |

### 活动类型 (type)

| 值 | 说明 | 描述 |
|----|------|------|
| `dining` | 报餐活动 | 用户的报餐记录 |
| `reservation` | 预约活动 | 用户的场地预约记录 |

### 报餐状态 (status)

| 值 | 说明 | 描述 |
|----|------|------|
| `pending` | 待确认 | 报餐订单已提交，等待管理员确认 |
| `confirmed` | 已确认 | 报餐订单已确认，可以正常用餐 |
| `completed` | 已完成 | 用餐完成，订单结束 |
| `cancelled` | 已取消 | 报餐订单已取消 |

### 预约状态 (status)

| 值 | 说明 | 描述 |
|----|------|------|
| `pending` | 待审核 | 预约申请已提交，等待审核 |
| `approved` | 已批准 | 预约申请已批准 |
| `rejected` | 已拒绝 | 预约申请被拒绝 |
| `completed` | 已完成 | 预约时间已过，预约完成 |
| `cancelled` | 已取消 | 预约被取消 |

### 公告类型 (type)

| 值 | 说明 | 样式建议 |
|----|------|----------|
| `info` | 信息 | 蓝色，普通信息 |
| `warning` | 警告 | 橙色，重要提醒 |
| `error` | 错误 | 红色，紧急通知 |
| `success` | 成功 | 绿色，成功消息 |

## 📱 前端集成示例

### JavaScript示例

```javascript
// 获取今日统计
async function getTodayStats() {
  try {
    const token = localStorage.getItem('token');
    const response = await fetch('/api/system/today-stats', {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`
      }
    });
    
    const result = await response.json();
    
    if (result.success) {
      return result.data;
    } else {
      throw new Error(result.message);
    }
  } catch (error) {
    console.error('获取今日统计失败:', error);
    throw error;
  }
}

// 获取今日菜单
async function getTodayMenu() {
  try {
    const token = localStorage.getItem('token');
    const response = await fetch('/api/system/today-menu', {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`
      }
    });
    
    const result = await response.json();
    
    if (result.success) {
      return result.data;
    } else {
      throw new Error(result.message);
    }
  } catch (error) {
    console.error('获取今日菜单失败:', error);
    throw error;
  }
}

// 获取最近活动
async function getRecentActivities(limit = 10) {
  try {
    const token = localStorage.getItem('token');
    const response = await fetch(`/api/system/recent-activities?limit=${limit}`, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`
      }
    });
    
    const result = await response.json();
    
    if (result.success) {
      return result.data;
    } else {
      throw new Error(result.message);
    }
  } catch (error) {
    console.error('获取最近活动失败:', error);
    throw error;
  }
}

// 获取系统公告
async function getSystemNotice() {
  try {
    const token = localStorage.getItem('token');
    const response = await fetch('/api/system/notice', {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`
      }
    });
    
    const result = await response.json();
    
    if (result.success) {
      return result.data;
    } else {
      throw new Error(result.message);
    }
  } catch (error) {
    console.error('获取系统公告失败:', error);
    throw error;
  }
}
```

### 微信小程序示例

```javascript
// 获取今日统计
async function getTodayStats() {
  try {
    const token = wx.getStorageSync('token');
    const response = await wx.request({
      url: 'https://api.example.com/api/system/today-stats',
      method: 'GET',
      header: {
        'Authorization': `Bearer ${token}`
      }
    });
    
    const result = response.data;
    
    if (result.success) {
      return result.data;
    } else {
      throw new Error(result.message);
    }
  } catch (error) {
    console.error('获取今日统计失败:', error);
    throw error;
  }
}

// 获取今日菜单
async function getTodayMenu() {
  try {
    const token = wx.getStorageSync('token');
    const response = await wx.request({
      url: 'https://api.example.com/api/system/today-menu',
      method: 'GET',
      header: {
        'Authorization': `Bearer ${token}`
      }
    });
    
    const result = response.data;
    
    if (result.success) {
      return result.data;
    } else {
      throw new Error(result.message);
    }
  } catch (error) {
    console.error('获取今日菜单失败:', error);
    throw error;
  }
}
```

### React组件示例

```jsx
import React, { useState, useEffect } from 'react';

// 今日统计组件
function TodayStats() {
  const [stats, setStats] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  useEffect(() => {
    fetchTodayStats();
  }, []);

  const fetchTodayStats = async () => {
    try {
      setLoading(true);
      const data = await getTodayStats();
      setStats(data);
    } catch (error) {
      setError(error.message);
    } finally {
      setLoading(false);
    }
  };

  if (loading) return <div>加载中...</div>;
  if (error) return <div>错误: {error}</div>;
  if (!stats) return <div>暂无数据</div>;

  return (
    <div className="today-stats">
      <h3>今日统计</h3>
      <div className="stats-grid">
        <div className="stat-item">
          <span className="stat-number">{stats.diningCount}</span>
          <span className="stat-label">报餐次数</span>
        </div>
        <div className="stat-item">
          <span className="stat-number">{stats.reservationCount}</span>
          <span className="stat-label">预约次数</span>
        </div>
        <div className="stat-item">
          <span className="stat-number">{stats.verificationCount}</span>
          <span className="stat-label">验证次数</span>
        </div>
        <div className="stat-item">
          <span className="stat-number">{stats.menuCount}</span>
          <span className="stat-label">菜单数量</span>
        </div>
      </div>
    </div>
  );
}

// 今日菜单组件
function TodayMenu() {
  const [menu, setMenu] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  useEffect(() => {
    fetchTodayMenu();
  }, []);

  const fetchTodayMenu = async () => {
    try {
      setLoading(true);
      const data = await getTodayMenu();
      setMenu(data);
    } catch (error) {
      setError(error.message);
    } finally {
      setLoading(false);
    }
  };

  if (loading) return <div>加载中...</div>;
  if (error) return <div>错误: {error}</div>;
  if (!menu || menu.menus.length === 0) return <div>今日暂无菜单</div>;

  return (
    <div className="today-menu">
      <h3>今日菜单</h3>
      {menu.menus.map((meal) => (
        <div key={meal._id} className="meal-section">
          <h4>{getMealTypeName(meal.mealType)} - {meal.mealTime}</h4>
          <div className="dishes-list">
            {meal.dishes.map((dish, index) => (
              <div key={index} className="dish-item">
                <span className="dish-name">{dish.name}</span>
                <span className="dish-price">¥{dish.price}</span>
              </div>
            ))}
          </div>
          <div className="meal-info">
            <span>容量: {meal.capacity}人</span>
            <span>已报餐: {meal.currentOrders}人</span>
          </div>
        </div>
      ))}
    </div>
  );
}

// 获取餐次名称
function getMealTypeName(mealType) {
  const mealTypeNames = {
    'breakfast': '早餐',
    'lunch': '午餐',
    'dinner': '晚餐'
  };
  return mealTypeNames[mealType] || mealType;
}
```

## 🔄 数据更新策略

### 实时性要求

| 数据类型 | 更新频率 | 建议 |
|----------|----------|------|
| 今日统计 | 实时 | 每次操作后立即更新 |
| 今日菜单 | 实时 | 菜单发布/修改后立即更新 |
| 最近活动 | 实时 | 新活动产生后立即更新 |
| 系统公告 | 实时 | 公告发布后立即更新 |

### 缓存策略

```javascript
// 缓存配置
const cacheConfig = {
  todayStats: { ttl: 60000 },      // 1分钟
  todayMenu: { ttl: 300000 },      // 5分钟
  recentActivities: { ttl: 120000 }, // 2分钟
  systemNotice: { ttl: 300000 }    // 5分钟
};

// 带缓存的获取函数
async function getTodayStatsWithCache() {
  const cacheKey = 'today_stats';
  let cachedData = cache.get(cacheKey);
  
  if (cachedData) {
    return cachedData;
  }
  
  const data = await getTodayStats();
  cache.set(cacheKey, data, cacheConfig.todayStats.ttl);
  return data;
}
```

## ⚠️ 注意事项

1. **权限控制**: 最近活动接口需要部门管理员权限，前端需要根据用户角色控制显示
2. **数据实时性**: 统计数据会实时更新，建议在关键操作后刷新数据
3. **错误处理**: 所有接口都有统一的错误处理，前端需要妥善处理各种错误情况
4. **缓存策略**: 建议对不常变化的数据进行适当缓存，提升用户体验
5. **数据格式**: 所有时间字段都使用ISO 8601格式，前端需要格式化显示
6. **容量控制**: 菜单容量信息用于前端显示剩余可报餐人数
7. **状态管理**: 活动状态用于前端显示不同的状态标识和操作按钮
