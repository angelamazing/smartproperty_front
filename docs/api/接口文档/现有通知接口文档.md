# 现有通知功能说明文档

## 📋 概述

本文档详细说明当前系统中已实现的通知相关功能，以及前端可以使用的通知配置选项。

**⚠️ 重要说明**: 当前系统通知功能实现度较低，大部分功能仅为接口预留，实际可用的通知功能有限。

**文档版本**: v1.1  
**最后更新**: 2025-01-27  
**适用范围**: 前端开发人员

---

## ✅ 已实现的通知功能

### 1. 系统公告通知

#### 1.1 获取系统公告

**接口地址**: `GET /api/system/notice`

**功能描述**: 获取最新的系统公告信息

**请求头**:
```http
Authorization: Bearer {token}
Content-Type: application/json
```

**响应示例**:
```json
{
  "success": true,
  "message": "获取系统公告成功",
  "data": {
    "title": "系统公告",
    "content": "系统运行正常，暂无重要公告",
    "time": "2025-01-27T10:30:00.000Z",
    "type": "info"
  }
}
```

**公告类型**:
- `info`: 信息类公告（默认）
- `warning`: 警告类公告
- `error`: 错误类公告
- `success`: 成功类公告

#### 1.2 前端集成示例

```javascript
/**
 * 获取系统公告
 * @returns {Promise<Object>} 公告数据
 */
async function getSystemNotice() {
  try {
    const token = localStorage.getItem('token');
    
    const response = await fetch('/api/system/notice', {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });
    
    const result = await response.json();
    
    if (result.success) {
      return result.data;
    } else {
      throw new Error(result.message);
    }
  } catch (error) {
    console.error('获取系统公告失败:', error);
    throw error;
  }
}
```

#### 1.3 Vue.js 组件示例

```vue
<template>
  <view class="system-notice">
    <view v-if="notice" class="notice-card" :class="notice.type">
      <view class="notice-header">
        <text class="notice-title">{{ notice.title }}</text>
        <text class="notice-time">{{ formatTime(notice.time) }}</text>
      </view>
      <view class="notice-content">
        <text>{{ notice.content }}</text>
      </view>
    </view>
  </view>
</template>

<script>
export default {
  name: 'SystemNotice',
  data() {
    return {
      notice: null
    }
  },
  onLoad() {
    this.loadNotice()
  },
  methods: {
    async loadNotice() {
      try {
        this.notice = await this.getSystemNotice()
      } catch (error) {
        console.error('加载系统公告失败:', error)
      }
    },
    
    async getSystemNotice() {
      const response = await uni.request({
        url: '/api/system/notice',
        method: 'GET',
        header: {
          'Authorization': `Bearer ${uni.getStorageSync('token')}`
        }
      })
      
      if (response.data.success) {
        return response.data.data
      } else {
        throw new Error(response.data.message)
      }
    },
    
    formatTime(time) {
      return new Date(time).toLocaleString()
    }
  }
}
</script>

<style>
.notice-card {
  padding: 20rpx;
  margin: 20rpx;
  border-radius: 10rpx;
  border-left: 6rpx solid #007aff;
}

.notice-card.info {
  background-color: #f0f9ff;
  border-left-color: #007aff;
}

.notice-card.warning {
  background-color: #fff7ed;
  border-left-color: #f59e0b;
}

.notice-card.error {
  background-color: #fef2f2;
  border-left-color: #ef4444;
}

.notice-card.success {
  background-color: #f0fdf4;
  border-left-color: #10b981;
}

.notice-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10rpx;
}

.notice-title {
  font-size: 32rpx;
  font-weight: bold;
  color: #1f2937;
}

.notice-time {
  font-size: 24rpx;
  color: #6b7280;
}

.notice-content {
  font-size: 28rpx;
  color: #374151;
  line-height: 1.5;
}
</style>
```

---

### 2. 短信验证码通知（仅接口预留）

#### 2.1 发送验证码接口

**接口地址**: `POST /api/auth/send-verification-code`

**功能描述**: 发送短信验证码到用户手机（⚠️ **仅接口预留，短信功能未实现**）

**请求参数**:
```json
{
  "phoneNumber": "13800138000"
}
```

**响应示例**:
```json
{
  "success": true,
  "message": "验证码发送成功",
  "data": {
    "message": "验证码发送成功"
  }
}
```

**⚠️ 重要说明**:
- 短信发送功能**未真正实现**，只是预留了接口
- 开发环境会直接返回验证码用于测试
- 生产环境调用 `sendSMS` 方法，但该方法只是模拟发送，并未集成真实短信服务商

#### 2.2 当前实现状态

```javascript
// 当前 sendSMS 方法实现（仅模拟）
async sendSMS(phoneNumber, code) {
  // 这里集成具体的短信服务商API
  // 例如：阿里云短信、腾讯云短信等
  logger.info(`发送短信验证码: ${phoneNumber} -> ${code}`);
  
  // 模拟短信发送成功
  return true;
}
```

**需要完善的部分**:
- ❌ 未集成真实短信服务商API
- ❌ 未配置短信模板
- ❌ 未处理短信发送失败情况
- ❌ 未实现短信发送状态回调

#### 2.3 前端集成示例

```javascript
/**
 * 发送验证码（当前仅开发环境可用）
 * @param {string} phoneNumber - 手机号
 * @returns {Promise<Object>} 发送结果
 */
async function sendVerificationCode(phoneNumber) {
  try {
    const response = await fetch('/api/auth/send-verification-code', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ phoneNumber })
    });
    
    const result = await response.json();
    
    if (result.success) {
      // 开发环境会返回验证码
      if (result.data.code) {
        console.log('开发环境验证码:', result.data.code);
        uni.showToast({
          title: `验证码: ${result.data.code}`,
          icon: 'none',
          duration: 3000
        });
      }
      return result.data;
    } else {
      throw new Error(result.message);
    }
  } catch (error) {
    console.error('发送验证码失败:', error);
    throw error;
  }
}
```

---

### 3. 系统统计通知

#### 3.1 获取今日统计

**接口地址**: `GET /api/system/today-stats`

**功能描述**: 获取今日系统统计数据

**响应示例**:
```json
{
  "success": true,
  "message": "获取今日统计成功",
  "data": {
    "diningCount": 25,
    "reservationCount": 8,
    "verificationCount": 3,
    "menuCount": 1,
    "date": "2025-01-27"
  }
}
```

#### 3.2 前端集成示例

```javascript
/**
 * 获取今日统计
 * @returns {Promise<Object>} 统计数据
 */
async function getTodayStats() {
  try {
    const token = localStorage.getItem('token');
    
    const response = await fetch('/api/system/today-stats', {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });
    
    const result = await response.json();
    
    if (result.success) {
      return result.data;
    } else {
      throw new Error(result.message);
    }
  } catch (error) {
    console.error('获取今日统计失败:', error);
    throw error;
  }
}
```

---

## ❌ 未实现的通知功能

### 1. 用户个人通知设置

以下功能在接口文档中已定义，但后端未实现：

- ❌ 获取用户通知设置 (`GET /api/user/notification-settings`)
- ❌ 更新用户通知设置 (`PUT /api/user/notification-settings`)
- ❌ 重置用户通知设置 (`POST /api/user/notification-settings/reset`)

### 2. 短信通知

- ❌ 真实短信发送功能（仅接口预留）
- ❌ 短信服务商集成
- ❌ 短信模板配置
- ❌ 短信发送状态回调

### 3. 推送通知

- ❌ 手机推送通知
- ❌ 应用内推送通知
- ❌ 邮件通知

### 4. 业务通知

- ❌ 报餐提醒通知
- ❌ 球馆预约通知
- ❌ 审批结果通知
- ❌ 即时消息通知
- ❌ 群组消息通知

---

## 🔧 前端可用的通知配置

### 1. 系统公告配置

```javascript
// 公告类型配置
const NOTICE_TYPES = {
  info: {
    color: '#007aff',
    backgroundColor: '#f0f9ff',
    icon: 'info-circle'
  },
  warning: {
    color: '#f59e0b',
    backgroundColor: '#fff7ed',
    icon: 'exclamation-triangle'
  },
  error: {
    color: '#ef4444',
    backgroundColor: '#fef2f2',
    icon: 'times-circle'
  },
  success: {
    color: '#10b981',
    backgroundColor: '#f0fdf4',
    icon: 'check-circle'
  }
};

// 公告显示配置
const NOTICE_CONFIG = {
  autoRefresh: true,        // 自动刷新
  refreshInterval: 30000,   // 刷新间隔（毫秒）
  showDuration: 5000,      // 显示时长（毫秒）
  maxRetries: 3,           // 最大重试次数
  retryDelay: 1000         // 重试延迟（毫秒）
};
```

### 2. 验证码配置（仅开发环境）

```javascript
// 验证码配置（当前仅开发环境可用）
const VERIFICATION_CONFIG = {
  codeLength: 6,           // 验证码长度
  expiryMinutes: 5,        // 有效期（分钟）
  sendInterval: 60,        // 发送间隔（秒）
  maxAttempts: 3,          // 最大尝试次数
  cooldownPeriod: 300,     // 冷却期（秒）
  isDevelopment: true,     // 当前仅开发环境可用
  showCodeInToast: true    // 开发环境显示验证码
};
```

### 3. 统计通知配置

```javascript
// 统计通知配置
const STATS_CONFIG = {
  autoRefresh: true,       // 自动刷新
  refreshInterval: 60000,  // 刷新间隔（毫秒）
  showThreshold: 10,       // 显示阈值
  animationDuration: 500   // 动画时长（毫秒）
};
```

---

## 📱 前端实现建议

### 1. 通知组件架构

```javascript
// 通知管理器
class NotificationManager {
  constructor() {
    this.notices = [];
    this.config = {
      maxNotices: 5,
      autoHide: true,
      hideDelay: 5000
    };
  }
  
  // 添加通知
  addNotice(notice) {
    this.notices.unshift(notice);
    if (this.notices.length > this.config.maxNotices) {
      this.notices.pop();
    }
    this.render();
  }
  
  // 渲染通知
  render() {
    // 实现通知渲染逻辑
  }
  
  // 清除通知
  clearNotice(id) {
    this.notices = this.notices.filter(notice => notice.id !== id);
    this.render();
  }
}
```

### 2. 通知样式配置

```css
/* 通知样式配置 */
.notification-container {
  position: fixed;
  top: 20px;
  right: 20px;
  z-index: 9999;
  max-width: 400px;
}

.notification-item {
  background: white;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  margin-bottom: 10px;
  padding: 16px;
  border-left: 4px solid #007aff;
  animation: slideIn 0.3s ease-out;
}

.notification-item.info {
  border-left-color: #007aff;
}

.notification-item.warning {
  border-left-color: #f59e0b;
}

.notification-item.error {
  border-left-color: #ef4444;
}

.notification-item.success {
  border-left-color: #10b981;
}

@keyframes slideIn {
  from {
    transform: translateX(100%);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}
```

---

## 🚀 开发建议

### 1. 优先级排序

1. **高优先级**: 实现用户个人通知设置功能
2. **中优先级**: 实现推送通知机制
3. **低优先级**: 实现邮件通知功能

### 2. 技术选型建议

- **推送通知**: 使用微信小程序订阅消息或第三方推送服务
- **邮件通知**: 使用 Nodemailer 或 SendGrid
- **应用内通知**: 使用 WebSocket 或 Server-Sent Events

### 3. 数据库设计建议

```sql
-- 用户通知设置表
CREATE TABLE user_notification_settings (
  id VARCHAR(36) PRIMARY KEY,
  user_id VARCHAR(36) NOT NULL,
  system_announcement BOOLEAN DEFAULT TRUE,
  security_alert BOOLEAN DEFAULT TRUE,
  meal_reminder BOOLEAN DEFAULT TRUE,
  court_booking BOOLEAN DEFAULT TRUE,
  approval_notification BOOLEAN DEFAULT TRUE,
  instant_message BOOLEAN DEFAULT TRUE,
  group_message BOOLEAN DEFAULT TRUE,
  in_app_notification BOOLEAN DEFAULT TRUE,
  push_notification BOOLEAN DEFAULT TRUE,
  email_notification BOOLEAN DEFAULT FALSE,
  do_not_disturb BOOLEAN DEFAULT FALSE,
  dnd_start_time VARCHAR(5) DEFAULT '22:00',
  dnd_end_time VARCHAR(5) DEFAULT '08:00',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  UNIQUE KEY unique_user_settings (user_id)
);

-- 通知记录表
CREATE TABLE notification_logs (
  id VARCHAR(36) PRIMARY KEY,
  user_id VARCHAR(36) NOT NULL,
  type VARCHAR(50) NOT NULL,
  title VARCHAR(200) NOT NULL,
  content TEXT NOT NULL,
  status ENUM('pending', 'sent', 'failed') DEFAULT 'pending',
  sent_at TIMESTAMP NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

---

## 📞 技术支持

如果在使用现有通知功能时遇到问题，请检查：

1. **Token有效性**: 确保JWT Token未过期且有效
2. **网络连接**: 确保网络连接正常
3. **服务器状态**: 确保后端服务正常运行
4. **数据库连接**: 确保数据库连接正常

---

## 4. 公告管理功能（✅ 已实现）

### 4.1 获取公告列表

**接口地址**: `GET /api/admin/notices`

**功能描述**: 获取公告列表，支持分页、筛选和搜索

**请求参数**:
- `page`: 页码（可选，默认1）
- `pageSize`: 每页数量（可选，默认20）
- `status`: 状态筛选（可选：draft, published, archived）
- `type`: 类型筛选（可选：info, warning, error, success）
- `keyword`: 关键词搜索（可选）

**响应示例**:
```json
{
  "success": true,
  "message": "获取公告列表成功",
  "data": {
    "records": [...],
    "total": 9,
    "page": 1,
    "pageSize": 20,
    "hasMore": false,
    "totalPages": 1
  }
}
```

### 4.2 获取公告详情

**接口地址**: `GET /api/admin/notices/:noticeId`

**功能描述**: 获取指定公告的详细信息

### 4.3 创建公告

**接口地址**: `POST /api/admin/notices`

**功能描述**: 创建新的公告

**请求体**:
```json
{
  "title": "公告标题",
  "content": "公告内容",
  "type": "info",
  "priority": 1,
  "status": "draft",
  "startTime": "2025-01-01T00:00:00.000Z",
  "endTime": "2025-12-31T23:59:59.000Z",
  "isSticky": false,
  "targetUsers": ["user1", "user2"]
}
```

### 4.4 更新公告

**接口地址**: `PUT /api/admin/notices/:noticeId`

**功能描述**: 更新指定公告的信息

### 4.5 删除公告

**接口地址**: `DELETE /api/admin/notices/:noticeId`

**功能描述**: 删除指定公告

### 4.6 发布公告

**接口地址**: `POST /api/admin/notices/:noticeId/publish`

**功能描述**: 发布指定公告

### 4.7 取消发布公告

**接口地址**: `POST /api/admin/notices/:noticeId/unpublish`

**功能描述**: 取消发布指定公告

### 4.8 批量删除公告

**接口地址**: `DELETE /api/admin/notices/batch`

**功能描述**: 批量删除多个公告

**请求体**:
```json
{
  "noticeIds": ["id1", "id2", "id3"]
}
```

---

## 📊 功能实现状态总结

| 功能模块 | 实现状态 | 可用程度 | 说明 |
|---------|---------|---------|------|
| 系统公告 | ✅ 已实现 | 100% | 完全可用 |
| 公告管理 | ✅ 已实现 | 100% | 完全可用 |
| 短信验证码 | ⚠️ 仅接口预留 | 20% | 仅开发环境可用 |
| 系统统计 | ✅ 已实现 | 100% | 完全可用 |
| 用户通知设置 | ❌ 未实现 | 0% | 完全不可用 |
| 推送通知 | ❌ 未实现 | 0% | 完全不可用 |
| 邮件通知 | ❌ 未实现 | 0% | 完全不可用 |
| 业务通知 | ❌ 未实现 | 0% | 完全不可用 |

**总体实现度**: 约 40%
**前端可用功能**: 系统公告 + 公告管理 + 系统统计 + 开发环境验证码

---

**注意**: 本文档基于当前系统实现情况编写，随着功能开发进度会持续更新。
