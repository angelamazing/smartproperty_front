# å¤´åƒç›¸å…³æ¥å£æ–‡æ¡£

## ğŸ“‹ æ¥å£æ¦‚è¿°

åç«¯æä¾›äº†å®Œæ•´çš„å¤´åƒç®¡ç†åŠŸèƒ½ï¼ŒåŒ…æ‹¬å¤´åƒä¸Šä¼ ã€æ›´æ–°ã€è·å–ç­‰æ“ä½œã€‚

## ğŸ” æƒé™è¯´æ˜

- **ç”¨æˆ·æ¥å£**: éœ€è¦ç”¨æˆ·ç™»å½•è®¤è¯ (`authenticateToken`)
- **ç®¡ç†å‘˜æ¥å£**: éœ€è¦ç®¡ç†å‘˜æƒé™ (`adminAuth`)

## ğŸ“¥ æ¥å£åˆ—è¡¨

### 1. ä¸Šä¼ å¤´åƒæ–‡ä»¶

**æ¥å£è·¯å¾„**: `POST /api/admin/upload/avatar`  
**è¯·æ±‚æ–¹å¼**: `POST`  
**æƒé™è¦æ±‚**: ç®¡ç†å‘˜æƒé™  
**æ¥å£æè¿°**: ä¸Šä¼ å¤´åƒæ–‡ä»¶åˆ°æœåŠ¡å™¨

#### è¯·æ±‚å‚æ•°

**Content-Type**: `multipart/form-data`

| å‚æ•°å | ç±»å‹ | å¿…å¡« | è¯´æ˜ | ç¤ºä¾‹ |
|--------|------|------|------|------|
| avatar | File | âœ… | å¤´åƒæ–‡ä»¶ | é€‰æ‹©æ–‡ä»¶ |

#### æ–‡ä»¶è¦æ±‚

- **æ”¯æŒæ ¼å¼**: JPGã€PNGã€GIFã€WebP
- **æ–‡ä»¶å¤§å°**: æœ€å¤§ 2MB
- **æ–‡ä»¶æ•°é‡**: åªèƒ½ä¸Šä¼  1 ä¸ªæ–‡ä»¶

#### å“åº”æ ¼å¼

**æˆåŠŸå“åº”**:
```json
{
  "success": true,
  "message": "å¤´åƒä¸Šä¼ æˆåŠŸ",
  "code": "200",
  "timestamp": "2025-09-04T12:00:00.000Z",
  "data": {
    "avatarUrl": "http://localhost:3000/uploads/avatars/avatar_1691234567890_abc123.jpg",
    "fileName": "avatar_1691234567890_abc123.jpg",
    "fileSize": 1024000,
    "mimeType": "image/jpeg",
    "originalName": "user-avatar.jpg"
  }
}
```

**é”™è¯¯å“åº”**:
```json
{
  "success": false,
  "message": "å¤´åƒæ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡ 2MB",
  "code": "400",
  "timestamp": "2025-09-04T12:00:00.000Z"
}
```

#### ä½¿ç”¨ç¤ºä¾‹

```bash
curl -X POST http://localhost:3000/api/admin/upload/avatar \
  -H "Authorization: Bearer your-admin-token" \
  -F "avatar=@/path/to/avatar.jpg"
```

### 2. æ›´æ–°ç”¨æˆ·å¤´åƒURL

**æ¥å£è·¯å¾„**: `PUT /api/user/avatar`  
**è¯·æ±‚æ–¹å¼**: `PUT`  
**æƒé™è¦æ±‚**: ç”¨æˆ·ç™»å½•  
**æ¥å£æè¿°**: æ›´æ–°ç”¨æˆ·å¤´åƒURL

#### è¯·æ±‚å‚æ•°

**Content-Type**: `application/json`

| å‚æ•°å | ç±»å‹ | å¿…å¡« | è¯´æ˜ | ç¤ºä¾‹ |
|--------|------|------|------|------|
| avatarUrl | string | âœ… | å¤´åƒURL | "http://localhost:3000/uploads/avatars/avatar_123.jpg" |

#### è¯·æ±‚ç¤ºä¾‹

```json
{
  "avatarUrl": "http://localhost:3000/uploads/avatars/avatar_1691234567890_abc123.jpg"
}
```

#### å“åº”æ ¼å¼

**æˆåŠŸå“åº”**:
```json
{
  "success": true,
  "message": "å¤´åƒæ›´æ–°æˆåŠŸ",
  "code": "200",
  "timestamp": "2025-09-04T12:00:00.000Z",
  "data": null
}
```

**é”™è¯¯å“åº”**:
```json
{
  "success": false,
  "message": "ç”¨æˆ·ä¸å­˜åœ¨",
  "code": "404",
  "timestamp": "2025-09-04T12:00:00.000Z"
}
```

### 3. ç®¡ç†å‘˜æ›´æ–°ç”¨æˆ·å¤´åƒ

**æ¥å£è·¯å¾„**: `PUT /api/admin/user/avatar`  
**è¯·æ±‚æ–¹å¼**: `PUT`  
**æƒé™è¦æ±‚**: ç®¡ç†å‘˜æƒé™  
**æ¥å£æè¿°**: ç®¡ç†å‘˜æ›´æ–°æŒ‡å®šç”¨æˆ·çš„å¤´åƒ

#### è¯·æ±‚å‚æ•°

**Content-Type**: `application/json`

| å‚æ•°å | ç±»å‹ | å¿…å¡« | è¯´æ˜ | ç¤ºä¾‹ |
|--------|------|------|------|------|
| userId | string | âœ… | ç”¨æˆ·ID | "user-uuid-here" |
| avatarUrl | string | âœ… | å¤´åƒURL | "http://localhost:3000/uploads/avatars/avatar_123.jpg" |

#### è¯·æ±‚ç¤ºä¾‹

```json
{
  "userId": "user-uuid-here",
  "avatarUrl": "http://localhost:3000/uploads/avatars/avatar_1691234567890_abc123.jpg"
}
```

## ğŸ”§ æŠ€æœ¯å®ç°ç»†èŠ‚

### æ–‡ä»¶å­˜å‚¨

- **å­˜å‚¨è·¯å¾„**: `public/uploads/avatars/`
- **æ–‡ä»¶å‘½å**: `avatar_{timestamp}_{random}.{extension}`
- **è®¿é—®URL**: `http://localhost:3000/uploads/avatars/{filename}`

### æ–‡ä»¶å¤„ç†æµç¨‹

1. **æ–‡ä»¶éªŒè¯**: æ£€æŸ¥æ–‡ä»¶ç±»å‹å’Œå¤§å°
2. **æ–‡ä»¶ä¿å­˜**: ä½¿ç”¨ multer ä¿å­˜åˆ°æŒ‡å®šç›®å½•
3. **URLç”Ÿæˆ**: ç”Ÿæˆå¯è®¿é—®çš„æ–‡ä»¶URL
4. **æ•°æ®åº“æ›´æ–°**: æ›´æ–°ç”¨æˆ·è¡¨ä¸­çš„ avatarUrl å­—æ®µ

### ä¸­é—´ä»¶é…ç½®

```javascript
// å¤´åƒä¸Šä¼ é…ç½®
const avatarStorage = multer.diskStorage({
  destination: (req, file, cb) => {
    const uploadDir = path.join(__dirname, '..', 'public', 'uploads', 'avatars');
    ensureUploadDir(uploadDir);
    cb(null, uploadDir);
  },
  filename: (req, file, cb) => {
    const timestamp = Date.now();
    const random = Math.random().toString(36).substr(2, 9);
    const extension = path.extname(file.originalname);
    const filename = `avatar_${timestamp}_${random}${extension}`;
    cb(null, filename);
  }
});

// æ–‡ä»¶è¿‡æ»¤å™¨
const avatarFilter = (req, file, cb) => {
  const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
  if (allowedTypes.includes(file.mimetype)) {
    cb(null, true);
  } else {
    cb(new Error('åªæ”¯æŒ JPGã€PNGã€GIFã€WebP æ ¼å¼çš„å›¾ç‰‡'), false);
  }
};
```

## ğŸ“Š é”™è¯¯å¤„ç†

### å¸¸è§é”™è¯¯ç 

| é”™è¯¯ç  | è¯´æ˜ | è§£å†³æ–¹æ¡ˆ |
|--------|------|----------|
| 400 | æ–‡ä»¶å¤§å°è¶…é™ | å‹ç¼©å›¾ç‰‡æˆ–é€‰æ‹©æ›´å°çš„æ–‡ä»¶ |
| 400 | æ–‡ä»¶æ ¼å¼ä¸æ”¯æŒ | ä½¿ç”¨æ”¯æŒçš„å›¾ç‰‡æ ¼å¼ |
| 400 | æ–‡ä»¶æ•°é‡è¶…é™ | åªä¸Šä¼ ä¸€ä¸ªæ–‡ä»¶ |
| 401 | æœªæˆæƒ | æä¾›æœ‰æ•ˆçš„è®¤è¯Token |
| 403 | æƒé™ä¸è¶³ | ä½¿ç”¨ç®¡ç†å‘˜æƒé™ |
| 404 | ç”¨æˆ·ä¸å­˜åœ¨ | æ£€æŸ¥ç”¨æˆ·IDæ˜¯å¦æ­£ç¡® |
| 500 | æœåŠ¡å™¨é”™è¯¯ | æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€å’Œæ—¥å¿— |

### é”™è¯¯å“åº”ç¤ºä¾‹

```json
{
  "success": false,
  "message": "å¤´åƒæ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡ 2MB",
  "code": "400",
  "timestamp": "2025-09-04T12:00:00.000Z"
}
```

## ğŸ’¡ ä½¿ç”¨å»ºè®®

### 1. å‰ç«¯é›†æˆ

```javascript
// ä¸Šä¼ å¤´åƒ
async function uploadAvatar(file, token) {
  const formData = new FormData();
  formData.append('avatar', file);
  
  const response = await fetch('/api/admin/upload/avatar', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${token}`
    },
    body: formData
  });
  
  return await response.json();
}

// æ›´æ–°å¤´åƒURL
async function updateAvatarUrl(avatarUrl, token) {
  const response = await fetch('/api/user/avatar', {
    method: 'PUT',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${token}`
    },
    body: JSON.stringify({ avatarUrl })
  });
  
  return await response.json();
}
```

### 2. å¤´åƒæ˜¾ç¤º

```javascript
// å¤„ç†å¤´åƒURL
function getAvatarUrl(userInfo, useProxy = true) {
  if (!userInfo?.avatarUrl) {
    return 'https://api.dicebear.com/7.x/avataaars/svg?seed=default';
  }
  
  const avatarUrl = userInfo.avatarUrl;
  
  // å¦‚æœå·²ç»æ˜¯å®Œæ•´URLï¼Œç›´æ¥ä½¿ç”¨
  if (avatarUrl.startsWith('http://') || avatarUrl.startsWith('https://')) {
    return avatarUrl;
  }
  
  // å¦‚æœä½¿ç”¨ä»£ç†ï¼Œä½¿ç”¨ç›¸å¯¹è·¯å¾„
  if (useProxy) {
    if (avatarUrl.startsWith('/')) {
      return avatarUrl;
    }
    return `/uploads/avatars/${avatarUrl}`;
  }
  
  // å¦‚æœä¸ä½¿ç”¨ä»£ç†ï¼Œä½¿ç”¨å®Œæ•´URL
  return `http://localhost:3000/uploads/avatars/${avatarUrl}`;
}
```

### 3. æœ€ä½³å®è·µ

1. **æ–‡ä»¶å‹ç¼©**: ä¸Šä¼ å‰å‹ç¼©å›¾ç‰‡ä»¥å‡å°‘æ–‡ä»¶å¤§å°
2. **æ ¼å¼é€‰æ‹©**: ä¼˜å…ˆä½¿ç”¨ WebP æ ¼å¼ä»¥è·å¾—æ›´å¥½çš„å‹ç¼©æ¯”
3. **é”™è¯¯å¤„ç†**: å®ç°å®Œæ•´çš„é”™è¯¯å¤„ç†å’Œç”¨æˆ·æç¤º
4. **åŠ è½½çŠ¶æ€**: æ˜¾ç¤ºä¸Šä¼ è¿›åº¦å’ŒåŠ è½½çŠ¶æ€
5. **é»˜è®¤å¤´åƒ**: æä¾›é»˜è®¤å¤´åƒä½œä¸ºå¤‡ç”¨æ–¹æ¡ˆ

## ğŸ”„ ç›¸å…³æ¥å£

- **è·å–ç”¨æˆ·ä¿¡æ¯**: `GET /api/user/info`
- **æ›´æ–°ç”¨æˆ·èµ„æ–™**: `PUT /api/user/profile`
- **è·å–ç”¨æˆ·åˆ—è¡¨**: `GET /api/user/list` (ç®¡ç†å‘˜)

## ğŸ“ æ›´æ–°æ—¥å¿—

### v1.0.0 (2025-09-04)
- âœ… åˆå§‹ç‰ˆæœ¬å‘å¸ƒ
- âœ… æ”¯æŒå¤´åƒæ–‡ä»¶ä¸Šä¼ 
- âœ… æ”¯æŒå¤´åƒURLæ›´æ–°
- âœ… å®Œæ•´çš„é”™è¯¯å¤„ç†
- âœ… æ–‡ä»¶ç±»å‹å’Œå¤§å°éªŒè¯

---

**æœ€åæ›´æ–°**: 2025-09-04  
**æ–‡æ¡£ç‰ˆæœ¬**: v1.0.0  
**ç»´æŠ¤äººå‘˜**: å¼€å‘å›¢é˜Ÿ
