# 头像相关接口文档

## 📋 接口概述

后端提供了完整的头像管理功能，包括头像上传、更新、获取等操作。

## 🔐 权限说明

- **用户接口**: 需要用户登录认证 (`authenticateToken`)
- **管理员接口**: 需要管理员权限 (`adminAuth`)

## 📥 接口列表

### 1. 上传头像文件

**接口路径**: `POST /api/admin/upload/avatar`  
**请求方式**: `POST`  
**权限要求**: 管理员权限  
**接口描述**: 上传头像文件到服务器

#### 请求参数

**Content-Type**: `multipart/form-data`

| 参数名 | 类型 | 必填 | 说明 | 示例 |
|--------|------|------|------|------|
| avatar | File | ✅ | 头像文件 | 选择文件 |

#### 文件要求

- **支持格式**: JPG、PNG、GIF、WebP
- **文件大小**: 最大 2MB
- **文件数量**: 只能上传 1 个文件

#### 响应格式

**成功响应**:
```json
{
  "success": true,
  "message": "头像上传成功",
  "code": "200",
  "timestamp": "2025-09-04T12:00:00.000Z",
  "data": {
    "avatarUrl": "http://localhost:3000/uploads/avatars/avatar_1691234567890_abc123.jpg",
    "fileName": "avatar_1691234567890_abc123.jpg",
    "fileSize": 1024000,
    "mimeType": "image/jpeg",
    "originalName": "user-avatar.jpg"
  }
}
```

**错误响应**:
```json
{
  "success": false,
  "message": "头像文件大小不能超过 2MB",
  "code": "400",
  "timestamp": "2025-09-04T12:00:00.000Z"
}
```

#### 使用示例

```bash
curl -X POST http://localhost:3000/api/admin/upload/avatar \
  -H "Authorization: Bearer your-admin-token" \
  -F "avatar=@/path/to/avatar.jpg"
```

### 2. 更新用户头像URL

**接口路径**: `PUT /api/user/avatar`  
**请求方式**: `PUT`  
**权限要求**: 用户登录  
**接口描述**: 更新用户头像URL

#### 请求参数

**Content-Type**: `application/json`

| 参数名 | 类型 | 必填 | 说明 | 示例 |
|--------|------|------|------|------|
| avatarUrl | string | ✅ | 头像URL | "http://localhost:3000/uploads/avatars/avatar_123.jpg" |

#### 请求示例

```json
{
  "avatarUrl": "http://localhost:3000/uploads/avatars/avatar_1691234567890_abc123.jpg"
}
```

#### 响应格式

**成功响应**:
```json
{
  "success": true,
  "message": "头像更新成功",
  "code": "200",
  "timestamp": "2025-09-04T12:00:00.000Z",
  "data": null
}
```

**错误响应**:
```json
{
  "success": false,
  "message": "用户不存在",
  "code": "404",
  "timestamp": "2025-09-04T12:00:00.000Z"
}
```

### 3. 管理员更新用户头像

**接口路径**: `PUT /api/admin/user/avatar`  
**请求方式**: `PUT`  
**权限要求**: 管理员权限  
**接口描述**: 管理员更新指定用户的头像

#### 请求参数

**Content-Type**: `application/json`

| 参数名 | 类型 | 必填 | 说明 | 示例 |
|--------|------|------|------|------|
| userId | string | ✅ | 用户ID | "user-uuid-here" |
| avatarUrl | string | ✅ | 头像URL | "http://localhost:3000/uploads/avatars/avatar_123.jpg" |

#### 请求示例

```json
{
  "userId": "user-uuid-here",
  "avatarUrl": "http://localhost:3000/uploads/avatars/avatar_1691234567890_abc123.jpg"
}
```

## 🔧 技术实现细节

### 文件存储

- **存储路径**: `public/uploads/avatars/`
- **文件命名**: `avatar_{timestamp}_{random}.{extension}`
- **访问URL**: `http://localhost:3000/uploads/avatars/{filename}`

### 文件处理流程

1. **文件验证**: 检查文件类型和大小
2. **文件保存**: 使用 multer 保存到指定目录
3. **URL生成**: 生成可访问的文件URL
4. **数据库更新**: 更新用户表中的 avatarUrl 字段

### 中间件配置

```javascript
// 头像上传配置
const avatarStorage = multer.diskStorage({
  destination: (req, file, cb) => {
    const uploadDir = path.join(__dirname, '..', 'public', 'uploads', 'avatars');
    ensureUploadDir(uploadDir);
    cb(null, uploadDir);
  },
  filename: (req, file, cb) => {
    const timestamp = Date.now();
    const random = Math.random().toString(36).substr(2, 9);
    const extension = path.extname(file.originalname);
    const filename = `avatar_${timestamp}_${random}${extension}`;
    cb(null, filename);
  }
});

// 文件过滤器
const avatarFilter = (req, file, cb) => {
  const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
  if (allowedTypes.includes(file.mimetype)) {
    cb(null, true);
  } else {
    cb(new Error('只支持 JPG、PNG、GIF、WebP 格式的图片'), false);
  }
};
```

## 📊 错误处理

### 常见错误码

| 错误码 | 说明 | 解决方案 |
|--------|------|----------|
| 400 | 文件大小超限 | 压缩图片或选择更小的文件 |
| 400 | 文件格式不支持 | 使用支持的图片格式 |
| 400 | 文件数量超限 | 只上传一个文件 |
| 401 | 未授权 | 提供有效的认证Token |
| 403 | 权限不足 | 使用管理员权限 |
| 404 | 用户不存在 | 检查用户ID是否正确 |
| 500 | 服务器错误 | 检查服务器状态和日志 |

### 错误响应示例

```json
{
  "success": false,
  "message": "头像文件大小不能超过 2MB",
  "code": "400",
  "timestamp": "2025-09-04T12:00:00.000Z"
}
```

## 💡 使用建议

### 1. 前端集成

```javascript
// 上传头像
async function uploadAvatar(file, token) {
  const formData = new FormData();
  formData.append('avatar', file);
  
  const response = await fetch('/api/admin/upload/avatar', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${token}`
    },
    body: formData
  });
  
  return await response.json();
}

// 更新头像URL
async function updateAvatarUrl(avatarUrl, token) {
  const response = await fetch('/api/user/avatar', {
    method: 'PUT',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${token}`
    },
    body: JSON.stringify({ avatarUrl })
  });
  
  return await response.json();
}
```

### 2. 头像显示

```javascript
// 处理头像URL
function getAvatarUrl(userInfo, useProxy = true) {
  if (!userInfo?.avatarUrl) {
    return 'https://api.dicebear.com/7.x/avataaars/svg?seed=default';
  }
  
  const avatarUrl = userInfo.avatarUrl;
  
  // 如果已经是完整URL，直接使用
  if (avatarUrl.startsWith('http://') || avatarUrl.startsWith('https://')) {
    return avatarUrl;
  }
  
  // 如果使用代理，使用相对路径
  if (useProxy) {
    if (avatarUrl.startsWith('/')) {
      return avatarUrl;
    }
    return `/uploads/avatars/${avatarUrl}`;
  }
  
  // 如果不使用代理，使用完整URL
  return `http://localhost:3000/uploads/avatars/${avatarUrl}`;
}
```

### 3. 最佳实践

1. **文件压缩**: 上传前压缩图片以减少文件大小
2. **格式选择**: 优先使用 WebP 格式以获得更好的压缩比
3. **错误处理**: 实现完整的错误处理和用户提示
4. **加载状态**: 显示上传进度和加载状态
5. **默认头像**: 提供默认头像作为备用方案

## 🔄 相关接口

- **获取用户信息**: `GET /api/user/info`
- **更新用户资料**: `PUT /api/user/profile`
- **获取用户列表**: `GET /api/user/list` (管理员)

## 📝 更新日志

### v1.0.0 (2025-09-04)
- ✅ 初始版本发布
- ✅ 支持头像文件上传
- ✅ 支持头像URL更新
- ✅ 完整的错误处理
- ✅ 文件类型和大小验证

---

**最后更新**: 2025-09-04  
**文档版本**: v1.0.0  
**维护人员**: 开发团队
