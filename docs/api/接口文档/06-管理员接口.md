# 管理员接口文档

## 📋 接口概述

管理员接口提供系统管理、菜单管理、用户管理、数据统计等管理员功能。

**基础路径**: `/api/admin`

**认证要求**: 所有接口都需要有效的JWT Token和管理员权限

## 🔐 接口列表

### 1. 获取系统统计数据

**接口地址**: `GET /api/admin/system-stats`

**接口描述**: 获取系统整体统计数据

**请求头**:
```http
Authorization: Bearer {token}
```

**响应示例**:
```json
{
  "success": true,
  "message": "获取系统统计成功",
  "data": {
    "userStats": {
      "totalUsers": 156,
      "activeUsers": 142,
      "newUsersThisMonth": 12,
      "userGrowthRate": "8.3%"
    },
    "diningStats": {
      "totalOrders": 2340,
      "ordersThisMonth": 456,
      "averageOrderAmount": 28.5,
      "popularMealType": "lunch"
    },
    "reservationStats": {
      "totalReservations": 890,
      "reservationsThisMonth": 67,
      "averageUtilization": "65.2%",
      "popularVenue": "会议室A"
    },
    "systemStats": {
      "uptime": "99.8%",
      "lastBackup": "2024-01-15T02:00:00.000Z",
      "diskUsage": "45.2%",
      "memoryUsage": "62.1%"
    }
  }
}
```

---

### 2. 获取系统状态

**接口地址**: `GET /api/admin/system/status`

**接口描述**: 获取系统运行状态信息

**请求头**:
```http
Authorization: Bearer {token}
```

**响应示例**:
```json
{
  "success": true,
  "message": "获取系统状态成功",
  "data": {
    "serverStatus": "running",
    "databaseStatus": "connected",
    "redisStatus": "connected",
    "uptime": "15天 8小时 32分钟",
    "cpuUsage": "23.5%",
    "memoryUsage": "62.1%",
    "diskUsage": "45.2%",
    "networkStatus": "normal",
    "lastHealthCheck": "2024-01-15T15:30:00.000Z",
    "activeConnections": 45,
    "errorLogs": {
      "last24Hours": 3,
      "last7Days": 12,
      "criticalErrors": 0
    }
  }
}
```

---

## 🍽️ 菜单管理模块

### 3. 保存菜单草稿

**接口地址**: `POST /api/admin/menu/draft`

**接口描述**: 保存菜单草稿

**请求头**:
```http
Authorization: Bearer {token}
Content-Type: application/json
```

**请求参数**:
```json
{
  "date": "2024-01-16",
  "mealType": "lunch",
  "dishes": [
    {
      "dishId": "dish_id_1",
      "name": "宫保鸡丁",
      "price": 15.0,
      "category": "荤菜"
    },
    {
      "dishId": "dish_id_2",
      "name": "麻婆豆腐",
      "price": 12.0,
      "category": "素菜"
    }
  ],
  "status": "draft"
}
```

**响应示例**:
```json
{
  "success": true,
  "message": "菜单草稿保存成功",
  "data": {
    "menuId": "menu_id_123",
    "date": "2024-01-16",
    "mealType": "lunch",
    "status": "draft",
    "createTime": "2024-01-15T16:30:00.000Z"
  }
}
```

---

### 4. 发布菜单

**接口地址**: `POST /api/admin/menu/publish`

**接口描述**: 发布菜单

**请求头**:
```http
Authorization: Bearer {token}
Content-Type: application/json
```

**请求参数**:
```json
{
  "date": "2024-01-16",
  "mealType": "lunch",
  "dishes": [
    {
      "dishId": "dish_id_1",
      "name": "宫保鸡丁",
      "price": 15.0,
      "category": "荤菜"
    },
    {
      "dishId": "dish_id_2",
      "name": "麻婆豆腐",
      "price": 12.0,
      "category": "素菜"
    }
  ],
  "publishTime": "2024-01-15T17:00:00.000Z",
  "effectiveTime": "2024-01-16T11:30:00.000Z"
}
```

**响应示例**:
```json
{
  "success": true,
  "message": "菜单发布成功",
  "data": {
    "menuId": "menu_id_123",
    "date": "2024-01-16",
    "mealType": "lunch",
    "status": "published",
    "publishTime": "2024-01-15T17:00:00.000Z",
    "effectiveTime": "2024-01-16T11:30:00.000Z"
  }
}
```

---

### 5. 获取菜单历史

**接口地址**: `GET /api/admin/menu/history`

**接口描述**: 获取菜单发布历史

**请求头**:
```http
Authorization: Bearer {token}
```

**查询参数**:
```
page: number          // 页码，默认1
pageSize: number      // 每页数量，默认20，最大100
startDate: string     // 开始日期，格式：YYYY-MM-DD（可选）
endDate: string       // 结束日期，格式：YYYY-MM-DD（可选）
mealType: string      // 餐次类型筛选（可选）
```

**响应示例**:
```json
{
  "success": true,
  "message": "获取菜单历史成功",
  "data": {
    "list": [
      {
        "_id": "menu_id_1",
        "date": "2024-01-15",
        "mealType": "lunch",
        "status": "published",
        "dishes": [
          {
            "name": "宫保鸡丁",
            "price": 15.0
          },
          {
            "name": "麻婆豆腐",
            "price": 12.0
          }
        ],
        "publishTime": "2024-01-14T17:00:00.000Z",
        "effectiveTime": "2024-01-15T11:30:00.000Z",
        "orderCount": 245,
        "totalAmount": 3675.0
      }
    ],
    "pagination": {
      "page": 1,
      "pageSize": 20,
      "total": 45,
      "totalPages": 3
    }
  }
}
```

---

### 6. 获取菜单模板

**接口地址**: `GET /api/admin/menu/templates`

**接口描述**: 获取菜单模板列表

**请求头**:
```http
Authorization: Bearer {token}
```

**响应示例**:
```json
{
  "success": true,
  "message": "获取菜单模板成功",
  "data": [
    {
      "_id": "template_id_1",
      "name": "工作日午餐模板",
      "mealType": "lunch",
      "dishes": [
        {
          "dishId": "dish_id_1",
          "name": "宫保鸡丁",
          "price": 15.0,
          "category": "荤菜"
        },
        {
          "dishId": "dish_id_2",
          "name": "麻婆豆腐",
          "price": 12.0,
          "category": "素菜"
        }
      ],
      "usageCount": 25,
      "createTime": "2024-01-01T00:00:00.000Z"
    }
  ]
}
```

---

### 7. 撤回菜单

**接口地址**: `PUT /api/admin/menu/:menuId/revoke`

**接口描述**: 撤回已发布的菜单

**请求头**:
```http
Authorization: Bearer {token}
Content-Type: application/json
```

**路径参数**:
```
menuId: string  // 菜单ID
```

**响应示例**:
```json
{
  "success": true,
  "message": "菜单撤回成功",
  "data": {
    "menuId": "menu_id_1",
    "oldStatus": "published",
    "newStatus": "revoked",
    "revokeTime": "2024-01-15T16:30:00.000Z",
    "revokedBy": "admin_id"
  }
}
```

---

### 8. 删除菜单模板

**接口地址**: `DELETE /api/admin/menu/templates/:templateId`

**接口描述**: 删除菜单模板

**请求头**:
```http
Authorization: Bearer {token}
```

**路径参数**:
```
templateId: string  // 模板ID
```

**响应示例**:
```json
{
  "success": true,
  "message": "菜单模板删除成功",
  "data": {
    "templateId": "template_id_1",
    "deleteTime": "2024-01-15T16:30:00.000Z",
    "deletedBy": "admin_id"
  }
}
```

---

## 👥 用户管理模块

### 9. 获取用户列表

**接口地址**: `GET /api/admin/users`

**接口描述**: 获取用户列表，支持分页和筛选

**请求头**:
```http
Authorization: Bearer {token}
```

**查询参数**:
```
page: number          // 页码，默认1
size: number          // 每页数量，默认20，最大100
departmentId: string  // 部门ID筛选（可选）
role: string          // 角色筛选（可选）
status: string        // 状态筛选（可选）
keyword: string       // 关键词搜索（姓名/手机号/邮箱）
```

**响应示例**:
```json
{
  "success": true,
  "message": "获取用户列表成功",
  "data": {
    "list": [
      {
        "_id": "user_id_1",
        "nickName": "张三",
        "realName": "张三",
        "phoneNumber": "13800138000",
        "email": "zhangsan@example.com",
        "department": "技术部",
        "position": "软件工程师",
        "role": "user",
        "status": "active",
        "createTime": "2023-01-01T00:00:00.000Z",
        "lastLoginTime": "2024-01-15T10:30:00.000Z"
      }
    ],
    "pagination": {
      "page": 1,
      "size": 20,
      "total": 156,
      "totalPages": 8
    }
  }
}
```

---

### 10. 创建用户

**接口地址**: `POST /api/admin/users`

**接口描述**: 创建新用户

**请求头**:
```http
Authorization: Bearer {token}
Content-Type: application/json
```

**请求参数**:
```json
{
  "nickName": "李四",
  "realName": "李四",
  "phoneNumber": "13800138001",
  "email": "lisi@example.com",
  "departmentId": "dept_id_1",
  "position": "产品经理",
  "role": "user",
  "employeeId": "EMP002",
  "joinDate": "2024-01-01"
}
```

**响应示例**:
```json
{
  "success": true,
  "message": "用户创建成功",
  "data": {
    "userId": "user_id_2",
    "nickName": "李四",
    "realName": "李四",
    "phoneNumber": "13800138001",
    "createTime": "2024-01-15T16:30:00.000Z"
  }
}
```

---

### 11. 更新用户信息

**接口地址**: `PUT /api/admin/users/:userId`

**接口描述**: 更新用户信息

**请求头**:
```http
Authorization: Bearer {token}
Content-Type: application/json
```

**路径参数**:
```
userId: string  // 用户ID
```

**请求参数**:
```json
{
  "nickName": "李四",
  "realName": "李四",
  "email": "lisi@example.com",
  "departmentId": "dept_id_1",
  "position": "高级产品经理",
  "role": "dept_admin"
}
```

**响应示例**:
```json
{
  "success": true,
  "message": "用户信息更新成功",
  "data": {
    "userId": "user_id_2",
    "updateTime": "2024-01-15T16:30:00.000Z",
    "updatedFields": ["position", "role"]
  }
}
```

---

### 12. 删除用户

**接口地址**: `DELETE /api/admin/users/:userId`

**接口描述**: 删除用户（软删除）

**请求头**:
```http
Authorization: Bearer {token}
```

**路径参数**:
```
userId: string  // 用户ID
```

**响应示例**:
```json
{
  "success": true,
  "message": "用户删除成功",
  "data": {
    "userId": "user_id_2",
    "deleteTime": "2024-01-15T16:30:00.000Z",
    "deletedBy": "admin_id"
  }
}
```

---

## 🏢 部门管理模块

### 13. 获取部门列表

**接口地址**: `GET /api/admin/departments`

**接口描述**: 获取部门列表

**请求头**:
```http
Authorization: Bearer {token}
```

**响应示例**:
```json
{
  "success": true,
  "message": "获取部门列表成功",
  "data": [
    {
      "_id": "dept_id_1",
      "name": "技术部",
      "code": "TECH",
      "parentId": null,
      "level": 1,
      "sort": 1,
      "managerId": "user_id_1",
      "managerName": "张三",
      "memberCount": 45,
      "status": "active",
      "createTime": "2023-01-01T00:00:00.000Z"
    }
  ]
}
```

---

### 14. 创建部门

**接口地址**: `POST /api/admin/departments`

**接口描述**: 创建新部门

**请求头**:
```http
Authorization: Bearer {token}
Content-Type: application/json
```

**请求参数**:
```json
{
  "name": "前端组",
  "code": "FE",
  "parentId": "dept_id_1",
  "managerId": "user_id_2",
  "sort": 2,
  "description": "负责前端开发工作"
}
```

**响应示例**:
```json
{
  "success": true,
  "message": "部门创建成功",
  "data": {
    "departmentId": "dept_id_2",
    "name": "前端组",
    "code": "FE",
    "createTime": "2024-01-15T16:30:00.000Z"
  }
}
```

---

## 📊 数据统计模块

### 15. 获取报餐统计

**接口地址**: `GET /api/admin/dining/stats`

**接口描述**: 获取报餐统计数据

**请求头**:
```http
Authorization: Bearer {token}
```

**查询参数**:
```
startDate: string  // 开始日期，格式：YYYY-MM-DD
endDate: string    // 结束日期，格式：YYYY-MM-DD
```

**响应示例**:
```json
{
  "success": true,
  "message": "获取报餐统计成功",
  "data": {
    "period": "2024-01-01 至 2024-01-15",
    "totalOrders": 2340,
    "totalAmount": 66750.0,
    "averageOrderAmount": 28.5,
    "byMealType": {
      "breakfast": {
        "orders": 780,
        "amount": 15600.0,
        "percentage": "33.3%"
      },
      "lunch": {
        "orders": 1200,
        "amount": 36000.0,
        "percentage": "51.3%"
      },
      "dinner": {
        "orders": 360,
        "amount": 15150.0,
        "percentage": "15.4%"
      }
    },
    "byDepartment": [
      {
        "deptName": "技术部",
        "orders": 890,
        "amount": 25350.0,
        "percentage": "38.0%"
      },
      {
        "deptName": "人事部",
        "orders": 450,
        "amount": 12800.0,
        "percentage": "19.2%"
      }
    ],
    "trends": {
      "daily": [
        {
          "date": "2024-01-01",
          "orders": 156,
          "amount": 4450.0
        }
      ]
    }
  }
}
```

---

### 16. 获取预约统计

**接口地址**: `GET /api/admin/reservation/stats`

**接口描述**: 获取预约统计数据

**请求头**:
```http
Authorization: Bearer {token}
```

**查询参数**:
```
startDate: string  // 开始日期，格式：YYYY-MM-DD
endDate: string    // 结束日期，格式：YYYY-MM-DD
```

**响应示例**:
```json
{
  "success": true,
  "message": "获取预约统计成功",
  "data": {
    "period": "2024-01-01 至 2024-01-15",
    "totalReservations": 890,
    "approvedReservations": 756,
    "rejectedReservations": 45,
    "cancelledReservations": 89,
    "approvalRate": "85.0%",
    "byVenue": [
      {
        "venueName": "会议室A",
        "reservations": 234,
        "utilization": "65.2%",
        "amount": 23400.0
      },
      {
        "venueName": "活动室B",
        "reservations": 156,
        "utilization": "52.1%",
        "amount": 31200.0
      }
    ],
    "byTimeSlot": [
      {
        "timeSlot": "09:00-12:00",
        "reservations": 234,
        "percentage": "26.3%"
      },
      {
        "timeSlot": "14:00-18:00",
        "reservations": 456,
        "percentage": "51.2%"
      }
    ]
  }
}
```

---

## 📱 前端集成示例

### JavaScript示例

```javascript
// 获取系统统计
async function getSystemStats() {
  try {
    const token = localStorage.getItem('token');
    const response = await fetch('/api/admin/system-stats', {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`
      }
    });
    
    const result = await response.json();
    
    if (result.success) {
      return result.data;
    } else {
      throw new Error(result.message);
    }
  } catch (error) {
    console.error('获取系统统计失败:', error);
    throw error;
  }
}

// 发布菜单
async function publishMenu(menuData) {
  try {
    const token = localStorage.getItem('token');
    const response = await fetch('/api/admin/menu/publish', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(menuData)
    });
    
    const result = await response.json();
    
    if (result.success) {
      return result.data;
    } else {
      throw new Error(result.message);
    }
  } catch (error) {
    console.error('发布菜单失败:', error);
    throw error;
  }
}

// 获取用户列表
async function getUserList(params = {}) {
  try {
    const token = localStorage.getItem('token');
    const queryString = new URLSearchParams(params).toString();
    
    const response = await fetch(`/api/admin/users?${queryString}`, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`
      }
    });
    
    const result = await response.json();
    
    if (result.success) {
      return result.data;
    } else {
      throw new Error(result.message);
    }
  } catch (error) {
    console.error('获取用户列表失败:', error);
    throw error;
  }
}

// 创建用户
async function createUser(userData) {
  try {
    const token = localStorage.getItem('token');
    const response = await fetch('/api/admin/users', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(userData)
    });
    
    const result = await response.json();
    
    if (result.success) {
      return result.data;
    } else {
      throw new Error(result.message);
    }
  } catch (error) {
    console.error('创建用户失败:', error);
    throw error;
  }
}
```

### React组件示例

```jsx
import React, { useState, useEffect } from 'react';

// 系统状态组件
function SystemStatus() {
  const [status, setStatus] = useState(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    fetchSystemStatus();
  }, []);

  const fetchSystemStatus = async () => {
    try {
      setLoading(true);
      const data = await getSystemStatus();
      setStatus(data);
    } catch (error) {
      console.error('获取系统状态失败:', error);
    } finally {
      setLoading(false);
    }
  };

  if (loading) return <div>加载中...</div>;
  if (!status) return <div>暂无数据</div>;

  return (
    <div className="system-status">
      <h3>系统状态</h3>
      <div className="status-grid">
        <div className="status-item">
          <span className="status-label">服务器状态</span>
          <span className={`status-value ${status.serverStatus}`}>
            {status.serverStatus === 'running' ? '运行中' : '停止'}
          </span>
        </div>
        <div className="status-item">
          <span className="status-label">数据库状态</span>
          <span className={`status-value ${status.databaseStatus}`}>
            {status.databaseStatus === 'connected' ? '已连接' : '未连接'}
          </span>
        </div>
        <div className="status-item">
          <span className="status-label">CPU使用率</span>
          <span className="status-value">{status.cpuUsage}</span>
        </div>
        <div className="status-item">
          <span className="status-label">内存使用率</span>
          <span className="status-value">{status.memoryUsage}</span>
        </div>
        <div className="status-item">
          <span className="status-label">磁盘使用率</span>
          <span className="status-value">{status.diskUsage}</span>
        </div>
        <div className="status-item">
          <span className="status-label">运行时间</span>
          <span className="status-value">{status.uptime}</span>
        </div>
      </div>
    </div>
  );
}

// 菜单管理组件
function MenuManagement() {
  const [menus, setMenus] = useState([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    fetchMenuHistory();
  }, []);

  const fetchMenuHistory = async () => {
    try {
      setLoading(true);
      const data = await getMenuHistory();
      setMenus(data.list);
    } catch (error) {
      console.error('获取菜单历史失败:', error);
    } finally {
      setLoading(false);
    }
  };

  const handlePublishMenu = async (menuData) => {
    try {
      await publishMenu(menuData);
      fetchMenuHistory(); // 刷新列表
    } catch (error) {
      console.error('发布菜单失败:', error);
    }
  };

  if (loading) return <div>加载中...</div>;

  return (
    <div className="menu-management">
      <h3>菜单管理</h3>
      <div className="menu-list">
        {menus.map((menu) => (
          <div key={menu._id} className="menu-item">
            <div className="menu-header">
              <h4>{menu.date} - {getMealTypeName(menu.mealType)}</h4>
              <span className={`status-badge ${menu.status}`}>
                {getStatusName(menu.status)}
              </span>
            </div>
            <div className="menu-dishes">
              {menu.dishes.map((dish, index) => (
                <span key={index} className="dish-tag">
                  {dish.name} ¥{dish.price}
                </span>
              ))}
            </div>
            <div className="menu-footer">
              <span>订单数: {menu.orderCount}</span>
              <span>总金额: ¥{menu.totalAmount}</span>
              <span>发布时间: {formatDateTime(menu.publishTime)}</span>
            </div>
          </div>
        ))}
      </div>
    </div>
  );
}

// 获取餐次名称
function getMealTypeName(mealType) {
  const mealTypeNames = {
    'breakfast': '早餐',
    'lunch': '午餐',
    'dinner': '晚餐'
  };
  return mealTypeNames[mealType] || mealType;
}

// 获取状态名称
function getStatusName(status) {
  const statusNames = {
    'draft': '草稿',
    'published': '已发布',
    'revoked': '已撤回'
  };
  return statusNames[status] || status;
}

// 格式化日期时间
function formatDateTime(dateTime) {
  return new Date(dateTime).toLocaleString('zh-CN');
}
```

## 🔒 权限说明

### 管理员角色

| 角色 | 权限等级 | 功能描述 |
|------|----------|----------|
| `dept_admin` | 1 | 部门管理员，可管理本部门用户和查看统计数据 |
| `admin` | 2 | 管理员，可进行系统管理和用户管理 |
| `sys_admin` | 3 | 系统管理员，拥有所有权限，包括角色管理 |

### 权限验证

```javascript
// 检查管理员权限
function checkAdminPermission(userRole, requiredLevel) {
  const roleLevels = {
    'dept_admin': 1,
    'admin': 2,
    'sys_admin': 3
  };
  
  return roleLevels[userRole] >= requiredLevel;
}

// 使用示例
if (checkAdminPermission(user.role, 2)) {
  // 可以访问管理员功能
  showAdminFeatures();
} else {
  // 隐藏管理员功能
  hideAdminFeatures();
}
```

## ⚠️ 注意事项

1. **权限控制**: 所有管理员接口都需要相应的权限等级，前端需要根据用户角色控制显示
2. **数据安全**: 管理员接口涉及敏感数据，建议在生产环境使用HTTPS
3. **操作日志**: 所有管理操作都会记录详细日志，便于审计
4. **数据验证**: 所有输入数据都会进行严格验证，前端也需要进行相应的验证
5. **错误处理**: 接口返回详细的错误信息，前端需要妥善处理各种错误情况
6. **批量操作**: 批量操作接口有数量限制，避免一次性处理过多数据
7. **实时更新**: 统计数据会实时更新，建议定期刷新数据
8. **备份提醒**: 重要操作前建议进行数据备份
