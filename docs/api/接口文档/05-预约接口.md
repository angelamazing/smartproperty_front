# 预约接口文档

## 📋 接口概述

预约接口提供场地预约、预约管理、审核流程等预约相关功能。

**基础路径**: `/api/reservation`

**认证要求**: 所有接口都需要有效的JWT Token

## 🔐 接口列表

### 1. 获取可预约场地

**接口地址**: `GET /api/reservation/venues`

**接口描述**: 获取可预约的场地列表

**请求头**:
```http
Authorization: Bearer {token}
```

**查询参数**:
```
venueType: string  // 场地类型：meeting_room/activity_room/office（可选）
capacity: number   // 容纳人数筛选（可选）
date: string       // 日期筛选，格式：YYYY-MM-DD（可选）
```

**响应示例**:
```json
{
  "success": true,
  "message": "获取场地列表成功",
  "data": [
    {
      "_id": "venue_id_1",
      "name": "会议室A",
      "type": "meeting_room",
      "capacity": 20,
      "location": "3楼东侧",
      "facilities": ["投影仪", "白板", "音响"],
      "images": ["https://example.com/venue1.jpg"],
      "description": "适合小型会议和讨论",
      "hourlyRate": 100,
      "dailyRate": 800,
      "status": "available",
      "businessHours": "09:00-18:00"
    },
    {
      "_id": "venue_id_2",
      "name": "活动室B",
      "type": "activity_room",
      "capacity": 50,
      "location": "1楼大厅",
      "facilities": ["音响", "灯光", "舞台"],
      "images": ["https://example.com/venue2.jpg"],
      "description": "适合举办活动和培训",
      "hourlyRate": 200,
      "dailyRate": 1500,
      "status": "available",
      "businessHours": "08:00-22:00"
    }
  ]
}
```

---

### 2. 检查场地可用性

**接口地址**: `GET /api/reservation/venues/:venueId/availability`

**接口描述**: 检查指定场地在指定时间段的可用性

**请求头**:
```http
Authorization: Bearer {token}
```

**路径参数**:
```
venueId: string  // 场地ID
```

**查询参数**:
```
date: string           // 日期，格式：YYYY-MM-DD
startTime: string      // 开始时间，格式：HH:mm
endTime: string        // 结束时间，格式：HH:mm
```

**响应示例**:
```json
{
  "success": true,
  "message": "检查可用性成功",
  "data": {
    "venueId": "venue_id_1",
    "date": "2024-01-15",
    "startTime": "14:00",
    "endTime": "16:00",
    "available": true,
    "conflictingReservations": [],
    "availableSlots": [
      {
        "startTime": "09:00",
        "endTime": "12:00"
      },
      {
        "startTime": "14:00",
        "endTime": "18:00"
      }
    ]
  }
}
```

**时间冲突时的响应**:
```json
{
  "success": true,
  "message": "检查可用性成功",
  "data": {
    "venueId": "venue_id_1",
    "date": "2024-01-15",
    "startTime": "14:00",
    "endTime": "16:00",
    "available": false,
    "conflictingReservations": [
      {
        "reservationId": "res_id_1",
        "startTime": "13:00",
        "endTime": "15:00",
        "userName": "张三",
        "purpose": "部门会议"
      }
    ],
    "availableSlots": [
      {
        "startTime": "09:00",
        "endTime": "12:00"
      },
      {
        "startTime": "16:00",
        "endTime": "18:00"
      }
    ]
  }
}
```

---

### 3. 提交场地预约

**接口地址**: `POST /api/reservation/submit`

**接口描述**: 提交场地预约申请

**请求头**:
```http
Authorization: Bearer {token}
Content-Type: application/json
```

**请求参数**:
```json
{
  "venueId": "string",           // 场地ID
  "venueName": "string",         // 场地名称
  "reservationDate": "2024-01-15", // 预约日期
  "startTime": "14:00",          // 开始时间
  "endTime": "16:00",            // 结束时间
  "purpose": "部门会议",          // 使用目的
  "attendeeCount": 15,           // 参与人数
  "contactPerson": "张三",        // 联系人
  "contactPhone": "13800138000", // 联系电话
  "facilities": ["投影仪", "白板"], // 需要的设施（可选）
  "remark": "需要准备茶水"        // 备注（可选）
}
```

**响应示例**:
```json
{
  "success": true,
  "message": "预约申请提交成功",
  "data": {
    "reservationId": "res_id_123",
    "venueName": "会议室A",
    "reservationDate": "2024-01-15",
    "startTime": "14:00",
    "endTime": "16:00",
    "purpose": "部门会议",
    "status": "pending",
    "createTime": "2024-01-15T10:30:00.000Z"
  }
}
```

**错误响应**:
```json
{
  "success": false,
  "message": "预约失败",
  "error": "该时间段已被预约"
}
```

---

### 4. 获取我的预约

**接口地址**: `GET /api/reservation/my-reservations`

**接口描述**: 获取当前用户的预约记录

**请求头**:
```http
Authorization: Bearer {token}
```

**查询参数**:
```
page: number          // 页码，默认1
size: number          // 每页数量，默认20，最大100
status: string        // 状态筛选：pending/approved/rejected/completed/cancelled（可选）
startDate: string     // 开始日期筛选（可选）
endDate: string       // 结束日期筛选（可选）
```

**响应示例**:
```json
{
  "success": true,
  "message": "获取预约记录成功",
  "data": {
    "list": [
      {
        "_id": "res_id_1",
        "venueId": "venue_id_1",
        "venueName": "会议室A",
        "reservationDate": "2024-01-15",
        "startTime": "14:00",
        "endTime": "16:00",
        "purpose": "部门会议",
        "attendeeCount": 15,
        "status": "approved",
        "createTime": "2024-01-15T10:30:00.000Z",
        "approveTime": "2024-01-15T11:00:00.000Z",
        "approvedBy": "admin_id"
      }
    ],
    "pagination": {
      "page": 1,
      "size": 20,
      "total": 8,
      "totalPages": 1
    }
  }
}
```

---

### 5. 获取预约详情

**接口地址**: `GET /api/reservation/:reservationId/detail`

**接口描述**: 获取指定预约的详细信息

**请求头**:
```http
Authorization: Bearer {token}
```

**路径参数**:
```
reservationId: string  // 预约ID
```

**响应示例**:
```json
{
  "success": true,
  "message": "获取预约详情成功",
  "data": {
    "_id": "res_id_1",
    "userId": "user_id_1",
    "userName": "张三",
    "venueId": "venue_id_1",
    "venueName": "会议室A",
    "venueType": "meeting_room",
    "venueLocation": "3楼东侧",
    "reservationDate": "2024-01-15",
    "startTime": "14:00",
    "endTime": "16:00",
    "purpose": "部门会议",
    "attendeeCount": 15,
    "contactPerson": "张三",
    "contactPhone": "13800138000",
    "facilities": ["投影仪", "白板"],
    "remark": "需要准备茶水",
    "status": "approved",
    "createTime": "2024-01-15T10:30:00.000Z",
    "approveTime": "2024-01-15T11:00:00.000Z",
    "approvedBy": "admin_id",
    "approvedByName": "管理员",
    "rejectReason": null,
    "venue": {
      "images": ["https://example.com/venue1.jpg"],
      "description": "适合小型会议和讨论",
      "hourlyRate": 100,
      "dailyRate": 800
    }
  }
}
```

---

### 6. 取消预约

**接口地址**: `PUT /api/reservation/:reservationId/cancel`

**接口描述**: 取消指定的预约

**请求头**:
```http
Authorization: Bearer {token}
Content-Type: application/json
```

**路径参数**:
```
reservationId: string  // 预约ID
```

**请求参数**:
```json
{
  "reason": "string"  // 取消原因（可选）
}
```

**响应示例**:
```json
{
  "success": true,
  "message": "预约取消成功",
  "data": {
    "reservationId": "res_id_1",
    "oldStatus": "approved",
    "newStatus": "cancelled",
    "cancelTime": "2024-01-15T13:30:00.000Z",
    "cancelReason": "会议改期"
  }
}
```

---

## 👥 管理员功能接口

### 7. 获取预约列表（管理员功能）

**接口地址**: `GET /api/reservation/list`

**接口描述**: 获取所有预约记录（需要部门管理员权限）

**请求头**:
```http
Authorization: Bearer {token}
```

**查询参数**:
```
page: number          // 页码，默认1
size: number          // 每页数量，默认20，最大100
status: string        // 状态筛选（可选）
venueId: string       // 场地ID筛选（可选）
startDate: string     // 开始日期筛选（可选）
endDate: string       // 结束日期筛选（可选）
userId: string        // 用户ID筛选（可选）
```

**响应示例**:
```json
{
  "success": true,
  "message": "获取预约列表成功",
  "data": {
    "list": [
      {
        "_id": "res_id_1",
        "userId": "user_id_1",
        "userName": "张三",
        "department": "技术部",
        "venueName": "会议室A",
        "reservationDate": "2024-01-15",
        "startTime": "14:00",
        "endTime": "16:00",
        "purpose": "部门会议",
        "attendeeCount": 15,
        "status": "pending",
        "createTime": "2024-01-15T10:30:00.000Z"
      }
    ],
    "pagination": {
      "page": 1,
      "size": 20,
      "total": 25,
      "totalPages": 2
    }
  }
}
```

---

### 8. 审核预约申请（管理员功能）

**接口地址**: `PUT /api/reservation/:reservationId/review`

**接口描述**: 审核预约申请（需要部门管理员权限）

**请求头**:
```http
Authorization: Bearer {token}
Content-Type: application/json
```

**路径参数**:
```
reservationId: string  // 预约ID
```

**请求参数**:
```json
{
  "action": "approve",     // 审核动作：approve/reject
  "remark": "同意使用",     // 审核备注（可选）
  "rejectReason": null     // 拒绝原因（reject时必填）
}
```

**响应示例**:
```json
{
  "success": true,
  "message": "预约审核成功",
  "data": {
    "reservationId": "res_id_1",
    "oldStatus": "pending",
    "newStatus": "approved",
    "reviewTime": "2024-01-15T11:00:00.000Z",
    "reviewedBy": "admin_id",
    "remark": "同意使用"
  }
}
```

---

### 9. 批量审核预约（管理员功能）

**接口地址**: `PUT /api/reservation/batch/review`

**接口描述**: 批量审核多个预约申请（需要部门管理员权限）

**请求头**:
```http
Authorization: Bearer {token}
Content-Type: application/json
```

**请求参数**:
```json
{
  "reservationIds": ["res_id_1", "res_id_2", "res_id_3"],  // 预约ID数组
  "action": "approve",     // 审核动作：approve/reject
  "remark": "批量审核通过"  // 审核备注（可选）
}
```

**响应示例**:
```json
{
  "success": true,
  "message": "批量审核成功",
  "data": {
    "approvedCount": 3,
    "failedCount": 0,
    "failedReservationIds": [],
    "reviewTime": "2024-01-15T11:00:00.000Z",
    "reviewedBy": "admin_id"
  }
}
```

---

### 10. 获取预约统计（管理员功能）

**接口地址**: `GET /api/reservation/stats`

**接口描述**: 获取预约统计数据（需要部门管理员权限）

**请求头**:
```http
Authorization: Bearer {token}
```

**查询参数**:
```
date: string  // 统计日期，格式：YYYY-MM-DD，默认今日
```

**响应示例**:
```json
{
  "success": true,
  "message": "获取预约统计成功",
  "data": {
    "date": "2024-01-15",
    "totalReservations": 12,
    "pendingReservations": 3,
    "approvedReservations": 8,
    "rejectedReservations": 1,
    "cancelledReservations": 0,
    "byVenue": [
      {
        "venueName": "会议室A",
        "reservations": 5,
        "utilization": "62.5%"
      },
      {
        "venueName": "活动室B",
        "reservations": 4,
        "utilization": "50.0%"
      }
    ],
    "byTimeSlot": [
      {
        "timeSlot": "09:00-12:00",
        "reservations": 4
      },
      {
        "timeSlot": "14:00-18:00",
        "reservations": 8
      }
    ]
  }
}
```

---

## 📊 数据结构说明

### 场地类型 (venueType)

| 值 | 说明 | 描述 |
|----|------|------|
| `meeting_room` | 会议室 | 适合会议和讨论 |
| `activity_room` | 活动室 | 适合活动和培训 |
| `office` | 办公室 | 适合办公和洽谈 |

### 预约状态 (status)

| 值 | 说明 | 描述 |
|----|------|------|
| `pending` | 待审核 | 预约申请已提交，等待审核 |
| `approved` | 已批准 | 预约申请已批准，可以使用 |
| `rejected` | 已拒绝 | 预约申请被拒绝 |
| `completed` | 已完成 | 预约时间已过，预约完成 |
| `cancelled` | 已取消 | 预约被取消 |

### 场地状态 (status)

| 值 | 说明 | 描述 |
|----|------|------|
| `available` | 可用 | 场地可以预约 |
| `maintenance` | 维护中 | 场地正在维护，不可预约 |
| `unavailable` | 不可用 | 场地暂时不可用 |

## 📱 前端集成示例

### JavaScript示例

```javascript
// 获取可预约场地
async function getVenues(params = {}) {
  try {
    const token = localStorage.getItem('token');
    const queryString = new URLSearchParams(params).toString();
    
    const response = await fetch(`/api/reservation/venues?${queryString}`, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`
      }
    });
    
    const result = await response.json();
    
    if (result.success) {
      return result.data;
    } else {
      throw new Error(result.message);
    }
  } catch (error) {
    console.error('获取场地列表失败:', error);
    throw error;
  }
}

// 检查场地可用性
async function checkAvailability(venueId, date, startTime, endTime) {
  try {
    const token = localStorage.getItem('token');
    const params = new URLSearchParams({
      date,
      startTime,
      endTime
    });
    
    const response = await fetch(`/api/reservation/venues/${venueId}/availability?${params.toString()}`, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`
      }
    });
    
    const result = await response.json();
    
    if (result.success) {
      return result.data;
    } else {
      throw new Error(result.message);
    }
  } catch (error) {
    console.error('检查可用性失败:', error);
    throw error;
  }
}

// 提交预约申请
async function submitReservation(reservationData) {
  try {
    const token = localStorage.getItem('token');
    const response = await fetch('/api/reservation/submit', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(reservationData)
    });
    
    const result = await response.json();
    
    if (result.success) {
      return result.data;
    } else {
      throw new Error(result.message);
    }
  } catch (error) {
    console.error('提交预约失败:', error);
    throw error;
  }
}

// 获取我的预约
async function getMyReservations(params = {}) {
  try {
    const token = localStorage.getItem('token');
    const queryString = new URLSearchParams(params).toString();
    
    const response = await fetch(`/api/reservation/my-reservations?${queryString}`, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`
      }
    });
    
    const result = await response.json();
    
    if (result.success) {
      return result.data;
    } else {
      throw new Error(result.message);
    }
  } catch (error) {
    console.error('获取预约记录失败:', error);
    throw error;
  }
}
```

### React组件示例

```jsx
import React, { useState, useEffect } from 'react';

// 场地选择组件
function VenueSelection({ onVenueSelect }) {
  const [venues, setVenues] = useState([]);
  const [loading, setLoading] = useState(true);
  const [selectedVenue, setSelectedVenue] = useState(null);

  useEffect(() => {
    fetchVenues();
  }, []);

  const fetchVenues = async () => {
    try {
      setLoading(true);
      const data = await getVenues();
      setVenues(data);
    } catch (error) {
      console.error('获取场地失败:', error);
    } finally {
      setLoading(false);
    }
  };

  const handleVenueSelect = (venue) => {
    setSelectedVenue(venue);
    onVenueSelect(venue);
  };

  if (loading) return <div>加载中...</div>;

  return (
    <div className="venue-selection">
      <h3>选择场地</h3>
      <div className="venues-grid">
        {venues.map((venue) => (
          <div 
            key={venue._id} 
            className={`venue-item ${selectedVenue?._id === venue._id ? 'selected' : ''}`}
            onClick={() => handleVenueSelect(venue)}
          >
            <img src={venue.images[0]} alt={venue.name} />
            <h4>{venue.name}</h4>
            <p className="venue-type">{getVenueTypeName(venue.type)}</p>
            <p className="venue-capacity">容纳 {venue.capacity} 人</p>
            <p className="venue-location">{venue.location}</p>
            <p className="venue-rate">¥{venue.hourlyRate}/小时</p>
            <div className="venue-facilities">
              {venue.facilities.map((facility, index) => (
                <span key={index} className="facility-tag">{facility}</span>
              ))}
            </div>
          </div>
        ))}
      </div>
    </div>
  );
}

// 时间选择组件
function TimeSelection({ venue, onTimeSelect }) {
  const [selectedDate, setSelectedDate] = useState('');
  const [selectedStartTime, setSelectedStartTime] = useState('');
  const [selectedEndTime, setSelectedEndTime] = useState('');
  const [availability, setAvailability] = useState(null);

  const handleTimeCheck = async () => {
    if (!selectedDate || !selectedStartTime || !selectedEndTime) return;
    
    try {
      const data = await checkAvailability(
        venue._id,
        selectedDate,
        selectedStartTime,
        selectedEndTime
      );
      setAvailability(data);
      
      if (data.available) {
        onTimeSelect({
          date: selectedDate,
          startTime: selectedStartTime,
          endTime: selectedEndTime
        });
      }
    } catch (error) {
      console.error('检查可用性失败:', error);
    }
  };

  return (
    <div className="time-selection">
      <h3>选择时间</h3>
      <div className="time-inputs">
        <input
          type="date"
          value={selectedDate}
          onChange={(e) => setSelectedDate(e.target.value)}
          min={new Date().toISOString().split('T')[0]}
        />
        <input
          type="time"
          value={selectedStartTime}
          onChange={(e) => setSelectedStartTime(e.target.value)}
        />
        <input
          type="time"
          value={selectedEndTime}
          onChange={(e) => setSelectedEndTime(e.target.value)}
        />
        <button onClick={handleTimeCheck}>检查可用性</button>
      </div>
      
      {availability && (
        <div className={`availability-result ${availability.available ? 'available' : 'unavailable'}`}>
          {availability.available ? (
            <p>✅ 该时间段可用</p>
          ) : (
            <div>
              <p>❌ 该时间段不可用</p>
              <p>冲突预约：</p>
              <ul>
                {availability.conflictingReservations.map((conflict) => (
                  <li key={conflict.reservationId}>
                    {conflict.startTime}-{conflict.endTime} - {conflict.userName} ({conflict.purpose})
                  </li>
                ))}
              </ul>
            </div>
          )}
        </div>
      )}
    </div>
  );
}

// 获取场地类型名称
function getVenueTypeName(type) {
  const typeNames = {
    'meeting_room': '会议室',
    'activity_room': '活动室',
    'office': '办公室'
  };
  return typeNames[type] || type;
}
```

## 🔄 业务流程说明

### 预约流程

1. **选择场地**: 用户浏览可用场地列表
2. **检查可用性**: 用户选择时间并检查场地可用性
3. **提交申请**: 用户填写预约信息并提交申请
4. **管理员审核**: 管理员审核预约申请
5. **预约确认**: 申请通过后，预约生效
6. **使用场地**: 用户在预约时间使用场地
7. **预约完成**: 预约时间结束后，预约状态变为完成

### 取消流程

1. **申请取消**: 用户在预约时间前申请取消
2. **系统处理**: 系统自动处理取消申请
3. **预约取消**: 预约状态变为已取消

## ⚠️ 注意事项

1. **权限控制**: 管理员功能需要部门管理员权限，前端需要根据用户角色控制显示
2. **时间限制**: 预约需要提前申请，取消也需要提前操作
3. **场地冲突**: 同一时间段只能有一个预约，系统会自动检查冲突
4. **状态管理**: 预约状态变更会记录操作日志，便于审计
5. **数据验证**: 所有输入数据都会进行验证，前端也需要进行相应的验证
6. **错误处理**: 接口返回详细的错误信息，前端需要妥善处理各种错误情况
7. **实时更新**: 场地可用性会实时更新，建议在关键操作后刷新数据
