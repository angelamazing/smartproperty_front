# æŠ¥é¤è®°å½•æ—¶é—´æ®µæŸ¥è¯¢åŠŸèƒ½æ–‡æ¡£

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

æœ¬æ¬¡æ›´æ–°ä¸º `GET /api/dining/records` æ¥å£æ·»åŠ äº†æ—¶é—´æ®µæŸ¥è¯¢åŠŸèƒ½ï¼Œæ”¯æŒæ›´çµæ´»çš„æ—¥æœŸç­›é€‰æ¡ä»¶ã€‚

## ğŸ†• æ–°å¢åŠŸèƒ½

### 1. æ—¶é—´æ®µæŸ¥è¯¢å‚æ•°

| å‚æ•°å | ç±»å‹ | å¿…å¡« | è¯´æ˜ | ç¤ºä¾‹ |
|--------|------|------|------|------|
| `startDate` | string | å¦ | å¼€å§‹æ—¥æœŸ (YYYY-MM-DD) | `2025-09-01` |
| `endDate` | string | å¦ | ç»“æŸæ—¥æœŸ (YYYY-MM-DD) | `2025-09-05` |

### 2. æŸ¥è¯¢æ¨¡å¼

#### æ¨¡å¼1ï¼šå•æ—¥æŸ¥è¯¢ï¼ˆåŸæœ‰åŠŸèƒ½ï¼‰
```
GET /api/dining/records?date=2025-09-05&page=1&pageSize=20
```

#### æ¨¡å¼2ï¼šæ—¶é—´æ®µæŸ¥è¯¢ï¼ˆæ–°å¢åŠŸèƒ½ï¼‰
```
GET /api/dining/records?startDate=2025-09-01&endDate=2025-09-05&page=1&pageSize=20
```

#### æ¨¡å¼3ï¼šå¼€å§‹æ—¥æœŸæŸ¥è¯¢ï¼ˆæ–°å¢åŠŸèƒ½ï¼‰
```
GET /api/dining/records?startDate=2025-09-01&page=1&pageSize=20
```

#### æ¨¡å¼4ï¼šç»“æŸæ—¥æœŸæŸ¥è¯¢ï¼ˆæ–°å¢åŠŸèƒ½ï¼‰
```
GET /api/dining/records?endDate=2025-09-05&page=1&pageSize=20
```

#### æ¨¡å¼5ï¼šç»„åˆæŸ¥è¯¢ï¼ˆæ–°å¢åŠŸèƒ½ï¼‰
```
GET /api/dining/records?startDate=2025-09-01&endDate=2025-09-05&status=confirmed&page=1&pageSize=20
```

## ğŸ”§ æŠ€æœ¯å®ç°

### 1. éªŒè¯è§„åˆ™æ›´æ–°

**æ–‡ä»¶**: `utils/validation.js`

```javascript
getDiningRecords: Joi.object({
  date: Joi.string().pattern(/^\d{4}-\d{2}-\d{2}$/).allow(''),
  startDate: Joi.string().pattern(/^\d{4}-\d{2}-\d{2}$/).allow(''),
  endDate: Joi.string().pattern(/^\d{4}-\d{2}-\d{2}$/).allow(''),
  status: Joi.string().valid('pending', 'confirmed', 'completed', 'cancelled').allow(''),
  page: commonSchemas.page,
  pageSize: commonSchemas.pageSize
}).custom((value, helpers) => {
  // éªŒè¯æ—¥æœŸèŒƒå›´é€»è¾‘
  const { date, startDate, endDate } = value;
  
  // ä¸èƒ½åŒæ—¶ä½¿ç”¨dateå’ŒstartDate/endDateå‚æ•°
  if (date && (startDate || endDate)) {
    return helpers.error('ä¸èƒ½åŒæ—¶ä½¿ç”¨dateå’ŒstartDate/endDateå‚æ•°');
  }
  
  // éªŒè¯æ—¥æœŸèŒƒå›´
  if (startDate && endDate) {
    const start = new Date(startDate);
    const end = new Date(endDate);
    
    if (start > end) {
      return helpers.error('å¼€å§‹æ—¥æœŸä¸èƒ½æ™šäºç»“æŸæ—¥æœŸ');
    }
    
    // æ£€æŸ¥æ—¥æœŸèŒƒå›´ä¸èƒ½è¶…è¿‡ä¸€å¹´
    const oneYear = 365 * 24 * 60 * 60 * 1000;
    if (end - start > oneYear) {
      return helpers.error('æŸ¥è¯¢æ—¶é—´èŒƒå›´ä¸èƒ½è¶…è¿‡ä¸€å¹´');
    }
  }
  
  return value;
})
```

### 2. æ§åˆ¶å™¨å±‚æ›´æ–°

**æ–‡ä»¶**: `controllers/diningController.js`

```javascript
async getDiningRecords(req, res) {
  try {
    const userId = req.user.id;
    const { date, startDate, endDate, status, page = 1, pageSize = 20 } = req.query;
    
    // ç¡®ä¿å‚æ•°ä¸ºæœ‰æ•ˆå€¼æˆ–ç©ºå­—ç¬¦ä¸²
    const filters = { 
      date: date || '', 
      startDate: startDate || '',
      endDate: endDate || '',
      status: status || '' 
    };
    
    // ç¡®ä¿åˆ†é¡µå‚æ•°æ˜¯æœ‰æ•ˆæ•°å­—
    const pageNum = parseInt(page) || 1;
    const pageSizeNum = parseInt(pageSize) || 20;
    
    const result = await diningService.getDiningRecords(userId, filters, pageNum, pageSizeNum, req.db);
    
    return response.pagination(res, result.records, result.total, result.page, result.pageSize, 'è·å–æŠ¥é¤è®°å½•æˆåŠŸ');
  } catch (error) {
    logger.error('è·å–æŠ¥é¤è®°å½•å¤±è´¥:', error);
    return response.serverError(res, 'è·å–æŠ¥é¤è®°å½•å¤±è´¥', error.message);
  }
}
```

### 3. æœåŠ¡å±‚æ›´æ–°

**æ–‡ä»¶**: `services/diningService.js`

```javascript
async getDiningRecords(userId, filters, page, pageSize, db) {
  try {
    // åŸºç¡€æŸ¥è¯¢æ¡ä»¶
    let whereClause = 'WHERE registrantId = ?';
    let whereValues = [userId];
    
    // æ„å»ºç­›é€‰æ¡ä»¶
    if (filters.date && filters.date.trim() !== '') {
      // å•æ—¥æŸ¥è¯¢
      whereClause += ' AND diningDate = ?';
      whereValues.push(filters.date);
    } else if (filters.startDate && filters.endDate && 
               filters.startDate.trim() !== '' && filters.endDate.trim() !== '') {
      // æ—¶é—´æ®µæŸ¥è¯¢
      whereClause += ' AND diningDate BETWEEN ? AND ?';
      whereValues.push(filters.startDate, filters.endDate);
    } else if (filters.startDate && filters.startDate.trim() !== '') {
      // å¼€å§‹æ—¥æœŸæŸ¥è¯¢
      whereClause += ' AND diningDate >= ?';
      whereValues.push(filters.startDate);
    } else if (filters.endDate && filters.endDate.trim() !== '') {
      // ç»“æŸæ—¥æœŸæŸ¥è¯¢
      whereClause += ' AND diningDate <= ?';
      whereValues.push(filters.endDate);
    }
    
    if (filters.status && filters.status.trim() !== '') {
      whereClause += ' AND status = ?';
      whereValues.push(filters.status);
    }
    
    // æŸ¥è¯¢æ€»æ•°å’Œè®°å½•åˆ—è¡¨...
  } catch (error) {
    logger.error('è·å–æŠ¥é¤è®°å½•å¤±è´¥:', error);
    throw error;
  }
}
```

## ğŸ“Š æµ‹è¯•ç»“æœ

### æµ‹è¯•ç”¨ä¾‹

| æµ‹è¯•åœºæ™¯ | URL | çŠ¶æ€ç  | ç»“æœ |
|----------|-----|--------|------|
| å•æ—¥æŸ¥è¯¢ | `/api/dining/records?date=2025-09-05` | 200 | âœ… æˆåŠŸ |
| æ—¶é—´æ®µæŸ¥è¯¢ | `/api/dining/records?startDate=2025-09-01&endDate=2025-09-05` | 200 | âœ… æˆåŠŸ |
| å¼€å§‹æ—¥æœŸæŸ¥è¯¢ | `/api/dining/records?startDate=2025-09-01` | 200 | âœ… æˆåŠŸ |
| ç»“æŸæ—¥æœŸæŸ¥è¯¢ | `/api/dining/records?endDate=2025-09-05` | 200 | âœ… æˆåŠŸ |
| ç»„åˆæŸ¥è¯¢ | `/api/dining/records?startDate=2025-09-01&endDate=2025-09-05&status=confirmed` | 200 | âœ… æˆåŠŸ |

### éªŒè¯è§„åˆ™æµ‹è¯•

| æµ‹è¯•åœºæ™¯ | é¢„æœŸç»“æœ | å®é™…ç»“æœ |
|----------|----------|----------|
| åŒæ—¶ä½¿ç”¨dateå’ŒstartDate | è¿”å›é”™è¯¯ | âœ… æ­£ç¡® |
| startDate > endDate | è¿”å›é”™è¯¯ | âœ… æ­£ç¡® |
| æ—¥æœŸèŒƒå›´è¶…è¿‡ä¸€å¹´ | è¿”å›é”™è¯¯ | âœ… æ­£ç¡® |

## ğŸ¯ ä½¿ç”¨ç¤ºä¾‹

### 1. æŸ¥è¯¢æœ€è¿‘ä¸€å‘¨çš„æŠ¥é¤è®°å½•

```bash
curl -X GET "http://localhost:3000/api/dining/records?startDate=2025-08-29&endDate=2025-09-05&page=1&pageSize=20" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### 2. æŸ¥è¯¢9æœˆ1æ—¥ä¹‹åçš„å·²ç¡®è®¤æŠ¥é¤è®°å½•

```bash
curl -X GET "http://localhost:3000/api/dining/records?startDate=2025-09-01&status=confirmed&page=1&pageSize=20" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### 3. æŸ¥è¯¢9æœˆ5æ—¥ä¹‹å‰çš„å¾…ç¡®è®¤æŠ¥é¤è®°å½•

```bash
curl -X GET "http://localhost:3000/api/dining/records?endDate=2025-09-05&status=pending&page=1&pageSize=20" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **å‚æ•°äº’æ–¥**: ä¸èƒ½åŒæ—¶ä½¿ç”¨ `date` å’Œ `startDate`/`endDate` å‚æ•°
2. **æ—¥æœŸæ ¼å¼**: æ‰€æœ‰æ—¥æœŸå‚æ•°å¿…é¡»ä½¿ç”¨ `YYYY-MM-DD` æ ¼å¼
3. **æ—¥æœŸèŒƒå›´**: æŸ¥è¯¢æ—¶é—´èŒƒå›´ä¸èƒ½è¶…è¿‡ä¸€å¹´
4. **æ—¥æœŸé€»è¾‘**: å¼€å§‹æ—¥æœŸä¸èƒ½æ™šäºç»“æŸæ—¥æœŸ
5. **å‘åå…¼å®¹**: åŸæœ‰çš„å•æ—¥æŸ¥è¯¢åŠŸèƒ½å®Œå…¨ä¿ç•™ï¼Œä¸å½±å“ç°æœ‰åŠŸèƒ½

## ğŸ”„ ç‰ˆæœ¬ä¿¡æ¯

- **æ›´æ–°æ—¥æœŸ**: 2025-09-05
- **ç‰ˆæœ¬**: v1.1.0
- **æ›´æ–°ç±»å‹**: åŠŸèƒ½å¢å¼º
- **å½±å“èŒƒå›´**: æŠ¥é¤è®°å½•æŸ¥è¯¢æ¥å£
- **å‘åå…¼å®¹**: æ˜¯

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·è”ç³»å¼€å‘å›¢é˜Ÿã€‚

---

**æ›´æ–°å®Œæˆï¼** ğŸ‰ ç°åœ¨ `GET /api/dining/records` æ¥å£æ”¯æŒçµæ´»çš„æ—¶é—´æ®µæŸ¥è¯¢åŠŸèƒ½äº†ï¼
