# 报餐记录时间段查询功能文档

## 📋 功能概述

本次更新为 `GET /api/dining/records` 接口添加了时间段查询功能，支持更灵活的日期筛选条件。

## 🆕 新增功能

### 1. 时间段查询参数

| 参数名 | 类型 | 必填 | 说明 | 示例 |
|--------|------|------|------|------|
| `startDate` | string | 否 | 开始日期 (YYYY-MM-DD) | `2025-09-01` |
| `endDate` | string | 否 | 结束日期 (YYYY-MM-DD) | `2025-09-05` |

### 2. 查询模式

#### 模式1：单日查询（原有功能）
```
GET /api/dining/records?date=2025-09-05&page=1&pageSize=20
```

#### 模式2：时间段查询（新增功能）
```
GET /api/dining/records?startDate=2025-09-01&endDate=2025-09-05&page=1&pageSize=20
```

#### 模式3：开始日期查询（新增功能）
```
GET /api/dining/records?startDate=2025-09-01&page=1&pageSize=20
```

#### 模式4：结束日期查询（新增功能）
```
GET /api/dining/records?endDate=2025-09-05&page=1&pageSize=20
```

#### 模式5：组合查询（新增功能）
```
GET /api/dining/records?startDate=2025-09-01&endDate=2025-09-05&status=confirmed&page=1&pageSize=20
```

## 🔧 技术实现

### 1. 验证规则更新

**文件**: `utils/validation.js`

```javascript
getDiningRecords: Joi.object({
  date: Joi.string().pattern(/^\d{4}-\d{2}-\d{2}$/).allow(''),
  startDate: Joi.string().pattern(/^\d{4}-\d{2}-\d{2}$/).allow(''),
  endDate: Joi.string().pattern(/^\d{4}-\d{2}-\d{2}$/).allow(''),
  status: Joi.string().valid('pending', 'confirmed', 'completed', 'cancelled').allow(''),
  page: commonSchemas.page,
  pageSize: commonSchemas.pageSize
}).custom((value, helpers) => {
  // 验证日期范围逻辑
  const { date, startDate, endDate } = value;
  
  // 不能同时使用date和startDate/endDate参数
  if (date && (startDate || endDate)) {
    return helpers.error('不能同时使用date和startDate/endDate参数');
  }
  
  // 验证日期范围
  if (startDate && endDate) {
    const start = new Date(startDate);
    const end = new Date(endDate);
    
    if (start > end) {
      return helpers.error('开始日期不能晚于结束日期');
    }
    
    // 检查日期范围不能超过一年
    const oneYear = 365 * 24 * 60 * 60 * 1000;
    if (end - start > oneYear) {
      return helpers.error('查询时间范围不能超过一年');
    }
  }
  
  return value;
})
```

### 2. 控制器层更新

**文件**: `controllers/diningController.js`

```javascript
async getDiningRecords(req, res) {
  try {
    const userId = req.user.id;
    const { date, startDate, endDate, status, page = 1, pageSize = 20 } = req.query;
    
    // 确保参数为有效值或空字符串
    const filters = { 
      date: date || '', 
      startDate: startDate || '',
      endDate: endDate || '',
      status: status || '' 
    };
    
    // 确保分页参数是有效数字
    const pageNum = parseInt(page) || 1;
    const pageSizeNum = parseInt(pageSize) || 20;
    
    const result = await diningService.getDiningRecords(userId, filters, pageNum, pageSizeNum, req.db);
    
    return response.pagination(res, result.records, result.total, result.page, result.pageSize, '获取报餐记录成功');
  } catch (error) {
    logger.error('获取报餐记录失败:', error);
    return response.serverError(res, '获取报餐记录失败', error.message);
  }
}
```

### 3. 服务层更新

**文件**: `services/diningService.js`

```javascript
async getDiningRecords(userId, filters, page, pageSize, db) {
  try {
    // 基础查询条件
    let whereClause = 'WHERE registrantId = ?';
    let whereValues = [userId];
    
    // 构建筛选条件
    if (filters.date && filters.date.trim() !== '') {
      // 单日查询
      whereClause += ' AND diningDate = ?';
      whereValues.push(filters.date);
    } else if (filters.startDate && filters.endDate && 
               filters.startDate.trim() !== '' && filters.endDate.trim() !== '') {
      // 时间段查询
      whereClause += ' AND diningDate BETWEEN ? AND ?';
      whereValues.push(filters.startDate, filters.endDate);
    } else if (filters.startDate && filters.startDate.trim() !== '') {
      // 开始日期查询
      whereClause += ' AND diningDate >= ?';
      whereValues.push(filters.startDate);
    } else if (filters.endDate && filters.endDate.trim() !== '') {
      // 结束日期查询
      whereClause += ' AND diningDate <= ?';
      whereValues.push(filters.endDate);
    }
    
    if (filters.status && filters.status.trim() !== '') {
      whereClause += ' AND status = ?';
      whereValues.push(filters.status);
    }
    
    // 查询总数和记录列表...
  } catch (error) {
    logger.error('获取报餐记录失败:', error);
    throw error;
  }
}
```

## 📊 测试结果

### 测试用例

| 测试场景 | URL | 状态码 | 结果 |
|----------|-----|--------|------|
| 单日查询 | `/api/dining/records?date=2025-09-05` | 200 | ✅ 成功 |
| 时间段查询 | `/api/dining/records?startDate=2025-09-01&endDate=2025-09-05` | 200 | ✅ 成功 |
| 开始日期查询 | `/api/dining/records?startDate=2025-09-01` | 200 | ✅ 成功 |
| 结束日期查询 | `/api/dining/records?endDate=2025-09-05` | 200 | ✅ 成功 |
| 组合查询 | `/api/dining/records?startDate=2025-09-01&endDate=2025-09-05&status=confirmed` | 200 | ✅ 成功 |

### 验证规则测试

| 测试场景 | 预期结果 | 实际结果 |
|----------|----------|----------|
| 同时使用date和startDate | 返回错误 | ✅ 正确 |
| startDate > endDate | 返回错误 | ✅ 正确 |
| 日期范围超过一年 | 返回错误 | ✅ 正确 |

## 🎯 使用示例

### 1. 查询最近一周的报餐记录

```bash
curl -X GET "http://localhost:3000/api/dining/records?startDate=2025-08-29&endDate=2025-09-05&page=1&pageSize=20" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### 2. 查询9月1日之后的已确认报餐记录

```bash
curl -X GET "http://localhost:3000/api/dining/records?startDate=2025-09-01&status=confirmed&page=1&pageSize=20" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### 3. 查询9月5日之前的待确认报餐记录

```bash
curl -X GET "http://localhost:3000/api/dining/records?endDate=2025-09-05&status=pending&page=1&pageSize=20" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

## 📝 注意事项

1. **参数互斥**: 不能同时使用 `date` 和 `startDate`/`endDate` 参数
2. **日期格式**: 所有日期参数必须使用 `YYYY-MM-DD` 格式
3. **日期范围**: 查询时间范围不能超过一年
4. **日期逻辑**: 开始日期不能晚于结束日期
5. **向后兼容**: 原有的单日查询功能完全保留，不影响现有功能

## 🔄 版本信息

- **更新日期**: 2025-09-05
- **版本**: v1.1.0
- **更新类型**: 功能增强
- **影响范围**: 报餐记录查询接口
- **向后兼容**: 是

## 📞 技术支持

如有问题或建议，请联系开发团队。

---

**更新完成！** 🎉 现在 `GET /api/dining/records` 接口支持灵活的时间段查询功能了！
