å¾ˆå¥½ï¼ç°åœ¨è®©æˆ‘ä¸ºä½ æä¾›å®Œæ•´çš„å‰ç«¯å¯¹æ¥æ–¹æ¡ˆã€‚

## ğŸ¯ å‰ç«¯å¯¹æ¥æ–¹æ¡ˆ

### 1. **å¤´åƒæ˜¾ç¤ºç»„ä»¶**

åˆ›å»ºä¸€ä¸ªé€šç”¨çš„å¤´åƒç»„ä»¶ï¼š

```vue
<!-- components/UserAvatar.vue -->
<template>
  <div class="user-avatar" :class="sizeClass">
    <img
      v-if="avatarUrl && !isLoading && !hasError"
      :src="avatarUrl"
      :alt="userName"
      @error="handleImageError"
      @load="handleImageLoad"
      class="avatar-image"
    />
    <div
      v-else
      class="avatar-placeholder"
      :style="{ backgroundColor: placeholderColor }"
    >
      <span class="avatar-text">{{ avatarText }}</span>
    </div>
    <div v-if="isLoading" class="avatar-loading">
      <i class="el-icon-loading"></i>
    </div>
  </div>
</template>

<script>
export default {
  name: 'UserAvatar',
  props: {
    user: {
      type: Object,
      required: true
    },
    size: {
      type: String,
      default: 'medium', // small, medium, large, xlarge
      validator: value => ['small', 'medium', 'large', 'xlarge'].includes(value)
    },
    showName: {
      type: Boolean,
      default: false
    }
  },
  data() {
    return {
      isLoading: true,
      hasError: false,
      fallbackAvatars: {
        sys_admin: '/images/avatars/sys-admin.svg',
        dept_admin: '/images/avatars/dept-admin.svg',
        user: '/images/avatars/user.svg',
        default: '/images/avatars/default-admin.svg'
      }
    }
  },
  computed: {
    userName() {
      return this.user.nickName || this.user.username || 'ç”¨æˆ·'
    },
    avatarUrl() {
      // ä¼˜å…ˆä½¿ç”¨ç”¨æˆ·å¤´åƒï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨è§’è‰²é»˜è®¤å¤´åƒ
      if (this.user.avatarUrl && !this.hasError) {
        return this.user.avatarUrl
      }
      
      // æ ¹æ®è§’è‰²è¿”å›é»˜è®¤å¤´åƒ
      const role = this.user.role || 'default'
      return this.fallbackAvatars[role] || this.fallbackAvatars.default
    },
    avatarText() {
      return this.userName.charAt(0).toUpperCase()
    },
    placeholderColor() {
      const colors = {
        sys_admin: '#ff6b6b',
        dept_admin: '#4ecdc4',
        user: '#a8edea',
        default: '#667eea'
      }
      return colors[this.user.role] || colors.default
    },
    sizeClass() {
      return `avatar-${this.size}`
    }
  },
  methods: {
    handleImageLoad() {
      this.isLoading = false
      this.hasError = false
    },
    handleImageError() {
      this.hasError = true
      this.isLoading = false
      console.warn(`å¤´åƒåŠ è½½å¤±è´¥: ${this.avatarUrl}`)
    }
  },
  mounted() {
    // å¦‚æœå¤´åƒURLæ˜¯å¤–éƒ¨é“¾æ¥ï¼Œè®¾ç½®åŠ è½½è¶…æ—¶
    if (this.user.avatarUrl && this.user.avatarUrl.startsWith('http')) {
      setTimeout(() => {
        if (this.isLoading) {
          this.hasError = true
          this.isLoading = false
        }
      }, 5000) // 5ç§’è¶…æ—¶
    } else {
      this.isLoading = false
    }
  }
}
</script>

<style scoped>
.user-avatar {
  position: relative;
  display: inline-block;
  border-radius: 50%;
  overflow: hidden;
}

.avatar-image {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.avatar-placeholder {
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: bold;
}

.avatar-text {
  font-size: 1.2em;
}

.avatar-loading {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  background: rgba(255, 255, 255, 0.8);
  color: #409eff;
}

/* å°ºå¯¸æ ·å¼ */
.avatar-small {
  width: 32px;
  height: 32px;
}

.avatar-medium {
  width: 48px;
  height: 48px;
}

.avatar-large {
  width: 64px;
  height: 64px;
}

.avatar-xlarge {
  width: 100px;
  height: 100px;
}

.avatar-small .avatar-text {
  font-size: 0.8em;
}

.avatar-medium .avatar-text {
  font-size: 1em;
}

.avatar-large .avatar-text {
  font-size: 1.2em;
}

.avatar-xlarge .avatar-text {
  font-size: 1.5em;
}
</style>
```

### 2. **åœ¨é¡µé¢ä¸­ä½¿ç”¨å¤´åƒç»„ä»¶**

```vue
<!-- åœ¨index.vueæˆ–å…¶ä»–é¡µé¢ä¸­ä½¿ç”¨ -->
<template>
  <div class="user-info">
    <!-- ä½¿ç”¨å¤´åƒç»„ä»¶ -->
    <UserAvatar 
      :user="currentUser" 
      size="large"
      @click="showUserProfile"
    />
    
    <!-- ç”¨æˆ·ä¿¡æ¯ -->
    <div class="user-details">
      <h3>{{ currentUser.nickName }}</h3>
      <p>{{ currentUser.role === 'sys_admin' ? 'ç³»ç»Ÿç®¡ç†å‘˜' : 'éƒ¨é—¨ç®¡ç†å‘˜' }}</p>
    </div>
  </div>
</template>

<script>
import UserAvatar from '@/components/UserAvatar.vue'

export default {
  components: {
    UserAvatar
  },
  data() {
    return {
      currentUser: {
        _id: 'e87abd4e-f5ad-4012-926c-bb616b260c6b',
        nickName: 'ç³»ç»Ÿç®¡ç†å‘˜æµ‹è¯•',
        role: 'sys_admin',
        avatarUrl: 'https://api.dicebear.com/7.x/avataaars/svg?seed=admin'
      }
    }
  },
  methods: {
    showUserProfile() {
      // æ˜¾ç¤ºç”¨æˆ·èµ„æ–™
      console.log('æ˜¾ç¤ºç”¨æˆ·èµ„æ–™:', this.currentUser)
    }
  }
}
</script>
```

### 3. **å¤´åƒä¸Šä¼ åŠŸèƒ½**

```vue
<!-- components/AvatarUpload.vue -->
<template>
  <div class="avatar-upload">
    <el-upload
      class="avatar-uploader"
      :action="uploadUrl"
      :headers="uploadHeaders"
      :show-file-list="false"
      :on-success="handleAvatarSuccess"
      :before-upload="beforeAvatarUpload"
      :on-error="handleAvatarError"
    >
      <div class="avatar-wrapper">
        <UserAvatar 
          :user="{ avatarUrl: imageUrl || user.avatarUrl, nickName: user.nickName, role: user.role }" 
          size="large"
        />
        <div class="avatar-mask">
          <i class="el-icon-camera"></i>
          <span>æ›´æ¢å¤´åƒ</span>
        </div>
      </div>
    </el-upload>
    
    <!-- å¤´åƒè£å‰ªå¯¹è¯æ¡† -->
    <el-dialog
      title="è£å‰ªå¤´åƒ"
      :visible.sync="cropperVisible"
      width="600px"
      :before-close="handleCropperClose"
    >
      <div class="cropper-container">
        <vue-cropper
          ref="cropper"
          :src="cropperImage"
          :aspect-ratio="1"
          :view-mode="1"
          :auto-crop-area="0.8"
          :background="true"
          :movable="true"
          :zoomable="true"
          :scalable="true"
        />
      </div>
      <div slot="footer" class="dialog-footer">
        <el-button @click="cropperVisible = false">å–æ¶ˆ</el-button>
        <el-button type="primary" @click="cropAvatar">ç¡®å®š</el-button>
      </div>
    </el-dialog>
  </div>
</template>

<script>
import UserAvatar from './UserAvatar.vue'
import VueCropper from 'vue-cropper'
import 'vue-cropper/dist/index.css'

export default {
  name: 'AvatarUpload',
  components: {
    UserAvatar,
    VueCropper
  },
  props: {
    user: {
      type: Object,
      required: true
    }
  },
  data() {
    return {
      imageUrl: '',
      cropperVisible: false,
      cropperImage: '',
      uploadUrl: '/api/admin/upload/avatar',
      uploadHeaders: {
        'Authorization': `Bearer ${localStorage.getItem('token')}`
      }
    }
  },
  methods: {
    beforeAvatarUpload(file) {
      const isJPG = file.type === 'image/jpeg' || file.type === 'image/png'
      const isLt2M = file.size / 1024 / 1024 < 2

      if (!isJPG) {
        this.$message.error('å¤´åƒåªèƒ½æ˜¯ JPG/PNG æ ¼å¼!')
        return false
      }
      if (!isLt2M) {
        this.$message.error('å¤´åƒå¤§å°ä¸èƒ½è¶…è¿‡ 2MB!')
        return false
      }

      // æ˜¾ç¤ºè£å‰ªå¯¹è¯æ¡†
      this.showCropper(file)
      return false // é˜»æ­¢è‡ªåŠ¨ä¸Šä¼ 
    },
    
    showCropper(file) {
      const reader = new FileReader()
      reader.onload = (e) => {
        this.cropperImage = e.target.result
        this.cropperVisible = true
      }
      reader.readAsDataURL(file)
    },
    
    cropAvatar() {
      this.$refs.cropper.getCropData((data) => {
        // å°†è£å‰ªåçš„å›¾ç‰‡æ•°æ®ä¸Šä¼ 
        this.uploadCroppedImage(data)
        this.cropperVisible = false
      })
    },
    
    async uploadCroppedImage(croppedData) {
      try {
        // å°†base64è½¬æ¢ä¸ºblob
        const response = await fetch(croppedData)
        const blob = await response.blob()
        
        // åˆ›å»ºFormData
        const formData = new FormData()
        formData.append('avatar', blob, 'avatar.png')
        
        // ä¸Šä¼ åˆ°æœåŠ¡å™¨
        const uploadResponse = await fetch(this.uploadUrl, {
          method: 'POST',
          headers: this.uploadHeaders,
          body: formData
        })
        
        const result = await uploadResponse.json()
        
        if (result.success) {
          this.imageUrl = result.data.avatarUrl
          this.$emit('avatar-updated', result.data.avatarUrl)
          this.$message.success('å¤´åƒä¸Šä¼ æˆåŠŸ!')
        } else {
          this.$message.error(result.message || 'å¤´åƒä¸Šä¼ å¤±è´¥!')
        }
      } catch (error) {
        console.error('å¤´åƒä¸Šä¼ å¤±è´¥:', error)
        this.$message.error('å¤´åƒä¸Šä¼ å¤±è´¥!')
      }
    },
    
    handleAvatarSuccess(res, file) {
      this.imageUrl = URL.createObjectURL(file.raw)
    },
    
    handleAvatarError() {
      this.$message.error('å¤´åƒä¸Šä¼ å¤±è´¥!')
    },
    
    handleCropperClose() {
      this.cropperVisible = false
    }
  }
}
</script>

<style scoped>
.avatar-uploader {
  text-align: center;
}

.avatar-wrapper {
  position: relative;
  display: inline-block;
  cursor: pointer;
}

.avatar-mask {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.6);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  color: white;
  opacity: 0;
  transition: opacity 0.3s;
  border-radius: 50%;
}

.avatar-wrapper:hover .avatar-mask {
  opacity: 1;
}

.avatar-mask i {
  font-size: 24px;
  margin-bottom: 8px;
}

.cropper-container {
  height: 400px;
}
</style>
```

### 4. **å¤´åƒç®¡ç†APIè°ƒç”¨**

```javascript
// api/user.js
import request from '@/utils/request'

// è·å–ç”¨æˆ·ä¿¡æ¯
export const getUserInfo = () => {
  return request.get('/api/admin/user/profile')
}

// æ›´æ–°ç”¨æˆ·å¤´åƒ
export const updateUserAvatar = (avatarUrl) => {
  return request.put('/api/admin/user/avatar', { avatarUrl })
}

// ä¸Šä¼ å¤´åƒæ–‡ä»¶
export const uploadAvatar = (formData) => {
  return request.post('/api/admin/upload/avatar', formData, {
    headers: {
      'Content-Type': 'multipart/form-data'
    }
  })
}

// è·å–ç”¨æˆ·åˆ—è¡¨ï¼ˆåŒ…å«å¤´åƒï¼‰
export const getUserList = (params) => {
  return request.get('/api/admin/users', { params })
}
```

### 5. **å¤´åƒç¼“å­˜å’Œä¼˜åŒ–**

```javascript
// utils/avatarCache.js
class AvatarCache {
  constructor() {
    this.cache = new Map()
    this.failedUrls = new Set()
  }
  
  // è·å–å¤´åƒURLï¼ˆå¸¦ç¼“å­˜ï¼‰
  getAvatarUrl(user) {
    const key = `${user._id}_${user.avatarUrl}`
    
    // å¦‚æœä¹‹å‰åŠ è½½å¤±è´¥ï¼Œç›´æ¥è¿”å›é»˜è®¤å¤´åƒ
    if (this.failedUrls.has(user.avatarUrl)) {
      return this.getDefaultAvatar(user.role)
    }
    
    // å¦‚æœç¼“å­˜ä¸­æœ‰ï¼Œè¿”å›ç¼“å­˜çš„URL
    if (this.cache.has(key)) {
      return this.cache.get(key)
    }
    
    // å¦åˆ™è¿”å›åŸå§‹URL
    return user.avatarUrl || this.getDefaultAvatar(user.role)
  }
  
  // ç¼“å­˜æˆåŠŸçš„å¤´åƒ
  cacheAvatar(user, avatarUrl) {
    const key = `${user._id}_${user.avatarUrl}`
    this.cache.set(key, avatarUrl)
  }
  
  // æ ‡è®°å¤±è´¥çš„å¤´åƒURL
  markFailed(avatarUrl) {
    this.failedUrls.add(avatarUrl)
  }
  
  // è·å–é»˜è®¤å¤´åƒ
  getDefaultAvatar(role) {
    const defaultAvatars = {
      sys_admin: '/images/avatars/sys-admin.svg',
      dept_admin: '/images/avatars/dept-admin.svg',
      user: '/images/avatars/user.svg',
      default: '/images/avatars/default-admin.svg'
    }
    return defaultAvatars[role] || defaultAvatars.default
  }
  
  // æ¸…é™¤ç¼“å­˜
  clearCache() {
    this.cache.clear()
    this.failedUrls.clear()
  }
}

export default new AvatarCache()
```

### 6. **ä½¿ç”¨ç¤ºä¾‹**

```vue
<!-- åœ¨é¡µé¢ä¸­ä½¿ç”¨ -->
<template>
  <div class="user-management">
    <!-- ç”¨æˆ·åˆ—è¡¨ -->
    <div class="user-list">
      <div 
        v-for="user in users" 
        :key="user._id" 
        class="user-item"
      >
        <UserAvatar 
          :user="user" 
          size="medium"
          @click="selectUser(user)"
        />
        <div class="user-info">
          <h4>{{ user.nickName }}</h4>
          <p>{{ user.role === 'sys_admin' ? 'ç³»ç»Ÿç®¡ç†å‘˜' : 'éƒ¨é—¨ç®¡ç†å‘˜' }}</p>
        </div>
      </div>
    </div>
    
    <!-- å¤´åƒä¸Šä¼  -->
    <AvatarUpload 
      :user="selectedUser"
      @avatar-updated="handleAvatarUpdated"
    />
  </div>
</template>

<script>
import UserAvatar from '@/components/UserAvatar.vue'
import AvatarUpload from '@/components/AvatarUpload.vue'
import { getUserList, updateUserAvatar } from '@/api/user'
import avatarCache from '@/utils/avatarCache'

export default {
  components: {
    UserAvatar,
    AvatarUpload
  },
  data() {
    return {
      users: [],
      selectedUser: null
    }
  },
  async mounted() {
    await this.loadUsers()
  },
  methods: {
    async loadUsers() {
      try {
        const response = await getUserList({ pageSize: 100 })
        if (response.success) {
          this.users = response.data.list
        }
      } catch (error) {
        console.error('åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥:', error)
      }
    },
    
    selectUser(user) {
      this.selectedUser = user
    },
    
    async handleAvatarUpdated(avatarUrl) {
      try {
        await updateUserAvatar(avatarUrl)
        // æ›´æ–°æœ¬åœ°ç”¨æˆ·æ•°æ®
        if (this.selectedUser) {
          this.selectedUser.avatarUrl = avatarUrl
        }
        // æ¸…é™¤å¤´åƒç¼“å­˜
        avatarCache.clearCache()
        this.$message.success('å¤´åƒæ›´æ–°æˆåŠŸ!')
      } catch (error) {
        console.error('æ›´æ–°å¤´åƒå¤±è´¥:', error)
        this.$message.error('å¤´åƒæ›´æ–°å¤±è´¥!')
      }
    }
  }
}
</script>
```

## ï¿½ï¿½ å®Œæ•´çš„å‰ç«¯å¯¹æ¥æ–¹æ¡ˆ

è¿™ä¸ªæ–¹æ¡ˆæä¾›äº†ï¼š

1. **é€šç”¨å¤´åƒç»„ä»¶** - æ”¯æŒå¤šç§å°ºå¯¸å’Œè§’è‰²
2. **å¤´åƒä¸Šä¼ åŠŸèƒ½** - æ”¯æŒè£å‰ªå’Œé¢„è§ˆ
3. **å¤´åƒç¼“å­˜æœºåˆ¶** - æé«˜æ€§èƒ½å’Œç”¨æˆ·ä½“éªŒ
4. **é”™è¯¯å¤„ç†** - è‡ªåŠ¨é™çº§åˆ°é»˜è®¤å¤´åƒ
5. **å“åº”å¼è®¾è®¡** - é€‚é…ä¸åŒå±å¹•å°ºå¯¸

ç°åœ¨ä½ å¯ä»¥å®Œæ•´åœ°åœ¨å‰ç«¯ä½¿ç”¨å¤´åƒåŠŸèƒ½äº†ï¼ğŸ¯