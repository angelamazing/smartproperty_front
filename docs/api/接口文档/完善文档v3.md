# 部门报餐功能对接文档

## 概述

本文档描述了部门管理和报餐功能的完整实现，包括9个部门的设置、部门管理员权限控制、以及部门报餐的核心功能。

## 系统架构

### 部门结构
系统包含以下9个部门：
1. 地质数据中心 (GEO_DATA)
2. 地质工程中心 (GEO_ENG)
3. 生态环境中心 (ECO_ENV)
4. 地质环境中心 (GEO_ENV)
5. 地质调查中心 (GEO_SURVEY)
6. 黄梅分站 (HUANGMEI)
7. 矿业有限责任公司 (MINING_CO)
8. 物业中心 (PROPERTY)
9. 机关科室 (ADMIN)

### 用户角色
- `dept_admin`: 部门管理员 - 负责本部门的报餐管理
- `sys_admin`: 系统管理员 - 拥有所有权限
- `admin`: 普通管理员
- `user`: 普通用户

## 核心功能

### 1. 部门管理员登录

**接口**: `POST /api/auth/test-login-admin`

**请求参数**:
```json
{
  "phoneNumber": "13800001001"
}
```

**响应示例**:
```json
{
  "success": true,
  "message": "部门管理员测试登录成功",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "userInfo": {
      "_id": "12e4db1e-8ff5-4c68-a7ed-8e239885f401",
      "nickName": "部门管理员测试",
      "role": "dept_admin",
      "department": "技术部",
      "permissions": ["user.view", "dining.manage", "reservation.audit", "venue.manage"]
    }
  }
}
```

### 2. 获取部门成员列表

**接口**: `GET /api/dining/enhanced/dept-members`

**请求头**:
```
Authorization: Bearer {token}
```

**查询参数**:
- `includeInactive` (可选): 是否包含非活跃用户，默认 false
- `keyword` (可选): 搜索关键词，支持姓名和手机号搜索

**响应示例**:
```json
{
  "success": true,
  "message": "获取部门成员成功",
  "data": [
    {
      "_id": "e87abd4e-f5ad-4012-926c-bb616b260c6b",
      "name": "系统管理员测试",
      "role": "系统管理员",
      "avatarUrl": "http://localhost:3000/uploads/avatars/avatar_1756687222017_hsnganr3o.png",
      "phoneNumber": "13800000002",
      "email": null,
      "status": "active",
      "isDepartmentAdmin": false
    },
    {
      "_id": "12e4db1e-8ff5-4c68-a7ed-8e239885f401",
      "name": "部门管理员测试",
      "role": "部门管理员",
      "avatarUrl": "",
      "phoneNumber": "13800000001",
      "email": null,
      "status": "active",
      "isDepartmentAdmin": true
    }
  ]
}
```

### 3. 部门报餐

**接口**: `POST /api/dining/enhanced/department-order`

**请求头**:
```
Authorization: Bearer {token}
Content-Type: application/json
```

**请求参数**:
```json
{
  "date": "2025-09-02",
  "mealType": "lunch",
  "members": [
    {
      "userId": "e87abd4e-f5ad-4012-926c-bb616b260c6b"
    },
    {
      "userId": "12e4db1e-8ff5-4c68-a7ed-8e239885f401"
    }
  ],
  "remark": "备注信息（可选）"
}
```

**参数说明**:
- `date`: 报餐日期，格式 YYYY-MM-DD
- `mealType`: 餐次类型，可选值：`breakfast`, `lunch`, `dinner`
- `members`: 报餐成员列表，每个成员包含 `userId`
- `remark`: 备注信息，可选

**响应示例**:
```json
{
  "success": true,
  "message": "成功为 2 名部门成员报餐",
  "data": {
    "success": true,
    "message": "成功为 2 名部门成员报餐",
    "orders": [
      {
        "orderId": "a086699c-1949-44da-b93f-352ceab5f290",
        "userId": "e87abd4e-f5ad-4012-926c-bb616b260c6b",
        "userName": "系统管理员测试",
        "status": "confirmed"
      },
      {
        "orderId": "a086699c-1949-44da-b93f-352ceab5f290",
        "userId": "12e4db1e-8ff5-4c68-a7ed-8e239885f401",
        "userName": "部门管理员测试",
        "status": "confirmed"
      }
    ],
    "departmentName": "技术部"
  }
}
```

### 4. 获取部门报餐记录

**接口**: `GET /api/dining/enhanced/department-orders`

**请求头**:
```
Authorization: Bearer {token}
```

**查询参数**:
- `date` (可选): 指定日期，格式 YYYY-MM-DD
- `mealType` (可选): 餐次类型
- `page` (可选): 页码，默认 1
- `pageSize` (可选): 每页数量，默认 20
- `startDate` (可选): 开始日期
- `endDate` (可选): 结束日期

**响应示例**:
```json
{
  "success": true,
  "message": "获取部门报餐记录成功",
  "data": {
    "list": [
      {
        "_id": "a086699c-1949-44da-b93f-352ceab5f290",
        "registrantId": "12e4db1e-8ff5-4c68-a7ed-8e239885f401",
        "registrantName": "部门管理员测试",
        "memberIds": ["e87abd4e-f5ad-4012-926c-bb616b260c6b", "12e4db1e-8ff5-4c68-a7ed-8e239885f401"],
        "memberNames": ["系统管理员测试", "部门管理员测试"],
        "memberCount": 2,
        "date": "2025-09-02",
        "mealType": "lunch",
        "menuName": "今日午餐",
        "orderTime": "2025-09-02T03:35:21.000Z",
        "status": "confirmed",
        "totalAmount": 68.00
      }
    ],
    "total": 1,
    "page": 1,
    "pageSize": 20,
    "totalPages": 1,
    "departmentName": "技术部"
  }
}
```

### 5. 获取部门报餐统计

**接口**: `GET /api/dining/enhanced/department-stats`

**请求头**:
```
Authorization: Bearer {token}
```

**查询参数**:
- `startDate` (可选): 开始日期
- `endDate` (可选): 结束日期

**响应示例**:
```json
{
  "success": true,
  "message": "获取部门报餐统计成功",
  "data": {
    "departmentName": "技术部",
    "totalMembers": 2,
    "totalOrders": 1,
    "uniqueUsers": 2,
    "orderDays": 1,
    "mealTypeStats": {
      "breakfast": 0,
      "lunch": 2,
      "dinner": 0
    },
    "participationRate": 100
  }
}
```

### 6. 获取部门报餐概览

**接口**: `GET /api/dining/enhanced/department-overview`

**请求头**:
```
Authorization: Bearer {token}
```

**响应示例**:
```json
{
  "success": true,
  "message": "获取部门报餐概览成功",
  "data": {
    "date": "2025-09-02",
    "departmentName": "技术部",
    "totalMembers": 2,
    "todayStats": {
      "totalOrders": 1,
      "uniqueUsers": 2,
      "participationRate": 100,
      "mealTypeStats": {
        "breakfast": 0,
        "lunch": 2,
        "dinner": 0
      }
    },
    "members": [
      {
        "_id": "e87abd4e-f5ad-4012-926c-bb616b260c6b",
        "name": "系统管理员测试",
        "role": "系统管理员",
        "hasOrdered": true,
        "orderInfo": {
          "mealType": "lunch",
          "orderTime": "2025-09-02T03:35:21.000Z",
          "status": "confirmed"
        }
      },
      {
        "_id": "12e4db1e-8ff5-4c68-a7ed-8e239885f401",
        "name": "部门管理员测试",
        "role": "部门管理员",
        "hasOrdered": true,
        "orderInfo": {
          "mealType": "lunch",
          "orderTime": "2025-09-02T03:35:21.000Z",
          "status": "confirmed"
        }
      }
    ]
  }
}
```

## 权限控制

### 部门管理员权限
- 只能查看和管理本部门的成员
- 只能为本部门成员报餐
- 无法跨部门操作

### 权限验证
所有接口都需要有效的JWT Token，系统会自动验证：
1. Token有效性
2. 用户状态（必须为active）
3. 部门权限（部门管理员只能操作本部门）

## 错误处理

### 常见错误码
- `401`: 未授权，Token无效或过期
- `403`: 权限不足，无法访问资源
- `400`: 请求参数错误
- `500`: 服务器内部错误

### 错误响应格式
```json
{
  "success": false,
  "message": "错误描述",
  "code": "错误码",
  "timestamp": "2025-09-02T03:35:21.548Z"
}
```

### 常见错误场景
1. **菜单不存在**: 该日期的菜单不存在或未发布
2. **重复报餐**: 用户已经报餐，无法重复报餐
3. **跨部门操作**: 尝试为其他部门成员报餐
4. **权限不足**: 非部门管理员尝试访问管理功能

## 前端集成示例

### 1. 登录并获取Token
```javascript
// 部门管理员登录
const loginResponse = await fetch('/api/auth/test-login-admin', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    phoneNumber: '13800001001'
  })
});

const loginData = await loginResponse.json();
const token = loginData.data.token;
```

### 2. 获取部门成员
```javascript
// 获取部门成员列表
const membersResponse = await fetch('/api/dining/enhanced/dept-members', {
  headers: {
    'Authorization': `Bearer ${token}`
  }
});

const membersData = await membersResponse.json();
console.log('部门成员:', membersData.data);
```

### 3. 部门报餐
```javascript
// 部门报餐
const orderResponse = await fetch('/api/dining/enhanced/department-order', {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${token}`,
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    date: '2025-09-02',
    mealType: 'lunch',
    members: [
      { userId: 'e87abd4e-f5ad-4012-926c-bb616b260c6b' },
      { userId: '12e4db1e-8ff5-4c68-a7ed-8e239885f401' }
    ]
  })
});

const orderData = await orderResponse.json();
console.log('报餐结果:', orderData);
```

### 4. 获取报餐记录
```javascript
// 获取部门报餐记录
const ordersResponse = await fetch('/api/dining/enhanced/department-orders?date=2025-09-02', {
  headers: {
    'Authorization': `Bearer ${token}`
  }
});

const ordersData = await ordersResponse.json();
console.log('报餐记录:', ordersData.data);
```

## 测试数据

### 部门管理员账号
- 手机号: `13800001001`
- 部门: 技术部
- 角色: 部门管理员

### 测试菜单
系统已创建今日（2025-09-02）的测试菜单：
- 午餐菜单: 宫保鸡丁、麻婆豆腐、白米饭、紫菜蛋花汤
- 晚餐菜单: 红烧肉、清炒小白菜、白米饭、冬瓜排骨汤

## 注意事项

1. **Token管理**: 前端需要妥善管理JWT Token，包括存储、刷新和过期处理
2. **错误处理**: 建议实现统一的错误处理机制
3. **权限控制**: 前端应该根据用户角色显示相应的功能
4. **数据验证**: 前端应该进行基本的数据验证，减少无效请求
5. **用户体验**: 建议添加加载状态和操作反馈

## 更新日志

- **2025-09-02**: 完成部门管理和报餐功能开发
- **2025-09-02**: 修复用户ID引用不一致问题
- **2025-09-02**: 修复数据库表结构不匹配问题
- **2025-09-02**: 创建测试菜单数据
- **2025-09-02**: 完成核心功能测试验证
