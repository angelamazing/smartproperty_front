# 用户角色管理前端对接文档

## 📋 概述

本文档详细说明了前端如何对接用户角色管理功能，包括角色数据结构、API接口调用、权限验证等完整实现。

## 🔐 系统角色定义

### 四个核心角色

| 角色代码 | 角色名称 | 权限等级 | 功能描述 | 权限范围 |
|----------|----------|----------|----------|----------|
| `user` | 普通用户 | 1 | 基础功能用户 | 报餐、查看菜单、个人信息管理 |
| `admin` | 管理员 | 3 | 系统管理权限 | 用户管理、菜单管理、数据统计 |
| `sys_admin` | 系统管理员 | 4 | 最高权限 | 所有功能，包括角色管理、系统设置 |
| `dept_admin` | 部门管理员 | 2 | 部门级管理 | 本部门用户管理、部门数据统计 |

### 权限等级说明

```javascript
const ROLE_LEVELS = {
  'user': 1,           // 普通用户
  'dept_admin': 2,     // 部门管理员  
  'admin': 3,          // 管理员
  'sys_admin': 4       // 系统管理员
}

// 权限检查函数
function hasPermission(userRole, requiredRole) {
  const userLevel = ROLE_LEVELS[userRole] || 0
  const requiredLevel = ROLE_LEVELS[requiredRole] || 0
  return userLevel >= requiredLevel
}
```

## 📊 角色数据结构

### 后端返回的角色数据结构

```json
{
  "success": true,
  "message": "获取角色列表成功",
  "data": [
    {
      "id": "role_001",
      "name": "user",
      "description": "普通用户",
      "status": "active",
      "create_time": "2025-08-27T03:57:09.000Z",
      "update_time": "2025-09-06T23:21:48.000Z",
      "user_count": 56,
      "permissions": [],
      "permissionCount": 0
    },
    {
      "id": "role_002",
      "name": "admin", 
      "description": "普通管理员",
      "status": "active",
      "create_time": "2025-08-27T03:57:09.000Z",
      "update_time": "2025-08-27T03:57:09.000Z",
      "user_count": 0,
      "permissions": [],
      "permissionCount": 0
    },
    {
      "id": "role_003",
      "name": "sys_admin",
      "description": "系统管理员", 
      "status": "active",
      "create_time": "2025-08-27T03:57:09.000Z",
      "update_time": "2025-08-27T03:57:09.000Z",
      "user_count": 1,
      "permissions": [],
      "permissionCount": 0
    }
  ]
}
```

### 角色映射关系

```javascript
// 角色ID到角色代码的映射
const ROLE_MAPPING = {
  'role_001': 'user',        // 普通用户
  'role_002': 'admin',       // 管理员
  'role_003': 'sys_admin',   // 系统管理员
  'role_004': 'dept_admin'   // 部门管理员（如果存在）
}

// 角色代码到显示名称的映射
const ROLE_DISPLAY_NAMES = {
  'user': '普通用户',
  'admin': '管理员', 
  'sys_admin': '系统管理员',
  'dept_admin': '部门管理员'
}
```

## 🔌 API接口对接

### 1. 获取角色列表

**接口地址**: `GET /api/admin/roles`

**前端实现**:
```javascript
// 在 api.js 中
admin: {
  getRolesList: () => api.get('/api/admin/roles'),
  // ... 其他接口
}

// 在组件中使用
async loadRoles() {
  try {
    const response = await api.admin.getRolesList()
    if (response.success) {
      this.rolesList = response.data || []
      console.log('角色列表加载成功:', this.rolesList)
    }
  } catch (error) {
    console.error('加载角色列表失败:', error)
    uni.showToast({ title: '加载角色列表失败', icon: 'error' })
  }
}
```

### 2. 更新用户角色

**接口地址**: `PUT /api/admin/users/{userId}`

**请求参数**:
```json
{
  "nickName": "用户昵称",
  "phoneNumber": "手机号码",
  "email": "邮箱地址",
  "departmentId": "部门ID",
  "role": "角色代码",  // 重要：这里使用角色代码，不是角色ID
  "status": "active"
}
```

**前端实现**:
```javascript
// 在 UserEditModal.vue 中
prepareSaveData() {
  const saveData = { ...this.formData }
  
  // 字段名映射：前端字段名 -> 后端字段名
  if (saveData.realName) {
    saveData.nickName = saveData.realName
    delete saveData.realName
  }
  
  // 角色字段映射：roleId -> role
  if (saveData.roleId) {
    console.log('开始角色映射，roleId:', saveData.roleId)
    console.log('可用角色列表:', this.roles)
    
    const matchedRole = this.roles.find(role => 
      role.id === saveData.roleId
    )
    
    console.log('匹配到的角色:', matchedRole)
    
    if (matchedRole) {
      saveData.role = matchedRole.name  // 使用角色代码
      delete saveData.roleId
      console.log('角色映射成功:', saveData.roleId, '->', matchedRole.name)
    } else {
      console.error('角色映射失败：未找到匹配的角色，roleId:', saveData.roleId)
    }
  } else {
    console.log('没有roleId需要映射')
  }
  
  console.log('准备保存的数据:', saveData)
  return saveData
}
```

### 3. 角色权限验证

**前端权限检查**:
```javascript
// 权限检查工具函数
export const PermissionUtils = {
  // 检查用户是否有指定权限
  hasPermission(userRole, requiredRole) {
    const roleLevels = {
      'user': 1,
      'dept_admin': 2, 
      'admin': 3,
      'sys_admin': 4
    }
    
    const userLevel = roleLevels[userRole] || 0
    const requiredLevel = roleLevels[requiredRole] || 0
    
    return userLevel >= requiredLevel
  },
  
  // 检查是否可以编辑用户
  canEditUser(currentUserRole, targetUserRole) {
    // 系统管理员可以编辑所有用户
    if (currentUserRole === 'sys_admin') {
      return true
    }
    
    // 管理员可以编辑普通用户和部门管理员
    if (currentUserRole === 'admin') {
      return ['user', 'dept_admin'].includes(targetUserRole)
    }
    
    // 部门管理员只能编辑本部门的普通用户
    if (currentUserRole === 'dept_admin') {
      return targetUserRole === 'user'
    }
    
    return false
  },
  
  // 检查是否可以分配角色
  canAssignRole(currentUserRole, targetRole) {
    const roleLevels = {
      'user': 1,
      'dept_admin': 2,
      'admin': 3, 
      'sys_admin': 4
    }
    
    const currentLevel = roleLevels[currentUserRole] || 0
    const targetLevel = roleLevels[targetRole] || 0
    
    // 只能分配比自己权限等级低的角色
    return currentLevel > targetLevel
  }
}
```

## 🎨 前端组件实现

### 1. 角色选择器组件

```vue
<!-- RoleSelector.vue -->
<template>
  <view class="role-selector">
    <!-- H5环境下的自定义选择器 -->
    <view v-if="isH5" class="h5-picker">
      <view 
        v-for="role in roles" 
        :key="role.id"
        class="h5-option"
        :class="{ 
          active: modelValue === role.id,
          'no-selection': !modelValue
        }"
        @click="selectRole(role.id)"
      >
        <text>{{ getRoleDisplayName(role.name) }}</text>
        <text v-if="modelValue === role.id" class="check-icon">✓</text>
      </view>
      
      <!-- 取消选择按钮 -->
      <view 
        v-if="modelValue"
        class="clear-selection-btn"
        @click="clearSelection"
      >
        <text class="clear-icon">✕</text>
        <text>取消选择</text>
      </view>
    </view>
    
    <!-- 非H5环境使用原生picker -->
    <picker v-else :range="roleNames" @change="onPickerChange">
      <view class="form-picker">
        <text>{{ selectedRoleName || '请选择角色' }}</text>
        <text class="picker-arrow">▼</text>
      </view>
    </picker>
  </view>
</template>

<script>
export default {
  name: 'RoleSelector',
  props: {
    modelValue: {
      type: [String, Number],
      default: ''
    },
    roles: {
      type: Array,
      default: () => []
    },
    isH5: {
      type: Boolean,
      default: false
    }
  },
  emits: ['update:modelValue', 'role-change'],
  computed: {
    roleNames() {
      return this.roles.map(role => this.getRoleDisplayName(role.name))
    },
    
    selectedRoleName() {
      const role = this.roles.find(r => r.id === this.modelValue)
      return role ? this.getRoleDisplayName(role.name) : ''
    }
  },
  methods: {
    selectRole(roleId) {
      this.$emit('update:modelValue', roleId)
      this.$emit('role-change', roleId)
    },
    
    clearSelection() {
      this.$emit('update:modelValue', '')
      this.$emit('role-change', '')
    },
    
    onPickerChange(e) {
      const index = parseInt(e.detail.value)
      const role = this.roles[index]
      if (role) {
        this.$emit('update:modelValue', role.id)
        this.$emit('role-change', role.id)
      }
    },
    
    // 获取角色显示名称
    getRoleDisplayName(roleCode) {
      const displayNames = {
        'user': '普通用户',
        'admin': '管理员',
        'sys_admin': '系统管理员', 
        'dept_admin': '部门管理员'
      }
      return displayNames[roleCode] || roleCode
    }
  }
}
</script>
```

### 2. 用户编辑模态框

```vue
<!-- UserEditModal.vue -->
<template>
  <view v-if="visible" class="user-edit-overlay" @click="handleOverlayClick">
    <view class="user-edit-modal" @click.stop>
      <!-- 模态框内容 -->
      <view class="modal-content">
        <!-- 角色权限部分 -->
        <FormSection title="角色权限">
          <FormField label="用户角色" required>
            <template #input>
              <RoleSelector 
                v-model="formData.roleId"
                :roles="roles"
                :is-h5="isH5"
                @role-change="onRoleChange"
              />
            </template>
          </FormField>
          
          <!-- 角色描述 -->
          <view v-if="selectedRole" class="role-info">
            <view class="role-description">
              <text class="role-desc-title">角色说明：</text>
              <text class="role-desc-text">{{ selectedRole.description }}</text>
            </view>
          </view>
        </FormSection>
      </view>
      
      <!-- 模态框底部 -->
      <view class="modal-footer">
        <button class="cancel-btn" @click="close">取消</button>
        <button 
          class="save-btn" 
          :class="{ disabled: !isFormValid || saving }"
          @click="saveUser" 
          :disabled="!isFormValid || saving"
        >
          <text v-if="saving">保存中...</text>
          <text v-else>保存</text>
        </button>
      </view>
    </view>
  </view>
</template>

<script>
import api from '@/utils/api'
import RoleSelector from './form/RoleSelector.vue'

export default {
  name: 'UserEditModal',
  components: {
    RoleSelector
  },
  props: {
    visible: {
      type: Boolean,
      default: false
    },
    user: {
      type: Object,
      default: null
    },
    roles: {
      type: Array,
      default: () => []
    }
  },
  data() {
    return {
      formData: this.getInitialFormData(),
      saving: false,
      isH5: false
    }
  },
  computed: {
    selectedRole() {
      return this.roles.find(role => role.id === this.formData.roleId)
    },
    
    isFormValid() {
      return this.validateForm().length === 0
    }
  },
  methods: {
    // 角色变化处理
    onRoleChange(roleId) {
      console.log('角色变化:', roleId)
      this.formData.roleId = roleId
    },
    
    // 保存用户
    async saveUser() {
      this.validationErrors = this.validateForm()
      if (this.validationErrors.length > 0) {
        this.showError('请检查表单填写')
        return
      }
      
      this.saving = true
      try {
        const saveData = this.prepareSaveData()
        
        let response
        if (this.isEditMode) {
          response = await api.admin.updateUser(this.user.id, saveData)
        } else {
          response = await api.admin.createUser(saveData)
        }
        
        if (response.success) {
          this.showSuccess(this.isEditMode ? '更新成功' : '创建成功')
          this.$emit('saved', response.data)
          this.close()
        } else {
          throw new Error(response.message || '保存失败')
        }
      } catch (error) {
        console.error('保存用户失败:', error)
        this.handleSaveError(error)
      } finally {
        this.saving = false
      }
    },
    
    // 准备保存数据
    prepareSaveData() {
      const saveData = { ...this.formData }
      
      // 字段名映射：前端字段名 -> 后端字段名
      if (saveData.realName) {
        saveData.nickName = saveData.realName
        delete saveData.realName
      }
      
      // 角色字段映射：roleId -> role
      if (saveData.roleId) {
        console.log('开始角色映射，roleId:', saveData.roleId)
        console.log('可用角色列表:', this.roles)
        
        const matchedRole = this.roles.find(role => 
          role.id === saveData.roleId
        )
        
        console.log('匹配到的角色:', matchedRole)
        
        if (matchedRole) {
          saveData.role = matchedRole.name
          delete saveData.roleId
          console.log('角色映射成功:', saveData.roleId, '->', matchedRole.name)
        } else {
          console.error('角色映射失败：未找到匹配的角色，roleId:', saveData.roleId)
        }
      } else {
        console.log('没有roleId需要映射')
      }
      
      console.log('准备保存的数据:', saveData)
      return saveData
    }
  }
}
</script>
```

## 🧪 测试验证

### 1. 角色更新测试

```javascript
// 测试角色更新功能
const testRoleUpdate = async () => {
  const testCases = [
    {
      roleId: "role_001",
      expectedRole: "user",
      description: "更新为普通用户"
    },
    {
      roleId: "role_002", 
      expectedRole: "admin",
      description: "更新为管理员"
    },
    {
      roleId: "role_003",
      expectedRole: "sys_admin", 
      description: "更新为系统管理员"
    }
  ]
  
  for (const testCase of testCases) {
    console.log(`测试: ${testCase.description}`)
    
    // 模拟用户编辑
    const formData = {
      roleId: testCase.roleId,
      nickName: "测试用户",
      phoneNumber: "13800138000"
    }
    
    // 调用角色映射
    const matchedRole = roles.find(role => role.id === testCase.roleId)
    const mappedRole = matchedRole ? matchedRole.name : null
    
    console.assert(mappedRole === testCase.expectedRole, 
      `角色映射失败: 期望 ${testCase.expectedRole}, 实际 ${mappedRole}`)
    
    console.log(`✅ ${testCase.description} 测试通过`)
  }
}
```

### 2. 权限验证测试

```javascript
// 测试权限验证功能
const testPermissionValidation = () => {
  const testCases = [
    {
      userRole: 'sys_admin',
      requiredRole: 'admin',
      expected: true,
      description: '系统管理员可以访问管理员功能'
    },
    {
      userRole: 'admin',
      requiredRole: 'sys_admin', 
      expected: false,
      description: '管理员不能访问系统管理员功能'
    },
    {
      userRole: 'user',
      requiredRole: 'admin',
      expected: false,
      description: '普通用户不能访问管理员功能'
    }
  ]
  
  testCases.forEach(testCase => {
    const result = PermissionUtils.hasPermission(testCase.userRole, testCase.requiredRole)
    console.assert(result === testCase.expected, 
      `权限验证失败: ${testCase.description}`)
    console.log(`✅ ${testCase.description} 测试通过`)
  })
}
```

## 📝 注意事项

### 1. 角色数据一致性
- 确保前端角色列表与后端保持一致
- 角色ID和角色代码的映射关系要正确
- 处理角色数据变更的情况

### 2. 权限控制
- 前端权限检查只是辅助，后端权限验证是核心
- 权限变更后要及时更新用户状态
- 处理权限不足的错误提示

### 3. 错误处理
- 提供详细的错误信息
- 处理角色映射失败的情况
- 记录角色操作日志

### 4. 性能优化
- 缓存角色列表数据
- 避免重复的角色查找操作
- 优化角色选择器的渲染性能

## 🎉 总结

通过本文档，前端开发人员可以：

1. **理解角色系统**: 掌握四个角色的权限等级和功能范围
2. **正确对接API**: 使用标准的RESTful接口进行角色管理
3. **实现权限控制**: 在前端进行权限验证和用户界面控制
4. **处理角色映射**: 正确转换角色ID和角色代码
5. **测试验证**: 使用提供的测试用例验证功能正确性

这套角色管理系统确保了用户权限的精确控制，为系统的安全性和可维护性提供了坚实基础。
