# 菜单管理完整接口说明

## 📋 接口概述

菜单管理接口提供菜单的创建、发布、撤回、查询等功能，支持早中晚餐的菜单管理，包含菜品选择、时间控制、状态管理等核心功能。

**基础路径**: `/api/admin/menu`

**认证要求**: 所有接口都需要有效的JWT Token和管理员权限

**Content-Type**: `application/json`

## 🔐 认证说明

所有接口都需要在请求头中携带管理员Token：

```http
Authorization: Bearer {your_admin_token}
```

## ⏰ 时间处理说明

菜单管理遵循项目统一时间处理规范：
- **存储格式**: UTC时间
- **API传输**: ISO 8601格式
- **前端显示**: 北京时间(UTC+8)
- **时间验证**: 防止保存过去日期

## 📚 菜单管理接口列表

### 1. 保存菜单草稿

**接口地址**: `POST /api/admin/menu/draft`

**接口描述**: 保存菜单草稿，支持创建新草稿或更新现有草稿

**请求头**:
```http
Authorization: Bearer {token}
Content-Type: application/json
```

**请求参数**:
```json
{
  "date": "2025-12-01",                    // 必填，发布日期 (YYYY-MM-DD)
  "mealType": "lunch",                     // 必填，餐次类型：breakfast/lunch/dinner
  "dishes": [                              // 必填，菜品列表
    {
      "dishId": "dish_id_1",               // 菜品ID
      "price": 15.0,                       // 可选，价格，默认使用菜品原价
      "sort": 1                            // 可选，排序，默认为数组索引
    },
    {
      "dishId": "dish_id_2",
      "price": 12.0,
      "sort": 2
    }
  ],
  "description": "今日午餐菜单",            // 可选，菜单描述
  "status": "draft"                        // 可选，状态：draft/published，默认draft
}
```

**参数验证**:
- `date`: 不能为空，不能是过去的日期
- `mealType`: 必须是 breakfast/lunch/dinner 之一
- `dishes`: 必须是数组，不能为空
- `dishes.*.dishId`: 菜品ID不能为空

**响应示例**:
```json
{
  "success": true,
  "message": "菜单草稿保存成功",
  "data": {
    "id": "menu_id_123",
    "date": "2025-12-01",
    "mealType": "lunch",
    "status": "draft",
    "description": "今日午餐菜单",
    "dishes": [
      {
        "dishId": "dish_id_1",
        "price": 15.0,
        "sort": 1
      }
    ]
  },
  "timestamp": "2025-09-16T12:50:17.000Z"
}
```

---

### 2. 发布菜单

**接口地址**: `POST /api/admin/menu/publish`

**接口描述**: 发布菜单，将草稿状态转为已发布状态，自动设置发布时间和生效时间

**请求头**:
```http
Authorization: Bearer {token}
Content-Type: application/json
```

**请求参数**:
```json
{
  "date": "2025-12-01",                    // 必填，发布日期
  "mealType": "lunch",                     // 必填，餐次类型
  "dishes": [                              // 必填，菜品列表
    {
      "dishId": "dish_id_1",
      "price": 15.0,
      "sort": 1
    }
  ],
  "description": "今日午餐菜单",            // 可选，菜单描述
  "publishTime": "2025-09-16T12:00:00.000Z", // 可选，发布时间，默认当前时间
  "effectiveTime": "2025-12-01T11:00:00.000Z" // 可选，生效时间，默认当前时间
}
```

**参数验证**:
- `date`: 不能为空，不能是过去的日期
- `mealType`: 必须是 breakfast/lunch/dinner 之一
- `dishes`: 必须是数组，不能为空
- `publishTime`: 可选，必须是ISO 8601格式
- `effectiveTime`: 可选，必须是ISO 8601格式，不能是过去时间

**响应示例**:
```json
{
  "success": true,
  "message": "菜单发布成功",
  "data": {
    "id": "menu_id_123",
    "date": "2025-12-01",
    "mealType": "lunch",
    "status": "published",
    "description": "今日午餐菜单",
    "publishTime": "2025-09-16T12:50:17.000Z",
    "effectiveTime": "2025-09-16T12:50:17.000Z",
    "dishes": [
      {
        "dishId": "dish_id_1",
        "price": 15.0,
        "sort": 1
      }
    ]
  },
  "timestamp": "2025-09-16T12:50:17.000Z"
}
```

---

### 3. 获取菜单历史

**接口地址**: `GET /api/admin/menu/history`

**接口描述**: 获取菜单发布历史记录，支持分页和筛选

**请求头**:
```http
Authorization: Bearer {token}
```

**查询参数**:
| 参数名 | 类型 | 必填 | 默认值 | 说明 |
|--------|------|------|--------|------|
| page | number | 否 | 1 | 页码，必须大于0 |
| pageSize | number | 否 | 20 | 每页数量，1-100之间 |
| startDate | string | 否 | - | 开始日期 (YYYY-MM-DD) |
| endDate | string | 否 | - | 结束日期 (YYYY-MM-DD) |
| mealType | string | 否 | - | 餐次类型：breakfast/lunch/dinner |

**请求示例**:
```http
GET /api/admin/menu/history?page=1&pageSize=10&mealType=lunch&startDate=2025-09-01&endDate=2025-09-30
Authorization: Bearer {token}
```

**响应示例**:
```json
{
  "success": true,
  "message": "获取菜单历史成功",
  "data": {
    "list": [
      {
        "_id": "menu_id_123",
        "publishDate": "2025-09-15",
        "mealType": "lunch",
        "publishStatus": "published",
        "description": "今日午餐菜单",
        "publisherId": "admin_id_1",
        "publishTime": "2025-09-15T10:30:00.000Z",
        "effectiveTime": "2025-09-15T11:00:00.000Z",
        "createTime": "2025-09-15T10:00:00.000Z",
        "updateTime": "2025-09-15T10:30:00.000Z",
        "dishes": [
          {
            "dishId": "dish_id_1",
            "dishName": "宫保鸡丁",
            "price": 15.0,
            "sort": 1
          }
        ]
      }
    ],
    "pagination": {
      "page": 1,
      "pageSize": 10,
      "total": 25,
      "totalPages": 3
    }
  },
  "timestamp": "2025-09-16T12:50:17.000Z"
}
```

---

### 4. 根据日期和餐次获取菜单

**接口地址**: `GET /api/admin/menu/by-date`

**接口描述**: 根据指定日期和餐次获取菜单信息

**请求头**:
```http
Authorization: Bearer {token}
```

**查询参数**:
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| date | string | 是 | 日期 (YYYY-MM-DD) |
| mealType | string | 是 | 餐次类型：breakfast/lunch/dinner |

**请求示例**:
```http
GET /api/admin/menu/by-date?date=2025-12-01&mealType=lunch
Authorization: Bearer {token}
```

**响应示例**:
```json
{
  "success": true,
  "message": "获取菜单成功",
  "data": {
    "_id": "menu_id_123",
    "publishDate": "2025-12-01",
    "mealType": "lunch",
    "publishStatus": "published",
    "description": "今日午餐菜单",
    "publisherId": "admin_id_1",
    "publishTime": "2025-09-16T12:50:17.000Z",
    "effectiveTime": "2025-09-16T12:50:17.000Z",
    "createTime": "2025-09-16T12:00:00.000Z",
    "updateTime": "2025-09-16T12:50:17.000Z",
    "dishes": [
      {
        "dishId": "dish_id_1",
        "dishName": "宫保鸡丁",
        "description": "经典川菜，口感麻辣鲜香",
        "price": 15.0,
        "categoryName": "荤菜",
        "image": "https://example.com/dish1.jpg",
        "sort": 1
      }
    ]
  },
  "timestamp": "2025-09-16T12:50:17.000Z"
}
```

---

### 5. 撤回菜单

**接口地址**: `PUT /api/admin/menu/:menuId/revoke`

**接口描述**: 撤回已发布的菜单，将其状态改为已撤回

**请求头**:
```http
Authorization: Bearer {token}
```

**路径参数**:
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| menuId | string | 是 | 菜单ID |

**请求示例**:
```http
PUT /api/admin/menu/menu_id_123/revoke
Authorization: Bearer {token}
```

**响应示例**:
```json
{
  "success": true,
  "message": "菜单撤回成功",
  "data": {
    "_id": "menu_id_123",
    "publishStatus": "revoked",
    "updateTime": "2025-09-16T12:50:17.000Z"
  },
  "timestamp": "2025-09-16T12:50:17.000Z"
}
```

---

### 6. 获取菜单的菜品列表

**接口地址**: `GET /api/admin/menu/:menuId/dishes`

**接口描述**: 获取指定菜单的菜品详细信息

**请求头**:
```http
Authorization: Bearer {token}
```

**路径参数**:
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| menuId | string | 是 | 菜单ID |

**请求示例**:
```http
GET /api/admin/menu/menu_id_123/dishes
Authorization: Bearer {token}
```

**响应示例**:
```json
{
  "success": true,
  "message": "获取菜单菜品成功",
  "data": [
    {
      "_id": "menu_dish_id_1",
      "menuId": "menu_id_123",
      "dishId": "dish_id_1",
      "price": 15.0,
      "sort": 1,
      "dishName": "宫保鸡丁",
      "dishDescription": "经典川菜，口感麻辣鲜香",
      "dishImage": "https://example.com/dish1.jpg",
      "categoryName": "荤菜",
      "createTime": "2025-09-16T12:00:00.000Z"
    }
  ],
  "timestamp": "2025-09-16T12:50:17.000Z"
}
```

---

### 7. 设置菜单菜品

**接口地址**: `POST /api/admin/menu/:menuId/dishes`

**接口描述**: 为指定菜单设置菜品列表

**请求头**:
```http
Authorization: Bearer {token}
Content-Type: application/json
```

**路径参数**:
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| menuId | string | 是 | 菜单ID |

**请求参数**:
```json
{
  "dishItems": [                           // 必填，菜品项目数组
    {
      "dishId": "dish_id_1",               // 必填，菜品ID
      "price": 15.0,                       // 可选，价格，默认使用菜品原价
      "sort": 1                            // 可选，排序，默认为数组索引
    },
    {
      "dishId": "dish_id_2",
      "price": 12.0,
      "sort": 2
    }
  ]
}
```

**参数验证**:
- `dishItems`: 必须是数组
- `dishItems.*.dishId`: 菜品ID不能为空
- `dishItems.*.price`: 可选，必须大于等于0
- `dishItems.*.sort`: 可选，必须大于等于0

**请求示例**:
```http
POST /api/admin/menu/menu_id_123/dishes
Authorization: Bearer {token}
Content-Type: application/json

{
  "dishItems": [
    {
      "dishId": "dish_id_1",
      "price": 15.0,
      "sort": 1
    }
  ]
}
```

**响应示例**:
```json
{
  "success": true,
  "message": "菜单菜品设置成功",
  "data": {
    "menuId": "menu_id_123",
    "dishCount": 1,
    "dishes": [
      {
        "dishId": "dish_id_1",
        "price": 15.0,
        "sort": 1
      }
    ]
  },
  "timestamp": "2025-09-16T12:50:17.000Z"
}
```

---

### 8. 获取菜单模板

**接口地址**: `GET /api/admin/menu/templates`

**接口描述**: 获取菜单模板列表

**请求头**:
```http
Authorization: Bearer {token}
```

**请求示例**:
```http
GET /api/admin/menu/templates
Authorization: Bearer {token}
```

**响应示例**:
```json
{
  "success": true,
  "message": "获取菜单模板成功",
  "data": [
    {
      "_id": "template_id_1",
      "name": "工作日午餐模板",
      "description": "适合工作日午餐的菜品组合",
      "mealType": "lunch",
      "dishes": [
        {
          "dishId": "dish_id_1",
          "price": 15.0,
          "sort": 1
        }
      ],
      "createTime": "2025-09-01T10:00:00.000Z",
      "updateTime": "2025-09-01T10:00:00.000Z"
    }
  ],
  "timestamp": "2025-09-16T12:50:17.000Z"
}
```

---

### 9. 删除菜单模板

**接口地址**: `DELETE /api/admin/menu/templates/:templateId`

**接口描述**: 删除指定的菜单模板

**请求头**:
```http
Authorization: Bearer {token}
```

**路径参数**:
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| templateId | string | 是 | 模板ID |

**请求示例**:
```http
DELETE /api/admin/menu/templates/template_id_1
Authorization: Bearer {token}
```

**响应示例**:
```json
{
  "success": true,
  "message": "菜单模板删除成功",
  "data": {
    "templateId": "template_id_1"
  },
  "timestamp": "2025-09-16T12:50:17.000Z"
}
```

## 📊 菜品管理接口列表

### 10. 获取菜品列表

**接口地址**: `GET /api/admin/dishes`

**接口描述**: 获取菜品列表，支持分页和筛选

**请求头**:
```http
Authorization: Bearer {token}
```

**查询参数**:
| 参数名 | 类型 | 必填 | 默认值 | 说明 |
|--------|------|------|--------|------|
| page | number | 否 | 1 | 页码，必须大于0 |
| pageSize | number | 否 | 20 | 每页数量，1-100之间 |
| keyword | string | 否 | - | 关键词搜索（菜品名称/描述） |
| categoryId | string | 否 | - | 分类ID筛选 |
| status | string | 否 | - | 状态筛选：active/inactive |
| mealType | string | 否 | - | 餐次类型筛选：breakfast/lunch/dinner |

**请求示例**:
```http
GET /api/admin/dishes?page=1&pageSize=10&mealType=lunch&keyword=鸡丁
Authorization: Bearer {token}
```

**响应示例**:
```json
{
  "success": true,
  "message": "获取菜品列表成功",
  "data": {
    "list": [
      {
        "_id": "dish_id_1",
        "name": "宫保鸡丁",
        "description": "经典川菜，口感麻辣鲜香",
        "price": 15.0,
        "categoryId": "cat_id_1",
        "categoryName": "荤菜",
        "image": "https://example.com/dish1.jpg",
        "calories": 280,
        "protein": 25.5,
        "fat": 12.3,
        "carbohydrate": 18.7,
        "tags": ["川菜", "辣", "鸡肉"],
        "meal_types": ["lunch", "dinner"],
        "status": "active",
        "isRecommended": true,
        "createTime": "2025-09-01T10:00:00.000Z",
        "updateTime": "2025-09-15T15:30:00.000Z"
      }
    ],
    "pagination": {
      "page": 1,
      "pageSize": 10,
      "total": 45,
      "totalPages": 5
    }
  },
  "timestamp": "2025-09-16T12:50:17.000Z"
}
```

---

### 11. 获取菜品详情

**接口地址**: `GET /api/admin/dishes/:dishId`

**接口描述**: 获取指定菜品的详细信息

**请求头**:
```http
Authorization: Bearer {token}
```

**路径参数**:
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| dishId | string | 是 | 菜品ID |

**请求示例**:
```http
GET /api/admin/dishes/dish_id_1
Authorization: Bearer {token}
```

**响应示例**:
```json
{
  "success": true,
  "message": "获取菜品详情成功",
  "data": {
    "_id": "dish_id_1",
    "name": "宫保鸡丁",
    "description": "经典川菜，口感麻辣鲜香，选用鸡胸肉配以花生米和干辣椒制作而成",
    "price": 15.0,
    "categoryId": "cat_id_1",
    "categoryName": "荤菜",
    "image": "https://example.com/dish1.jpg",
    "calories": 280,
    "protein": 25.5,
    "fat": 12.3,
    "carbohydrate": 18.7,
    "tags": ["川菜", "辣", "鸡肉", "花生"],
    "meal_types": ["lunch", "dinner"],
    "status": "active",
    "isRecommended": true,
    "createTime": "2025-09-01T10:00:00.000Z",
    "updateTime": "2025-09-15T15:30:00.000Z",
    "createByName": "管理员"
  },
  "timestamp": "2025-09-16T12:50:17.000Z"
}
```

---

### 12. 创建菜品

**接口地址**: `POST /api/admin/dishes`

**接口描述**: 创建新菜品

**请求头**:
```http
Authorization: Bearer {token}
Content-Type: application/json
```

**请求参数**:
```json
{
  "name": "宫保鸡丁",                       // 必填，菜品名称
  "description": "经典川菜，口感麻辣鲜香",    // 可选，菜品描述
  "price": 15.0,                          // 必填，价格
  "categoryId": "cat_id_1",               // 必填，分类ID
  "image": "https://example.com/dish1.jpg", // 可选，图片URL
  "calories": 280,                        // 可选，卡路里
  "protein": 25.5,                        // 可选，蛋白质(g)
  "fat": 12.3,                           // 可选，脂肪(g)
  "carbohydrate": 18.7,                   // 可选，碳水化合物(g)
  "tags": ["川菜", "辣", "鸡肉"],          // 可选，标签数组
  "mealTypes": ["lunch", "dinner"],       // 可选，适用餐次
  "status": "active",                     // 可选，状态：active/inactive，默认active
  "isRecommended": true                   // 可选，是否推荐，默认false
}
```

**响应示例**:
```json
{
  "success": true,
  "message": "菜品创建成功",
  "data": {
    "_id": "dish_id_new"
  },
  "timestamp": "2025-09-16T12:50:17.000Z"
}
```

---

### 13. 更新菜品

**接口地址**: `PUT /api/admin/dishes/:dishId`

**接口描述**: 更新菜品信息

**请求头**:
```http
Authorization: Bearer {token}
Content-Type: application/json
```

**路径参数**:
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| dishId | string | 是 | 菜品ID |

**请求参数**: 与创建菜品相同，所有字段都是可选的

**响应示例**:
```json
{
  "success": true,
  "message": "菜品更新成功",
  "data": {
    "_id": "dish_id_1"
  },
  "timestamp": "2025-09-16T12:50:17.000Z"
}
```

---

### 14. 删除菜品

**接口地址**: `DELETE /api/admin/dishes/:dishId`

**接口描述**: 删除菜品（软删除，状态改为deleted）

**请求头**:
```http
Authorization: Bearer {token}
```

**路径参数**:
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| dishId | string | 是 | 菜品ID |

**响应示例**:
```json
{
  "success": true,
  "message": "菜品删除成功",
  "data": {
    "_id": "dish_id_1"
  },
  "timestamp": "2025-09-16T12:50:17.000Z"
}
```

---

### 15. 批量更新菜品状态

**接口地址**: `PUT /api/admin/dishes/batch/status`

**接口描述**: 批量更新菜品状态

**请求头**:
```http
Authorization: Bearer {token}
Content-Type: application/json
```

**请求参数**:
```json
{
  "dishIds": ["dish_id_1", "dish_id_2"],  // 必填，菜品ID数组
  "status": "active"                      // 必填，新状态：active/inactive
}
```

**响应示例**:
```json
{
  "success": true,
  "message": "批量更新菜品状态成功",
  "data": {
    "updatedCount": 2
  },
  "timestamp": "2025-09-16T12:50:17.000Z"
}
```

---

### 16. 获取菜品分类

**接口地址**: `GET /api/admin/dishes/categories`

**接口描述**: 获取菜品分类列表

**请求头**:
```http
Authorization: Bearer {token}
```

**响应示例**:
```json
{
  "success": true,
  "message": "获取菜品分类成功",
  "data": [
    {
      "_id": "cat_id_1",
      "name": "荤菜",
      "description": "各种肉类菜品",
      "icon": "meat",
      "sort": 1,
      "status": "active",
      "createTime": "2025-09-01T10:00:00.000Z",
      "updateTime": "2025-09-01T10:00:00.000Z"
    },
    {
      "_id": "cat_id_2",
      "name": "素菜",
      "description": "各种蔬菜菜品",
      "icon": "vegetable",
      "sort": 2,
      "status": "active",
      "createTime": "2025-09-01T10:00:00.000Z",
      "updateTime": "2025-09-01T10:00:00.000Z"
    }
  ],
  "timestamp": "2025-09-16T12:50:17.000Z"
}
```

---

### 17. 创建菜品分类

**接口地址**: `POST /api/admin/dishes/categories`

**接口描述**: 创建菜品分类

**请求头**:
```http
Authorization: Bearer {token}
Content-Type: application/json
```

**请求参数**:
```json
{
  "name": "汤类",                          // 必填，分类名称
  "description": "各种汤类菜品",            // 可选，分类描述
  "icon": "soup",                         // 可选，图标
  "sort": 3                              // 可选，排序，默认0
}
```

**响应示例**:
```json
{
  "success": true,
  "message": "菜品分类创建成功",
  "data": {
    "_id": "cat_id_new"
  },
  "timestamp": "2025-09-16T12:50:17.000Z"
}
```

---

### 18. 更新菜品分类

**接口地址**: `PUT /api/admin/dishes/categories/:categoryId`

**接口描述**: 更新菜品分类

**请求头**:
```http
Authorization: Bearer {token}
Content-Type: application/json
```

**路径参数**:
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| categoryId | string | 是 | 分类ID |

**请求参数**: 与创建分类相同，所有字段都是可选的

**响应示例**:
```json
{
  "success": true,
  "message": "菜品分类更新成功",
  "data": {
    "_id": "cat_id_1"
  },
  "timestamp": "2025-09-16T12:50:17.000Z"
}
```

## ❌ 错误响应格式

所有接口在出错时都会返回统一的错误格式：

```json
{
  "success": false,
  "message": "错误描述信息",
  "error": {
    "code": "ERROR_CODE",
    "details": "详细错误信息"
  },
  "timestamp": "2025-09-16T12:50:17.000Z"
}
```

## 📋 常见错误码

| 错误码 | HTTP状态码 | 说明 |
|--------|------------|------|
| VALIDATION_ERROR | 400 | 参数验证失败 |
| UNAUTHORIZED | 401 | 未授权访问 |
| FORBIDDEN | 403 | 权限不足 |
| NOT_FOUND | 404 | 资源不存在 |
| DUPLICATE_MENU | 409 | 菜单已存在 |
| PAST_DATE | 400 | 不能使用过去日期 |
| INTERNAL_ERROR | 500 | 服务器内部错误 |

## 🧪 测试脚本

项目提供了完整的测试脚本来验证接口功能：

```bash
# 测试菜单时间处理修复
node scripts/test-menu-time-fix.js

# 测试菜单发布流程
node scripts/test-menu-publish-flow.js

# 检查数据库表结构
node scripts/check-menus-table.js
```

## 📝 使用注意事项

1. **时间处理**: 所有时间相关操作都使用UTC时间存储，API返回ISO 8601格式
2. **权限控制**: 所有接口都需要管理员权限
3. **数据验证**: 严格验证输入参数，防止无效数据
4. **事务处理**: 菜单发布和菜品设置使用数据库事务确保数据一致性
5. **软删除**: 菜品删除采用软删除方式，保留数据记录
6. **分页查询**: 列表接口都支持分页，避免大量数据影响性能

## 🔄 工作流程示例

### 典型的菜单发布流程：

1. **获取可用菜品** → `GET /api/admin/dishes`
2. **保存菜单草稿** → `POST /api/admin/menu/draft`
3. **预览菜单内容** → `GET /api/admin/menu/:menuId/dishes`
4. **发布菜单** → `POST /api/admin/menu/publish`
5. **查看发布历史** → `GET /api/admin/menu/history`

这个完整的接口说明涵盖了菜单管理的所有核心功能，包括菜单的创建、发布、管理以及相关菜品的管理功能。
