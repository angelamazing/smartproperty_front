<!DOCTYPE html>
<html>
<head>
    <title>iOS日期修复测试</title>
    <style>
        body{font-family:Arial;max-width:600px;margin:20px auto;padding:20px}
        .btn{background:#007bff;color:white;border:none;padding:8px 16px;margin:5px;border-radius:4px;cursor:pointer}
        .log{background:#f5f5f5;padding:10px;height:200px;overflow-y:auto;font-family:monospace;font-size:12px}
        .success{color:green} .error{color:red}
    </style>
</head>
<body>
    <h1>iOS日期兼容性修复测试</h1>
    <p>测试 "9/13/2025, 7:19:58 AM" 格式</p>
    
    <button class="btn" onclick="test()">运行测试</button>
    <button class="btn" onclick="clearLog()">清空</button>
    
    <div class="log" id="log">等待测试...</div>
    
    <script>
        const formats = ["9/13/2025, 7:19:58 AM", "1/1/2026, 12:00:00 AM"];
        let originalDate = Date;
        
        function log(msg) {
            document.getElementById('log').innerHTML += new Date().toLocaleTimeString() + ' - ' + msg + '<br>';
        }
        
        function clearLog() { document.getElementById('log').innerHTML = ''; }
        
        function applyFix() {
            window.Date = function(...args) {
                if (args.length === 1 && typeof args[0] === 'string') {
                    const str = args[0];
                    const match = str.match(/(\\d{1,2})\\/(\\d{1,2})\\/(\\d{4}),?\\s*(\\d{1,2}):(\\d{1,2}):(\\d{1,2})\\s*(AM|PM)/i);
                    if (match) {
                        let [,m,d,y,h,min,s,ap] = match;
                        let hour = parseInt(h);
                        if (ap.toUpperCase() === 'PM' && hour !== 12) hour += 12;
                        if (ap.toUpperCase() === 'AM' && hour === 12) hour = 0;
                        const iso = `${y}-${m.padStart(2,'0')}-${d.padStart(2,'0')}T${hour.toString().padStart(2,'0')}:${min.padStart(2,'0')}:${s.padStart(2,'0')}`;
                        log(`转换: "${str}" → "${iso}"`);
                        return new originalDate(iso);
                    }
                }
                return new originalDate(...args);
            };
            Object.setPrototypeOf(window.Date, originalDate);
            window.Date.prototype = originalDate.prototype;
        }
        
        function test() {
            log('应用修复...');
            applyFix();
            
            let success = 0;
            formats.forEach((fmt, i) => {
                try {
                    const date = new Date(fmt);
                    if (!isNaN(date.getTime())) {
                        log(`<span class="success">✅ 测试${i+1}: 成功 → ${date.toISOString()}</span>`);
                        success++;
                    } else {
                        log(`<span class="error">❌ 测试${i+1}: 失败</span>`);
                    }
                } catch(e) {
                    log(`<span class="error">❌ 测试${i+1}: 异常 ${e.message}</span>`);
                }
            });
            
            const rate = Math.round(success/formats.length*100);
            log(`<strong>结果: ${success}/${formats.length} (${rate}%) ${rate===100?'🎉完全成功':'⚠️部分成功'}</strong>`);
        }
    </script>
</body>
</html>